************************
计算流体力学有限体积法
************************

扩散项的空间离散
===================


在矩形计算域的二维扩散项
--------------------------

如图所示的是一个由规则笛卡尔网格划分的简单矩形计算域，在这个计算域中将要离散下面这个稳定态扩散方程：

.. math::
	\begin{align}
	- \nabla \cdot (\Gamma^{\phi} \nabla\phi) = Q^{\phi}
	\end{align}

其中 :math:`\phi` 表示一个标量变量（例如温度、质量分数、湍流动能等等）， :math:`Q^{\phi}` 表示计算域中单位体积 :math:`\phi` 的产生量， :math:`\Gamma^{\phi}` 表示扩散系数。


.. figure:: ../_images/计算流体力学有限体积法/二维均一笛卡尔网格.png
  :align: center


根据散度项的Gauss法离散，上面的方程可以离散为

.. math::
	\begin{align}
	\sum_{f\sim nb(C)} (-\Gamma^{\phi}\nabla\phi)_{f} \cdot\mathbf{S}_{f} = Q_{C}^{\phi} V_{C}
	\end{align}

对于如图所示的网格，上式可以展开写成

.. math::
	\begin{align}
	(- \Gamma^{\phi} \nabla\phi)_{e} \cdot \mathbf{S}_{e}
	+ (- \Gamma^{\phi} \nabla\phi)_{w} \cdot \mathbf{S}_{w}
	+ (- \Gamma^{\phi} \nabla\phi)_{n} \cdot \mathbf{S}_{n}
	+ (- \Gamma^{\phi} \nabla\phi)_{s} \cdot \mathbf{S}_{s}
	= Q_{C}^{\phi}V_{C}
	\end{align}

对于如图所示的均一笛卡尔网格，网格面法向量可以如下表示

.. math::
	\begin{align}
	& \mathbf{S}_{e} = + (\Delta y)_{e} \mathbf{i} = \| \mathbf{S}_{e} \| \mathbf{i} = S_{e}\mathbf{i},
	&& \mathbf{S}_{w} = - (\Delta y)_{w} \mathbf{i} = - \| \mathbf{S}_{w} \| \mathbf{i} = -S_{w}\mathbf{i}, \\
	& \mathbf{S}_{n} = + (\Delta x)_{n} \mathbf{j} = \| \mathbf{S}_{n} \| \mathbf{j} = S_{n}\mathbf{j},
	&& \mathbf{S}_{s} = - (\Delta x)_{s} \mathbf{j} = - \| \mathbf{S}_{s} \| \mathbf{j} = -S_{s}\mathbf{j}
	\end{align}

于是，对于右边的网格面，其扩散通量为

.. math::
	\begin{align}
	- (\Gamma^{\phi}\nabla \phi)_{e} \cdot \mathbf{S}_{e}
	= - \Gamma_{e}^{\phi} \Big( \frac{\partial \phi}{\partial x}\mathbf{i} + \frac{\partial \phi}{\partial y}\mathbf{j} \Big) \cdot S_{e} \mathbf{i}
	= - \Gamma_{e}^{\phi}(\Delta y)_{e} \Big(\frac{\partial \phi}{\partial x} \Big)_{e}
	\end{align}

根据之前讨论的单积分点离散守恒方程的内容，扩散通量可以写成如下通用形式：

.. math::
	\begin{align}
	-(\Gamma^{\phi}\nabla\phi)_{e}\cdot\mathbf{S}_{e}
	= \text{FluxT}_{e} = \text{FluxC}_{e}\phi_{C} + \text{FluxF}_{e}\phi_{F} + \text{FluxV}_{e}   
	\end{align}

为了确定 :math:`\text{FluxC}_{e},\text{FluxF}_{e},\text{FluxV}_{e}` 这三个系数，就需要取一个剖面利用相邻两个单元来计算梯度。假设 :math:`\phi` 在网格形心中线性分布，那么在 :math:`e` 面上沿着 :math:`\mathbf{i}` 方向的梯度可以写成

.. math::
	\begin{align}
	\Big(\frac{\partial \phi}{\partial x} \Big)_{e} = \frac{\phi_{E} - \phi_{C}}{(\delta x)_{e}} 
	\end{align}

其中 :math:`(\delta x)_{e}` 是待求网格形心点与右侧相邻网格形心点的距离。将上式代入到 :math:`e` 面的扩散项离散方程，得到

.. math::
	\begin{align}
	\text{FluxT}_{e} = - \Gamma^{\phi} (\Delta y)_{e} \frac{\phi_{E} - \phi_{C}}{\delta x_{e}} = \Gamma^{\phi}_{e} \frac{(\Delta y)_{e}}{\delta x_{e}}(\phi_{C} - \phi_{E})  
	\end{align}

额外引入一个符号进行简化，定义

.. math::
	\begin{align}
	\text{gDiff}_{e} = \frac{(\Delta y)_{e}}{\delta x_{e}} = \frac{\| \mathbf{S}_{e} \|}{\| \mathbf{d}_{CE} \|} = \frac{S_{e}}{d_{CE}}  
	\end{align}

其中 :math:`\mathbf{d}_{CE}` 是单元C和E形心之间的距离向量。于是， :math:`e` 面扩散通量的通用形式的系数就确定为了

.. math::
	\begin{align}
	\text{FluxC}_{e} = \Gamma_{e}^{\phi}\text{gDiff}_{e} ,\quad 
	\text{FluxF}_{e} = -\Gamma_{e}^{\phi}\text{gDiff}_{e} ,\quad 
	\text{FluxV}_{e} = 0     
	\end{align}

类似的操作也可以应用于 :math:`w,n,s` 面上，然后就得到

.. math::
	\begin{align}
	& \text{FluxT}_{w} = \text{FluxC}_{w}\phi_{C} + \text{FluxF}_{w}\phi_{N} + \text{FluxV}_{w} \\
	& \text{FluxT}_{n} = \text{FluxC}_{n}\phi_{C} + \text{FluxF}_{n}\phi_{N} + \text{FluxV}_{n} \\
	& \text{FluxT}_{s} = \text{FluxC}_{s}\phi_{C} + \text{FluxF}_{s}\phi_{N} + \text{FluxV}_{s}    
	\end{align}

其中

.. math::
	\begin{align}
	& \text{FluxC}_{w} = \Gamma_{w}^{\phi}\text{gDiff}_{w} ,\quad \text{FluxF}_{w} = -\Gamma_{w}^{\phi}\text{gDiff}_{w} ,\quad \text{FluxV}_{w} = 0 \\
	& \text{FluxC}_{n} = \Gamma_{n}^{\phi}\text{gDiff}_{n} ,\quad \text{FluxF}_{n} = -\Gamma_{n}^{\phi}\text{gDiff}_{n} ,\quad \text{FluxV}_{n} = 0 \\
	& \text{FluxC}_{s} = \Gamma_{s}^{\phi}\text{gDiff}_{s} ,\quad \text{FluxF}_{s} = -\Gamma_{s}^{\phi}\text{gDiff}_{s} ,\quad \text{FluxV}_{s} = 0 \\
	\end{align}

.. math::
	\begin{align}
	\text{gDiif}_{w} = \frac{\| \mathbf{S}_{w} \|}{\| \mathbf{d}_{CW} \|} = \frac{(\Delta x)_{w}}{\delta y_{w}} = \frac{S_{w}}{d_{CW}}
	,\quad 
	\text{gDiif}_{n} = \frac{\| \mathbf{S}_{n} \|}{\| \mathbf{d}_{CN} \|} = \frac{(\Delta x)_{n}}{\delta y_{n}} = \frac{S_{n}}{d_{CN}}
	,\quad 
	\text{gDiif}_{s} = \frac{\| \mathbf{S}_{s} \|}{\| \mathbf{d}_{CS} \|} = \frac{(\Delta x)_{s}}{\delta y_{s}} = \frac{S_{s}}{d_{CS}}
	\end{align}

将上述离散结果全部代入到扩散方程，则可以表示成如下的线性方程：

.. math::
	\begin{align}
	a_{C}\phi_{C} + \sum_{F\sim NB(C)}a_{F}\phi_{F} = b_{C}
	\end{align}

其中

.. math::
	\begin{align}
	& a_{C} = \sum_{f\sim nb(C)}\text{FluxC}_{f} \\
	& a_{F} = \text{FluxF}_{f} = -\Gamma^{\phi}_{f} \text{gDiff}_{f} \\
	& b_{C} = Q_{C}^{\phi}V_{C} - \sum_{f\sim nb(C)}\text{FluxV}_{f}   
	\end{align}

这里的 :math:`F` 表示与单元C相邻的单元(E,W,N,S)， :math:`f` 表示单元C的相邻面(e,w,n,s)。



对离散方程的评价
------------------

一个合适的离散方法应该得到一个能够反映原始守恒方程所有特性的线性方程。之前介绍了离散方法的一些特性，接下来继续说明离散方程系数必须满足的两条规则。


零和规则
^^^^^^^^^^

回顾离散流程，第一个主要估计产生于变量 :math:`\phi` 在横跨单元表面的单元形心之间的插值。有人会问为什么使用一阶方法而不使用更高阶的方法。为了回答这个问题，可以考虑一个一维无源传导方程，在这些条件下离散方程简化为

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{E}\phi_{E} + a_{W}\phi_{W} = 0
	\end{align}

其中

.. math::
	\begin{align}
	a_{E} = -\Gamma_{e}^{\phi}\text{gDiff}_{e} ,\quad 
	a_{W} = -\Gamma_{w}^{\phi}\text{gDiff}_{w} ,\quad 
	a_{C} = -(a_{E} + a_{W}) 
	\end{align}


在没有源项的情况下， :math:`\phi` 的变化仅仅出现在扩散中，并且满足Fourier's law（椭圆方程）。因此， :math:`\phi_{e}` 或 :math:`\phi_{w}` 的值应该分别处于 :math:`\phi_{C}` 与 :math:`\phi_{E}` 之间和 :math:`\phi_{C}` 与 :math:`\phi_{W}` 之间，而线性方法是一定能够保证这件事的。当采用二阶方法时，可能会导致插值到面上的值高于或低于网格形心上的值，这是不符合物理规律的。对于其他更高阶的方法也是如此。如果需要绝对保证合乎物理的结果，那么就应该使用线性方法。另外，当网格大小减小时所采用的离散方法就会变得没那么重要，因为所有估计在网格单元趋于零的时候都会取到一个相同的解析值。更进一步地，在不考虑任何源项的情况下，多维温度扩散方程化简为

.. math::
	\begin{align}
	- \nabla \cdot (\Gamma^{\phi}\nabla\phi) = 0
	\end{align}

上式表明 :math:`\phi` 和 :math:`\phi + \text{const}` 都是上面的扩散方程的解。一个一致的离散方法应该反映出这个特性，也就是说，离散方程应该满足

.. math::
	\begin{align}
	\left.\begin{array}{c}
	a_{C}\phi_{C} + \sum\limits_{F \sim NB(C)} a_{F}\phi_{F} = 0 \\
	a_{C}(\phi_{C} + \text{const}) + \sum\limits_{F \sim NB(C)}a_{F}(\phi_{F} + \text{const}) = 0
	\end{array}\right\} \Rightarrow 
	a_{C} + \sum_{F \sim NB(C)}a_{F} = 0
	\end{align}

上述方程可以进一步将系数的关系写成

.. math::
	\begin{align}
	a_{C} = -\sum_{F \sim NB(C)}a_{F}
	\quad \text{or}\quad 
	\sum_{F\sim NB(C)}\frac{a_{F}}{a_{C}} = -1
	\end{align}

因此， :math:`\phi_{C}` 可以被视为相邻量的加权和，并且在无源项的时候它总是由相邻的 :math:`\phi_{F}` 值限制有界。而当有源项的时候， :math:`\phi_{C}` 不必以这种方式限制有界，也就可以高于相邻值，但是这是完全符合物理的。超出值将由源项 :math:`S_{C}^{\phi}` 的模相对于相邻节点系数 :math:`a_{F}` 的大小来决定。



反号规则
^^^^^^^^^^

上面的论述也同时说明了系数 :math:`a_{C}` 和 :math:`a_{F}` 是反号的。这具有重要的物理意义，它表明当 :math:`\phi_{F}` 增大/减小时， :math:`\phi_{C}` 的值应当随之增大/减小。这基本上与有界性有关，这表明满足这个性质的充分条件是相邻系数和主系数的符号相反。如果不是，那么有界性性质可能就不成立。




边界条件
-----------

我们都知道任何常微分方程或偏微分方程的解析解都需要给定合适的边界条件才能确定其中的常数。因此，即使控制方程是一样的，使用不同的边界条件也会得到完全不同的结果。数值解也遵循同样的道理，数值解遵循相同的约束，需要正确和准确地实现边界条件，因为由数值近似引入的这些条件的任何微小变化都会导致所考虑问题的错误解。边界条件将与被离散化的项相关。对于传导/扩散问题，会遇到狄利克雷、诺伊曼、混合和对称边界条件类型，下面将详细介绍。

边界条件应用于边界元素，边界元素在边界上有一个或多个面。 :math:`\phi` 的离散值存储在边界单元的中心处和边界面的中心处。设 :math:`C` 为如图所示边界元的形心，边界面的形心记为 :math:`b` ，边界面的面向量 :math:`S_{b}` 指向向外。与前面一样，单元格 :math:`C` 的离散化过程产生

.. math::
	\begin{align}
	\sum_{f \sim nb(C)}(\mathbf{J}^{\phi,D} \cdot \mathbf{S})_{f} = Q_{C}^{\phi}V_{C}
	\end{align}

对内面通量还是跟之前所述的那样进行离散，而对边界通量进行的离散则需要构造对 :math:`\phi_{C}` 的线性化，也即

.. math::
	\begin{align}
	\mathbf{J}_{b}^{\phi,D} \cdot \mathbf{S}_{b} = \text{FluxT}_{b} = -\Gamma_{b}^{\phi}(\nabla \phi)_{b} \cdot \mathbf{S}_{b} = \text{FluxC}_{b}\phi_{C} + \text{FluxV}_{b}   
	\end{align}

边界条件的定义包括指定未知的边界值 :math:`\phi_{b}` ，或者指定边界通量 :math:`\mathbf{J}_{b}^{\phi,D}` 。这样就导出了不同边界条件类型的扩散问题在边界元处的离散方程。


Dirichlet边界条件
^^^^^^^^^^^^^^^^^^^

Dirichlet边界条件就是一种直接指定 :math:`\phi` 在边界上的值的条件，即

.. math::
	\begin{align}
	\phi_{b} = \phi_{\text{specified}}
	\end{align}

.. figure:: ../_images/计算流体力学有限体积法/扩散项Dirichlet边界条件.png
  :align: center

对于如图的情况，有

.. math::
	\begin{align}
	\text{FluxT}_{b} = -\Gamma_{b}^{\phi}(\nabla \phi)_{b} \cdot \mathbf{S}_{b}
	= - \Gamma_{b}^{\phi} \frac{\| \mathbf{S}_{b} \|}{\| \mathbf{d}_{Cb} \|}(\phi_{b} - \phi_{C})
	= \text{FluxC}_{b}\phi_{C} + \text{FluxV}_{b} 
	\end{align}

其中

.. math::
	\begin{align}
	& \text{FluxC}_{b} = \Gamma_{b}^{\phi}\text{gDiff}_{b} \\
	& \text{FluxV}_{b} = -\Gamma_{b}^{\phi}\text{gDiff}_{b}\phi_{b} \\
	& \text{gDiff}_{b} = \frac{S_{b}}{d_{Cb}} 
	\end{align}


因此对于图中所示的 :math:`C` 单元，系数 :math:`a_{E}` 为零，离散方程化简为

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{W}\phi_{W} + a_{N}\phi_{N} + a_{S}\phi_{S} = b_{C}
	\end{align}

其中

.. math::
	\begin{align}
	& a_{E} = 0 \\
	& a_{W} = \text{FluxF}_{w} = -\Gamma_{w}^{\phi}\text{gDiff}_{w} \\
	& a_{N} = \text{FluxF}_{n} = -\Gamma_{n}^{\phi}\text{gDiff}_{n} \\
	& a_{S} = \text{FluxF}_{s} = -\Gamma_{s}^{\phi}\text{gDiff}_{s} \\
	& a_{C} = \text{FluxC}_{b} + \sum_{f \sim nb(C)}\text{FluxC}_{f} = \text{FluxC}_{b} + (\text{FluxC}_{w} + \text{FluxC}_{n} + \text{FluxC}_{s}) \\
	& b_{C} = Q_{C}^{\phi}V_{C} - \Big( \text{FluxV}_{b} + \sum_{f \sim nb(C)}\text{FluxV}_{f} \Big)
	\end{align}

从上面的离散方程中可以看到如下的特点：

1. 系数 :math:`\text{FluxC}_{b}` 要比其他相邻系数更大，因为 :math:`b` 更靠近 :math:`C` 形心，也因此对 :math:`\phi_{C}` 有更重要的影响。
2. 系数 :math:`a_{C}` 仍然是所有相邻系数的和（包括 :math:`\text{FluxC}_{b}` ）。这意味着对于边界处的单元有 :math:`\sum\limits_{F \sim NB(C)}|a_{F}|/|a_{C}| < 1` ，给出了满足Scarborough判据的第二个必要条件，从而保证了线性方程组在任意一次迭代中的收敛性。
3.  :math:`\text{FluxV}_{b}` 现在位于方程右手边，也就是 :math:`b_{C}` 的一部分，因为它不包含任何未知数。
    


Neumann边界条件
^^^^^^^^^^^^^^^^^^

如果在边界处指定了 :math:`\phi` 的通量(或表面的法线梯度)则称为Neumann边界条件。在这种情况下，指定的通量满足

.. math::
	\begin{align}
	- (\Gamma^{\phi}\nabla\phi)_{b} \cdot \mathbf{i} = q_{b}
	\end{align}


.. figure:: ../_images/计算流体力学有限体积法/扩散项Neumann边界条件.png
  :align: center


可以进一步表示成与扩散通量有关，即

.. math::
	\begin{align}
	\mathbf{J}_{b}^{\phi,D} \cdot \mathbf{S}_{b}
	= - (\Gamma^{\phi}\nabla\phi)_{b} \cdot \| \mathbf{S}_{b} \| \mathbf{i}
	= \text{FluxC}_{b}\phi_{C} + \text{FluxV}_{b}
	= q_{b} \| \mathbf{S}_{b} \|
	\end{align}

其中

.. math::
	\begin{align}
	& \text{FluxC}_{b} = 0 \\
	& \text{FluxV}_{b} = q_{b}S_{b} = q_{b}(\Delta y)_{C}  
	\end{align}

这里假设通量分量是正的，当它们的作用方向与所使用的坐标系相同。因此， :math:`q_{b}` 将直接放入边界单元 :math:`C` 的离散方程当中：

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{W}\phi_{W} + a_{N}\phi_{N} + a_{S}\phi_{S} = b_{C}
	\end{align}

其中

.. math::
	\begin{align}
	& a_{E} = 0 \\
	& a_{W} = \text{FluxF}_{w} = -\Gamma_{w}^{\phi}\text{gDiff}_{w} \\
	& a_{N} = \text{FluxF}_{n} = -\Gamma_{n}^{\phi}\text{gDiff}_{n} \\
	& a_{S} = \text{FluxF}_{s} = -\Gamma_{s}^{\phi}\text{gDiff}_{s} \\
	& a_{C} = \sum_{f \sim nb(C)}\text{FluxC}_{f} = -(a_{W} + a_{N} + a_{S}) \\
	& b_{C} = Q_{C}^{\phi}V_{C} - \Big( \text{FluxV}_{b} + \sum_{f \sim nb(C)}\text{FluxV}_{f} \Big)      
	\end{align}

从上面的离散方程可以看出如下特征：

1. Neumann边界条件不会对主导系数 :math:`a_{C}` 产生贡献。
2. 如果 :math:`q_{b}` 和 :math:`S_{C}^{\phi}` 都是零，那么 :math:`\phi_{C}` 将被其相邻量限制有界。否则， :math:`\phi_{C}` 将可能超过或低于其相邻值 :math:`\phi` ，这种情况是允许的。例如，如果 :math:`\phi` 表示温度，那么 :math:`q_{b}` 表示应用在边界上的热通量。因此，如果热量添加到边界上，那么在靠近边界的区域其温度要比内部区域要更高。
3. 一旦 :math:`\phi_{C}` 被计算出来，那么边界上的值 :math:`\phi_{b}` 就可以如下计算
   
.. math::
	\begin{align}
	\phi_{b} = \frac{\Gamma_{b}^{\phi}\text{gDiff}_{b}\phi_{C} - q_{b}}{\Gamma_{b}^{\phi}\text{gDiff}_{b}} 
	\end{align}

4. Neumann条件可以被认为是有限体积法的自然边界条件，因为对于指定通量为零的情况，不需要对面进行任何离散化，而指定值为零(Dirichlet条件)仍然需要进行离散化。



混合边界条件
^^^^^^^^^^^^^^^

混合边界条件，如图所示，是指边界上的信息通过对流传递系数( :math:`h_{\infty}` )和 :math:`\phi` 周围值( :math:`\phi_{\infty}` )给出的情况，可以表示为

.. math::
	\begin{align}
	\mathbf{J}_{b}^{\phi,D} \cdot \mathbf{S}_{b}
	= - (\Gamma^{\phi}\nabla\phi)_{b} \cdot \mathbf{i} S_{b}
	= - h_{\infty} (\phi_{\infty} - \phi_{b})(\Delta y)_{C}
	\end{align}

也可以展开写成

.. math::
	\begin{align}
	- \Gamma_{b}^{\phi}S_{b}\Big( \frac{\phi_{b} - \phi_{C}}{\delta x_{b}} \Big)
	= - h_{\infty} (\phi_{\infty} - \phi_{b}) S_{b}
	\end{align}

.. figure:: ../_images/计算流体力学有限体积法/扩散项混合边界条件.png
  :align: center


从上式我们可以得到 :math:`\phi_{b}` 的表达式：

.. math::
	\begin{align}
	\phi_{b} = \frac{h_{\infty}\phi_{\infty} + (\Gamma_{b}^{\phi}/\delta x_{b})\phi_{C}}{h_{\infty} + (\Gamma_{b}^{\phi}/\delta x_{b})} 
	\end{align}

将上式代入到最开始边界条件的定义式，通量方程就变成了

.. math::
	\begin{align}
	\mathbf{J}_{b}^{\phi,D} \cdot \mathbf{S}_{b}
	= - \Big[ \frac{h_{\infty}(\Gamma_{b}^{\phi}/\delta x_{b})}{h_{\infty} + (\Gamma_{b}^{\phi}/\delta x_{b})}S_{b} \Big] (\phi_{\infty} - \phi_{C})
	= \text{FluxC}_{b}\phi_{C} + \text{FluxV}_{b}  
	\end{align}

下面记 :math:`R_{eq} = \frac{h_{\infty}(\Gamma_{b}^{\phi}/\delta x_{b})}{h_{\infty} + (\Gamma_{b}^{\phi}/\delta x_{b})}S_{b}` ，则其中

.. math::
	\begin{align}
	\text{FluxC}_{b} = R_{eq} ,\quad 
	\text{FluxV}_{b} = -R_{eq}\phi_{\infty}  
	\end{align}

根据上式，在边界处的单元的离散方程就变成了如下形式：

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{W}\phi_{W} + a_{N}\phi_{N} + a_{S}\phi_{S} = b_{C}
	\end{align}

其中

.. math::
	\begin{align}
	& a_{E} = 0 \\
	& a_{W} = \text{FluxF}_{w} = -\Gamma_{w}^{\phi}\text{gDiff}_{w} \\
	& a_{N} = \text{FluxF}_{n} = -\Gamma_{n}^{\phi}\text{gDiff}_{n} \\
	& a_{S} = \text{FluxF}_{s} = -\Gamma_{s}^{\phi}\text{gDiff}_{s} \\
	& a_{C} = \text{FluxC}_{b} + \sum_{f \sim nb(C)}\text{FluxC}_{f} = (\text{FluxC}_{b} + \text{FluxC}_{w} + \text{FluxC}_{n} + \text{FluxC}_{s}) \\
	& b_{C} = Q_{C}^{\phi}V_{C} - \Big( \text{FluxV}_{b} + \sum_{f \sim nb(C)}\text{FluxV}_{f} \Big) 
	\end{align}




对称边界条件
^^^^^^^^^^^^^^^

沿着对称边界，到标量变量边界的法向通量为零。因此，对称边界条件等价于通量值设为零的Neumann边界条件，也即 :math:`\text{FluxC}_{b} = \text{FluxV}_{b} = 0` 。因此，对称边界条件的离散方程通过设置 :math:`q_{b}=0` 得到，即

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{W}\phi_{W} + a_{N}\phi_{N} + a_{S}\phi_{S} = b_{C}
	\end{align}

其中

.. math::
	\begin{align}
	& a_{E} = 0 \\
	& a_{W} = \text{FluxF}_{w} = -\Gamma_{w}^{\phi}\text{gDiff}_{w} \\
	& a_{N} = \text{FluxF}_{n} = -\Gamma_{n}^{\phi}\text{gDiff}_{n} \\
	& a_{S} = \text{FluxF}_{s} = -\Gamma_{s}^{\phi}\text{gDiff}_{s} \\
	& a_{C} = \sum_{f \sim nb(C)}\text{FluxC}_{f} = - (a_{W} + a_{N} + a_{S}) \\
	& b_{C} = Q_{C}^{\phi}V_{C} - \sum_{f \sim nb(C)}\text{FluxV}_{f}   
	\end{align}



界面扩散系数
--------------

在上述离散方程中，我们分别使用了 :math:`\Gamma_{e}^{\phi},\Gamma_{w}^{\phi},\Gamma_{n}^{\phi},\Gamma_{s}^{\phi}` 来表示 :math:`\Gamma^{\phi}` 在单元 :math:`e,w,n,s` 面上的值。当扩散系数随位置变化的时候，网格形心将会存储这些数值，然后就需要根据这些形心处的值来计算网格界面值。当然，下面的讨论与均匀扩散系数的情况无关。


如果考虑能量方程，讨论可能会变得更清楚，在这种情况下，扩散系数代表所使用的材料的热传导系数而 :math:`\phi` 表示温度。非均匀热传导发生在非均匀材料和/或热导率与温度有关的时候。在一般的关于 :math:`\phi` 的微分方程中，扩散系数 :math:`\Gamma^{\phi}` 都将用相同的方式进行处理。在湍流中经常会遇到 :math:`\Gamma^{\phi}` 的显著变化，这里的 :math:`\Gamma^{\phi}` 可能表示湍流粘度或湍流传导性系数。因此，我们需要找到一个能够处理非均一 :math:`\Gamma^{\phi}` 的合适算法。

一种简单的处理方法就是利用单元 :math:`C` 及其相邻单元的 :math:`\Gamma^{\phi}` 进行线性估计，因此，对于 :math:`e` 面的插值可以这样得到：

.. math::
	\begin{align}
	\Gamma_{e}^{\phi} = (1 -g_{e})\Gamma_{C}^{\phi} + g_{e}\Gamma_{E}^{\phi}
	\end{align}

其中插值因子 :math:`g_{e}` 是关于形心与插值面距离的比值，定义为

.. math::
	\begin{align}
	g_{e} = \frac{d_{Ce}}{d_{Ce} + d_{eE}} 
	\end{align}

因此，对于一个笛卡尔网格，如果网格面位于网格形心点的中间，那么 :math:`g_{e}=0.5` ，并且 :math:`\Gamma_{e}^{\phi}` 就是 :math:`\Gamma_{C}^{\phi}` 和 :math:`\Gamma_{E}^{\phi}` 的算术平均值。对于其他面的系数也可以类似得到：

.. math::
	\begin{align}
	g_{w} = \frac{d_{Cw}}{d_{Cw} + d_{wW}} ,\quad 
	g_{n} = \frac{d_{Cn}}{d_{Cn} + d_{nN}} ,\quad 
	g_{s} = \frac{d_{Cs}}{d_{Cs} + d_{sS}}   
	\end{align}

因此，只计算一次单元各网格面的系数就足够了。此外，使用距离而不是体积将导致相同的插值因子，因为这里的网格是笛卡尔的。


这种基本方法在某些情况下会导致相当不正确的结果，不能准确地处理，例如，复合材料中可能发生的传导率的突然变化。不过，有一种比这简单得多的选择。在开发这种替代方案时，我们认识到界面上的局部电导率值不是主要考虑的问题，相反，我们的主要目标是获得界面处扩散通量的良好表示。对于如图所示的一维问题，假设单元C由导热系数为 :math:`\Gamma_{C}^{\phi}` 的材料组成，而单元E由导热系数为 :math:`\Gamma_{E}^{\phi}` 的材料组成。对于C点与E点之间的非均质网格面，一维无源分析得到(假设界面E两侧的通量相同)：

.. math::
	\begin{align}
	\mathbf{J}_{e}^{\phi,D} \cdot \mathbf{S}_{e}
	= \frac{\phi_{C} - \phi_{e}}{\cfrac{(\delta x)_{Ce}}{\Gamma_{C}^{\phi}}}
	= \frac{\phi_{e} - \phi_{E}}{\cfrac{(\delta x)_{eE}}{\Gamma_{E}^{\phi}}}
	= \frac{\phi_{C} - \phi_{E}}{\cfrac{(\delta x)_{Ce}}{\Gamma_{C}^{\phi}} + \cfrac{(\delta x)_{eE}}{\Gamma_{E}^{\phi}}} 
	= \frac{\phi_{C} - \phi_{E}}{\cfrac{(\delta x)_{CE}}{\Gamma_{e}^{\phi}}} 
	\end{align}


.. figure:: ../_images/计算流体力学有限体积法/在单元面上的插值.png
  :align: center


由此得出平板的有效热传导率为

.. math::
	\begin{align}
	\frac{(\delta x)_{CE}}{\Gamma_{e}^{\phi}}
	= \frac{(\delta x)_{Ce}}{\Gamma_{C}^{\phi}} + \frac{(\delta x)_{eE}}{\Gamma_{E}^{\phi}}
	\quad \Rightarrow \quad 
	\frac{1}{\Gamma_{e}^{\phi}} = \Big( \frac{1-g_{e}}{\Gamma_{E}^{\phi}} + \frac{g_{e}}{\Gamma_{C}^{\phi}}  \Big) 
	\end{align}

当网格面位于C和E的中间时，有 :math:`g_{e}=0.5` ，上式就化简为了

.. math::
	\begin{align}
	\Gamma_{e}^{\phi} = \frac{2 \Gamma_{C}^{\phi} \Gamma_{E}^{\phi}}{\Gamma_{C}^{\phi} + \Gamma_{E}^{\phi}} 
	\end{align}

也就是说， :math:`\Gamma_{e}^{\phi}` 是 :math:`\Gamma_{C}^{\phi}` 和 :math:`\Gamma_{E}^{\phi}` 的调和平均值，而不是开始所采用的算术平均值。

值得注意的是，非连续扩散系数的调和平均值插值仅适用于一维扩散。然而，它在多维情况下的应用具有重要的优势。如果使用这种类型的插值，在处理共轭界面时就不需要做任何特别的事情，固体和流体的网格被简单地视为相同区域的一部分，在网格质心处存储不同的扩散系数。通过将扩散系数计算为共享网格面质心处的调和平均值，可以正确计算出共轭界面处的扩散通量。



非笛卡尔正交网格
------------------

现在让我们考虑一个没有沿着 :math:`x,y` 坐标的正交网格，如图所示，这样的网格可以通过将之前的笛卡尔网格旋转某个角度得到。该网格的离散化方程应该与笛卡尔网格的离散化方程完全相同。对于相似的边界条件，应得到相同的解。


.. figure:: ../_images/计算流体力学有限体积法/非笛卡尔正交网格.png
  :align: center

再次考虑稳态扩散方程

.. math::
	\begin{align}
	\nabla \cdot \mathbf{J}^{\phi,D} = Q^{\phi}
	\end{align}

跟之前一样，它的离散形式为

.. math::
	\begin{align}
	\sum_{f \sim nb(C)} - (\Gamma^{\phi} \nabla\phi)_{f} \cdot \mathbf{S}_{f} = Q_{C}^{\phi}V_{C}
	\end{align}

单独考虑在 :math:`e` 面的离散，就得到了

.. math::
	\begin{align}
	\mathbf{J}_{e}^{\phi,D} \cdot \mathbf{S}_{e}
	= - \Gamma_{e}^{\phi} (\nabla \phi \cdot \mathbf{n})_{e} S_{e}
	= - \Gamma_{e}^{\phi} \Big( \frac{\partial \phi}{\partial n} \Big)_{e} S_{e}
	\end{align}

其中 :math:`(\nabla \phi \cdot \mathbf{n})_{e} = \Big( \frac{\partial \phi}{\partial n} \Big)_{e}` 是 :math:`\phi` 在 :math:`e` 面上沿 :math:`\mathbf{n}` 方向的梯度。再次沿着 :math:`\mathbf{n}` 方向使用线性方法，该梯度就可以写成

.. math::
	\begin{align}
	\Big( \frac{\partial \phi}{\partial n} \Big)_{e} = \frac{\phi_{E} - \phi_{C}}{d_{CE}} 
	\end{align}

其他项的离散化过程与笛卡尔网格一样，最终得到相同的离散化方程。



非正交非结构化网格
---------------------

非正交性
^^^^^^^^^^^

在前面所述的网格构型中，通量都是与网格面正交的，然而一般来说，结构化含曲线的网格以及非结构网格都是非正交的。因此，面法向量 :math:`\mathbf{S}_{f}` 和连接相邻网格单元质心的向量 :math:`\mathbf{CF}` 并不在同一直线上，如图所示。在这种情况下，面法向梯度就不能够写成关于 :math:`\phi_{F}` 和 :math:`\phi_{C}` 的函数，因为它有一个垂直于 :math:`\mathbf{CF}` 方向的分量。

.. figure:: ../_images/计算流体力学有限体积法/非正交网格系统中的网格单元关系.png
  :align: center

所以，只有在正交网格的情况下，面法向梯度才能写成下面的形式：

.. math::
	\begin{align}
	(\nabla \phi \cdot \mathbf{n})_{f}
	= \Big( \frac{\partial \phi}{\partial n} \Big)_{f}
	= \frac{\phi_{F} - \phi_{C}}{\| \mathbf{r}_{F} - \mathbf{r}_{C} \|}
	= \frac{\phi_{F} - \phi_{C}}{d_{CF}}
	\end{align}

在非正交网格中，就需要引入一个描述相邻网格质心方向的新的单位向量 :math:`\mathbf{e}` ，它可以表示为

.. math::
	\begin{align}
	\mathbf{e} = \frac{\mathbf{r}_{F} - \mathbf{r}_{C}}{\| \mathbf{r}_{F} - \mathbf{r}_{C} \|} = \frac{\mathbf{d}_{CF}}{d_{CF}} 
	\end{align}

那么，在 :math:`\mathbf{e}` 方向的梯度就可以写成

.. math::
	\begin{align}
	(\nabla \phi \cdot \mathbf{e})_{f}
	= \Big( \frac{\partial \phi}{\partial e} \Big)_{f}
	= \frac{\phi_{F} - \phi_{C}}{\| \mathbf{r}_{F} - \mathbf{r}_{C} \|}
	= \frac{\phi_{F} - \phi_{C}}{d_{CF}}  
	\end{align}

因此，为了实现非正交网格中通量的线性化，面法向量应该写成两个向量的和，即

.. math::
	\begin{align}
	\mathbf{S}_{f} = \mathbf{E}_{f} + \mathbf{T}_{f}
	\end{align}

如此，面法向梯度就可以写成关于 :math:`\phi_{F}` 、 :math:`\phi_{C}` 的函数加上修正项的形式，即

.. math::
	\begin{align}
	(\nabla \phi)_{f} \cdot \mathbf{S}_{f} 
	= (\nabla\phi)_{f} \cdot \mathbf{E}_{f} + (\nabla\phi)_{f} \cdot \mathbf{T}
	= E_{f}\Big( \frac{\partial \phi}{\partial e} \Big)_{f} + (\nabla\phi)_{f} \cdot \mathbf{T}_{f}
	= E_{f}\frac{\phi_{F} - \phi_{C}}{d_{CF}} + (\nabla \phi)_{f} \cdot \mathbf{T}_{f} 
	\end{align}

上式右侧第一项表示与正交网格类似的贡献项，右侧第二项称为交叉扩散项或非正交扩散项，这是由于网格非正交性造成的。分解 :math:`\mathbf{S}_{f}` 的方式是可选的，它们将会采用不同的非正交扩散项。


最小修正法
^^^^^^^^^^^^

如图所示，最小修正法(Minimum Correction Approach)采用 :math:`\mathbf{E}_{f}` 和 :math:`\mathbf{T}_{f}` 相互垂直的形式来分解 :math:`\mathbf{S}_{f}` 。当非正交性增加时， :math:`\phi_{F},\phi_{C}` 对扩散通量的贡献减小。在这种情况下，向量 :math:`\mathbf{E}_{f}` 可以这样表示：

.. math::
	\begin{align}
	\mathbf{E}_{f} = (\mathbf{e} \cdot \mathbf{S}_{f})\mathbf{e} = (S_{f}\cos\theta)\mathbf{e}
	\end{align}

.. figure:: ../_images/计算流体力学有限体积法/最小修正法的面法向量分解方式.png
  :align: center


正交修正法
^^^^^^^^^^^^

在正交修正法(Orthogonal Correction Approach)中，来自 :math:`\phi_{F},\phi_{C}` 的贡献不论非正交角度如何，都与正交网格的情况保持相同，如图所示。为了实现这一点， :math:`\mathbf{E}_{f}` 被定义为

.. math::
	\begin{align}
	\mathbf{E}_{f} = S_{f}\mathbf{e}
	\end{align}

.. figure:: ../_images/计算流体力学有限体积法/正交修正法的面法向量分解方式.png
  :align: center


过松弛法
^^^^^^^^^^

在过松弛法(Over-Relaxed Approach)中，来自 :math:`\phi_{F},\phi_{C}` 的贡献的重要性被强制随着非正交性的增加而提高，如图所示。需要通过选择 :math:`\mathbf{T}_{f}` 垂直于 :math:`\mathbf{S}_{f}` 来实现。 :math:`\mathbf{E}_{f}` 通过下式进行计算：

.. math::
	\begin{align}
	\mathbf{E}_{f} = \Big( \frac{S_{f}}{\cos\theta} \Big)\mathbf{e}
	= \Big( \frac{S_{f}^{2}}{S_{f}\cos\theta} \Big)\mathbf{e}
	= \frac{\mathbf{S}_{f} \cdot \mathbf{S}_{f}}{\mathbf{e} \cdot \mathbf{S}_{f}}\mathbf{e}
	\end{align}


.. figure:: ../_images/计算流体力学有限体积法/过松弛法的面法向量分解方式.png
  :align: center


总的来说，在非正交网格中，网格单元的面扩散通量无法仅仅通过相邻两个单元质心的值计算得到，必须额外添加一项表示非正交性的贡献。这一额外添加的项称为交叉扩散项(cross diffusion)，计算方式有

.. math::
	\begin{align}
	(\nabla\phi)_{f} \cdot \mathbf{T}_{f}
	= (\nabla\phi)_{f} \cdot (\mathbf{S}_{f} - \mathbf{E}_{f})
	= \left \{ \begin{array}{l}
	(\nabla \phi)_{f} \cdot (\mathbf{n} - \cos\theta \mathbf{e})S_{f} \quad \text{minimum correction} \\
	(\nabla \phi)_{f} \cdot (\mathbf{n} - \mathbf{e})S_{f} \quad \text{normal correction} \\
	(\nabla \phi)_{f} \cdot \Big( \mathbf{n} - \frac{1}{\cos\theta}\mathbf{e} \Big) \quad \text{over-relaxed} 
	\end{array} \right .
	\end{align}

对于正交网格， :math:`\mathbf{n}` 和 :math:`\mathbf{e}` 共线，因此交叉扩散项为零。而当交叉扩散项不为零的时候，它不能够写成关于 :math:`\phi_{F}` 和 :math:`\phi_{C}` 的函数，因此它将会作为源项添加到线性方程组当中。

.. note:: 交叉扩散项不能用节点值表示。由于这一事实，它将以延迟修正的方式处理，即使用当前梯度场计算其值，并将其作为源项添加到代数方程的右侧。


梯度计算
^^^^^^^^^^^

在一维算域或多维正交算域中离散扩散项的时候，可以发现 :math:`\phi` 的梯度可以显式地写成关于单元节点 :math:`\phi` 值的函数。但是在非正交网格中，扩散项的计算要更加复杂，梯度的非正交分量无法线性化并写成关于单元节点值的形式，而是必须移到方程右边并显式地求值。这意味着要首先计算得到梯度然后才能计算非正交性在离散方程中的贡献。一种广泛使用的计算单元上梯度的方法是Green-Gauss定理，对于任何封闭体积 :math:`V` ，总有：

.. math::
	\begin{align}
	\int_{V}\nabla \phi~\mathrm{d}V = \oint_{\partial V}\phi~\mathrm{d}\mathbf{S}
	\end{align}

其中 :math:`\mathrm{d}\mathbf{S}` 是指向封闭曲面外侧的面积微元法向量。为了得到该方程的离散形式，考虑应用平均值定理：

.. math::
	\begin{align}
	\overline{\nabla \phi}V = \int_{V}\nabla\phi~\mathrm{d}V
	\end{align}

联立上面两个方程即可得到单元C的平均梯度计算方法：

.. math::
	\begin{align}
	\overline{\nabla \phi_{C}} = \frac{1}{V_{C}}\oint_{\partial V_{C}}\phi_{f}\mathbf{S}_{f}
	\end{align}

上式右侧对单元面的积分可以通过面心值与网格面面积相乘来估计，于是

.. math::
	\begin{align}
	\nabla\phi_{C} = \frac{1}{V_{C}}\sum_{f\sim nb(C)} \phi_{f}\mathbf{S}_{f}
	\end{align}

单元面上的梯度可以通过加权平均单元质心处的梯度来得到，即

.. math::
	\begin{align}
	\nabla\phi_{f} = g_{C}\nabla\phi_{C} + g_{F}\nabla \phi_{F}
	\end{align}

其中 :math:`g_{C},g_{F}` 是与网格面 :math:`f` 相对于节点C和F的位置有关的几何插值因子。



非正交网格的线性方程
^^^^^^^^^^^^^^^^^^^^^^^^^

将网格面法向量 :math:`\mathbf{S}_{f}` 分解成 :math:`\mathbf{E}_{f}` 和 :math:`\mathbf{T}_{f}` 两个向量，并将其等效表达式代入到扩散通量半离散方程，得到

.. math::
	\begin{align}
	\sum_{f\sim nb(C)}\Big( \mathbf{J}_{f}^{\phi,D}\cdot \mathbf{S}_{f} \Big)
	&= \sum_{f\sim nb(C)}\Big( -(\Gamma^{\phi}\nabla\phi)_{f} \cdot (\mathbf{E}_{f} + \mathbf{T}_{f}) \Big) \\
	&= \sum_{f\sim nb(C)}\Big( -(\Gamma^{\phi}\nabla\phi)_{f} \cdot \mathbf{E}_{f} \Big) + \sum_{f\sim nb(C)}\Big( -(\Gamma^{\phi}\nabla\phi)_{f}\cdot \mathbf{T}_{f} \Big) \\
	&= \sum_{f\sim nb(C)}\Big( -\Gamma_{f}^{\phi}E_{f}\frac{\phi_{F}-\phi_{C}}{d_{CF}} \Big) + \sum_{f\sim nb(C)}\Big( -(\Gamma^{\phi}\nabla\phi)_{f}\cdot \mathbf{T}_{f} \Big) \\
	&= \sum_{f\sim nb(C)}\Gamma_{f}^{\phi}\text{gDiff}_{f}(\phi_{C} - \phi_{F}) + \sum_{f\sim nb(C)}\Big( -(\Gamma^{\phi}\nabla\phi)_{f}\cdot \mathbf{T}_{f} \Big) \\
	&= \Big( \sum_{f\sim nb(C)}\text{FluxC}_{f} \Big)\phi_{C} + \sum_{f\sim nb(C)}(\text{FluxF}_{f}\phi_{F}) + \sum_{f\sim nb(C)}(\text{FluxV}_{f})
	\end{align}

其中 :math:`\text{gDiff}_{f}` 是一个几何扩散系数，定义为

.. math::
	\begin{align}
	\text{gDiff}_{f} = \frac{E_{f}}{d_{CF}}
	\end{align}

利用上述形式的扩散通量并展开，最终得到非结构化/结构化非正交网格的离散化扩散方程形式为：

.. math::
	\begin{align}
	a_{C}\phi_{C} + \sum_{F\sim NB(C)}a_{F}\phi_{F} = b_{C}
	\end{align}

其中

.. math::
	\begin{align}
	& a_{F} = \text{FluxF}_{f} = -\Gamma_{f}^{\phi}\text{gDiff}_{f} \\
	& a_{C} = \sum_{f\sim nb(C)}\text{FluxC}_{f} = - \sum_{f\sim nb(C)}\text{FluxF}_{f} = \sum_{f\sim nb(C)}\Gamma_{f}^{\phi}\text{gDiff}_{f} \\
	& b_{C} = Q_{C}^{\phi}V_{C} - \sum_{f\sim nb(C)}(\text{FluxV}_{f}) = Q_{C}^{\phi}V_{C} + \sum_{f\sim nb(C)}\Big( (\Gamma^{\phi}\nabla\phi)_{f} \cdot \mathbf{T}_{f} \Big)
	\end{align}

.. attention:: 注意方程右边非正交项的符号变化。



偏斜度
--------

在计算关于 :math:`\phi` 的离散方程时，总是要估计其在网格面上的值，而在网格面上的估计值应该是整个网格面上的平均值。在离散化过程的不同步骤中，总是假设变量在网格单元节点之间呈线性分布，当这一观点延续到变量沿面变化的时候，那么任何变量的面平均值都应该在网格面的面心处找到。通常的做法是使用线性插值到网格面，并且在网格面与连接相邻单元节点的直线之间的交点处来估计网格面的值。

但是，当网格倾斜时，单元间连线不一定穿过网格面的质心，如图所示， :math:`CF` 连线在网格面上的交点为 :math:`f'` ，与网格面的面心 :math:`f` 并不重合。为了保证离散方法整体具有二阶精度，所有面的积分都需要在 :math:`f` 处进行，因此需要找到从 :math:`f'` 处的值修正得到 :math:`f` 处的值的方法。

偏斜度修正(skewness correction)通过将 :math:`f` 处的 :math:`\phi` 展开为 :math:`f'` 处的泰勒展开式来实现，即

.. math::
	\begin{align}
	\phi_{f} = \phi_{f'} + (\nabla\phi)_{f'} \cdot \mathbf{d}_{f'f}
	\end{align}

其中 :math:`\mathbf{d}_{f'f}` 表示一个由交点 :math:`f'` 指向面心 :math:`f` 的向量。

.. figure:: ../_images/计算流体力学有限体积法/存在偏斜度的网格.png
  :align: center




各向异性扩散
---------------

前面讨论的扩散方程都假设材料在各个方向上都具有相同的扩散系数，即认为介质是各向同性的。对于介质扩散系数与方向有关的情况，称为各项异性。如果材料是各项异性的，那么其半离散扩散方程为

.. math::
	\begin{align}
	\sum_{f\sim nb(C)}(-\boldsymbol{\kappa}^{\phi} \cdot \nabla\phi)_{f} \cdot \mathbf{S}_{f} = S_{C}^{\phi}V_{C}
	\end{align}

其中 :math:`\boldsymbol{\kappa}^{\phi}` 是一个二阶对称张量。考虑一个一般的三维情况，上式等号左边的项可以改写为

.. math::
	\begin{align}
	(-\boldsymbol{\kappa}^{\phi} \cdot \nabla\phi)_{f} \cdot \mathbf{S}_{f}
	& = - \begin{bmatrix}
	\boldsymbol{\kappa}_{11}^{\phi} & \boldsymbol{\kappa}_{12}^{\phi} & \boldsymbol{\kappa}_{13}^{\phi} \\
	\boldsymbol{\kappa}_{21}^{\phi} & \boldsymbol{\kappa}_{22}^{\phi} & \boldsymbol{\kappa}_{23}^{\phi} \\
	\boldsymbol{\kappa}_{31}^{\phi} & \boldsymbol{\kappa}_{32}^{\phi} & \boldsymbol{\kappa}_{33}^{\phi}
	\end{bmatrix}_{f}
	\begin{bmatrix}
	\frac{\partial \phi}{\partial x} \\
	\frac{\partial \phi}{\partial y} \\
	\frac{\partial \phi}{\partial z}
	\end{bmatrix}_{f}
	\cdot \mathbf{S}_{f}
	= - \begin{bmatrix}
	\boldsymbol{\kappa}_{11}^{\phi}\frac{\partial \phi}{\partial x} + \boldsymbol{\kappa}_{12}^{\phi}\frac{\partial \phi}{\partial y} + \boldsymbol{\kappa}_{13}^{\phi}\frac{\partial \phi}{\partial z} \\
	\boldsymbol{\kappa}_{21}^{\phi}\frac{\partial \phi}{\partial x} + \boldsymbol{\kappa}_{22}^{\phi}\frac{\partial \phi}{\partial y} + \boldsymbol{\kappa}_{23}^{\phi}\frac{\partial \phi}{\partial z} \\
	\boldsymbol{\kappa}_{31}^{\phi}\frac{\partial \phi}{\partial x} + \boldsymbol{\kappa}_{32}^{\phi}\frac{\partial \phi}{\partial y} + \boldsymbol{\kappa}_{33}^{\phi}\frac{\partial \phi}{\partial z}
	\end{bmatrix}_{f}
	\begin{bmatrix}
	S^{x} \\ S^{y} \\ S^{z}
	\end{bmatrix}_{f}
	\\
	& = - \begin{bmatrix}
	\frac{\partial \phi}{\partial x} & \frac{\partial \phi}{\partial y} & \frac{\partial \phi}{\partial z} 
	\end{bmatrix}_{f}
	\begin{bmatrix}
	\boldsymbol{\kappa}_{11}^{\phi} & \boldsymbol{\kappa}_{21}^{\phi} & \boldsymbol{\kappa}_{31}^{\phi} \\
	\boldsymbol{\kappa}_{12}^{\phi} & \boldsymbol{\kappa}_{22}^{\phi} & \boldsymbol{\kappa}_{32}^{\phi} \\
	\boldsymbol{\kappa}_{13}^{\phi} & \boldsymbol{\kappa}_{23}^{\phi} & \boldsymbol{\kappa}_{33}^{\phi}
	\end{bmatrix}_{f}
	\begin{bmatrix}
	S^{x} \\ S^{y} \\ S^{z}
	\end{bmatrix}_{f}
	= -(\nabla \phi)_{f} \cdot \Big[ (\boldsymbol{\kappa}^{\phi})^{T}\cdot \mathbf{S}\Big]_{f}
	= -(\nabla \phi)_{f} \cdot \mathbf{S}_{f}'
	\end{align}

将其代入到原半离散方程中，即可得到

.. math::
	\begin{align}
	\sum_{f\sim nb(C)}(-\nabla\phi)_{f} \cdot \mathbf{S}_{f}' = Q_{C}^{\phi}V_{C}
	\end{align}

显然，上面的形式可以简单地通过将 :math:`\Gamma^{\phi}` 设为 :math:`1` 并将 :math:`\mathbf{S}_{f}` 替换为 :math:`\mathbf{S}_{f}` 得到。这也就意味着同样的代码可以用于求解各向同性和各向异性的问题。



迭代解过程的欠松弛
---------------------

对于一般的扩散问题， :math:`\Gamma^{\phi}` 可能是关于未知因变量 :math:`\phi` 的函数，网格也可能是高度非正交的，具有较大的需要使用延迟修正方法处理的交叉扩散项。因此，在迭代的过程中， :math:`\phi` 的较大变化会会导致较大的源项以及较大的系数变化，这可能会导致迭代求解过程发散。这种发散通常是由于系数和交叉扩散项引入的非线性，使得源项受到尚未收敛的当前解场的高度影响。

为了促进收敛并稳定迭代求解过程，就需要减缓 :math:`\phi` 在迭代过程中的变化，这通过欠松弛(under-relaxation)的技术来实现。引入欠松弛的方法有很多，这里先介绍其中一种。首先考虑一般的离散方程：

.. math::
	\begin{align}
	a_{C}\phi_{C} + \sum_{F\sim NB(C)}a_{F}\phi_{F} = b_{C}
	\end{align}

上式可以改写成

.. math::
	\begin{align}
	\phi_{C} = \frac{-\sum\limits_{F\sim NB(C)}a_{F}\phi_{F} + b_{C}}{a_{C}} 
	\end{align}

将 :math:`\phi_{C}` 在前一次迭代得到的值记作 :math:`\phi_{C}^{*}` 。如果将 :math:`\phi_{C}^{*}` 添加到上式的右侧，则有

.. math::
	\begin{align}
	\phi_{C} = \phi_{C}^{*}
	+ \left ( \frac{-\sum\limits_{F\sim NB(C)}a_{F}\phi_{F} + b_{C}}{a_{C}} - \phi_{C}^{*} \right)
	\end{align}

其中，括号内的表达式表示当前迭代对 :math:`\phi_{C}` 产生的变化量。这个变化量可以通过引入松弛因子 :math:`\lambda^{\phi}` 来修改，即

.. math::
	\begin{align}
	\phi_{C} = \phi_{C}^{*}
	+ \lambda ^{\phi}\left ( \frac{-\sum\limits_{F\sim NB(C)}a_{F}\phi_{F} + b_{C}}{a_{C}} - \phi_{C}^{*} \right)
	\end{align}

将其写回一般离散方程的形式，得到

.. math::
	\begin{align}
	\frac{a_{C}}{\lambda^{\phi}}\phi_{C}
	+ \sum_{F\sim NB(C)}a_{F}\phi_{F}
	= b_{C}
	+ \frac{(1-\lambda^{\phi})a_{C}}{\lambda^{\phi}}\phi_{C}^{\phi}  
	\end{align}


.. note:: 在收敛点上， :math:`\phi_{C}` 和 :math:`\phi_{C}^{*}` 将会相等，与松弛因子的取值无关。并且在收敛点上， :math:`\phi_{C}` 满足原始离散方程。这是所有松弛方法都应当满足的特性。

根据松弛因子的取值，可以将方程分为欠松弛( :math:`0<\lambda^{\phi}<1` )或过松弛( :math:`\lambda^{\phi}>1` )两种。在CFD中通常使用欠松弛方程。当松弛因子接近1时，表明几乎没有松弛操作；当松弛因子接近0时，将会产生非常强的欠松弛效果并使得迭代过程的变化及其缓慢。

.. attention:: 松弛因子的最优选择总是与问题相关的，没有通用的一种规则。影响松弛因子取值的因素包括所解决问题的类型、方程组的大小（计算域网格数量）、网格间距和拓展速率、采用的迭代方法等。通常来说，松弛因子是根据经验或初步计算结果来分配的。此外，没有必要在整个计算域使用相同的欠松弛值，并且在迭代过程中也可以取不同的值。

含松弛算法的离散方程可以简单地从原始离散方程得到，只需要修改对应系数：

.. math::
	\begin{align}
	a_{C} \leftarrow \frac{a_{C}}{\lambda^{\phi}}
	,\quad 
	b_{C} \leftarrow b_{C} + \frac{(1-\lambda^{\phi})a_{C}}{\lambda^{\phi}}\phi_{C}^{*}  
	\end{align}




梯度计算
==========


笛卡尔网格中的梯度计算
-------------------------

对于如图所示的一维问题，使用均一网格离散，假设单元质心之间的变化时线性的，就可以得到在单元面e处的导数表达式：

.. math::
	\begin{align}
	\Big(\frac{\mathrm{d}\phi}{\mathrm{d}x}\Big)_{e}
	= \frac{\phi_{E} - \phi_{C}}{x_{E} - x_{C}}
	= \frac{\phi_{E} - \phi_{C}}{\delta x_{e}}
	\end{align}

类似的，在单元质心C处的导数也可以用相邻单元的值来表示：

.. math::
	\begin{align}
	\Big(\frac{\mathrm{d}\phi}{\mathrm{d}x}\Big)_{C}
	= \frac{\phi_{e} - \phi_{w}}{x_{e} - x_{w}}
	= \frac{\Big(\cfrac{\phi_{E}-\phi_{C}}{2}\Big)-\Big(\cfrac{\phi_{C}+\phi_{W}}{2}\Big)}{\Delta x_{C}}
	= \frac{\phi_{E} - \phi_{W}}{2\Delta x_{C}} 
	\end{align}

上式常被称为一阶导的中心差分估计。

对于多维的笛卡尔网格，导数可以通过应用相同的原理沿各自的坐标方向来计算。例如，考虑如图所示的二维网格，使用上述的中心差分近似，得到x和y方向的偏导数为

.. math::
	\begin{align}
	\Big(\frac{\partial \phi}{\partial x}\Big)_{C}
	= \frac{\phi_{E} - \phi_{W}}{x_{E} - x_{W}}
	,\qquad
	\Big(\frac{\partial \phi}{\partial y}\Big)_{C}
	= \frac{\phi_{N} - \phi_{S}}{x_{N} - x_{S}} 
	\end{align}

对于三维网格，z方向也可以写出类似的式子。但是，在处理非结构化网格的时候，上述方法就不再适用，就需要寻找更加通用的计算梯度的方法。

.. figure:: ../_images/计算流体力学有限体积法/笛卡尔网格中的梯度计算.png
  :align: center




Green-Gauss梯度
-----------------

这是计算梯度最广泛使用的方法之一。前一章已经介绍过，这里不再赘述。相反，我们将给出方程的最终形式，并介绍一些计算面值的附加方法。

如前一章所推导，体积为 :math:`V_{C}` 的单元C质心处的梯度可以如下计算：

.. math::
	\begin{align}
	\nabla \phi_{C} = \frac{1}{V_{C}}\sum_{f\sim nb(C)}\phi_{f}\mathbf{S}_{f} 
	\end{align}

其中 :math:`f` 表示网格面， :math:`\mathbf{S}_{f}` 表示网格面法向量。在使用上述方程之前，还需要确定 :math:`\phi_{f}` 的表示。有两种计算它的路线，一种是基于相邻单元网格面的紧凑模板；另一种是基于相邻单元顶点的更广域的模板，该拓展模板涉及的单元格数量大约是紧凑模板的两倍。对于隐式方法，紧凑模板更加方便，因为它能够得到更紧凑的雅可比矩阵。但是，广域模板为重建带来了更多的信息，因此结果再预期上是更加准确的。



Compact Stencil
^^^^^^^^^^^^^^^^^

对于如图(a)(b)所示的二维和三维网格系统，一个简单的计算 :math:`\phi_{f}` 的方式为使用两个网格单元的平均值。在这个情况下 :math:`\phi_{f}` 可以如下计算：

.. math::
	\begin{align}
	\phi_{f} = g_{C}\phi_{C} + (1-g_{C})\phi_{F}
	\end{align}

其中 :math:`g_{C}` 为几何权重因子，定义为

.. math::
	\begin{align}
	g_{C} = \frac{\| \mathbf{r}_{F} - \mathbf{r}_{f} \|}{\| \mathbf{r}_{F} - \mathbf{r}_{C} \|} = \frac{d_{Ff}}{d_{FC}}  
	\end{align}

其中 :math:`\mathbf{r}` 表示坐标向量， :math:`d` 表示两点之间的距离。当网格面位于两个网格单元的中心时， :math:`\phi_{f}` 就能表示为

.. math::
	\begin{align}
	\phi_{f} = \frac{\phi_{C} + \phi_{F}}{2}
	\end{align}

这种方法在二维和三维情况下很容易实现，所有涉及的操作都是基于网格面的，不需要额外的网格连接。在精度方面，上述关系仅仅在 :math:`\mathbf{CF}` 和网格面 :math:`\mathbf{S}_{f}` 的交点与网格面 :math:`\mathbf{S}_{f}` 的面心重合时，即与高斯积分点 :math:`f` 重合时，才能得到二阶逼近结果。因此，除了上述特殊情况之外，通常无法实现梯度的二阶精确表示。


.. figure:: ../_images/计算流体力学有限体积法/无偏斜度的网格梯度计算.png
  :align: center

一般的结构化非正交网格或非结构化网格通常不满足这种条件，如图(c)(d)所示。网格的偏斜度(skewness)导致 :math:`\mathbf{CF}` 和网格面 :math:`\mathbf{S}_{f}` 相交于点 :math:`f'` ，与网格面质心点 :math:`f` 不同。在这种情况下，需要对插值的 :math:`\phi_{f'}` 进行修正来得到 :math:`\phi_{f}` 。修正方程为

.. math::
	\begin{align}
	\phi_{f} &= \phi_{f'} + \text{correction} \\
	&= \phi_{f'} + (\nabla\phi)_{f'} \cdot (\mathbf{r}_{f} - \mathbf{r}_{f'}) \\
	&= g_{C}\Big( \phi_{C} + (\nabla\phi)_{C} \cdot (\mathbf{r}_{f} - \mathbf{r}_{C}) \Big)
	+ (1 - g_{C}) \Big( \phi_{F} + (\nabla\phi)_{F} \cdot (\mathbf{r}_{f} - \mathbf{r}_{F})\Big) \\
	&= \phi_{f'} + g_{C}(\nabla\phi)_{C} \cdot (\mathbf{r}_{f} - \mathbf{r}_{C})
	+ (1 - g_{C}) (\nabla\phi)_{F} \cdot (\mathbf{r}_{f} - \mathbf{r}_{F})
	\end{align}

由于 :math:`g_{C}` 依赖于 :math:`f'` ，上式表明可以通过迭代来获得梯度的改进估计值。在每次迭代中，使用前一次迭代中计算的梯度结果来计算网格面的平均值，然后使用这些网格面平均值来计算梯度的新估计值。

.. attention:: 进行过多的迭代可能会导致数值振荡，因此通常不会进行两次以上的迭代。

.. figure:: ../_images/计算流体力学有限体积法/存在偏斜度的网格梯度计算.png
  :align: center

在这种情况下，计算 :math:`g_{C}` 需要确定 :math:`\mathbf{CF}` 和网格面  :math:`S_{f}` 的交点 :math:`f'` 的位置。有三种方法可以实现这一目的：

**方法一** ：在这个方法中， :math:`f'` 认为就是 :math:`\mathbf{CF}` 和网格面 :math:`S_{f}` 的交点。引入网格面单位法向量 :math:`\mathbf{n} = \mathbf{S}_{f} / \| \mathbf{S}_{f} \|` ，以及沿CF方向的单位向量 :math:`\mathbf{e} = \mathbf{CF} / \| \mathbf{CF} \|` ， :math:`f'` 点的位置可以利用 :math:`\mathbf{n}` 和线段 :math:`ff'` 的正交性得到，即

.. math::
	\begin{align}
	(\mathbf{r}_{f} - \mathbf{r}_{f'}) \cdot \mathbf{n} = 0
	\end{align}

并且，因为 :math:`f'` 是在CF上的一个点，于是向量 :math:`\mathbf{Cf'}` 可以用 :math:`\mathbf{e}` 来表示：

.. math::
	\begin{align}
	\mathbf{Cf'} = (\mathbf{r}_{f'} - \mathbf{r}_{C}) = k\mathbf{e}
	\end{align}

其中 :math:`k` 是一个标量。联立上面两个式子得到

.. math::
	\begin{align}
	\mathbf{r}_{f'} = \frac{\mathbf{r}_{f} \cdot \mathbf{n}}{\mathbf{e} \cdot \mathbf{n}}\mathbf{e} 
	\end{align}

上式确定出了 :math:`f'` 的位置，于是可以如下计算 :math:`g_{C}` ：

.. math::
	\begin{align}
	g_{C} = \frac{\| \mathbf{r}_{F} - \mathbf{r}_{f'} \|}{\| \mathbf{r}_{F} - \mathbf{r}_{C} \|} = \frac{d_{Ff'}}{d_{FC}} 
	\end{align}

那么，计算过程包括以下步骤：在第一次迭代中，计算整个域的梯度场如下：

1. 计算 :math:`\phi_{f'}` ： :math:`\phi_{f'} = g_{C}\phi_{C} + (1-g_{C})\phi_{F}` ；
2. 计算 :math:`\nabla\phi_{C}` ： :math:`\nabla\phi_{C} = \frac{1}{V_{C}}\sum_{f\sim nb(C)}\phi_{f'}\mathbf{S}_{f}` ；

从第二次迭代开始，按照以下步骤修正梯度场：

3. 更新 :math:`\phi_{f}` ： :math:`\phi_{f} = \phi_{f'} + g_{C}(\nabla\phi)_{C} \cdot (\mathbf{r}_{f} - \mathbf{r}_{C}) + (1 - g_{C})(\nabla\phi)_{F} \cdot (\mathbf{r}_{f} - \mathbf{r}_{F})` ；
4. 更新 :math:`\nabla\phi_{C}` ： :math:`\nabla\phi_{C} = \frac{1}{V_{C}}\sum\limits_{f\sim nb(C)}\phi_{f}\mathbf{S}_{f}` ；
5. 返回步骤3并重复。


**方法二** ：在该方法中将 :math:`f'` 点取为CF的中点，如图所示，这样方程可以得到化简。在整个计算域的梯度计算过程如下：在第一次迭代中，计算整个域的梯度场如下：

1. 计算 :math:`\phi_{f'}` ： :math:`\phi_{f'} = \frac{\phi_{C} - \phi_{F}}{2}` ；
2. 计算 :math:`\nabla\phi_{C}` ： :math:`\nabla\phi_{C} = \frac{1}{V_{C}}\sum_{f\sim nb(C)}\phi_{f'}\mathbf{S}_{f}` ；

从第二次迭代开始，按照以下步骤修正梯度场：

3. 更新 :math:`\phi_{f}` ： :math:`\phi_{f} = \phi_{f'} + 0.5 \times [(\nabla\phi)_{C} + (\nabla\phi)_{F}] \cdot [\mathbf{r}_{f} - 0.5\times (\mathbf{r}_{C} + \mathbf{r}_{F})]` ；
4. 更新 :math:`\nabla\phi_{C}` ： :math:`\nabla\phi_{C} = \frac{1}{V_{C}}\sum\limits_{f\sim nb(C)}\phi_{f}\mathbf{S}_{f}` ；
5. 返回步骤3并重复。


.. figure:: ../_images/计算流体力学有限体积法/取f'为CF的中点.png
  :align: center


**方法三** ：该方法选取的 :math:`f'` 使得 :math:`ff'` 最短，也即 :math:`ff'` 与 :math:`CF` 垂直，如图所示。这能在第一次迭代计算梯度的时候提高精度。在这个情况下， :math:`f'` 通过最小化 :math:`f` 和 :math:`f'` 的距离来计算得到。一般地， :math:`\mathbf{r}_{f'}` 能够如下表示：

.. math::
	\begin{align}
	\mathbf{r}_{f'} = \mathbf{r}_{C} + q(\mathbf{r}_{F} - \mathbf{r}_{C})
	\end{align}

其中 :math:`0<q<1` 。用 :math:`d` 来表示距离 :math:`ff'` ，则其平方可以表示为

.. math::
	\begin{align}
	d^{2} &= (\mathbf{r}_{f} - \mathbf{r}_{f'}) \cdot (\mathbf{r}_{f} - \mathbf{r}_{f'}) \\
	      &= [\mathbf{r}_{f} - \mathbf{r}_{C} - q(\mathbf{r}_{F} - \mathbf{r}_{C})] \cdot [\mathbf{r}_{f} - \mathbf{r}_{C} - q(\mathbf{r}_{F} - \mathbf{r}_{C})] \\
	      &= (\mathbf{r}_{f} - \mathbf{r}_{C}) \cdot (\mathbf{r}_{f} - \mathbf{r}_{C}) - 2q(\mathbf{r}_{f} - \mathbf{r}_{C}) \cdot (\mathbf{r}_{F} - \mathbf{r}_{C}) + q^{2}(\mathbf{r}_{F} - \mathbf{r}_{C}) \cdot (\mathbf{r}_{F} - \mathbf{r}_{C})
	\end{align}

求函数 :math:`d^{2}` 关于 :math:`q` 的最小值，得到

.. math::
	\begin{align}
	\frac{\partial (d^{2})}{\partial q} = 0
	\quad \Rightarrow \quad 
	-2(\mathbf{r}_{f} - \mathbf{r}_{C})\cdot (\mathbf{r}_{F} - \mathbf{r}_{C}) + 2q(\mathbf{r}_{F} - \mathbf{r}_{C}) \cdot (\mathbf{r}_{F} - \mathbf{r}_{C}) = 0 
	\end{align}

求解上式可以得到 :math:`q` 的表达式为

.. math::
	\begin{align}
	q = -\frac{\mathbf{r}_{Cf} \cdot \mathbf{r}_{CF}}{\mathbf{r}_{CF} \cdot \mathbf{r}_{CF}} 
	\end{align}

.. figure:: ../_images/计算流体力学有限体积法/取f'令距离ff'最短.png
  :align: center

在得知了 :math:`q` 的值后，在整个计算域中梯度的计算过程如下：在第一次迭代中，计算整个域的梯度场如下：

1. 计算 :math:`\mathbf{r}_{f'}` ： :math:`\mathbf{r}_{f'} = \mathbf{r}_{C} - \frac{\mathbf{r}_{Cf} \cdot \mathbf{r}_{CF}}{\mathbf{r}_{CF} \cdot \mathbf{r}_{CF}} (\mathbf{r}_{C} - \mathbf{r}_{F})` ；
2. 计算 :math:`g_{C}` ： :math:`g_{C} = \| \mathbf{r}_{F} - \mathbf{r}_{f'} \| / \| \mathbf{r}_{F} - \mathbf{r}_{C} \|` ；
3. 计算 :math:`\phi_{f'}` ： :math:`\phi_{f'} = \frac{\phi_{C} - \phi_{F}}{2}` ；
4. 计算 :math:`\nabla\phi_{C}` ： :math:`\nabla\phi_{C} = \frac{1}{V_{C}}\sum_{f\sim nb(C)}\phi_{f'}\mathbf{S}_{f}` ；

从第二次迭代开始，按照以下步骤修正梯度场：

5. 计算 :math:`\nabla\phi_{f'}` ： :math:`\nabla\phi_{f'} = g_{C}\nabla\phi_{C} + (1 - g_{C})\nabla\phi_{F}`
6. 更新 :math:`\phi_{f}` ： :math:`\phi_{f} = \phi_{f'} + 0.5 \times [(\nabla\phi)_{C} + (\nabla\phi)_{F}] \cdot [\mathbf{r}_{f} - 0.5\times (\mathbf{r}_{C} + \mathbf{r}_{F})]` ；
7. 更新 :math:`\nabla\phi_{C}` ： :math:`\nabla\phi_{C} = \frac{1}{V_{C}}\sum\limits_{f\sim nb(C)}\phi_{f}\mathbf{S}_{f}` ；
8. 返回步骤5并重复。


Extended Stencil
^^^^^^^^^^^^^^^^^^

网格面面心 :math:`f` 处的 :math:`\phi_{f}` 值可以通过网格面顶点处的值的平均来计算。这就需要估计在顶点处的值，而在顶点节点的值可以通过围绕该顶点的网格质心处的值进行加权平均得到，如图所示。权重系数认为是顶点到网格质心距离的倒数，于是在顶点处的值可以表示为

.. math::
	\begin{align}
	\phi_{n} = \frac{\sum\limits_{k=1}^{NB(n)}\cfrac{\phi_{F_{k}}}{\| \mathbf{r}_{n} - \mathbf{r}_{F_{k}} \|}}{\sum\limits_{k=1}^{NB(n)}\cfrac{1}{\| \mathbf{r}_{n} - \mathbf{r}_{F_{k}} \|}} 
	\end{align}

其中 :math:`n` 表示顶点节点， :math:`F_{k}` 表示相邻的网格质心节点， :math:`NB(n)` 表示围绕顶点节点 :math:`n` 的所有网格质心节点， :math:`\| \mathbf{r}_{n} - \mathbf{r}_{F_{k}}` 表示顶点节点到相邻网格质心节点的距离。

.. figure:: ../_images/计算流体力学有限体积法/由临近网格质心值加权平均得到顶点值.png
  :align: center

一旦得到了顶点处的值 :math:`\phi_{n}` ，那么面心上的值 :math:`\phi_{f}` 就可以能够顺利得到。在二维情况下， :math:`\phi_{f}` 的计算方式为

.. math::
	\begin{align}
	\phi_{f} = \frac{\phi_{n_{1}} + \phi_{n_{2}}}{2}
	\end{align}

于是在C处的梯度可以如下计算：

.. math::
	\begin{align}
	\nabla\phi_{C} = \frac{1}{V_{C}}\sum_{f\sim nb(C)}\phi_{f}\mathbf{S}_{f}
	= \frac{1}{V_{C}}\sum_{f\sim nb(C)}\Big( \frac{\phi_{n_{1}} + \phi_{n_{2}}}{2} \Big)_{f} \mathbf{S}_{f}
	\end{align}

在三维情况下，计算要稍微复杂一些，因为面顶点的数量取决于网格面的类型。通过顶点值确定 :math:`\phi_{f}` 的方式为

.. math::
	\begin{align}
	\phi_{f} = \frac{\sum\limits_{k=1}^{nb(f)}\cfrac{\phi_{n_{k}}}{\| \mathbf{r}_{n_{k}} - \mathbf{r}_{f} \|}}{\sum\limits_{k=1}^{nb(f)}\cfrac{1}{\| \mathbf{r}_{n_{k}} - \mathbf{r}_{f} \|}}
	\end{align}

其中 :math:`n` 表示网格面 :math:`f` 的顶点数量。一旦计算出 :math:`\phi_{f}` ，则可以通过下式计算出C处的梯度：

.. math::
	\begin{align}
	\nabla\phi_{C} = \frac{1}{V_{C}}\sum_{f\sim nb(C)}\phi_{f}\mathbf{S}_{f}
	\end{align}


.. note:: 

	这种方法的缺点之一是，来自网格面错误的一侧信息也会参与到变量的加权平均值。虽然这可以通过使用Cabello所讨论的迎风偏梯度来克服，但是基于迎风偏梯度的高阶算法不仅需要更高的内存开销来存储用于迎风偏梯度计算的单元信息，又增加了编码复杂度。


最小二乘法梯度
-----------------

使用最小二乘法来计算梯度在达到的计算精度阶数、所使用的stencil方面具有更大的灵活性。这种灵活性是有代价的，因为它需要对stencil terms进行适当的加权，而加权的计算增加了计算成本。

考虑一个控制体积以及它的相邻网格，在质心C和F之间的变量值可以表示为 :math:`(\phi_{F} - \phi_{C})` ，如果网格单元的梯度 :math:`(\nabla \phi_{C})` 是确定的，那么就有：

.. math::
	\begin{align}
	\phi_{F} = \phi_{C} + (\nabla\phi)_{C} \cdot (\mathbf{r}_{F} - \mathbf{r}_{C})
	\end{align}

但是，除非计算域是线性的，否则网格单元梯度就不能被确定，因为C所具有的相邻单元比梯度向量的分量还要多。在最小二乘法中，梯度通过一个优化过程来确定，这个优化就是找到下面定义的 :math:`G_{C}` 的最小值：

.. math::
	\begin{align}
	G_{C} &= \sum_{k=1}^{NB(C)}\Big( w_{k}\big(\phi_{F_{k}} - (\phi_{C} + \nabla\phi_{C} \cdot \mathbf{r}_{CF_{k}}) \big)^{2} \Big) \\
	      &= \sum_{k=1}^{NB(C)}\left \{ w_{k}\Big[ \Delta\phi_{k} - \Big( \Delta x_{k} (\frac{\partial \phi}{\partial x} )_{C} + \Delta y_{k}(\frac{\partial \phi}{\partial y} )_{C} + \Delta z_{k}(\frac{\partial \phi}{\partial z} )_{C} \Big) \Big]^{2} \right \} 
	\end{align}

其中 :math:`w_{k}` 是权重因子。其他各项的具体含义为：

.. math::
	\begin{align}
	\Delta\phi_{k} = \phi_{F_{k}} - \phi_{C}
	,\quad 
	\Delta x_{k} = \mathbf{r}_{CF_{k}} \cdot \mathbf{i}
	,\quad 
	\Delta y_{k} = \mathbf{r}_{CF_{k}} \cdot \mathbf{j}
	,\quad
	\Delta z_{k} = \mathbf{r}_{CF_{k}} \cdot \mathbf{k}
	\end{align}


函数 :math:`G_{C}` 通过下面这个条件来实现最小化：

.. math::
	\begin{align}
	\frac{\partial G_{C}}{\partial \Big(\cfrac{\partial \phi}{\partial x} \Big)} 
	= \frac{\partial G_{C}}{\partial \Big(\cfrac{\partial \phi}{\partial y} \Big)}
	= \frac{\partial G_{C}}{\partial \Big(\cfrac{\partial \phi}{\partial z} \Big)}
	= 0
	\end{align}

由上式得到含三个未知数的三个方程：

.. math::
	\begin{align}
	& \sum_{k=1}^{NB(C)}\left \{ 2 w_{k}\Delta x_{k} \Big[-\Delta\phi_{k} + \Delta x_{k} (\frac{\partial \phi}{\partial x} )_{C} + \Delta y_{k}(\frac{\partial \phi}{\partial y} )_{C} + \Delta z_{k}(\frac{\partial \phi}{\partial z} )_{C} \Big] \right \} = 0 \\
	& \sum_{k=1}^{NB(C)}\left \{ 2 w_{k}\Delta y_{k} \Big[-\Delta\phi_{k} + \Delta x_{k} (\frac{\partial \phi}{\partial x} )_{C} + \Delta y_{k}(\frac{\partial \phi}{\partial y} )_{C} + \Delta z_{k}(\frac{\partial \phi}{\partial z} )_{C} \Big] \right \} = 0 \\
	& \sum_{k=1}^{NB(C)}\left \{ 2 w_{k}\Delta z_{k} \Big[-\Delta\phi_{k} + \Delta x_{k} (\frac{\partial \phi}{\partial x} )_{C} + \Delta y_{k}(\frac{\partial \phi}{\partial y} )_{C} + \Delta z_{k}(\frac{\partial \phi}{\partial z} )_{C} \Big] \right \} = 0
	\end{align}

上面的方程组可以写成矩阵形式：

.. math::
	\begin{align}
	\begin{bmatrix}
	\sum\limits_{k=1}^{NB(C)}w_{k}\Delta x_{k}\Delta x_{k} & \sum\limits_{k=1}^{NB(C)}w_{k}\Delta x_{k}\Delta y_{k} & \sum\limits_{k=1}^{NB(C)}w_{k}\Delta x_{k}\Delta z_{k} \\
	\sum\limits_{k=1}^{NB(C)}w_{k}\Delta y_{k}\Delta x_{k} & \sum\limits_{k=1}^{NB(C)}w_{k}\Delta y_{k}\Delta y_{k} & \sum\limits_{k=1}^{NB(C)}w_{k}\Delta y_{k}\Delta z_{k} \\
	\sum\limits_{k=1}^{NB(C)}w_{k}\Delta z_{k}\Delta x_{k} & \sum\limits_{k=1}^{NB(C)}w_{k}\Delta z_{k}\Delta y_{k} & \sum\limits_{k=1}^{NB(C)}w_{k}\Delta z_{k}\Delta z_{k}
	\end{bmatrix}
	\begin{bmatrix}
	\Big(\cfrac{\partial \phi}{\partial x} \Big)_{C} \\ \Big(\cfrac{\partial \phi}{\partial y} \Big)_{C} \\ \Big(\cfrac{\partial \phi}{\partial z} \Big)_{C}
	\end{bmatrix}
	=
	\begin{bmatrix}
	\sum\limits_{k=1}^{NB(C)}w_{k}\Delta x_{k}\Delta\phi_{k} \\
	\sum\limits_{k=1}^{NB(C)}w_{k}\Delta y_{k}\Delta\phi_{k} \\
	\sum\limits_{k=1}^{NB(C)}w_{k}\Delta z_{k}\Delta\phi_{k}
	\end{bmatrix}
	\end{align}

上述方程组的解就是所要的梯度 :math:`(\nabla\phi)_{C}` 。一个解存在说明上述方程组左侧的系数矩阵不是奇异的。并且，权重因子 :math:`w_{k}` 的选择将会影响最后计算出的梯度值。例如，如果所有相邻单元的 :math:`w_{k}` 都设置为 :math:`1` ，那么所有相邻单元在计算梯度的时候都会有相同的权重，无论它们距离C有多远。实际上，离C更远的点会有更重要的影响，因为误差函数更容易受到它们的误差的影响。

另一种设置 :math:`w_{k}` 的方式就是使用CF距离的倒数，即

.. math::
	\begin{align}
	w_{k} = \frac{1}{| \mathbf{r}_{F_{k}} - \mathbf{r}_{C} |} = \frac{1}{\sqrt{\Delta x_{F_{x}}^{2} + \Delta y_{F_{k}}^{2} + \Delta z_{F_{k}}^{2}} }
	\end{align}

也可以为上述距离倒数取上 :math:`n` 次幂，即

.. math::
	\begin{align}
	w_{k} = \frac{1}{| \mathbf{r}_{F_{k}} - \mathbf{r}_{C} |^{n}} \qquad (n=1,2,3,\cdots)
	\end{align}



实际上，基于散度的梯度计算方式是最小二乘法的一种特殊情形。这可以通过笛卡尔网格来说明，在这种情况下，最小二乘法所需求解的矩阵化简为

.. math::
	\begin{align}
	\begin{bmatrix}
	x_{E} - x_{W} & 0 & 0 \\
	0 & y_{N} - y_{S} & 0 \\
	0 & 0 & z_{T} - z_{B}
	\end{bmatrix}
	\begin{bmatrix}
	(\partial \phi / \partial x)_{C} \\
	(\partial \phi / \partial y)_{C} \\
	(\partial \phi / \partial z)_{C}
	\end{bmatrix}
	=
	\begin{bmatrix}
	\phi_{E} - \phi_{W} \\
	\phi_{N} - \phi_{S} \\
	\phi_{T} - \phi_{B}
	\end{bmatrix}
	\end{align}


求解上述方程组，于是可以得到

.. math::
	\begin{align}
	\Big(\frac{\partial \phi}{\partial x} \Big)_{C} = \frac{\phi_{E} - \phi_{W}}{x_{E} - x_{W}} 
	,\quad 
	\Big(\frac{\partial \phi}{\partial y} \Big)_{C} = \frac{\phi_{N} - \phi_{S}}{y_{N} - y_{S}}
	,\quad 
	\Big(\frac{\partial \phi}{\partial z} \Big)_{C} = \frac{\phi_{T} - \phi_{B}}{z_{T} - z_{B}}
	\end{align}

上面的结果表明基于散度的梯度是最小二乘法的特殊情形。最后，容易证明计算得到的梯度的精度至少是一阶的。这可以从泰勒展开式中看到：围绕节点C处的值 :math:`\phi` 可以写成

.. math::
	\begin{align}
	\phi(\mathbf{r}) - \phi(\mathbf{r}_{C}) = (\nabla\phi)_{C} \cdot (\mathbf{r} - \mathbf{r}_{C}) + O(\mathbf{r}^{2})
	\end{align}

当求解 :math:`(\nabla\phi)_{C}` 时就有 :math:`O(\mathbf{r})` 。



将梯度插值到网格面
--------------------

前面已经叙述过，在非结构网格中离散扩散项需要添加修正项，而修正项涉及到在网格面上的梯度值。因此，在这种情况下，梯度需要从网格质心处插值到网格面心处。如图所示，网格面上的梯度所涉及到的stencil可以从周围一圈的值等效到只与面相接的stencil。

.. figure:: ../_images/计算流体力学有限体积法/梯度插值到网格面涉及的stencil.png
  :align: center


如图所示，与网格面相接的网格单元C、F质心处的梯度值分别为 :math:`\nabla\phi_{C}` 和 :math:`\nabla\phi_{F}` ，插值到面上的梯度 :math:`\overline{\nabla\phi_{f}}` 可以通过节点C、F处的值平均得到。取与网格面相接的单元作为stencil非常重要，因为这不能简单地通过平均来保证。除了平均之外，还需要迫使插值到面上的梯度在沿CF方向的值与通过节点CF定义的局部梯度相等，所以有

.. math::
	\begin{align}
	\nabla \phi_{f} = \overline{\nabla\phi_{f}} + \Big[ \frac{\phi_{F} - \phi_{C}}{d_{CF}} - (\overline{\nabla\phi_{f}} \cdot \mathbf{e}_{CF}) \Big]\mathbf{e}_{CF}
	\end{align}


其中

.. math::
	\begin{align}
	\overline{\nabla\phi_{f}} = g_{C}\nabla\phi_{C} + g_{F}\nabla\phi_{F}
	,\quad
	\mathbf{e}_{CF} = \frac{\mathbf{d}_{CF}}{d_{CF}}
	,\quad 
	\mathbf{d}_{CF} = \mathbf{r}_{F} - \mathbf{r}_{C} 
	\end{align}


这个方法在结构化或非结构化网格都适用。对于非结构化网格，虽然用于网格面梯度的stencil可能不会减少，但是网格面梯度的计算仍然将基于横跨该网格面的网格节点。

.. figure:: ../_images/计算流体力学有限体积法/插值到网格面上的梯度计算方式.png
  :align: center



对流项的离散化
================


一维稳态对流扩散
-----------------

首先考虑简单的一维稳定对流扩散方程：

.. math::
	\begin{align}
	\frac{\mathrm{d} (\rho u\phi)}{\mathrm{d} x} - \frac{\mathrm{d} }{\mathrm{d} x}\Big( \Gamma^{\phi} \frac{\mathrm{d} \phi}{\mathrm{d} x} \Big) = 0
	\end{align}

该方程具有解析解，因此可以与各种数值结果进行对比。


解析解
^^^^^^^^^

对于一维稳态问题，其连续性方程为

.. math::
	\begin{align}
	\frac{\mathrm{d} (\rho u)}{\mathrm{d} x} = 0 
	\end{align}

上式表明 :math:`\rho u` 是常数。于是，对一维稳定对流扩散方程的x进行积分得到

.. math::
	\begin{align}
	\rho u\phi - \Gamma^{\phi}\frac{\mathrm{d} \phi}{\mathrm{d} x} = c_{1} 
	\end{align}

其中 :math:`c_{1}` 是积分常数，它的值与所使用的边界条件有关。整理上式可以得到

.. math::
	\begin{align}
	\frac{\mathrm{d} \phi}{\mathrm{d} x} = \frac{\rho u}{\Gamma^{\phi}}\phi - \frac{c_{1}}{\Gamma^{\phi}}   
	\end{align}

进行一次变量代换，上式可以改写为

.. math::
	\begin{align}
	\frac{\mathrm{d} \Phi}{\mathrm{d} x} = \frac{\rho u}{\Gamma^{\phi}}\Phi  
	\end{align}

其中

.. math::
	\begin{align}
	\Phi = \frac{\rho u}{\Gamma^{\phi}} \phi - \frac{c_{1}}{\Gamma^{\phi}}  
	\end{align}

分离变量并积分，上式的解为

.. math::
	\begin{align}
	\frac{\mathrm{d} \Phi}{\Phi} = \frac{\rho u}{\Gamma^{\phi}}\mathrm{d}x
	\quad \Rightarrow \quad
	\ln(\Phi) = \frac{\rho u}{\Gamma^{\phi}}x + c_{3}
	\quad \Rightarrow \quad
	\Phi = c_{2}e^{(\rho u/\Gamma^{\phi})x}
	\end{align}

其中 :math:`c_{2}` 为另一个积分常数。将其代换回原变量，得到通解为

.. math::
	\begin{align}
	\phi = \frac{c_{2}\Gamma^{\phi}e^{(\rho u/\Gamma^{\phi})x} + c_{1}}{\rho u} 
	\end{align}

因此，W和E两点之间的解析解如图所示，且满足

.. math::
	\begin{align}
	\frac{\phi - \phi_{W}}{\phi_{E} - \phi_{W}} = \frac{\exp(Pe_{L}\cfrac{x - x_{W}}{L}) - 1}{\exp(Pe_{L}) - 1}  
	\end{align}

其中 :math:`Pe_{L}` 是基于长度 :math:`L` 的Péclet数，它表示对流输运率和扩散输运率的比值，定义为

.. math::
	\begin{align}
	Pe_{L} = \frac{\rho u L}{\Gamma^{\phi}} \qquad(L = x_{E} - x_{W})
	\end{align}

对不同的 :math:`Pe_{L}` 值计算上式，结果如图所示，可以看到，W和E之间的变化从纯扩散问题的线性轮廓变成了高 :math:`Pe_{L}` 数时的阶梯形轮廓。


.. figure:: ../_images/计算流体力学有限体积法/一维稳态对流扩散问题.png
  :align: center



数值解
^^^^^^^^^

对一维稳态对流扩散方程的离散可以从对一维单元积分得到，即

.. math::
	\begin{align}
	\int_{V_{c}}[\nabla \cdot (\rho\mathbf{U}\phi) - \nabla\cdot (\Gamma^{\phi}\nabla\phi)]~\mathrm{d}V = 0 
	\end{align}

其中 :math:`\mathbf{U} = u\mathbf{i}` 是速度矢量。对流方程可以写成对流通量与扩散通量的形式，即

.. math::
	\begin{align}
	\int_{V_{c}}\nabla \cdot (\mathbf{J}^{\phi,C} + \mathbf{J}^{\phi,D})~\mathrm{d}V = 0
	\end{align}

其中 :math:`\mathbf{J}^{\phi,C} = \rho\mathbf{U}\phi` ， :math:`\mathbf{J}^{\phi,D} = -\Gamma^{\phi}\nabla\phi` 。于是，根据散度定理，体积积分可以转换为表面积分，即

.. math::
	\begin{align}
	\int_{V_{c}}\nabla \cdot (\mathbf{J}^{\phi,C} + \mathbf{J}^{\phi,D})~\mathrm{d}V
	= \int_{\partial V_{c}}(\mathbf{J}^{\phi,C} + \mathbf{J}^{\phi,D})\cdot \mathrm{d}\mathbf{S}
	= \int_{\partial V_{c}}\Big[ \rho u\phi\mathbf{i} - \Gamma^{\phi}\frac{\mathrm{d}\phi}{\mathrm{d}x}\mathbf{i} \Big] \cdot \mathrm{d}\mathbf{S}
	= 0
	\end{align}

将表面积分替换为网格表面的通量求和，上式就变成了

.. math::
	\begin{align}
	\sum_{f\sim nb(C)}\Big( \rho u\phi\mathbf{i} - \Gamma^{\phi}\frac{\mathrm{d}\phi}{\mathrm{d}x}\mathbf{i}\Big)_{f} \cdot \mathbf{S}_{f} = 0
	\end{align}

注意到网格表面的速度矢量在单元的不同侧会反号，那么上式对于一个固定截面的情况下可以展开成下面的形式：

.. math::
	\begin{align}
	\Big[ (\rho u\Delta y\phi)_{e} - \Big( \Gamma^{\phi}\frac{\mathrm{d} \phi}{\mathrm{d} x}\Delta y \Big)_{e} \Big]
	- \Big[ (\rho u\Delta y\phi)_{w} - \Big( \Gamma^{\phi}\frac{\mathrm{d} \phi}{\mathrm{d} x}\Delta y \Big)_{w} \Big]
	= 0
	\end{align}

:math:`u` 在网格面上的值是已知的，并且梯度可以用前面叙述的方法进行离散。问题是，如何根据相邻节点的值离散网格面的值 :math:`\phi_{e}` 和 :math:`\phi_{w}` 。用来确定这些网格面上的值的方法称为“对流格式”。



中心差分格式
------------------

一个很直接的想法就是使用与扩散项类似的线性插值方法。因此，在给定网格面上的值 :math:`\phi` 就可以如下计算：

.. math::
	\begin{align}
	\phi(x) = k_{0} + k_{1}(x - x_{C})
	\end{align}

其中 :math:`k_{0}` 和 :math:`k_{1}` 是通过网格面相邻网格节点得到的常数。因此，对于网格面 :math:`e` ，根据 :math:`x=x_{E}` 处满足 :math:`\phi=\phi_{E}` 以及 :math:`x=x_{C}` 处满足 :math:`\phi=\phi_{C}` 的条件，由上式分析 :math:`x=x_{e}` 处的值得到

.. math::
	\begin{align}
	\phi_{e} = \phi_{C} + \frac{\phi_{E} - \phi_{C}}{x_{E} - x_{C}}(x_{e} - x_{C}) 
	\end{align}

这就是基本的中心差分格式，它可以通过泰勒二阶展开式得到，也就意味着它具有二阶精度。对于如图所示的均一网格，上式可以化简为

.. math::
	\begin{align}
	\phi_{e} = \frac{\phi_{C} + \phi_{E}}{2} 
	\end{align}

.. figure:: ../_images/计算流体力学有限体积法/中心差分格式.png
  :align: center


因此，在经过上述的线性方式离散扩散项之后，那么方程第一项就可以写成

.. math::
	\begin{align}
	(\rho u\Delta y\phi)_{e} - \Big( \Gamma^{\phi}\frac{\mathrm{d} \phi}{\mathrm{d} x}\Delta y \Big)_{e}
	= (\rho u\Delta y)_{e}\frac{\phi_{E} + \phi_{C}}{2} - \Big( \Gamma^{\phi}\frac{\Delta y}{\delta x} \Big)_{e} (\phi_{E} - \phi_{C})
	= \text{FluxC}_{e}\phi_{C} + \text{FluxF}_{e}\phi_{E} + \text{FluxV}_{e}
	\end{align}

其中

.. math::
	\begin{align}
	\text{FluxC}_{e} = \Gamma^{\phi}_{e}\frac{\Delta y_{e}}{\delta x_{e}} + \frac{(\rho u\Delta y)_{e}}{2}
	,\quad 
	\text{FluxF}_{e} = -\Gamma^{\phi}_{e}\frac{\Delta y_{e}}{\delta x_{e}} + \frac{(\rho u\Delta y)_{e}}{2}
	,\quad 
	\text{FluxV}_{e} = 0
	\end{align}

类似的，方程的第二项可以写成

.. math::
	\begin{align}
	- \Big[ (\rho u\Delta y\phi)_{w} - \Big( \Gamma^{\phi}\frac{\mathrm{d} \phi}{\mathrm{d} x}\Delta y \Big)_{w} \Big]
	= - \Big[ (\rho u\Delta y)_{w}\frac{\phi_{W} + \phi_{C}}{2} - \Big( \Gamma^{\phi}\frac{\Delta y}{\delta x} \Big)_{w}(\phi_{C} - \phi_{W}) \Big]
	= \text{FluxC}_{w}\phi_{C} + \text{FluxF}_{w}\phi_{W} + \text{FluxV}_{w}
	\end{align}

其中

.. math::
	\begin{align}
	\text{FluxC}_{w} = \Gamma^{\phi}_{w}\frac{\Delta y_{w}}{\delta x_{w}} - \frac{(\rho u\Delta y)_{w}}{2}
	,\quad
	\text{FluxF}_{w} = -\Gamma^{\phi}_{w}\frac{\Delta y_{w}}{\delta x_{w}} - \frac{(\rho u\Delta y)_{w}}{2}
	,\quad 
	\text{FluxV}_{w} = 0
	\end{align}

将上述方程全部代入到对流扩散方程中，得到

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{E}\phi_{E} + a_{W}\phi_{W} = 0
	\end{align}

其中

.. math::
	\begin{align}
	& a_{E} = \text{FluxF}_{e} = -\Gamma^{\phi}_{e}\frac{\Delta y_{e}}{\delta x_{e}} + \frac{(\rho u\Delta y)_{e}}{2} \\
	& a_{W} = \text{FluxF}_{w} = -\Gamma^{\phi}_{w}\frac{\Delta y_{w}}{\delta x_{w}} - \frac{(\rho u\Delta y)_{w}}{2} \\
	& a_{C} = \text{FluxC}_{e} + \text{FluxC}_{w} = \Big( \frac{(\rho u\Delta y)_{e}}{2} + \Gamma^{\phi}_{e}\frac{\Delta y_{e}}{\delta x_{e}} \Big) + \Big( -\frac{(\rho u\Delta y)_{w}}{2} + \Gamma^{\phi}_{w}\frac{\Delta y_{w}}{\delta x_{w}}\Big)
	\end{align}

在这个一维问题中 :math:`\Delta y_{e} = \Delta y_{w}` ，并且不失一般性地可以设为 :math:`1` 。同时，根据连续性方程可知 :math:`(\rho u\Delta y)_{e} - (\rho u\Delta y)_{w} = 0` 。假设扩散系数是均一的，那么上面的离散方程系数就可以简化为

.. math::
	\begin{align}
	& a_{E} = - \frac{\Gamma^{\phi}}{x_{E} - x_{C}} + \frac{(\rho u)_{e}}{2} \\
	& a_{W} = - \frac{\Gamma^{\phi}}{x_{C} - x_{W}} - \frac{(\rho u)_{w}}{2} \\
	& a_{C} = - (a_{E} + a_{W})
	\end{align}

将上述系数代入到离散方程当中，那么 :math:`\phi_{C}` 的值满足

.. math::
	\begin{align}
	\frac{\phi_{C} - \phi_{W}}{\phi_{E} - \phi_{W}} = \frac{a_{E}}{a_{E} + a_{W}}
	\end{align}


如果网格是均一的，那么上述方程可以写成关于 :math:`Pe_{L}` 的形式：

.. math::
	\begin{align}
	\frac{\phi_{C} - \phi_{W}}{\phi_{E} - \phi_{W}} = \frac{1}{2}\Big(1 - \frac{Pe_{L}}{2}\Big)
	\end{align}

其中 :math:`L` 是 :math:`(x_{E} - x_{W})` ，也就是两个单元的大小。

这个问题的解析解可以通过令 :math:`(x-x_{W})/L=0.5` 得到：

.. math::
	\begin{align}
	\frac{\phi_{C} - \phi_{W}}{\phi_{E} - \phi_{W}} = \frac{e^{Pe_{L}/2} - 1}{e^{Pe_{L}}-1}
	\end{align}

如图所示，中心差分数值解与解析解在 :math:`Pe_{L}` 值较低的时候非常接近，但是当 :math:`Pe_{L}` 增大到一定值之后，中心差分格式的数值解就与解析解的结果有相当的差距而变得非物理。


.. figure:: ../_images/计算流体力学有限体积法/中心差分数值解与解析解的对比.png
  :align: center


这个非物理现象意味着中心差分格式在推导的时候存在非物理的假设。如图所示，C点的扩散过程对C点上游和下游条件的影响相同，而对流过程是一个高度定向的过程，仅仅在流动方向上传递特性。因此，对迎风和顺风节点赋予相同的权重的线性近似，在扩散项处理中是非常好的；但是，它不能描述处对流的方向偏好，对于对流项，阶跃方法更加合适，这就是原因所在。


因此，只要扩散过程是主要的传递机制，使用线性方法就能够得到符合物理的结果。但是，一旦对流过程压倒扩散过程，仍使用线性方法就会得到非物理结果。容易计算出发生这种情况的Péclet数的值——假设流动为x正方向，当系数 :math:`a_{E}` 为正的时候就会导致非物理结果（如果流动为x负方向则考虑 :math:`a_{W}` ）：

.. math::
	\begin{align}
	- \Gamma^{\phi}_{e} \frac{\Delta y_{e}}{\delta x_{e}} + \frac{(\rho u\Delta y)_{e}}{2} > 0 
	\quad \Rightarrow \quad
	\frac{(\rho u)_{e}\delta x_{e}}{\Gamma^{\phi}_{e}} > 2 
	\end{align}

定义网格的Péclet数为 :math:`Pe = \frac{\rho u\delta x}{\Gamma^{\phi}}` ，其中对于均一网格来说就等于 :math:`Pe_{L}` 的一般，于是上述条件就可以改写成

.. math::
	\begin{align}
	Pe > 2
	\end{align}

因此，对于网格Péclet数大于 :math:`2` 的情况，离散化过程变得不再一致，因为现在相邻值的增加C处值的减小，而这反过来又将导致相邻值进一步增大，并且误差被放大。这个问题可以通过减小网格的大小来是单元Péclet数小于 :math:`2` 来避免，然而对于许多实际情况，存储和计算需求的增加可能太大而无法承担。此外，对于纯对流流动（如欧拉流），则是根本不可行的，所以需要其他措施。




中心差分格式的截断误差在有限体积法中比较复杂，因为梯度的计算需要再网格表面插值而不是在网格中心节点插值。假设速度在各处都是已知的，网格是均一的且大小为 :math:`\Delta x` ，那么中心差分近似就是对 :math:`(\phi_{e} - \phi_{w})` 计算的近似，可以写成

.. math::
	\begin{align}
	\underbrace{(\phi_{e} - \phi_{w})}_{\text{Interpolated}}
	= \frac{1}{2}(\phi_{E} + \phi_{C})
	  - \frac{1}{2}(\phi_{C} + \phi_{W})
	=  \underbrace{(\phi_{e} - \phi_{w})}_{\text{Exact}} + TE
	\end{align}

其中 :math:`TE` 表示截断误差。为了计算该截断误差，就需要下面的泰勒展开：

.. math::
	\begin{align}
	& \phi_{W} = \phi_{w}
	  - \frac{\Delta x}{2}\phi_{w}'
	  + \frac{\Delta x^{2}}{8}\phi_{w}''
	  - \frac{\Delta x^{3}}{48}\phi_{w}'''
	  + \frac{\Delta x^{4}}{384}\phi_{w}^{iv}
	  - \frac{\Delta x^{5}}{3840}\phi_{w}^{v}
	  + \cdots
	\\
	& \phi_{C} = \phi_{w}
	  + \frac{\Delta x}{2}\phi_{w}'
	  + \frac{\Delta x^{2}}{8}\phi_{w}''
	  + \frac{\Delta x^{3}}{48}\phi_{w}'''
	  + \frac{\Delta x^{4}}{384}\phi_{w}^{iv}
	  + \frac{\Delta x^{5}}{3840}\phi_{w}^{v}
	  + \cdots
	\\
	& \phi_{C} = \phi_{e}
	  - \frac{\Delta x}{2}\phi_{e}'
	  + \frac{\Delta x^{2}}{8}\phi_{e}''
	  - \frac{\Delta x^{3}}{48}\phi_{e}'''
	  + \frac{\Delta x^{4}}{384}\phi_{e}^{iv}
	  - \frac{\Delta x^{5}}{3840}\phi_{e}^{v}
	  + \cdots
	\\
	& \phi_{E} = \phi_{e}
	  + \frac{\Delta x}{2}\phi_{e}'
	  + \frac{\Delta x^{2}}{8}\phi_{e}''
	  + \frac{\Delta x^{3}}{48}\phi_{e}'''
	  + \frac{\Delta x^{4}}{384}\phi_{e}^{iv}
	  + \frac{\Delta x^{5}}{3840}\phi_{e}^{v}
	  + \cdots
	\end{align}

使用上述展开式，在面上的均值可以如下得到：

.. math::
	\begin{align}
	& \frac{1}{2}(\phi_{E} + \phi_{C})
	= \phi_{e} + \frac{\Delta x^{2}}{8}\phi_{e}'' + \frac{\Delta x^{4}}{384}\phi_{e}^{iv} + \cdots
	\quad\Rightarrow\quad
	\frac{\Delta x^{2}}{4}\phi_{e}''
	= (\phi_{C} - 2\phi_{e} + \phi_{E}) - \frac{\Delta x^{4}}{192}\phi_{e}^{iv} + \cdots
	\\
	& \frac{1}{2}(\phi_{C} + \phi_{W})
	= \phi_{w} + \frac{\Delta x^{2}}{8}\phi_{w}'' + \frac{\Delta x^{4}}{384}\phi_{w}^{iv} + \cdots
	\quad\Rightarrow\quad
	\frac{\Delta x^{2}}{4}\phi_{w}'' = (\phi_{W} - 2\phi_{w} + \phi_{C}) - \frac{\Delta x^{4}}{192}\phi_{w}^{iv} + \cdots
	\end{align}

上面两个式子相减就得到

.. math::
	\begin{align}
	\frac{1}{2}(\phi_{E} + \phi_{C})
	- \frac{1}{2}(\phi_{C} + \phi_{W})
	= (\phi_{e} - \phi_{w})
	+ \frac{\Delta x^{2}}{8}(\phi_{e}'' - \phi_{w}'')
	+ \frac{\Delta x^{4}}{384}(\phi_{e}^{iv} - \phi_{w}^{iv})
	+ \cdots
	\end{align}

更进一步的， :math:`\phi_{e}` 和 :math:`\phi_{w}` 对 :math:`\phi_{C}` 的泰勒展开则分别为

.. math::
	\begin{align}
	& \phi_{e} = \phi_{C}
	  + \frac{\Delta x}{2}\phi_{C}'
	  + \frac{\Delta x^{2}}{8}\phi_{C}''
	  + \frac{\Delta x^{3}}{48}\phi_{C}'''
	  + \frac{\Delta x^{4}}{384}\phi_{C}^{iv}
	  + \frac{\Delta x^{5}}{3840}\phi_{C}^{v}
	  + \cdots
	\\
	& \phi_{w} = \phi_{C}
	  - \frac{\Delta x}{2}\phi_{C}'
	  + \frac{\Delta x^{2}}{8}\phi_{C}''
	  - \frac{\Delta x^{3}}{48}\phi_{C}'''
	  + \frac{\Delta x^{4}}{384}\phi_{C}^{iv}
	  - \frac{\Delta x^{5}}{3840}\phi_{C}^{v}
	  + \cdots
	\end{align}

另外， :math:`\phi_{E}` 和 :math:`\phi_{W}` 也可以展开成 :math:`\phi_{C}` 的序列：

.. math::
	\begin{align}
	& \phi_{E} = \phi_{C}
	  + \Delta x\phi_{C}'
	  + \frac{\Delta x^{2}}{2}\phi_{C}''
	  + \frac{\Delta x^{3}}{6}\phi_{C}'''
	  + \frac{\Delta x^{4}}{24}\phi_{C}^{iv}
	  + \frac{\Delta x^{5}}{120}\phi_{C}^{v}
	  + \cdots
	\\
	& \phi_{W} = \phi_{C}
	  - \Delta x \phi_{C}'
	  + \frac{\Delta x^{2}}{2}\phi_{C}''
	  - \frac{\Delta x^{3}}{6}\phi_{C}'''
	  + \frac{\Delta x^{4}}{24}\phi_{C}^{iv}
	  - \frac{\Delta x^{5}}{120}\phi_{C}^{v}
	  + \cdots
	\end{align}

使用上述两组方程可以得到

.. math::
	\begin{align}
	\phi_{C} - 2\phi_{e} + \phi_{E}
	&= \phi_{C} - 2\phi_{C} - \Delta x \phi_{C}'
	  - \frac{\Delta x^{2}}{4}\phi_{C}'' - \frac{\Delta x^{3}}{24}\phi_{C}'''
	  - \frac{\Delta x^{4}}{192}\phi_{C}^{iv} - \frac{\Delta x^{5}}{1920}\phi_{C}^{v} + \cdots
	\\
	& \quad + \phi_{C} + \Delta x \phi_{C}'
	  + \frac{\Delta x^{2}}{2}\phi_{C}'' + \frac{\Delta x^{3}}{6}\phi_{C}'''
	  + \frac{\Delta x^{4}}{24}\phi_{C}^{iv} + \frac{\Delta x^{5}}{120}\phi_{C}^{v} + \cdots
	\\
	&= \frac{\Delta x^{2}}{4}\phi_{C}'' + \frac{\Delta x^{3}}{8}\phi_{C}'''
	  + \frac{7 \Delta x^{4}}{192}\phi_{C}^{iv} + \frac{15\Delta x^{5}}{1920}\phi_{C}^{v} + \cdots
	\end{align}

.. math::
	\begin{align}
	\phi_{W} - 2\phi_{w} + \phi_{C}
	= \frac{\Delta x^{2}}{4}\phi_{C}''
	  - \frac{\Delta x^{3}}{8}\phi_{C}'''
	  + \frac{7\Delta x^{4}}{192}\phi_{C}^{iv}
	  - \frac{15\Delta x^{5}}{1920}\phi_{C}^{v}
	  + \cdots
	\end{align}


于是可以得到 :math:`(\phi_{e}'' - \phi_{w}'')` 的表达式：

.. math::
	\begin{align}
	\frac{\Delta x^{2}}{8}(\phi_{e}'' - \phi_{w}'')
	= \frac{\Delta x^{3}}{8}\phi_{C}'''
	  + \frac{\Delta x^{5}}{128}\phi_{C}^{v}
	  + \cdots
	\end{align}

代入回作差方程就将其转换为

.. math::
	\begin{align}
	\frac{1}{2}(\phi_{E} + \phi_{C})
	- \frac{1}{2}(\phi_{C} + \phi_{W})
	= \phi_{e} - \phi_{w}
	  + \frac{\Delta x^{3}}{8}\phi_{C}'''
	  + \frac{\Delta x^{5}}{128}\phi_{C}^{v}
	  + \cdots
	\end{align}

通过除以 :math:`\Delta x` 即可得到与梯度计算有关的截断误差为

.. math::
	\begin{align}
	TE = \frac{\Delta x^{2}}{8}\phi_{C}''' + \frac{\Delta x^{4}}{128}\phi_{C}^{v} + \cdots
	\end{align}

这表明中心差分格式具有二阶精度。






一阶迎风格式
------------------

线性对称方法给两个节点提供了相同的权重，在网格面上没有方向偏重，这适用于无方向性现象的椭圆型项（如扩散项），但对于对流项来说是不合适的。一种更适合对流过程的格式是迎风格式(upwind scheme)。如图所示，迎风格式基本上模拟了对流过程的基本物理过程，因为网格表面值依赖于迎风节点值，即依赖于流动方向。在这个情况下，网格面上的值如下得到：

.. math::
	\begin{align}
	\phi_{e} = \left\{\begin{array}{ll}\phi_{C} \quad \text{if}~\dot{m}_{e}>0 \\ \phi_{E} \quad \text{if}~\dot{m}_{e}<0 \end{array}\right.
	,\quad 
	\phi_{w} = \left\{\begin{array}{ll}\phi_{C} \quad \text{if}~\dot{m}_{e}>0 \\ \phi_{W} \quad \text{if}~\dot{m}_{e}<0 \end{array}\right.
	\end{align}

其中 :math:`\dot{m}_{e}` 和 :math:`\dot{m}_{w}` 分别是在网格面 :math:`e` 和 :math:`w` 的质量通量：

.. math::
	\begin{align}
	& \dot{m}_{e} = (\rho\mathbf{U}\cdot \mathbf{S})_{e} = (\rho uS)_{e} = (\rho u \Delta y)_{e} \\
	& \dot{m}_{w} = (\rho\mathbf{U}\cdot \mathbf{S})_{w} = -(\rho uS)_{w} = -(\rho u\Delta y)_{w}
	\end{align}

.. figure:: ../_images/计算流体力学有限体积法/一阶迎风格式.png
  :align: center



因此，在网格面 :math:`e` 的对流通量可以写成

.. math::
	\begin{align}
	\dot{m}_{e}\phi_{e} = \max(\dot{m}_{e}, 0)\phi_{C} - \max(-\dot{m}_{e}, 0)\phi_{E}
	= \text{FluxC}_{e}^{Conv}\phi_{C} + \text{FluxF}_{e}^{Conv}\phi_{E} + \text{FluxV}_{e}^{Conv}
	\end{align}

其中

.. math::
	\begin{align}
	\text{FluxC}_{e}^{Conv} = \max(\dot{m}_{e}, 0) 
	,\quad 
	\text{FluxF}_{e}^{Conv} = -\max(-\dot{m}_{e}, 0)
	,\quad 
	\text{FluxV}_{e}^{Conv} = 0
	\end{align}


类似地，可以得到在网格面 :math:`w` 的对流通量可以写成

.. math::
	\begin{align}
	\dot{m}_{w}\phi_{w} = \max(\dot{m}_{w}, 0)\phi_{C} - \max(-\dot{m}_{w}, 0)\phi_{W}
	= \text{FluxC}_{w}^{Conv}\phi_{C} + \text{FluxF}_{w}^{Conv}\phi_{W} + \text{FluxV}_{w}^{Conv}
	\end{align}

其中

.. math::
	\begin{align}
	\text{FluxC}_{w}^{Conv} = \max(\dot{m}_{w}, 0)
	,\quad 
	\text{FluxF}_{w}^{Conv} = -\max(-\dot{m}_{w}, 0)
	,\quad
	\text{FluxV}_{w}^{Conv} = 0
	\end{align}

同时考虑扩散通量的贡献（以上标Diff表示），将它们全部代入离散方程当中得到

.. math::
	\begin{align}
	(\text{FluxC}_{e}^{Conv} + \text{FluxC}_{e}^{Diff} + \text{FluxC}_{w}^{Conv} + \text{FluxC}_{w}^{Diff})\phi_{C}
	+ (\text{FluxF}_{e}^{Conv} + \text{FluxF}_{e}^{Diff})\phi_{E}
	+ (\text{FluxF}_{w}^{Conv} + \text{FluxF}_{w}^{Diff})\phi_{W}
	= 0
	\end{align}

上式可以整合为下面的形式：

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{E}\phi_{E} + a_{W}\phi_{W} = 0
	\end{align}

其中

.. math::
	\begin{align}
	& a_{E} = \text{FluxF}_{e}^{Conv} + \text{FluxF}_{e}^{Diff} = -\max(-\dot{m}_{e}, 0) - \Gamma^{\phi}_{e}\frac{S_{e}}{\delta x_{e}} \\
	& a_{W} = \text{FluxF}_{w}^{Conv} + \text{FluxF}_{w}^{Diff} = -\max(-\dot{m}_{w}, 0) - \Gamma^{\phi}_{w}\frac{S_{w}}{\delta x_{w}} \\
	& a_{C} = \sum_{f}\Big( \text{FluxC}_{f}^{Conv} + \text{FluxC}_{f}^{Diff} \Big)
	= \max(\dot{m}_{e}, 0) + \max(\dot{m}_{w}, 0) + \Gamma^{\phi}_{e}\frac{S_{e}}{\delta x_{e}} + \Gamma^{\phi}_{w}\frac{S_{w}}{\delta x_{w}}
	= - (a_{E} + a_{W}) + (\dot{m}_{e} + \dot{m}_{w}) \\
	& b_{C} = - \sum_{f} \Big( \text{FluxV}_{f}^{Conv} + \text{FluxV}_{f}^{Diff} \Big) = 0
	\end{align}

容易发现，迎风格式能够得到负的相邻单元系数，并且根据连续性方程，可以得到主要节点的系数满足

.. math::
	\begin{align}
	a_{C} = -(a_{W} + a_{E})
	\end{align}

这就保证了有界条件。将连续性约束代入到系数表达式，并考虑均一网格、扩散系数为常数，那么

.. math::
	\begin{align}
	\frac{\phi_{C} - \phi_{W}}{\phi_{E} - \phi_{W}}
	= \frac{2 + \max(-Pe_{L}, 0)}{4 + \max(-Pe_{L}, 0) + \max(Pe_{L}, 0)}
	= \frac{2 + \max(-Pe_{L}, 0)}{4 + |Pe_{L}|} 
	\end{align}


如图所示，在 :math:`Pe_{L}` 值较低的时候，迎风格式没有中心差分格式那么精确，这也是可以理解的，因为迎风格式只有一阶精度而线性格式有二阶精度。当 :math:`Pe_{L}` 值较高时，中心差分格式不再稳定，因为它的解无界且非物理；而迎风格式虽然不是很精确，但物理趋势是正确的。因此，准确性和稳定性之间存在一种权衡。使用迎风格式能在较高Péclet数的情况下仍有良好的表现与有界性，但是这是牺牲精度来实现的。另一方面，二阶中心差分格式在超过一定Péclet数后变得不稳定，从而导致物理上错误的解。

.. figure:: ../_images/计算流体力学有限体积法/迎风格式与解析解的对比.png
  :align: center


下面分析迎风格式的截断误差问题。考虑由迎风格式得到的离散方程，为了恢复积分方程以考虑截断误差，就要将 :math:`\phi_{C}` 和 :math:`\phi_{W}` 分别写成 :math:`\phi_{e}` 和 :math:`\phi_{w}` 的方程。这里假设流动朝 :math:`x` 的正方向。在迎风格式中则有

.. math::
	\begin{align}
	\phi_{e} = \phi_{C},
	\qquad
	\phi_{w} = \phi_{W}
	\end{align}

因此，使用迎风格式的一维对流扩散离散方程化简为

.. math::
	\begin{align}
	(\rho u\Delta y)_{e}\phi_{C}
	- (\rho u\Delta y)_{w}\phi_{W}
	- \Big[ 
	  \Big( \Gamma^{\phi}\frac{\mathrm{d}\phi}{\mathrm{d}x}\Delta y \Big)_{e}
	  - \Big( \Gamma^{\phi}\frac{\mathrm{d}\phi}{\mathrm{d}x}\Delta y \Big)_{w}
	  \Big]
	= 0
	\end{align}

:math:`\phi_{C}` 在网格面 :math:`e` 处的一维泰勒展开为

.. math::
	\begin{align}
	\phi_{C} = \phi_{e}
	+ \Big(\frac{\mathrm{d} \phi}{\mathrm{d} x}\Big)_{e}(x_{C} - x_{e})
	+ \frac{1}{2}\Big(\frac{\mathrm{d}^{2} \phi}{\mathrm{d} x^{2}}\Big)_{e} (x_{C} - x_{e})^{2}
	+ \cdots
	= \phi_{e} - \Big(\frac{\mathrm{d} \phi}{\mathrm{d} x}\Big)_{e}(x_{e} - x_{C}) + \cdots
	\end{align}

对于均匀网格则变成

.. math::
	\begin{align}
	\phi_{C} = \phi_{e}
	- \Big(\frac{\mathrm{d} \phi}{\mathrm{d} x}\Big)_{e}\frac{(\delta x)_{e}}{2}
	+ \frac{1}{2}\Big(\frac{\mathrm{d}^{2}\phi}{\mathrm{d}x^{2}} \Big)_{e} \Big(\frac{(\delta x)_{e}}{2} \Big)^{2}
	\cdots
	\end{align}

:math:`\phi_{W}` 也可以得到类似的表达式：

.. math::
	\begin{align}
	\phi_{W} = \phi_{w} - \Big(\frac{\mathrm{d} \phi}{\mathrm{d} x}\Big)_{w}\frac{(\delta x)_{w}}{2} + \frac{1}{2}\Big(\frac{\mathrm{d}^{2}\phi}{\mathrm{d} x^{2}} \Big)_{w}\Big(\frac{(\delta x)_{w}}{2}\Big)^{2} \cdots
	\end{align}

忽略二阶及以上的项，然后代入到对流项当中，那么离散方程等号左侧就变成了

.. math::
	\begin{align}
	(\rho u\Delta y)_{e}\phi_{C}
	- (\rho u\Delta y)_{w}\phi_{W}
	- \Big[ 
	  \Big( \Gamma^{\phi}\frac{\mathrm{d}\phi}{\mathrm{d}x}\Delta y \Big)_{e}
	  - \Big( \Gamma^{\phi}\frac{\mathrm{d}\phi}{\mathrm{d}x}\Delta y \Big)_{w}
	  \Big]
	=
	(\rho u \Delta y)_{e} \Big[ \phi_{e} - \Big(\frac{\mathrm{d} \phi}{\mathrm{d} x} \Big)_{e} \frac{\delta x_{e}}{2} \Big]
	- (\rho u \Delta y)_{w} \Big[ \phi_{w} - \Big(\frac{\mathrm{d} \phi}{\mathrm{d} x} \Big)_{w}\frac{\delta x_{w}}{2} \Big]
	- \Big[ \Big( \Gamma^{\phi}\frac{\mathrm{d} \phi}{\mathrm{d} x}\Delta y \Big)_{e} - \Big(\Gamma^{\phi}\frac{\mathrm{d} \phi}{\mathrm{d} x} \Delta y\Big)_{w} \Big]
	\end{align}

整理后可以得到

.. math::
	\begin{align}
	(\rho u\Delta y)_{e}\phi_{C}
	- (\rho u\Delta y)_{w}\phi_{W}
	- \Big[ 
	  \Big( \Gamma^{\phi}\frac{\mathrm{d}\phi}{\mathrm{d}x}\Delta y \Big)_{e}
	  - \Big( \Gamma^{\phi}\frac{\mathrm{d}\phi}{\mathrm{d}x}\Delta y \Big)_{w}
	  \Big]
	=
	(\rho u \Delta y)_{e} \phi_{e}
	- (\rho u \Delta y)_{w} \phi_{w}
	- \bigg[ 
	  \Big( \Gamma^{\phi} + \rho u\frac{\delta x}{2} \Big)_{e} \Big( \frac{\mathrm{d} \phi}{\mathrm{d} x}\Delta y \Big)_{e}
	  - \Big( \Gamma^{\phi} + \rho u \frac{\delta x}{2} \Big)_{w} \Big( \frac{\mathrm{d} \phi}{\mathrm{d} x} \Delta y\Big)_{w}
	  \bigg]
	\end{align}

显然可以看到所求解的方程中额外产生了一个扩散分量，这被称为截断误差。该数值扩散的值为

.. math::
	\begin{align}
	\Gamma^{\phi}_{\text{truncation}} = \rho u \frac{\delta x}{2}
	\end{align}

该截断误差也称顺流扩散(stream wise diffusion)，由于修改了扩散系数的大小导致求解的精度降低。因此，对流和扩散方程额外产生扩散效应。另一方面，这个顺流扩散也是需要的，因为它能够使求解保持有界以保证物理正确性。

显然，要想减小顺流数值扩散就需要使用更高阶的对对流项的估计，这需要用某种方式保持解的有界性。




顺风格式
-------------

顺风格式(downwind scheme)是与迎风格式完全相反的格式，节点值由交界面下游处的值提供，因此在面 :math:`e` 和 :math:`w` 处的值如下进行计算：

.. math::
	\begin{align}
	\phi_{e} = \left \{\begin{array}{ll}
	\phi_{E} \quad \text{if}~\dot{m}_{e} > 0 \\
	\phi_{C} \quad \text{if}~\dot{m}_{e} < 0  
	\end{array}\right .
	\qquad
	\phi_{w} = \left \{\begin{array}{ll}
	\phi_{W} \quad \text{if}~\dot{m}_{e} > 0 \\
	\phi_{C} \quad \text{if}~\dot{m}_{e} < 0  
	\end{array}\right .
	\end{align}

根据上式，在网格面上的对流通量可以写成

.. math::
	\begin{align}
	& \dot{m}_{e}\phi_{e}
	= - \| -\dot{m}_{e} , 0 \| \phi_{C}
	  + \| \dot{m}_{e} , 0 \| \phi_{E}
	= \text{FluxC}_{e}^{Conv}\phi_{C}
	  + \text{FluxF}_{e}^{Conv}\phi_{E}
	  + \text{FluxV}_{e}^{Conv}
	\\
	& \dot{m}_{w}\phi_{w}
	= - \| -\dot{m}_{w},0 \|
	  + \| \dot{m}_{w} ,0 \| \phi_{W}
	= \text{FluxC}_{w}^{Conv}\phi_{C}
	  + \text{FluxF}_{w}^{Conv}\phi_{W}
	  + \text{FluxF}_{w}^{Conv}      
	\end{align}

将上式代入到离散方程当中，得到

.. math::
	\begin{align}
	( \text{FluxC}_{e}^{Conv}
	  + \text{FluxC}_{e}^{Diff}
	  + \text{FluxC}_{w}^{Conv}
	  + \text{FluxC}_{w}^{Diff}    
	) \phi_{C}
	+ (\text{FluxF}_{e}^{Conv} + \text{FluxF}_{e}^{Diff}) \phi_{E}
	+ (\text{FluxF}_{w}^{Conv} + \text{FluxF}_{w}^{Diff}) \phi_{W}
	= 0
	\end{align}

该方程可以简写成如下形式：

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{E}\phi_{E} + a_{W}\phi_{W} = 0
	\end{align}

其中

.. math::
	\begin{align}
	& a_{E}
	  = \text{FluxF}_{e}^{Conv} + \text{FluxF}_{e}^{Diff}
	  = \| \dot{m}_{e} ,0 \| - \Gamma_{e}^{\phi}\frac{S_{e}}{\delta x_{e}}
	\\
	& a_{W}
	  = \text{FluxF}_{w}^{Conv} + \text{FluxF}_{w}^{Diff}
	  = \| \dot{m}_{w} ,0 \| - \Gamma_{w}^{\phi}\frac{S_{w}}{\delta x_{w}}
	\\
	& a_{C}
	  = \sum_{f}\Big( \text{FluxC}_{f}^{Conv} + \text{FluxC}_{f}^{Diff} \Big)
	  = - \| -\dot{m}_{e} ,0 \| + \Gamma_{e}^{\phi}\frac{S_{e}}{\delta x_{e}} - \| -\dot{m}_{w} ,0 \| + \Gamma_{w}^{\phi}\frac{S_{w}}{\delta x_{w}}
	  = - (a_{E} + a_{W}) + (\dot{m}_{e} + \dot{m}_{w})
	\\
	& b_{C}
	  = - \sum_{f} \Big( \text{FluxV}_{f}^{Conv} + \text{FluxV}_{f}^{Diff} \Big) = 0
	\end{align}

调用上式的连续性约束，并假设网格是均一的、扩散系数为常数，那么就有

.. math::
	\begin{align}
	\frac{\phi_{C} - \phi_{W}}{\phi_{E} - \phi_{W}}
	= \frac{2 - \| Pe_{L} ,0 \|}{4 - \| -Pe_{L} ,0 \| - \| Pe_{L} ,0 \|}
	= \frac{2 - \| Pe_{L} ,0 \|}{4 - |Pe_{L}|}   
	\end{align}

可以看到，当 :math:`|Pe_{L}| \to 4` ，解就会变得完全不有界。顺风格式在与其他格式混合之后可能有利于捕捉间断界面。


接下来考虑顺风格式的截断误差。与迎风格式的分析过程类似，要将 :math:`\phi_{C}` 和 :math:`\phi_{W}` 写成关于 :math:`\phi_{e}` 和 :math:`\phi_{w}` 的函数。这里假设流动是沿着 :math:`x` 轴正方向的，那么在顺风格式下有

.. math::
	\begin{align}
	\phi_{e} = \phi_{E},
	\qquad
	\phi_{w} = \phi_{C}
	\end{align}

于是离散方程为

.. math::
	\begin{align}
	(\rho u \Delta y)_{e} \phi_{E}
	- (\rho u \Delta y)_{w} \phi_{C}
	- \bigg[
	  \Big( \Gamma^{\phi} \frac{\mathrm{d} \phi}{\mathrm{d} x} \Delta y \Big)_{e}
	  - \Big( \Gamma^{\phi} \frac{\mathrm{d} \phi}{\mathrm{d} x} \Delta y \Big)_{w}
	  \bigg]
	= 0
	\end{align}

对于均匀网格， :math:`\phi_{E}` 和 :math:`\phi_{C}` 分别在面 :math:`e` 和 :math:`w` 处的一维泰勒展开式分别为

.. math::
	\begin{align}
	& \phi_{E}
	= \phi_{e}
	  + \Big(\frac{\mathrm{d} \phi}{\mathrm{d} x}\Big)_{e} \frac{(\delta x)_{e}}{2}
	  + \frac{1}{2} \Big( \frac{\mathrm{d}^{2} \phi}{\mathrm{d} x^{2}} \Big)_{e} \Big( \frac{(\delta x)_{e}}{2} \Big)^{2}
	  + \cdots
	\\
	& \phi_{C}
	= \phi_{w}
	  + \Big( \frac{\mathrm{d} \phi}{\mathrm{d} x} \Big)_{w} \frac{(\delta x)_{w}}{2}
	  + \frac{1}{2} \Big( \frac{\mathrm{d}^{2} \phi}{\mathrm{d} x^{2}} \Big)_{w} \Big( \frac{(\delta x)_{w}}{2} \Big)^{2}
	  + \cdots
	\end{align}

忽略二阶及以上的项并将其代入到对流项，那么离散方程等号左侧就变成了

.. math::
	\begin{align}
	(\rho u \Delta y)_{e} \phi_{E}
	- (\rho u \Delta y)_{w} \phi_{C}
	- \bigg[
	  \Big( \Gamma^{\phi} \frac{\mathrm{d} \phi}{\mathrm{d} x} \Delta y \Big)_{e}
	  - \Big( \Gamma^{\phi} \frac{\mathrm{d} \phi}{\mathrm{d} x} \Delta y \Big)_{w}
	  \bigg]
	=
	(\rho u \Delta y)_{e} \phi_{e}
	- (\rho u \Delta y)_{w} \phi_{w}
	- \bigg[
	  \Big( \Gamma^{\phi} - \rho u \frac{\delta x}{2} \Big)_{e} \Big( \frac{\mathrm{d} \phi}{\mathrm{d} x} \Delta y \Big)_{e}
	  - \Big( \Gamma^{\phi} - \rho u \frac{\delta x}{2} \Big)_{w} \Big( \frac{\mathrm{d} \phi}{\mathrm{d} x} \Delta y \Big)_{w}
	  \bigg]
	\end{align}

可以看到，在该格式中数值扩散有一个负号，其值为

.. math::
	\begin{align}
	\Gamma^{\phi}_{\text{truncation}} = - \rho u \frac{\delta x}{2}
	\end{align}

它使扩散系数变小，呈现出反扩散效应。研究发现，使用顺风格式的预测会引起平流廓线的剪切。事实上，用这种格式生成的一维对流扩散问题的解比中心差分格式更具振荡性。









二阶迎风格式
-------------------

之前的讨论表明，一阶迎风格式和中心差分格式都有严重的局限性。一阶迎风格式由于数值扩散问题而导致精度较差，中心差分格式则由于其不稳定性(也称为数值弥散误差)而严重受限。这些缺点引起了人们对利用高阶迎风偏置插值剖面来提高对流格式精度和稳定性的大量研究。这些高阶格式旨在产生至少二阶的精确解，同时是无条件稳定的。

为了强调将通量与网格面关联而不是与网格体心关联的守恒性质，接下来使用 :math:`D` 表示Downwind、用 :math:`C` 表示Upwind、用 :math:`U` 表示far Upwind对应的网格面中心节点。另外， :math:`DD` 和 :math:`UU` 分别表示 :math:`D` 和 :math:`U` 的下游和上游网格面。对这些位置对应的通量值分别表示为 :math:`\phi_{DD},\phi_{D},\phi_{C},\phi_{U},\phi_{UU}` ，如图所示，对于速度方向分别为正或负情况会有所不同。


.. figure:: ../_images/计算流体力学有限体积法/用于描述对流格式的UU,U,C,D,DD节点位置的示意图.png
  :align: center

二阶迎风格式(second order upwind)需要使用线性轮廓(linear profile)，就像中心差分格式那样，但是并不是使用对称的轮廓，而使用向迎风方向偏移的模板(upwind biased stencil)。如图所示，线性剖面是利用网格面 :math:`C` 和 :math:`U` 上的值来构造的，因此网格面上的值实际上是通过外推而不是插值来计算的。

.. figure:: ../_images/计算流体力学有限体积法/二阶迎风格式轮廓.png
  :align: center

使用位于网格面中心处 :math:`x_{C}` 和 :math:`x_{U}` 的值 :math:`\phi_{C}` 和 :math:`\phi_{U}` 来构建线性轮廓则为

.. math::
	\begin{align}
	\phi(x) = \phi_{C} + \frac{\phi_{C} - \phi_{U}}{x_{C} - x_{U}}(x - x_{C})
	\end{align}

使用上式，在图中所示的面 :math:`f` 处的值 :math:`\phi` 可以如下得到

.. math::
	\begin{align}
	\phi_{f} = \phi(x_{f}) = \phi_{C} + \frac{\phi_{C} - \phi_{U}}{x_{C} - x_{U}}(x_{f} - x_{C}) 
	\end{align}

对于均匀网格则化简为

.. math::
	\begin{align}
	\phi_{f} = \frac{3}{2}\phi_{C} - \frac{1}{2}\phi_{U}
	\end{align}

使用上述剖面近似离散的一维对流扩散方程中的界面值，得到各网格面处的通量为

.. math::
	\begin{align}
	& \dot{m}_{e}\phi_{e} = 
	\Big(\frac{3}{2}\phi_{C} - \frac{1}{2}\phi_{W}\Big) \max(\dot{m}_{e},0)
	- \Big(\frac{3}{2}\phi_{E} - \frac{1}{2}\phi_{EE} \Big) \max(-\dot{m}_{e} ,0) \\
	& \dot{m}_{w}\phi_{w} = 
	\Big(\frac{3}{2}\phi_{C} - \frac{1}{2}\phi_{E} \Big) \max(\dot{m}_{w} ,0)
	- \Big(\frac{3}{2}\phi_{W} - \frac{1}{2}\phi_{WW} \Big) \max(-\dot{m}_{w} ,0)
	\end{align}


将上述通量代入到离散方程得到

.. math::
	\begin{align}
	\Big(\frac{3}{2}\phi_{C} - \frac{1}{2}\phi_{W}\Big) \max(\dot{m}_{e},0)
	- \Big(\frac{3}{2}\phi_{E} - \frac{1}{2}\phi_{EE} \Big) \max(-\dot{m}_{e} ,0)
	+ \Big(\frac{3}{2}\phi_{C} - \frac{1}{2}\phi_{E} \Big) \max(\dot{m}_{w} ,0)
	- \Big(\frac{3}{2}\phi_{W} - \frac{1}{2}\phi_{WW} \Big) \max(-\dot{m}_{w} ,0)
	- \bigg[
	  \Big(\Gamma^{\phi}\frac{S}{\delta x}\Big)_{e} (\phi_{E} - \phi_{C})
	  - \Big(\Gamma^{\phi}\frac{S}{\delta x}\Big)_{w} (\phi_{C} - \phi_{W})
	  \bigg]
	= 0
	\end{align}

该离散方程可以整理改写为

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{E}\phi_{E} + a_{W}\phi_{W} + a_{EE}\phi_{EE} + a_{WW}\phi_{WW} = 0
	\end{align}

其中

.. math::
	\begin{align}
	& a_{E} = \text{FluxF}_{e} = 
	    - \Gamma_{e}^{\phi}\frac{S_{e}}{\delta x_{e}}
	    - \frac{3}{2}\max(-\dot{m}_{e} ,0)
	    - \frac{1}{2} \max(\dot{m}_{w} ,0)
	\\
	& a_{W} = \text{FluxF}_{w} = 
	    - \Gamma_{w}^{\phi}\frac{S_{w}}{\delta x_{w}}
	    - \frac{3}{2}\max(-\dot{m}_{w},0)
	    - \frac{1}{2}\max(\dot{m}_{e},0)
	\\
	& a_{EE} = \text{FluxF}_{ee} = \frac{1}{2}\max(-\dot{m}_{e},0) \\
	& a_{WW} = \text{FluxF}_{ww} = \frac{1}{2}\max(-\dot{m}_{w},0) \\
	& a_{C} = \sum_{f\sim nb(C)}\text{FluxC}_{f} = 
	    \Gamma_{e}^{\phi}\frac{S_{e}}{\delta x_{e}}
	    + \Gamma_{w}^{\phi}\frac{S_{w}}{\delta x_{w}}
	    + \frac{3}{2}\max(\dot{m}_{e} , 0)
	    + \frac{3}{2}\max(\dot{m}_{w} , 0)
	    = - (a_{E} + a_{W} + a_{EE} + a_{WW}) + (\dot{m}_{e} + \dot{m}_{w})
	\end{align}


仿照与中心差分格式类似的分析过程，可以得到二阶迎风格式的截断误差为

.. math::
	\begin{align}
	TE = - \frac{3}{8}\Delta x^{2}\phi_{C}''' - \frac{1}{4}\Delta x^{3}\phi_{C}^{iv} + \cdots
	\end{align}

上式表明格式确实具有二阶精度。

接下来分析二阶迎风格式的稳定性。离散的对流通量为

.. math::
	\begin{align}
	RHS_{convection} = 
	- \Big(\frac{3}{2}\phi_{C} - \frac{1}{2}\phi_{W} \Big) \max(\dot{m}_{e} ,0)
	+ \Big(\frac{3}{2}\phi_{E} - \frac{1}{2}\phi_{EE} \Big) \max(-\dot{m}_{e},0)
	- \Big(\frac{3}{2}\phi_{C} - \frac{1}{2}\phi_{E} \Big) \max(\dot{m}_{w} ,0)
	+ \Big(\frac{3}{2}\phi_{W} - \frac{1}{2}\phi_{WW} \Big) \max(-\dot{m}_{w} ,0)
	\end{align}

其对 :math:`\phi_{C}` 的变化率为

.. math::
	\begin{align}
	\frac{\partial (RHS_{convection})}{\partial \phi_{C}} = - \frac{3}{2} \max(\dot{m}_{e} ,0) - \frac{3}{2}\max(\dot{m}_{w} ,0)
	\end{align}

它总是负的，说明二阶迎风格式是一个稳定的格式，即解的误差总能够保持控制。

.. attention:: 这里所说的误差总能控制只适用于推导中所述的条件，而不适用于速度不恒定的一般情况。





QUICK格式
---------------

二次上游插值对流运动学格式(The Quadratic Upstream Interpolation for Convective Kinematics, QUICK)由Leonard提出，该格式利用偏上游的二次多项式插值元素各面因变量的值，如图所示，插值得到的值用于计算因变量控制方程中的对流项。

.. figure:: ../_images/计算流体力学有限体积法/QUICK格式轮廓.png
  :align: center

在其原始形式中，QUICK格式需要使用一般的多维二次多项式来计算未知变量 :math:`\phi` 。然而，一般来说都会将流动视为局部一维，并在每个坐标方向上使用二阶一维剖面就足够了。对于所讨论的一维对流扩散问题， :math:`\phi` 的值通过二次多项式

.. math::
	\begin{align}
	\phi = k_{0} + k_{1}x + k_{2}x^{2}
	\end{align}

来计算，其中要求

.. math::
	\begin{align}
	\phi = \left\{ \begin{array}{ll} 
	\phi_{U} , \quad x = x_{U} \\
	\phi_{C} , \quad x = x_{C} \\
	\phi_{D} , \quad x = x_{D}
	\end{array} \right.
	\end{align}

代入上述要求，可以展开得到 :math:`\phi` 具体的计算方式：

.. math::
	\begin{align}
	\phi = \phi_{U}
	+ \frac{(x - x_{U})(x - x_{C})}{(x_{D} - x_{U})(x_{D} - x_{c})} (\phi_{D} - \phi_{U})
	+ \frac{(x - x_{U})(x - x_{D})}{(x_{C} - x_{U})(x_{C} - x_{D})} (\phi_{C} - \phi_{U})
	\end{align}

对于均匀网格，在网格面 :math:`f` 处的值的计算可以化简为

.. math::
	\begin{align}
	\phi_{f} = \frac{\phi_{C} + \phi_{D}}{2} - \frac{\phi_{D} - 2\phi_{C} + \phi_{U}}{8}
	\end{align}

于是，在网格单元面上的对流通量可以如下计算：

.. math::
	\begin{align}
	& \dot{m}_{e}\phi_{e} = \Big( \frac{3}{4}\phi_{C} - \frac{1}{8}\phi_{W} + \frac{3}{8}\phi_{E} \Big) \| \dot{m}_{e},0\|
	    - \Big( \frac{3}{4}\phi_{E} - \frac{1}{8}\phi_{EE} + \frac{3}{8}\phi_{C} \Big) \| -\dot{m}_{e} ,0\| \\
	& \dot{m}_{w}\phi_{w} = \Big( \frac{3}{4}\phi_{C} - \frac{1}{8}\phi_{E} + \frac{3}{8}\phi_{W} \Big) \| \dot{m}_{w} ,0 \|
	    - \Big( \frac{3}{4}\phi_{W} - \frac{1}{8}\phi_{WW} + \frac{3}{8}\phi_{C} \Big) \| -\dot{m}_{w} ,0\|
	\end{align}

将它代入到一维对流扩散方程，其离散形式变成

.. math::
	\begin{align}
	& \Big( \frac{3}{4}\phi_{C} - \frac{1}{8}\phi_{W} + \frac{3}{8}\phi_{E} \Big) \| \dot{m}_{e},0\|
	  - \Big( \frac{3}{4}\phi_{E} - \frac{1}{8}\phi_{EE} + \frac{3}{8}\phi_{C} \Big) \| -\dot{m}_{e} ,0\|
	\\
	& + \Big( \frac{3}{4}\phi_{C} - \frac{1}{8}\phi_{E} + \frac{3}{8}\phi_{W} \Big) \| \dot{m}_{w} ,0 \|
	    - \Big( \frac{3}{4}\phi_{W} - \frac{1}{8}\phi_{WW} + \frac{3}{8}\phi_{C} \Big) \| -\dot{m}_{w} ,0\|
	\\
	& \bigg[
	  \Big(\Gamma^{\phi}\frac{S}{\delta x}\Big)_{e} (\phi_{E} - \phi_{C})
	  - \Big( \Gamma^{\phi}\frac{S}{\delta x} \Big)_{w} (\phi_{C} - \phi_{W})
	  \bigg]
	= 0
	\end{align}

该方程可以整理改写为如下形式：

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{E}\phi_{E} + a_{W}\phi_{W} + a_{EE}\phi_{EE} + a_{WW}\phi_{WW} = 0
	\end{align}

其中各系数的表达式为

.. math::
	\begin{align}
	& a_{E} = \text{FluxF}_{e} = - \Gamma^{\phi}_{e}\frac{S_{e}}{\delta x_{e}} - \frac{3}{4}\| -\dot{m}_{e} ,0\| + \frac{3}{8}\| \dot{m}_{e},0 \| - \frac{1}{8}\| \dot{m}_{w},0 \| \\
	& a_{W} = \text{FluxF}_{w} = - \Gamma^{\phi}_{w}\frac{S_{w}}{\delta x_{w}} - \frac{3}{4}\| -\dot{m}_{w},0 \| + \frac{3}{8} \| \dot{m}_{w},0 \| - \frac{1}{8} \| \dot{m}_{e},0 \| \\
	& a_{EE} = \text{FluxF}_{ee} = \frac{1}{8} \| -\dot{m}_{e},0 \| \\
	& a_{WW} = \text{FluxF}_{ww} = \frac{1}{8} \| -\dot{m}_{w},0 \| \\
	& a_{C} = \sum_{f \sim nb(C)}\text{FluxC}_{f}
	= \Gamma^{\phi}_{e} \frac{S_{e}}{\delta x_{e}} + \Gamma^{\phi}_{w}\frac{S_{w}}{\delta x_{w}}
	  + \frac{3}{4} \| \dot{m}_{e},0 \| - \frac{3}{8} \| -\dot{m}_{e},0 \| + \frac{3}{4} \| \dot{m}_{w} ,0 \| - \frac{3}{8} \| -\dot{m}_{w},0 \|
	= -(a_{E} + a_{W} + a_{WW} + a_{EE}) + (\dot{m}_{e} + \dot{m}_{w})
	\end{align}



利用之前讨论过的分析过程，可以分析出QUICK格式的截断误差为

.. math::
	\begin{align}
	TE = \frac{1}{16}\Delta x^{3} \phi_{C}^{iv} - \frac{3}{128}\Delta x^{4}\phi_{C}^{v} + \cdots
	\end{align}

上式表明QUICK格式具有三阶精度。

接下来分析QUICK格式的稳定性。根据离散的对流通量，可以得到

.. math::
	\begin{align}
	RHS_{\text{convection}} &=
	- \Big( \frac{3}{4}\phi_{C} - \frac{1}{8}\phi_{W} + \frac{3}{8}\phi_{E} \Big) \| \dot{m}_{e},0\|
	+ \Big( \frac{3}{4}\phi_{E} - \frac{1}{8}\phi_{EE} + \frac{3}{8}\phi_{C} \Big) \| -\dot{m}_{e} ,0\| \\
	&\quad - \Big( \frac{3}{4}\phi_{C} - \frac{1}{8}\phi_{E} + \frac{3}{8}\phi_{W} \Big) \| \dot{m}_{w} ,0 \|
	+ \Big( \frac{3}{4}\phi_{W} - \frac{1}{8}\phi_{WW} + \frac{3}{8}\phi_{C} \Big) \| -\dot{m}_{w} ,0\|
	\end{align}

于是对流项敏感性为

.. math::
	\begin{align}
	\frac{\partial (RHS_{\text{convection}})}{\partial \phi_{C}} = 
	- \frac{3}{8} \| \dot{m}_{e},0 \| - \frac{3}{8} \| \dot{m}_{w},0 \| - \frac{3}{8}(\dot{m}_{e} + \dot{m}_{w}) 
	\end{align}

对于均一的流速它总是为负的，所以是一个稳定的格式。但是它并不能保证解的有界性，尤其对于一般情况下的非均一流速。




FROMM格式
---------------

FROMM格式通过目标网格面的迎风节点与顺风节点构建线性轮廓，如图所示，插值并不是对称轮廓而是迎风偏向的，并要求 :math:`\phi_{U},\phi_{C},\phi_{D}` 是共线的。

首先基于顺风 :math:`x_{D}` 处的 :math:`\phi_{D}` 以及远迎风 :math:`x_{U}` 处的 :math:`\phi_{U}` 构建线性格式：

.. math::
	\begin{align}
	\phi(x) = \phi_{U} + \frac{\phi_{D} - \phi_{U}}{x_{D} - x_{U}}(x - x_{U})
	\end{align}

根据该方程，在迎风 :math:`C` 节点处的值可以如下得到：

.. math::
	\begin{align}
	\phi_{C} = \phi_{U} + \frac{\phi_{D} - \phi_{U}}{x_{D} - x_{U}}(x_{C} - x_{U})
	\end{align}

对于均匀网格的情况，上述方程简化为

.. math::
	\begin{align}
	\phi_{C} = \frac{\phi_{D} + \phi_{U}}{2}
	\end{align}

那么所需面 :math:`f` 处的值则为

.. math::
	\begin{align}
	\phi_{f} = \phi(x_{f})
	= \phi_{U} + \frac{\phi_{D} - \phi_{U}}{x_{D} - x_{U}}(x_{f} - x_{U})
	= \phi_{C} + \frac{x_{f} - x_{C}}{x_{D} - x_{U}}(\phi_{D} - \phi_{U})
	\end{align}

对于均匀网格的情况，上述方程简化为

.. math::
	\begin{align}
	\phi_{f} = \phi_{C} + \frac{\phi_{D} - \phi_{U}}{4}
	\end{align}

使用该格式来估计离散一维对流扩散方程的网格面处的值，网格面处的通量为

.. math::
	\begin{align}
	& \dot{m}_{e}\phi_{e} = 
	\Big( \phi_{C} - \frac{1}{4}\phi_{W} + \frac{1}{4}\phi_{E} \Big) \| \dot{m}_{e},0 \|
	- \Big( \phi_{E} - \frac{1}{4}\phi_{EE} + \frac{1}{4}\phi_{C} \Big) \| -\dot{m}_{e},0 \|
	\\
	& \dot{m}_{w}\phi_{w} = 
	\Big( \phi_{C} - \frac{1}{4}\phi_{E} + \frac{1}{4}\phi_{W} \Big) \| \dot{m}_{w},0 \|
	- \Big( \phi_{W} - \frac{1}{4}\phi_{WW} + \frac{1}{4}\phi_{C} \Big) \| -\dot{m}_{w},0 \|
	\end{align}

将它们代入到离散方程中，则方程变为

.. math::
	\begin{align}
	& \Big( \phi_{C} - \frac{1}{4}\phi_{W} + \frac{1}{4}\phi_{E} \Big) \| \dot{m}_{e},0 \|
	- \Big( \phi_{E} - \frac{1}{4}\phi_{EE} + \frac{1}{4}\phi_{C} \Big) \| -\dot{m}_{e},0 \|
	\\
	& + \Big( \phi_{C} - \frac{1}{4}\phi_{E} + \frac{1}{4}\phi_{W} \Big) \| \dot{m}_{w},0 \|
	- \Big( \phi_{W} - \frac{1}{4}\phi_{WW} + \frac{1}{4}\phi_{C} \Big) \| -\dot{m}_{w},0 \|
	\\
	& \bigg[
	  \Big( \Gamma^{\phi}\frac{S}{\delta x} \Big)_{e} (\phi_{E} - \phi_{C})
	  - \Big( \Gamma^{\phi}\frac{S}{\delta x} \Big)_{w} (\phi_{C} - \phi_{W})
	  \bigg]
	= 0
	\end{align}

该方程可以整理改写为如下形式：

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{E}\phi_{E} + a_{W}\phi_{W} + a_{EE}\phi_{EE} + a_{WW}\phi_{WW} = 0
	\end{align}

其中

.. math::
	\begin{align}
	& a_{E} = \text{FluxF}_{e} = -\Gamma^{\phi}_{e}\frac{S_{e}}{\delta x_{e}} + \frac{1}{4} \| \dot{m}_{e},0 \| - \| -\dot{m}_{e},0 \| - \frac{1}{4} \| \dot{m}_{w},0 \| \\
	& a_{W} = \text{FluxF}_{w} = -\Gamma^{\phi}_{w}\frac{S_{w}}{\delta x_{w}} + \frac{1}{4} \| \dot{m}_{w},0 \| - \| -\dot{m}_{w},0 \| - \frac{1}{4} \| \dot{m}_{e},0 \| \\
	& a_{EE} = \text{FluxF}_{ee} = \frac{1}{4} \| -\dot{m}_{e},0 \| \\
	& a_{WW} = \text{FluxF}_{ww} = \frac{1}{4} \| -\dot{m}_{w},0 \| \\
	& a_{C} = \sum_{f\sim nb(C)}\text{FluxC}_{f}
	= \Gamma^{\phi}_{e}\frac{S_{e}}{\delta x_{e}} + \Gamma^{\phi}_{w}\frac{S_{w}}{\delta x_{w}} + \| \dot{m}_{e},0 \| - \frac{1}{4} \| -\dot{m}_{e},0 \| + \| \dot{m}_{w},0 \| - \frac{1}{4} \| -\dot{m}_{w},0 \|
	= -(a_{E} + a_{W} + a_{EE} + a_{WW}) + (\dot{m}_{e} + \dot{m}_{w})
	\end{align}


根据中心差分格式中讨论的分析方法，FROMM格式的截断误差可以发现满足

.. math::
	\begin{align}
	TE = O(\Delta x^{2})
	\end{align}

表明FROMM格式具有二阶精度。

现在考虑FROMM格式的稳定性。根据对流通量的离散形式，可以得到

.. math::
	\begin{align}
	RHS_{\text{convection}} &= 
	- \Big( \phi_{C} - \frac{1}{4}\phi_{W} + \frac{1}{4}\phi_{E} \Big) \| \dot{m}_{e},0 \|
	+ \Big( \phi_{E} - \frac{1}{4}\phi_{EE} + \frac{1}{4}\phi_{C} \Big) \| -\dot{m}_{e},0 \|
	\\
	&\quad - \Big( \phi_{C} - \frac{1}{4}\phi_{E} + \frac{1}{4}\phi_{W} \Big) \| \dot{m}_{w},0 \|
	+ \Big( \phi_{W} - \frac{1}{4}\phi_{WW} + \frac{1}{4}\phi_{C} \Big) \| -\dot{m}_{w},0 \|
	\end{align}

从而可知对流项敏感性为

.. math::
	\begin{align}
	\frac{\partial (RHS_{\text{convection}})}{\partial \phi_{C}} = 
	-\frac{3}{4}\| \dot{m}_{e},0 \| - \frac{3}{4} \| \dot{m}_{w},0 \| - \frac{1}{4}(\dot{m}_{e} + \dot{m}_{w})   
	\end{align}

这表明，对于恒定速度场，其对流敏感性总是负的，说明该格式是稳定的。但是对于一般的情况，速度场会变化，则并不能确保绝对稳定。






Flux Vector Splitting Methods
--------------------------------

abcdefg







数值稳定性
-------------

与截断误差相关的混乱(物理解的一阶和非物理解的二阶)导致许多工作者推断，既然扩散项的中心差分是如此准确，那么对流项的中心差分也应该同样准确。当然，正如前面几节所看到的，对流项的中心差异可以导致非物理解。造成这种现象的原因是，当应用于像对流项这样的奇阶导数时，中心差分格式没有固有的对流稳定性。

Leonard提出了对流稳定性的概念，以解释由中心差分格式应用于对流为主的流动所产生的数值解中的振荡。Leonard使用了一般的一维非定常对流扩散方程来描述这个概念：

.. math::
	\begin{align}
	\frac{\partial (\rho \phi)}{\partial t}
	= - \frac{\partial (\rho u\phi)}{\partial x}
	+ \frac{\partial }{\partial x}\Big( \Gamma^{\phi}\frac{\partial \phi}{\partial x} \Big)
	+ Q^{\phi}
	\end{align}

将该方程应用于如图所示的网格中心 :math:`C` 上，方程的左侧表示控制单元单位时间内 :math:`\phi_{C}` 的变化率，方程的右侧表示网格单元表面的净流入和单元内影响 :math:`\phi_{C}` 值的源项。如果方程右侧存在数值误差，则根据离散化过程中使用的格式的不同，由该方程计算出来的 :math:`\phi_{C}` 值将增加或减小。

在不稳定的格式中，与 :math:`\phi_{C}` 正确值的微小偏差使得方程右侧表示的净流入相应增加或减少。当求解过程中进行迭代时，净流入的增加/减少都将进一步增加/减少迭代过程后续每个步骤中的 :math:`\phi_{C}` 。在一个稳定的格式中，由于方程右侧的错误导致的 :math:`\phi_{C}` 变化应该作为一个自修正反馈到方程右侧。显然，对于这种数值稳定性，方程右侧(RHS)应该满足

.. math::
	\begin{align}
	\frac{\partial (RHS)}{\partial \phi_{C}} < 0 
	\end{align}

上式表明方程右侧的组合对 :math:`\phi_{C}` 变化的反应为负。这种情况下， :math:`\phi_{C}` 的增加/减少将对应于流入的减少/增加，这反过来又将 :math:`\phi_{C}` 向下/向上推至正确的值。然而，稳定性不应该与有界性或者准确性相混淆。一个稳定的数值格式实际上可能是无界的，从而导致过度/不足(over/under shoots)和振荡/摆动(oscillations/wiggles)，或者扩散性非常强从而给出精度非常低的结果。这里的稳定性指的是控制数值误差保持有界，使得其不会像中心差分格式那样无限增加，也就是让其在 :math:`Pe` 在 :math:`-\infty` 到 :math:`\infty` 变化时 :math:`\phi_{C}` 的归一化值不会同样在 :math:`-\infty` 到 :math:`\infty` 之间变化，而是在 :math:`1` 到 :math:`0` 之间变化。迎风格式恰好同时具有有界性和稳定性特征。


现在考虑方程右侧的一般离散形式：

.. math::
	\begin{align}
	RHS = -(\rho u \Delta y)_{e}\phi_{e}
	+ (\rho u \Delta y)_{w}\phi_{w}
	+ \bigg[
	  \Big(\Gamma^{\phi}\frac{\Delta y}{\delta x}\Big)_{e} (\phi_{E} - \phi_{C})
	  - \Big(\Gamma^{\phi}\frac{\Delta y}{\delta x}\Big)_{w} (\phi_{C} - \phi_{W})
	  \bigg]
	+ Q_{C}^{\phi}V_{C}
	\end{align}

当使用中心差分格式时，上式变成

.. math::
	\begin{align}
	RHS_{CD} = -(\rho u \Delta y)_{e}\frac{\phi_{E} + \phi_{C}}{2} 
	+ (\rho u \Delta y)_{w}\frac{\phi_{C} + \phi_{W}}{2} 
	+ \bigg[
	  \Big(\Gamma^{\phi}\frac{\Delta y}{\delta x}\Big)_{e} (\phi_{E} - \phi_{C})
	  - \Big(\Gamma^{\phi}\frac{\Delta y}{\delta x}\Big)_{w} (\phi_{C} - \phi_{W})
	  \bigg]
	+ Q_{C}^{\phi}V_{C}
	\end{align}

根据之前所述的标准来分析中心差分格式，可以发现扩散项的敏感性(sensitivity)为

.. math::
	\begin{align}
	\frac{\partial (RHS_{CD}^{Diff})}{\partial \phi_{C}}
	= - 2\Gamma^{\phi}\frac{\Delta y}{\delta x}
	\end{align}

由于 :math:`\Gamma^{\phi}` 是正的，所以扩散项敏感性是负的，表明对于扩散性来说这是一个稳定的格式。但是对流项的敏感性为

.. math::
	\begin{align}
	\frac{\partial (RHS_{CD}^{Conv})}{\partial \phi_{C}}
	= -\frac{1}{2}(\dot{m}_{e} + \dot{m}_{w})
	\end{align}

对于恒定流来说则敏感性为零，但是对非恒定流来说则并不一定为零，比如对于减速流来说它的值将会是正的。在一般的流动中，这样的区域就像一个摆动源(wiggle sources)并且在Péclet数非常大的时候非常容易导致数值突变。即使对于稳定流动，由于它的值为零，它也不能反馈到方程中进行自我修正。同时，上式还表明对于恒定流动，使用中心差分格式计算的净对流通量与 :math:`\phi_{C}` 无关。因此，如图所示，不同可能得 :math:`\phi_{C}` 值将导致网格节点C上的净对流通量相同。


.. figure:: ../_images/计算流体力学有限体积法/中心差分格式对phic值的不敏感性.png
  :align: center


而使用迎风格式的时候，一般离散方程的右侧项则为

.. math::
	\begin{align}
	RHS_{\text{upwind}} = 
	- \max(\dot{m}_{e} , 0) \phi_{C}
	+ \max(-\dot{m}_{e} , 0) \phi_{E}
	- \max(\dot{m}_{w} , 0) \phi_{C}
	+ \max(-\dot{m}_{w} , 0) \phi_{W}
	+ \Big( \Gamma^{\phi}\frac{S}{\delta x} \Big)_{e} (\phi_{E} - \phi_{C})
	- \Big( \Gamma^{\phi}\frac{S}{\delta x} \Big)_{w} (\phi_{C} - \phi_{W})
	+ Q_{C}^{\phi}
	\end{align}

其对对流项的敏感性对所有流动为负或者零，因此该格式对所有Péclet数都是稳定的：

.. math::
	\begin{align}
	\frac{\partial (RHS_{\text{upwind}}^{Conv})}{\partial \phi_{C}}
	= - \max( \dot{m}_{e} , 0) - \max( \dot{m}_{w} , 0)
	\end{align}

当两个质量流量都为负的时候，敏感性将为零，这种情况不会出现在一维横截面积不变的情况。当考虑上一阶近似引入的假扩散时，上式表明该格式非常稳定。但是正如之前讨论的那样，这种稳定性是以牺牲准确性为代价的。


对于顺风格式，一般离散方程的右侧项则为

.. math::
	\begin{align}
	RHS_{\text{downwind}} = 
	- \max(\dot{m}_{e} ,0)\phi_{E}
	+ \max(-\dot{m}_{e} ,0)\phi_{C}
	- \max(-\dot{m}_{w} ,0)\phi_{W}
	+ \max(-\dot{m}_{w} ,0)\phi_{C}
	+ \Big( \Gamma^{\phi}\frac{S}{\delta x} \Big)_{e} (\phi_{E} - \phi_{C})
	+ \Big( \Gamma^{\phi}\frac{S}{\delta x} \Big)_{w} (\phi_{W} - \phi_{C})
	\end{align}

其对对流项的敏感性为

.. math::
	\begin{align}
	\frac{\partial (RHS_{\text{downwind}}^{Conv})}{\partial \phi_{C}} = 
	- \max(-\dot{m}_{e} ,0) + \max(-\dot{m}_{w} , 0)
	\end{align}

对于所有流动它总是正的或者等于零。当考虑上它的反扩散效应之后，它就变成了一个高度不稳定的格式。




均匀网格与非均匀网格的函数关系
---------------------------------

前面提到的各种插值格式都是在一维笛卡尔网格上推导出来的。沿着曲线坐标轴，同样的函数关系也可以用曲线 :math:`\zeta` 轴代替笛卡尔坐标系的 :math:`x` 轴。

.. figure:: ../_images/计算流体力学有限体积法/一维曲线坐标系zeta.png
  :align: center

如上图所示，对于均匀网格，函数关系与一维直线网格的形式完全相同；对于非均匀网格，应该将函数关系中出现的自变量 :math:`x` 替换为更一般的自变量 :math:`\zeta` ，它表示沿坐标轴的距离。如果原点为 :math:`O` ，则

.. math::
	\begin{align}
	& \zeta_{U} = \zeta_{UU} + (\zeta_{U} - \zeta_{UU}) \\
	& \zeta_{UU} = \sqrt{(x_{UU} - x_{O})^{2} + (y_{UU} - y_{O})^{2} + (z_{UU} - z_{O})^{2}} \\
	& \zeta_{U} - \zeta_{UU} = \sqrt{(x_{U} - x_{UU})^{2} + (y_{U} - y_{UU})^{2} + (z_{U} - z_{UU})^{2}} 
	\end{align}

通过应用这个一般坐标系，不同格式的函数关系在均匀网格和非均匀网格的形式都可以得到，如下表所示：

+----------+------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 离散格式 | 均匀网格                                                                           | 非均匀网格                                                                                                                                                                                                                                                                            |
+==========+====================================================================================+=======================================================================================================================================================================================================================================================================================+
| Upwind   | :math:`\phi_{f} = \phi_{C}`                                                        | :math:`\phi_{f} = \phi_{C}`                                                                                                                                                                                                                                                           |
+----------+------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Downwind | :math:`\phi_{f} = \phi_{D}`                                                        | :math:`\phi_{f} = \phi_{D}`                                                                                                                                                                                                                                                           |
+----------+------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CD       | :math:`\phi_{f} = 0.5(\phi_{C} + \phi_{D})`                                        | :math:`\phi_{f} = \phi_{C} + \Big(\frac{\phi_{D} - \phi_{C}}{\zeta_{D} - \zeta_{C}}\Big)(\zeta_{f} - \zeta_{C})`                                                                                                                                                                      |
+----------+------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| SOU      | :math:`\phi_{f} = \frac{3}{2}\phi_{C} - \frac{1}{2}\phi_{U}`                       | :math:`\phi_{f} = \phi_{C} + \Big(\frac{\phi_{C} - \phi_{U}}{\zeta_{C} - \zeta_{U}}\Big)(\zeta_{f} - \zeta_{C})`                                                                                                                                                                      |
+----------+------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| QUICK    | :math:`\phi_{f} = \frac{3}{4}\phi_{C} - \frac{1}{8}\phi_{U} + \frac{3}{8}\phi_{D}` | :math:`\phi_{f} = \phi_{U} + \frac{(\zeta_{f} - \zeta_{U})(\zeta_{f} - \zeta_{C})}{(\zeta_{D} - \zeta_{U})(\zeta_{D} - \zeta_{C})}(\phi_{D} - \phi_{U}) + \frac{(\zeta_{f} - \zeta_{U})(\zeta_{f} - \zeta_{D})}{(\zeta_{C} - \zeta_{U})(\zeta_{C} - \zeta_{D})}(\phi_{C} - \phi_{U})` |
+----------+------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| FROMM    | :math:`\phi_{f} = \phi_{C} + \frac{1}{4}(\phi_{D} - \phi_{U})`                     | :math:`\phi_{f} = \phi_{C} + \frac{\zeta_{f} - \zeta_{C}}{\zeta_{D} - \zeta_{U}}(\phi_{D} - \phi_{U})`                                                                                                                                                                                |
+----------+------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+




稳态二维对流
---------------

考虑稳态二维对流方程：

.. math::
	\begin{align}
	\nabla \cdot (\rho\mathbf{U}\phi) = 0
	\end{align}

通过在如图所示的二维网格中取控制体积 :math:`V_{C}` 将上式进行有限体积离散，得到网格面通量的关系：

.. math::
	\begin{align}
	\sum_{f\sim nb(C)} \Big( \int_{f}\mathbf{J}^{\phi,C} \cdot \mathrm{d}\mathbf{S} \Big)
	= \sum_{f\sim nb(C)} \Big( \mathbf{J}_{f}^{\phi,C} \cdot \mathbf{S}_{f} \Big)
	= \sum_{f\sim nb(C)} (\rho\mathbf{U}\phi)_{f} \cdot \mathbf{S}_{f}
	= 0
	\end{align}

在一个均匀笛卡尔网格中，完整的离散形式为

.. math::
	\begin{align}
	\underbrace{(\rho u \Delta y \phi)_{e}}_{\dot{m}_{e}}
	- \underbrace{(\rho u \Delta y \phi)_{w}}_{-\dot{m}_{w}}
	+ \underbrace{(\rho v \Delta x \phi)_{n}}_{\dot{m}_{n}}
	- \underbrace{(\rho v \Delta x \phi)_{s}}_{-\dot{m}_{s}}
	= 0
	\end{align}

.. figure:: ../_images/计算流体力学有限体积法/二维笛卡尔网格中的稳态对流.png
  :align: center

在各坐标轴方向上分别应用一阶迎风格式来像一维情况那样处理流动，则离散方程变为

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{E}\phi_{E} + a_{W}\phi_{W} + a_{N}\phi_{N} + a_{S}\phi_{S} = 0
	\end{align}

其中各系数为

.. math::
	\begin{align}
	& a_{E} = \text{FluxF}_{e} = - \| -\dot{m}_{e},0 \| \\
	& a_{W} = \text{FluxF}_{w} = - \| -\dot{m}_{w},0 \| \\
	& a_{N} = \text{FluxF}_{n} = - \| -\dot{m}_{n},0 \| \\
	& a_{S} = \text{FluxF}_{s} = - \| -\dot{m}_{s},0 \| \\
	& a_{C} = \sum_{f\sim nb(C)}\text{FluxC}_{f}
	= \| \dot{m}_{e},0 \| + \| \dot{m}_{w},0 \| + \| \dot{m}_{n},0 \| + \| \dot{m}_{s},0 \|
	= - (a_{E} + a_{W} + a_{N} + a_{S}) + \dot{m}_{e} + \dot{m}_{w} + \dot{m}_{n} + \dot{m}_{s}
	\end{align}

如果使用的是QUICK格式，那么离散方程则变成

.. math::
	\begin{align}
	a_{C}\phi_{C} + a_{E}\phi_{E} + a_{W}\phi_{W} + a_{EE}\phi_{EE} + a_{WW}\phi_{WW} + a_{N}\phi_{N} + a_{S}\phi_{S} + a_{NN}\phi_{NN} + a_{SS}\phi_{SS} = 0
	\end{align}

其中各系数为

.. math::
	\begin{align}
	& a_{E} = \text{FluxF}_{e} = -\frac{3}{4} \| -\dot{m}_{e},0 \| + \frac{3}{8} \| \dot{m}_{e},0 \| - \frac{1}{8} \| \dot{m}_{w},0 \| \\
	& a_{W} = \text{FluxF}_{w} = -\frac{3}{4} \| -\dot{m}_{w},0 \| + \frac{3}{8} \| \dot{m}_{w},0 \| - \frac{1}{8} \| \dot{m}_{e},0 \| \\
	& a_{N} = \text{FluxF}_{n} = -\frac{3}{4} \| -\dot{m}_{n},0 \| + \frac{3}{8} \| \dot{m}_{n},0 \| - \frac{1}{8} \| \dot{m}_{s},0 \| \\
	& a_{S} = \text{FluxF}_{s} = -\frac{3}{4} \| -\dot{m}_{s},0 \| + \frac{3}{8} \| \dot{m}_{s},0 \| - \frac{1}{8} \| \dot{m}_{n},0 \| \\
	& a_{EE} = \text{FluxF}_{ee} = \frac{1}{8} \| -\dot{m}_{e},0 \| \\
	& a_{WW} = \text{FluxF}_{ww} = \frac{1}{8} \| -\dot{m}_{w},0 \| \\
	& a_{NN} = \text{FluxF}_{nn} = \frac{1}{8} \| -\dot{m}_{n},0 \| \\
	& a_{SS} = \text{FluxF}_{ss} = \frac{1}{8} \| -\dot{m}_{s},0 \| \\
	& a_{C} = \sum_{f\sim nb(C)}\text{FluxC}_{f} = - \sum_{F\sim NB(C)}a_{F} + (\dot{m}_{e} + \dot{m}_{w} + \dot{m}_{n} + \dot{m}_{s}) 
	\end{align}


现在使用上述两个离散方程来求解一个斜速度场中阶跃剖面的纯对流问题。计算域的划分如图所示，在正方形算域有一个物理量 :math:`\phi` 通过速度场 :math:`\mathbf{U} = (1,1)` 进行对流传输，左上角部分 :math:`\phi=1` 而右下角部分 :math:`\phi=0` 。由于方程中没有扩散项，所以理论上 :math:`\phi` 的分布会出现阶跃，但是如图所示迎风格式和QUICK格式的结果都与准确值有相当的差异。

.. figure:: ../_images/计算流体力学有限体积法/二维斜速度场对流传输问题.png
  :align: center

与准确值进行对比，可以看到一阶迎风格式得到的结果是模糊的，非常不准确，但是非常平滑。这种不准确性是由于一种新的误差，称为交叉流扩散(cross-stream diffusion)。这是由于所使用的一维插值格式将流动视为局部一维造成的。交叉流扩散最早由Patankar和Stubley发现，并认为这是一个多维现象(multi-dimensional phenomenon)，只有当速度场与网格不对齐时才会发生这种情况。对于二维流动，de Vahl Davis和Mallinson给出了交叉流扩散的近似表达式：

.. math::
	\begin{align}
	\Gamma_{false}^{\phi} = \frac{\rho |\mathbf{U}| \Delta x\Delta y \sin(2\theta)}{4 (\Delta y \sin^{3}\theta + \Delta x \cos^{3}\theta)} 
	\end{align}

其中 :math:`\theta` 表示速度矢量与 :math:`x` 轴的夹角。该误差可以通过使用更高阶的插值格式比如QUICK格式来减小。正如图中所示的那样，QUICK格式的结果更加锋利且比迎风格式更加精确，但是它受到附近尖锐梯度的影响产生了振荡(over/undershoots)。这个误差就是之前所说的色散误差(dispersion error)，它导致计算域中产生极大值/极小值，这是所有高阶格式的一个特征。



Notions on Numerical Methods
===============================

Selected Difference Schemes
------------------------------

The First Order Upwind Scheme
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Lax-Friedrichs Scheme
^^^^^^^^^^^^^^^^^^^^^^^^

Lax-Friedrichs scheme也是一个一阶格式，它不需要根据迎风方向来进行差分，而是采用了forward in time and central in space的方式来估计偏微分，也就是说，该格式将时间导数项从一般的 :math:`u_{t} = \frac{u_{i}^{n+1} - u_{i}^{n}}{\Delta t}` 中的 :math:`u_{i}^{n}` 修改为

.. math::
	\begin{align}
	\frac{1}{2}(u_{i-1}^{n} + u_{i+1}^{n}) 
	\end{align}


于是该格式给出的 :math:`u_{t} + au_{x} = 0` 的离散推进形式为

.. math::
	\begin{align}
	u_{i}^{n+1} = \frac{1}{2}(u_{i-1}^{n} + u_{i+1}^{n}) - \frac{1}{2}c(u_{i+1}^{n} - u_{i-1}^{n}) 
	\end{align}

其中 :math:`c = \Delta t a / \Delta x = a/(\Delta x/\Delta t)` 为Courant number。通过von Neumann stability analysis可以发现该格式在 :math:`0 \le |c| \le 1` 的条件下是稳定的。通过截断误差分析可知该格式具有一阶精度。考虑其数值扩散，也即引入数值粘性系数，则该格式实际求解的方程为

.. math::
	\begin{align}
	u_{t} + au_{x} = \alpha_{LF} u_{xx}
	,\qquad
	\alpha = \frac{\Delta x a}{2c}(1 - c^{2})
	\end{align}

与一阶迎风格式对比，可以发现Lax-Friedrichs格式会引入更多的扩散效应，因为对于 :math:`0 < c \le 1` 有

.. math::
	\begin{align}
	2 \le \alpha_{LF} / \alpha_{upwind} = \frac{1 + c}{c} < \infty 
	\end{align}

将该格式写成 :math:`u_{i}^{n+1} = \sum_{k=-l_{L}}^{l_{R}}b_{k}u_{i+k}^{n}` 的通用迎风格式形式，则该格式的系数为

.. math::
	\begin{align}
	b_{-1} = \frac{1}{2}(1 + c)
	,\quad
	b_{0} = 0
	,\quad
	b_{1} = \frac{1}{2}(1 -c)
	\end{align}

在满足稳定条件 :math:`0 \le |c| \le 1` 的前提下，Lax-Friedrich格式的系数 :math:`b_{k}` 均为正数或零，因此该格式属于monotone scheme。

Lax-Wendroff Scheme
^^^^^^^^^^^^^^^^^^^^^^

基础的Lax-Wendroff格式在空间和时间上都具有二阶精度。时间导数项仍是一般的first-order forward approximation :math:`u_{t} = (u_{i}^{n+1}-u_{i}^{n})/\Delta t` ；空间导数项则取迎风和顺风估计的平均值，即

.. math::
	\begin{align}
	u_{x} = \beta_{1}\frac{u_{i}^{n} - u_{i-1}^{n}}{\Delta x} + \beta_{2}\frac{u_{i+1}^{n} - u_{i}^{n}}{\Delta x}
	\end{align}

当取 :math:`\beta_{1} = \frac{1}{2}(1 + c)` 和 :math:`\beta_{2} = \frac{1}{2}(1 - c)` ，则得到Lax-Wendroff格式的离散推进方程：

.. math::
	\begin{align}
	u_{i}^{n+1} = \frac{1}{2}c(1+c)u_{i-1}^{n} + (1 - c^{2})u_{i}^{n} - \frac{1}{2}c(1 - c)u_{i+1}^{n}  
	\end{align}

其中 :math:`c` 为Courant number。虽然空间导数中的其中一项来自无条件不稳定的格式，但是Lax-Wendroff格式在 :math:`0 \le |c| \le 1` 的条件下是稳定的。虽然该格式通过一阶格式构建出来，但是最终得到的结果是二阶格式，这也充分说明了格式的精度一般不能直接从各偏微分的近似阶数直接得到。将Lax-Wendroff格式写成迎风格式通用形式，则其系数为

.. math::
	\begin{align}
	b_{-1} = \frac{(1 + c)c}{2}
	,\quad 
	b_{0} = 1-c^{2}
	,\quad
	b_{1} = - \frac{(1 - c)c}{2}
	\end{align}

因此该格式并不属于monoton scheme，不是所有的系数都是正值或零。格式不是单调的与数值解在尖锐梯度附近的伪振荡现象(spurious oscillations)有关，比如在不连续处。

Warming-Beam Scheme
^^^^^^^^^^^^^^^^^^^^^^

Warming-Beam格式也具有二阶精度。对于方程 :math:`u_{t} + au_{x} = 0` ，当 :math:`a` 为正时，该格式给出的离散推进方程为

.. math::
	\begin{align}
	u_{i}^{n+1} = \frac{1}{2}c(c - 1)u_{i-2}^{n} + c(2-c)u_{i-1}^{n} + \frac{1}{2}(c - 1)(c - 2)u_{i}^{n}
	\end{align}

可以看到，该格式使用的stencil完全位于其中网格点的一侧，显然该格式不是单调的。Warming-Beam格式的稳定性限制为

.. math::
	\begin{align}
	0 \le |c| \le 2
	\end{align}

因此该格式能够选取更大的时间步长，显著提高计算效率。

We can verify that the numerical flux of the scheme of Warming and Beam, as applied to the linear advection equation with :math:`a>0` , is

.. math::
	\begin{align}
	f_{i+\frac{1}{2}}^{WB} = \frac{1}{2}(c-1)f_{i-1} + \frac{1}{2}(3-c)f_{i}
	\end{align}

.. note:: 

	The Warming-Beam numerical flux can be derived from 

	.. math::
		\begin{align}
		\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}(\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}})
		,\qquad
		\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}} = \frac{1}{\Delta x} \int_{-\frac{1}{2}\Delta x}^{\frac{1}{2}\Delta x} \mathbf{U}_{i+\frac{1}{2}}(x, \frac{1}{2}\Delta t)~\mathrm{d}x
		\end{align}

	in terms of integral averages of solutions of Riemann problems under the assumption :math:`1 \le c \le 2` . An extension of this interpretation to non-linear systems was proposed by Toro and Bilett.

	We can apply the numerical flux above to the linear advection equation and derive the Warming-Beam flux for negative speed :math:`a` . Assume :math:`-2 \le c \le -1` .


Fromm Scheme
^^^^^^^^^^^^^^^

Another second order scheme is the FROMM scheme. For the linear advection equation, for :math:`a>0` , the scheme reads

.. math::
	\begin{align}
	u_{i}^{n+1} = 
	- \frac{1}{4}(1 - c)c u_{i-2}^{n}
	+ \frac{1}{4}(5 - c)c u_{i-1}^{n}
	+ \frac{1}{4}(1 - c)(4 + c) u_{i}^{n}
	- \frac{1}{4}(1 - c)c u_{i+1}^{n}
	\end{align}

which has stability restriction :math:`0 \le |c| \le 1` . Also, it can be easily verified that the FROMM scheme is no monotone.

Second-order schemes such as Lax-Wendroff, Warming-Beam and FROMM schemes have modified equation of the form

.. math::
	\begin{align}
	q_{t} + aq_{x} = \beta q_{xxx}
	\end{align}

which is a dispersive equation.

We can verify that the FROMM scheme as applied to the linear advection equation, for positive :math:`a` , can be written in conservation form with numerical flux

.. math::
	\begin{align}
	f_{i+\frac{1}{2}}^{FR} = -\frac{1}{4}(1-c)f_{i-1} + f_{i} + \frac{1}{4}(1-c)f_{i+1}  
	\end{align}

where :math:`c` is the Courant number.







Conservative Methods
-----------------------

Basic Definitions
^^^^^^^^^^^^^^^^^^^

Godunov's First-Order Upwind Method
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Godunov’s first–order upwind method是守恒方程(conservative formula) :math:`u_{i}^{n+1} = u_{i}^{n} + \frac{\Delta t}{\Delta x}\Big(f_{i-\frac{1}{2}} - f_{i+\frac{1}{2}}\Big)` 的一种conseervative method，其中intercell numerical fluxes :math:`f_{i+\frac{1}{2}}` 通过求解local Riemann problems来得到。该方法的一个基本假设是对于给定的时间级 :math:`n` ，数据是按照下面的方式分片常数分布的：

.. math::
	\begin{align}
	u_{i}^{n} = \frac{1}{\Delta x}\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}u(x,t^{n})~\mathrm{d}x 
	\end{align}

在时间级 :math:`n` 的 :math:`f_{i+\frac{1}{2}}` 可以看成非连续分离的 :math:`(u_{i}^{n}, u_{i+1}^{n})` 在交界面 :math:`x_{i+\frac{1}{2}}` 处的贡献。于是，局部地可以定义一个黎曼问题：

.. math::
	\begin{align}
	& u_{t} + f(u)_{x} = 0 \\
	& u(x,0) = u_{0}(0) =
	\left \{\begin{array}{ll}
	u_{i}^{n} \quad \text{if}~x<0 \\
	u_{i+1}^{n} \quad \text{if}~x>0 
	\end{array}\right .
	\end{align}

这个local Riemann problem可能可以得到解析解。因此，对于给定的时间级 :math:`n` ，在每个intercell boundary :math:`x_{i+\frac{1}{2}}` 我们都得到了有初始条件 :math:`(u_{i}^{n}, u_{i+1}^{n})` 的local Riemann problem :math:`RP(u_{i}^{n}, u_{i+1}^{n})` 。于是，现在需要一个能够找到在下一个时间级 :math:`n+1` 的global problem的解的方法。


First Version of Godunov's Method
"""""""""""""""""""""""""""""""""""


Godunov建议用下面的方式来将网格值 :math:`u_{i}^{n}` 更新到 :math:`u_{i}^{n+1}` ：求解守恒方程的两个黎曼问题 :math:`RP(u_{i-1}^{n}, u_{i}^{n})` 和 :math:`RP(u_{i}^{n},u_{i+1}^{n})` ，take an integral average in cell i of the combined solutions of these two local problems并将该值赋给 :math:`u_{i}^{n+1}` 。对于 :math:`a>0` 时黎曼问题 :math:`RP(u_{i-1}^{n} ,u_{i}^{n})` 的准确解为

.. math::
	\begin{align}
	u_{i-\frac{1}{2}}(x/t) = 
	\left\{\begin{array}{ll}
	u_{i-1}^{n} \quad \text{if}~x/t < a \\
	u_{i}^{n} \quad \text{if}~x/t > a
	\end{array}\right.
	\end{align}

其中the local origin of the Riemann problem is :math:`(0,0)` 。类似的，黎曼问题 :math:`RP(u_{i}^{n},u_{i+1}^{n})` 的准确解为

.. math::
	\begin{align}
	u_{i+\frac{1}{2}}(x/t) = 
	\left\{\begin{array}{ll}
	u_{i}^{n} \quad \text{if}~x/t < a \\
	u_{i+1}^{n} \quad \text{if}~x/t > a
	\end{array}\right.
	\end{align}

The Godunov scheme defines the updated solution as

.. math::
	\begin{align}
	u_{i}^{n+1} = \frac{1}{\Delta x}
	\bigg[
	    \int_{0}^{\frac{1}{2}\Delta x}u_{i-\frac{1}{2}}(x/\Delta t)~\mathrm{d}x
	    + \int_{-\frac{1}{2}\Delta x}^{0}u_{i+\frac{1}{2}}u_{i+\frac{1}{2}}(x/\Delta t)~\mathrm{d}x
	\bigg]
	\end{align}

This integral is evaluated at time :math:`\Delta t` (local time) between the points A and D in Fig.5.6. Note that we only use the right half of the solution :math:`u_{i-\frac{1}{2}}(x/t)` and the left half of the solution :math:`u_{i+\frac{1}{2}}(x/t)` . Each solution has its own local frame of reference with origin :math:`(0,0)` corresponding with the intercell boundaries at :math:`x_{i-\frac{1}{2}}` and :math:`x_{i+\frac{1}{2}}` . In order to evaluate the integral we impose a restriction on the size of the time step :math:`\Delta t` . We set

.. math::
	\begin{align}
	c = \frac{a \Delta t}{\Delta x} \le \frac{1}{2}
	\end{align}

The first term in the updated solution involves the intervals AB and BC; these have lengths respectively given by

.. math::
	\begin{align}
	l_{AB} = c\Delta x
	,\quad
	l_{BC} = (\frac{1}{2} - c)\Delta x
	\end{align}

The integrand is given by exact solution :math:`u_{i-\frac{1}{2}}(x/t), u_{i+\frac{1}{2}}(x/t)` ; hence we have

.. math::
	\begin{align}
	\frac{1}{\Delta x}\int_{0}^{\frac{1}{2}\Delta x}u_{i-\frac{1}{2}}(x/\Delta t)~\mathrm{d}x
	= c u_{i-1}^{n} + (\frac{1}{2} - c)u_{i}^{n}
	\end{align}

The second term gives

.. math::
	\begin{align}
	\frac{1}{\Delta x}\int_{-\frac{1}{2}\Delta x}^{0}u_{i+\frac{1}{2}}(x/\Delta t)~\mathrm{d}x = \frac{1}{2}u_{i}^{n}
	\end{align}

Hence the updated solution becomes

.. math::
	\begin{align}
	u_{i}^{n+1} = u_{i}^{n} + c(u_{i-1}^{n} - u_{i}^{n})
	\end{align}

which is identical to the first order upwind method for positive speed a. The conservative charater of the Godunov method is self evident: the updated solution is obtained by integral averaging, a conservative process, of local exact solutions of the conservation law.


Second Version of Godunov's Method
"""""""""""""""""""""""""""""""""""""

A second interpretation of the Godunov method leads directly to the conservative formula, which is easier to apply in practice and avoids the over-restrictive CFL-like condition :math:`c = \frac{a\Delta t}{\Delta x} \le \frac{1}{2}` . The integral average of the solution of the Riemann problems :math:`RP(u_{i-1}^{n},u_{i}^{n})` and :math:`RP(u_{i}^{n},u_{i+1}^{n})` can also be written as

.. math::
	\begin{align}
	u_{i}^{n+1} = \frac{1}{\Delta x}\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}\tilde{u}(x,\Delta t)~\mathrm{d}x
	\end{align}

where :math:`\tilde{u}(x,t)` is understood as the combined solution of :math:`RP(u_{i-1}^{n},u_{i}^{n})` and :math:`RP(u_{i}^{n},u_{i+1}^{n})` . Since :math:`\tilde{u}(x,t)` is an exact solution to the original conservation law, we can make use of it in its integral form, say, in the control volume :math:`[x_{i-\frac{1}{2}}, x_{i+\frac{1}{2}}] \times [0, \Delta t]` to write

.. math::
	\begin{align}
	\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{u}(x,\Delta t)~\mathrm{d}x
	= \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{u}(x,0)~\mathrm{d}x
	  + \int_{0}^{\Delta t} f\big( \tilde{u}(x_{i-\frac{1}{2}}, t) \big)~\mathrm{d}t
	  - \int_{0}^{\Delta t} f\big( \tilde{u}(x_{i+\frac{1}{2}}, t) \big)~\mathrm{d}t
	\end{align}

Using the definition of cell averages :math:`u_{i}^{n} = \frac{1}{\Delta x}\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}u(x,t^{n})~\mathrm{d}x` into the above equation followed by division through by :math:`\Delta x` , we reproduce the conservative formula

.. math::
	\begin{align}
	u_{i}^{n+1} = u_{i}^{n} + \frac{\Delta t}{\Delta x} \Big( f_{i-\frac{1}{2}} - f_{i+\frac{1}{2}} \Big)
	\end{align}

with the intercell fluxes defined as time integral averages, namely

.. math::
	\begin{align}
	f_{i-\frac{1}{2}} = \frac{1}{\Delta} \int_{0}^{\Delta t} f\big( \tilde{u}(x_{i-\frac{1}{2}},t) \big)~\mathrm{d}t
	,\qquad
	f_{i+\frac{1}{2}} = \frac{1}{\Delta} \int_{0}^{\Delta t} f\big( \tilde{u}(x_{i+\frac{1}{2}},t) \big)~\mathrm{d}t
	\end{align}

Thus, by invoking the integral form of the conservation laws on a control or finite volume :math:`[x_{i-\frac{1}{2}},x_{i+\frac{1}{2}}] \times [0,\Delta t]` in :math:`x-t` space we have arrived at the conservative formula with intercell fluxes; these are time integral averages of the physical flux :math:`f(u)` evaluated at the intercell boundaries. The integrand :math:`f\big(\tilde{u}(x,t)\big)` at each cell interface depends on the exact solution :math:`\tilde{u}(x,t)` of the Riemann problem along the t-axis (local coordinates); this is given by

.. math::
	\begin{align}
	\tilde{u}(x_{i-\frac{1}{2}},t) = u_{i-\frac{1}{2}}(0)
	,\qquad
	\tilde{u}(x_{i+\frac{1}{2}},t) = u_{i+\frac{1}{2}}(0)
	\end{align}

and the intercell fluxes :math:`f_{i-\frac{1}{2}}` and :math:`f_{i+\frac{1}{2}}` become

.. math::
	\begin{align}
	f_{i-\frac{1}{2}} = f\big(u_{i-\frac{1}{2}}(0)\big)
	,\qquad
	f_{i+\frac{1}{2}} = f\big(u_{i+\frac{1}{2}}(0)\big)
	\end{align}

In general, one expresses the Godunov intercell numerical flux as

.. math::
	\begin{align}
	f_{i+\frac{1}{2}}^{Godunov} = f\big(u_{i+\frac{1}{2}}(0)\big)
	\end{align}

where :math:`u_{i+\frac{1}{2}}(0)` denotes the exact solution :math:`u_{i+\frac{1}{2}}(x/t)` of the Riemann problem :math:`RP(u_{i}^{n},u_{i+1}^{n})` evaluated at :math:`x/t=0` , i.e. the solution is evaluated along the intercell boundary, which coincides with the t-axis in the local frame of the Riemann problem solution. We have thus defined the second version of Godunov's method for a general scalar conservation law, as the conservative formula together with the intercell numerical flux. For the special conservation law with flux :math:`f(u)=au,a>0` , we have

.. math::
	\begin{align}
	f_{i-\frac{1}{2}} = au_{i-1}^{n}
	,\qquad
	f_{i+\frac{1}{2}} = au_{i}^{n}
	\end{align}

which if substituted in the conservative formula reproduce the first-order upwind scheme. The second version :math:`u_{i}^{n+1} = u_{i}^{n} + \frac{\Delta t}{\Delta x} \Big( f_{i-\frac{1}{2}} - f_{i+\frac{1}{2}} \Big)` , :math:`f_{i+\frac{1}{2}}^{Godunov} = f\big(u_{i+\frac{1}{2}}(0)\big)` of Godunov's method is the one that is mostly used in practice.


Godunov's Method for Burgers's Equation
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

As a way of illustrating Godunov's method in the context of non-linear PDEs, we apply the scheme to the inviscid Burgers equation

.. math::
	\begin{align}
	u_{t} + f(u)_{x} = 0
	,\quad
	f(u) = \frac{1}{2}u^{2}
	\end{align}

We adopt the second version :math:`u_{i}^{n+1} = u_{i}^{n} + \frac{\Delta t}{\Delta x} \Big( f_{i-\frac{1}{2}} - f_{i+\frac{1}{2}} \Big)` with numerical flux given by :math:`f_{i+\frac{1}{2}}^{Godunov} = f\big(u_{i+\frac{1}{2}}(0)\big)` . We need the solution :math:`u_{i+\frac{1}{2}}(x/t)` of the Riemann problem :math:`RP(u_{i}^{n}, u_{i+1}^{n})` . The solution is a shock wave when :math:`u_{i}^{n} > u_{i+1}^{n}` , and a rarefaction wave when :math:`u_{i}^{n} \le u_{i+1}^{n}` . The complete solution is

.. math::
	\begin{align}
	& u_{i+\frac{1}{2}}(x/t) = \left \{ \begin{array}{ll}
	u_{i}^{n} \quad \text{if}~\frac{1}{2}(u_{i}^{n} + u_{i+1}^{n}) \ge x/t \\
	u_{i+1}^{n} \quad \text{if}~\frac{1}{2}(u_{i}^{n} + u_{i+1}^{n}) \le x/t
	\end{array} \right .
	\qquad \text{if}~u_{i}^{n} > u_{i+1}^{n} \\
	& u_{i+\frac{1}{2}}(x/t) = \left \{ \begin{array}{ll}
	u_{i}^{n} \quad \text{if}~x/t \le u_{i}^{n} \\
	x/t \quad \text{if}~u_{i}^{n} < x/t < u_{i+1}^{n} \\
	u_{i+1}^{n} \quad \text{if}~x/t \ge u_{i+1}^{n}
	\end{array} \right .
	\qquad \text{if}~u_{i}^{n} \le u_{i+1}^{n}
	\end{align}

The Godunov's flux requires :math:`u_{i+\frac{1}{2}}(0)` ; this is the solution :math:`u_{i+\frac{1}{2}}(x/t)` evaluated along the intercell boundary :math:`x_{i+\frac{1}{2}}` , that corresponds to :math:`x/t = 0` in the frame of the local Riemann problem. 

The second stage is to identify all possible wave patterns in the solution of the Riemann problem. For Burgers's equation there are five possibilities. These are illustrated in Fig.5.7. If the solution is a shock wave, then cases (a) and (b) can occur. The sought value :math:`u_{i+\frac{1}{2}}(0)` , on the t-axis, depends on the sign of the shock speed :math:`\frac{1}{2}(u_{i}^{n} + u_{i+1}^{n})` . If the solution is a rarefaction wave, then the three possible cases are illustrated in Figs.5.7c, 5.7d and 5.7e. Applying terminology from Gas Dynamics to the rarefaction cases, Fig.5.7c is called supersonic to the left, and that of Fig.5.7d supersonic to the right. The case of Fig.5.7e is that of a transonic rarefaction or sonic rarefaction; as the wave is crossed, there is a sign change in the characteristic speed :math:`u` , and thus there is one point at which :math:`u=0` , a sonic point. The complete sought solution is summarised as follows

.. math::
	\begin{align}
	& u_{i+\frac{1}{2}}(0) = \left \{ \begin{array}{ll}
	u_{i}^{n} \quad \text{if}~\frac{1}{2}(u_{i}^{n} + u_{i+1}^{n}) \ge 0 \\
	u_{i+1}^{n} \quad \text{if}~\frac{1}{2}(u_{i}^{n} + u_{i+1}^{n}) \le 0
	\end{array} \right .
	\qquad \text{if}~u_{i}^{n} > u_{i+1}^{n} \\
	& u_{i+\frac{1}{2}}(0) = \left \{ \begin{array}{ll}
	u_{i}^{n} \quad \text{if}~0 \le u_{i}^{n} \\
	x/t \quad \text{if}~u_{i}^{n} < 0 < u_{i+1}^{n} \\
	u_{i+1}^{n} \quad \text{if}~0 \ge u_{i+1}^{n}
	\end{array} \right .
	\qquad \text{if}~u_{i}^{n} \le u_{i+1}^{n}
	\end{align}

Naturally, Godunov's method can also be implemented using approximate soluitons to the Riemann problem. In applying Godunov's scheme to solve Burgers's equation, there are two more issues to consider. One concerns the application of boundary conditions, and the other is to do with the choice of the time step :math:`\Delta t` .


Boundary Conditions
"""""""""""""""""""""

The conservative formula can be applied directly to all cells :math:`i` , for :math:`i = 2,\cdots, M-1` . The two required intercell fluxes at :math:`x_{i-\frac{1}{2}}` and :math:`x_{i+\frac{1}{2}}` are defined in terms of the corresponding Riemann problems. For each of the cells :math:`1` and :math:`M` , which are adjacent to the left and right boundaries respectively, we only have one intercell flux. Some special procedure needs to be implemented. Let us consider the left boundary :math:`x=0` . One possibility is to assume a boundary function :math:`u_{1}(t)` prescribed there. Then we could define an intercell flux at the boundary by setting :math:`f_{\frac{1}{2}} = f(u_{1}(t))` .

A more attractive alternative is to specify a fictitious cell :math:`0` to the left of the boundary :math:`x=0` together with a cell average :math:`u_{0}^{n}`, at each time level :math:`n` , so that a Riemann problem :math:`RP(u_{0}^{n},u_{1}^{n})` can be posed and solved to find the missing intercell flux :math:`f_{\frac{1}{2}}` . For the right boundary we prescribe a fictitous cell :math:`M+1` and a cell average :math:`u_{M+1}^{n}` to find the intercell flux :math:`f_{M+\frac{1}{2}}` . The prescription of the fictitious states depends entirely on the physics of the particular problem at hand. Provisionally, for the inviscid Burgers's equation we apply the boundary conditions

.. math::
	\begin{align}
	u_{0}^{n} = u_{1}^{n}
	,\quad
	u_{M+1}^{n} = u_{M}^{n}
	\end{align}

Note that the fictitious states here are given in terms of the data at the states within the computational domain adjacent to the boundaries. This particular type of boundary conditions will cause no disturbance at the boundaries; waves will hopefully go through the boundaries as if the boundaries were not there. Often one speaks of transparent or transmissive boundary conditions in this case.


Choosing the Time Step
"""""""""""""""""""""""""

As seen for the linear case, the choice of the size of the time step :math:`\Delta t` in the conservative formula is related to the stability condition of the particular scheme. For Godunov's method, the choice of :math:`\Delta t` depends on the restriction on the Courant number :math:`c` . For non-linear problems, at each time level, there are multiple wave speeds and thus multiple associated Courant numbers. In deriving the second version of the Godunov's method, we made the implicit assumption that the value of the local Riemann problem solution along the intercell boundary is constant. This means that the fastest wave at a given time travels for at most one cell length :math:`\Delta x` in the sought time step :math:`\Delta t` . Denoting by :math:`S_{\max}^{n}` the maximum wave speed throughout the domain at time level :math:`n` we define the maximum Courant number :math:`C_{cfl}` ：

.. math::
	\begin{align}
	C_{cfl} = \frac{\Delta t S_{\max}^{n}}{\Delta x}
	\end{align}

where :math:`\Delta t` is such that

.. math::
	\begin{align}
	0 < C_{cfl} < 1
	\end{align}

.. attention:: 这里的 :math:`S` 表示波速 :math:`S = \frac{1}{2}(u_{i}^{n} + u_{i+1}^{n})` ，而不是面积。


We shall often call :math:`C_{cfl}` the **CFL coefficient** or **Courant number coefficient** . The time step :math:`\Delta t` follows as

.. math::
	\begin{align}
	\Delta t = C_{cfl} \Delta x / S_{\max}
	\end{align}

A matter of crucial importance is the estimation of the maximum speed :math:`S_{\max}^{n}` . In realistic applications this can be difficult and frustrating, as inappropriate choices can cause the scheme to crash, no matter how sophisticated this is. For Burgers's equation one can identify wave speeds, such as those emerging from solutions of Riemann problems at the intercell boundaries, and characteristic speeds :math:`u` . At any time level :math:`n` , there are :math:`M+2` characteristic speeds :math:`u_{i}^{n}` (including the fictitious cells) and hence one possibility is to take :math:`S_{\max}^{n}` as the maximum of these, in absolute value. Another possibility is to select, at each time level, a speed :math:`S_{i+\frac{1}{2}}^{n}` from the solution Riemann problem at each cell interface; this information is available as part of the flux computation process. For the case of a shock, one oboviously takes the shock speed. For the case of a rarefaction there are two characteristic speeds of significance, namely those of the head and tail of the expansion. Thus we define an intercell speed

.. math::
	\begin{align}
	S_{i+\frac{1}{2}}^{n} = \left \{ \begin{array}{ll}
	|\frac{1}{2}(u_{i}^{n} + u_{i+1}^{n})| \quad \text{(shock)} \\
	\max(|u_{i}^{n}|, |u_{i+1}^{n}|) \quad \text{(rarefaction)}
	\end{array} \right .
	\end{align}

Finally, we define a maximum wave speed at time level :math:`n` as follows

.. math::
	\begin{align}
	S_{\max}^{n} = \max_{i}\left\{ S_{i+\frac{1}{2}}^{n} \right \} \quad \text{for}~ i=0,\cdots,M+1
	\end{align}

Having chosen :math:`C_{cfl}` , the time step :math:`\Delta t` to march the solution to the next time level is given by :math:`\Delta t = C_{cfl}\Delta x / S_{\max}^{n}` . For a scheme with linearised stability condition :math:`|c| \le 1` , one usually takes the empirical value :math:`C_{cfl} = 0.9` .


Conservative Form of Difference Schemes
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Conventional finite difference schemes can often be expressed in conservation form. It is a question of finding an intercell flux.

The Lax-Friedrichs Scheme
"""""""""""""""""""""""""""

The Lax-Friedrichs scheme as applied to the linear advection equation is

.. math::
	\begin{align}
	u_{i}^{n+1} = \frac{1+c}{2}u_{i-1}^{n} + \frac{1-c}{2}u_{i+1}^{n}
	\end{align}

It is easy to verify that the conservative formula together with the intercell flux

.. math::
	\begin{align}
	f_{i+\frac{1}{2}} = \frac{1+c}{2c}f(u_{i}^{n}) + \frac{c - 1}{2c}f(u_{i+1}^{n})
	\end{align}

reproduces the Lax-Friedrichs scheme. Therefore, at least for the linear advection equation, one can recast the Lax-Friedrichs scheme in conservative form.

An interesting way of viewing the Lax-Friedrichs scheme is as an integral average within cell :math:`i` , namely

.. math::
	\begin{align}
	u_{i}^{n+1} = \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{u}(x,\frac{1}{2}\Delta t)\cdot \mathrm{d}x
	\end{align}

in which :math:`\tilde{u}(x,t)` is the solution of the Riemann problem :math:`RP(u_{i-1}^{n}, u_{i+1}^{n})` , that is

.. math::
	\begin{align}
	\tilde{u}(x/t) = \left\{ \begin{array}{ll}
	u_{i-1}^{n} \quad \text{if}~x/t < a \\
	u_{i+1}^{n} \quad \text{if}~x/t > a
	\end{array} \right.
	\end{align}

.. note:: 

	We note that the Lax-Fridrichs solution at cell :math:`i` is a weighted average of the solution of the Riemann problem with the left and right neighbour states as data, at time :math:`t=\frac{1}{2}\Delta t` . One could state that the Lax-Friedrichs scheme is upwind biased, as the upwidn term has always the larger weight.




Let us now attempt to generalise interpretation of the Lax-Friedrichs scheme to non-linear systems of conservation laws

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = 0
	\end{align}

Now the integral average within cell reads

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \hat{\mathbf{U}}(x,\frac{1}{2}\Delta t)~\mathrm{d}x
	\end{align}

where :math:`\hat{\mathbf{U}}(x,t)` is the solution of the Riemann problem :math:`RP(\mathbf{U}_{i-1}^{n}, \mathbf{U}_{i+1}^{n})` . Given an exact Riemann solver, one could then implement this Riemann-problem based version of the Lax-Friedrichs scheme. The author has implemented this version of the scheme for non-linear systems. The numerical results obtained are indistinguishable from those obtained from the conventional form of the scheme. The above version of the integral average offers no obvious advantages over the conventional form; in fact it is more expensive and complex and hence is of no practical use. A stochastic evaluation of the integral leads to a random choice type method.

If the space integral at time :math:`\frac{1}{2}\Delta t` given above is replaced by invoking the integral form of conservation law in control volume :math:`[-\frac{1}{2}\Delta x, \frac{1}{2}\Delta x] \times [0, \frac{1}{2}\Delta t]` we obtain

.. math::
	\begin{align}
	\int_{-\frac{1}{2}\Delta x}^{\frac{1}{2}\Delta x} \hat{\mathbf{U}}(x,\frac{1}{2}\Delta t)\mathrm{d}x
	= \int_{-\frac{1}{2}\Delta x}^{\frac{1}{2}\Delta x} \hat{\mathbf{U}}(x,0)\mathrm{d}x
	+ \int_{0}^{\frac{1}{2}\Delta t}\mathbf{F}(\hat{\mathbf{U}}(-\frac{1}{2}\Delta x, t))~\mathrm{d}t
	- \int_{0}^{\frac{1}{2}\Delta t}\mathbf{F}(\hat{\mathbf{U}}(\frac{1}{2}\Delta x, t))~\mathrm{d}t
	\end{align}

Direct evaluation of the integrals and use of the definition of integral averages in cell :math:`i` , as applied to systems, yield

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1}
	= \frac{1}{2}(\mathbf{U}_{i-1}^{n} + \mathbf{U}_{i+1}^{n})
	+ \frac{1}{2}\frac{\Delta t}{\Delta x}(\mathbf{F}_{i-1}^{n} - \mathbf{F}_{i+1}^{n})
	\end{align}

Simple algebraic manipulations of this expression lead to a conservative version of the Lax-Friedrichs scheme for systems

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} + \frac{\Delta t}{\Delta x}\Big( \mathbf{F}_{i-\frac{1}{2}} - \mathbf{F}_{i+\frac{1}{2}} \Big) 
	\end{align}

with the Lax-Friedrichs intercell flux given by

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}}^{LF}
	= \frac{1}{2}(\mathbf{F}_{i}^{n} + \mathbf{F}_{i+1}^{n})
	+ \frac{1}{2}\frac{\Delta x}{\Delta t}(\mathbf{U}_{i}^{n} - \mathbf{U}_{i+1}^{n})  
	\end{align}

This is the conventional numerical flux for the Lax-Friedrichs scheme when applied to systems of conservations laws :math:`\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = 0` . No mention of the Riemann problem is needed in this formulation.



The Lax-Wendroff Scheme
""""""""""""""""""""""""""

The Lax-Wendroff scheme as applied to the linear advection equation may also be written in conservation form. The intercell numerical flux is

.. math::
	\begin{align}
	f_{i+\frac{1}{2}} = \frac{1+c}{2}(au_{i}^{n}) + \frac{1-c}{2}(au_{i+1}^{n})
	\end{align}

which is a weighted average of fluxes on the left and right of the interface. For the linear advection equation, it is easy to check that this can also be obtained from

.. math::
	\begin{align}
	f_{i+\frac{1}{2}} = f(u_{i+\frac{1}{2}}^{n+\frac{1}{2}})
	,\qquad
	u_{i+\frac{1}{2}}^{n+\frac{1}{2}} = \frac{1+c}{2}u_{i}^{n} + \frac{1-c}{2}u_{i+1}^{n}
	\end{align}

For non-linear scalar conservation laws, such as Burgers's equations, this generalises to

.. math::
	\begin{align}
	f_{i+\frac{1}{2}} = f(u_{i+\frac{1}{2}}^{n+\frac{1}{2}})
	,\qquad
	u_{i+\frac{1}{2}}^{n+\frac{1}{2}} = \frac{1}{\Delta x} \int_{-\frac{1}{2}\Delta x}^{\frac{1}{2}\Delta x} u_{i+\frac{1}{2}}(x, \frac{1}{2}\Delta t)~\mathrm{d}x
	\end{align}

where :math:`u_{i+\frac{1}{2}}(x,t)` is the solution of the Riemann problem :math:`RP(u_{i}^{n}, u_{i+1}^{n})` . A straightforward Riemann-problem based generalisation of the Lax-Wendroff scheme to non-linear hyperbolic systems reads

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}(\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}})
	,\qquad
	\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}} = \frac{1}{\Delta x} \int_{-\frac{1}{2}\Delta x}^{\frac{1}{2}\Delta x} \mathbf{U}_{i+\frac{1}{2}}(x, \frac{1}{2}\Delta t)~\mathrm{d}x
	\end{align}

where :math:`\mathbf{U}_{i+\frac{1}{2}}(x,t)` is the solution of the Riemann problem :math:`RP(\mathbf{U}_{i}^{n}, \mathbf{U}_{i+1}^{n})` . This scheme is called the **Weighted Average Flux(WAF)** method.

As done for the Lax-Friedrichs scheme, one may repalce the integral involving the solution of the Riemann problem by invoking the integral form of the conservation laws in the control volume :math:`[-\frac{1}{2}\Delta x, \frac{1}{2}\Delta x] \times [0, \frac{1}{2}\Delta t]` to obtain

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}}
	= \mathbf{F}(\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}})
	,\qquad
	\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}}
	= \frac{1}{2}(\mathbf{U}_{i}^{n} + \mathbf{U}_{i+1}^{n})
	+ \frac{1}{2}\frac{\Delta t}{\Delta x}(\mathbf{F}_{i}^{n} - \mathbf{F}_{i+1}^{n}) 
	\end{align}

This scheme is known as the two-step Richtmyer version of the Lax-Wendroff method, as applied to non-linear systems of conservatioin laws :math:`\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = 0` . No mention of the Riemann problem solution is necessary here.

.. note:: 

	Note the similarities between the reinterpretations and generalisations of the Lax-Friedrichs and Lax-Wendroff schemes. For both schemes one ends up with two formulations. For the Lax-Friedrichs scheme the weighted-average charater leads to an integral formulation involving the solution of the Riemann problem. The second version of the scheme eliminates the role of the Riemann problem by utilising the integral form of the conservatioin law and leads to the conventional form of the Lax-Friedrichs scheme for non-linear systems. For the Lax-Wendroff method the procedure is entirely analogous. An integral average interpretation leads to a Riemann-problem based extension to non-linear systems. Utilisation of the integral form of the conservation law eliminates the role of the Riemann problem and leads to the conventional Richtmyer version version of the scheme. Both versions of the Lax-Wendroff method have actually been applied in practice.



Upwind Schemes for Linear Systems
-----------------------------------

Here we apply the first-order upwind scheme to hyperbolic systems with constant coefficients

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{A}\mathbf{U}_{x} = \mathbf{0}
	\end{align}

.. note:: 

	We can consider the linearised equations of Gas Dynamics as an example

	.. math::
		\begin{align}
		\mathbf{U}_{t} + \mathbf{A}\mathbf{U}_{x} = \mathbf{0}
		\end{align}

	with

	.. math::
		\begin{align}
		\mathbf{U} = \begin{bmatrix} \rho \\ u \end{bmatrix}
		,\qquad
		\mathbf{A} = \begin{bmatrix} 0 & \rho_{0} \\ a^{2}/\rho_{0} & 0 \end{bmatrix}
		\end{align}


We denote the real eigenvalues of the :math:`m \times m` constant coefficient matrix :math:`\mathbf{A}` by :math:`\lambda_{j}` with :math:`j=1,\cdots,m` and assume they are ordered as

.. math::
	\begin{align}
	\lambda_{1} < \lambda_{2} < \lambda_{3} < \cdots < \lambda_{m}
	\end{align}

The corresponding right eigenvectors are denoted by :math:`\mathbf{K}^{(1)},\mathbf{K}^{(2)},\cdots,\mathbf{K}^{(m)}` . Note here that in general the eigenvalues :math:`\lambda_{j}` can be of any sign and thus a one-sided differencing scheme applied to :math:`\mathbf{U}_{t} + \mathbf{A}\mathbf{U}_{x} = \mathbf{0}` directly will only work if all the eigenvalues are of the same sign. In the general case with eigenvalues of mixed sign, the particular chosen side for the differencing will be upwind for only some of the eigenvalues and downwind for the rest. The difficulty can be resolved by splitting the matrix into two matrices, one of them having positive or zero eigenvalues and the other having negative or zero eigenvalues. From the assumption of hyperbolicity, :math:`\mathbf{A}` may be diagonalised as

.. math::
	\begin{align}
	\mathbf{A} = \mathbf{K}\mathbf{\Lambda}\mathbf{K}^{-1}
	\end{align}

where :math:`\mathbf{K}` is the matrix whose columns are the right eigenvectors :math:`\mathbf{K}^{(k)}` , :math:`\mathbf{K}^{-1}` is the inverse of :math:`\mathbf{K}` and :math:`\mathbf{\Lambda}` is the diagonal matrix formed by the eigenvalues of :math:`\mathbf{A}` , namely

.. math::
	\begin{align}
	\mathbf{\Lambda} = \begin{pmatrix}
	\lambda_{1} & & 0 \\
	 & \ddots & \\
	0 & & \lambda_{m}
	\end{pmatrix}
	\end{align}

In terms of the characteristic variables

.. math::
	\begin{align}
	\mathbf{V} = \mathbf{K}^{-1}\mathbf{U}
	\end{align}

system :math:`\mathbf{U}_{t} + \mathbf{A}\mathbf{U}_{x} = \mathbf{0}` becomes the decoupled system

.. math::
	\begin{align}
	\mathbf{V}_{t} + \mathbf{\Lambda}\mathbf{V}_{x} = \mathbf{0}
	\end{align}

where the :math:`j` -th equation

.. math::
	\begin{align}
	\frac{\partial }{\partial t}v_{j} + \lambda_{j}\frac{\partial }{\partial x}v_{j} = 0, \quad \text{for}~j=1,\cdots,m  
	\end{align}

involves only the variable :math:`v_{j}(x,t)` .


The CIR Scheme
^^^^^^^^^^^^^^^^^

From a numerical point of view the decomposition of :math:`\mathbf{U}_{t} + \mathbf{A}\mathbf{U}_{x} = \mathbf{0}` into the decoupled set :math:`\mathbf{V}_{t} + \mathbf{\Lambda}\mathbf{V}_{x} = \mathbf{0}` with component equations is very convenient. Each component equation is a linear advection equation with characteristic speed :math:`\lambda_{j} = \text{constant}` . The first-order upwind scheme can directly be applied to each component equation. As for the scalar case we introduce the following definitions

.. math::
	\begin{align}
	& \lambda_{j}^{+} := \max(\lambda_{j}, 0) = \frac{1}{2}(\lambda_{j} + |\lambda_{j}|) \\
	& \lambda_{j}^{-} := \min(\lambda_{j}, 0) = \frac{1}{2}(\lambda_{j} - |\lambda_{j}|)
	\end{align}

where :math:`|\lambda_{j}|` is the absolute value of :math:`\lambda_{j}` . The following relations can be easily verified

.. math::
	\begin{align}
	\lambda_{j} = \lambda_{j}^{+} + \lambda_{j}^{-}
	,\qquad
	|\lambda_{j}| = \lambda_{j}^{+} - \lambda_{j}^{-}
	\end{align}

Then, the first-order upwind scheme applied to each PDE in the component equations for the characteristic variables reads

.. math::
	\begin{align}
	(v_{j})_{i}^{n+1} = (v_{j}^{n})_{i}
	- \frac{\Delta t}{\Delta x} \lambda_{j}^{+} \big[ (v_{j})_{i}^{n} - (v_{j})_{i-1}^{n} \big]
	- \frac{\Delta t}{\Delta x} \lambda_{j}^{-} \big[ (v_{j})_{i+1}^{n} - (v_{j})_{i}^{n} \big]
	\end{align}

This is a straight generalisation of the first-order upwind scheme to decoupled linear hyperbolic system :math:`\mathbf{V}_{t} + \mathbf{\Lambda}\mathbf{V}_{x} = \mathbf{0}` .

Based on definitions of :math:`\lambda_{j}^{+},\lambda_{j}^{-}` we can form the positive :math:`\mathbf{\Lambda}^{+}` and negative :math:`\mathbf{\Lambda}^{-}` components of the diagonal matrix :math:`\mathbf{\Lambda}` , namely

.. math::
	\begin{align}
	\mathbf{\Lambda}^{\pm} = \begin{pmatrix}
	\lambda_{1}^{\pm} & & 0 \\
	 & \ddots & \\
	0 & & \lambda_{m}^{\pm}
	\end{pmatrix}
	\end{align}

Property :math:`\mathbf{A} = \mathbf{K}\mathbf{\Lambda}\mathbf{K}^{-1}` allows us to introduce the positive and negative componets of the coefficient matrix :math:`\mathbf{A}` as

.. math::
	\begin{align}
	\mathbf{A}^{-} = \mathbf{K}\mathbf{\Lambda}^{-}\mathbf{K}^{-1}
	,\qquad 
	\mathbf{A}^{+} = \mathbf{K}\mathbf{\Lambda}^{+}\mathbf{K}^{-1}
	\end{align}

The matrices above can be shown to satisfy the following

.. math::
	\begin{align}
	& \mathbf{\Lambda} = \mathbf{\Lambda}^{+} + \mathbf{\Lambda^{-}}
	,\quad
	|\mathbf{\Lambda}| = \mathbf{\Lambda}^{+} - \mathbf{\Lambda^{-}} \\
	& \mathbf{A} = \mathbf{A}^{+} + \mathbf{A}^{-}
	,\quad 
	|\mathbf{A}| = \mathbf{A}^{+} - \mathbf{A}^{-}
	\end{align}

The first-order upwind scheme can be written as

.. math::
	\begin{align}
	\mathbf{V}_{i}^{n+1} = \mathbf{V}_{i}^{n}
	- \frac{\Delta t}{\Delta x} \mathbf{\Lambda}^{+} (\mathbf{V}_{i}^{n} - \mathbf{V}_{i-1}^{n})
	- \frac{\Delta t}{\Delta x} \mathbf{\Lambda}^{-} (\mathbf{V}_{i+1}^{n} - \mathbf{V}_{i}^{n}) 
	\end{align}

In terms of the original variables :math:`\mathbf{U} = \mathbf{K}\mathbf{V}` this scheme may be expressed as

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n}
	- \frac{\Delta t}{\Delta x} \mathbf{A}^{+} \Big( \mathbf{U}_{i}^{n} - \mathbf{U}_{i-1}^{n} \Big)
	- \frac{\Delta t}{\Delta x} \mathbf{A}^{-} \Big( \mathbf{U}_{i+1}^{n} - \mathbf{U}_{i}^{n} \Big)
	\end{align}

This is the generalisation of the first-order upwind scheme to linear hyperbolic systems :math:`\mathbf{U}_{t} + \mathbf{A}\mathbf{U}_{x} = \mathbf{0}` with constant coefficients. Note that by splitting the coefficient matrix :math:`\mathbf{A}` into a positive and a negative component we have been able to retain the basic principle of performing the one-sided spatial differencing according to the sign of the charateristic speeds. The differencing :math:`\mathbf{U}_{i}^{n} - \mathbf{U}_{i-1}^{n}` is upwind for the coefficient matrix :math:`\mathbf{A}^{+}` and :math:`\mathbf{U}_{i+1}^{n} - \mathbf{U}_{i}^{n}` is upwind for the coefficient matrix :math:`\mathbf{A}^{-}` .


Godunov's Method
^^^^^^^^^^^^^^^^^^^

Consider the constant coefficient, linear hyperbolic system written in conservation-law form

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}
	,\qquad
	\mathbf{F}(\mathbf{U}) = \mathbf{A}\mathbf{U}
	\end{align}

The Godunov first-order upwind method utilises the conservative formula and requires the solution :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` of the local Riemann problem :math:`RP(\mathbf{U}_{i}^{n}m, \mathbf{U}_{i+1}^{n})` for the above system to compute the intercell numerical flux

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}\big( \mathbf{U}_{i+\frac{1}{2}}(0) \big)
	\end{align}

Here :math:`\mathbf{U}_{i+\frac{1}{2}}(0)` is the value of the solution :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` at :math:`x/t=0` along the intercell boundary. The solution :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` can be easily found by first expanding the initial data :math:`\mathbf{U}_{i}^{n},\mathbf{U}_{i+1}^{n}` in terms of the right eigenvectors as

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n} = \sum_{j=1}^{m}\alpha_{j}\mathbf{K}^{(j)}
	,\qquad
	\mathbf{U}_{i+1}^{n} = \sum_{j=1}^{m}\beta_{j}\mathbf{K}^{(j)}
	\end{align}

The general solution at any point :math:`(x,t)` is given by

.. math::
	\begin{align}
	\mathbf{U}_{i+\frac{1}{2}}(x/t) = \sum_{j=1}^{I}\beta_{j}\mathbf{K}^{(j)} + \sum_{j=I+1}^{m}\alpha_{j}\mathbf{K}^{(j)}
	\end{align}

where :math:`I` is the largest integer with :math:`1 \le I \le m` such that :math:`x/t \ge \lambda_{I}` . The Godunov flux :math:`\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}(\mathbf{U}_{i+\frac{1}{2}}(0))` requires the solution at :math:`x/t = 0` in the above equation. For :math:`x/t = 0` , :math:`I` is such that :math:`\lambda_{I} \le 0` and :math:`\lambda_{I+1} \ge 0` , then :math:`\mathbf{U}_{i+\frac{1}{2}}(0)` is obtained by manipulating the above equation, namely

.. math::
	\begin{align}
	\mathbf{U}_{i+\frac{1}{2}}(0) = \mathbf{U}_{i}^{n}
	+ \sum_{j=1}^{I}(\beta_{j} - \alpha_{j})\mathbf{K}^{(j)}
	\quad \text{or} \quad
	\mathbf{U}_{i+\frac{1}{2}}(0) = \mathbf{U}_{i+1}^{n}
	- \sum_{j=I+1}^{m}(\beta_{j} - \alpha_{j})\mathbf{K}^{(j)}
	\end{align}

Recall that the jump across wave :math:`j` with eigenvalue :math:`\lambda_{j}` and eigenvector :math:`\mathbf{K}^{(j)}` is given by :math:`(\beta_{j} - \alpha_{j})\mathbf{K}^{(j)}` . Note that the solution of the Riemann problem, at :math:`x/t=0` , as given by :math:`\mathbf{U}_{i+\frac{1}{2}}(0) = \mathbf{U}_{i}^{n} + \sum_{j=1}^{I}(\beta_{j} - \alpha_{j})\mathbf{K}^{(j)}` , can be interpreted as being the left data state :math:`\mathbf{U}_{i}^{n}` plus all wave jumps across waves of negative or zero speed. Similarly, the form :math:`\mathbf{U}_{i+\frac{1}{2}}(0) = \mathbf{U}_{i+1}^{n} - \sum_{j=I+1}^{m}(\beta_{j} - \alpha_{j})\mathbf{K}^{(j)}` gives the solution as the right data state :math:`\mathbf{U}_{i+1}^{n}` minus the wave jumps across all waves of positive or zero speeds. By combining the above two equation we obtain

.. math::
	\begin{align}
	\mathbf{U}_{i+\frac{1}{2}}(0)
	= \frac{1}{2}(\mathbf{U}_{i}^{n} + \mathbf{U}_{i+1}^{n})
	- \frac{1}{2}\sum_{j=1}^{m}\operatorname{sign}(\lambda_{j})(\beta_{j} - \alpha_{j}) \mathbf{K}^{(j)}
	\end{align}

The Godunov intercell numerical flux :math:`\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}\big(\mathbf{U}_{i+\frac{1}{2}}(0)\big)` can now be obtained by  evaluating :math:`\mathbf{F}(\mathbf{U})` at any of the three expressions above for the solution of the Riemann problem. Use of :math:`\mathbf{U}_{i+\frac{1}{2}}(0) = \mathbf{U}_{i}^{n} + \sum_{j=1}^{I}(\beta_{j} - \alpha_{j})\mathbf{K}^{(j)}` gives

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{i}^{n} + \sum_{j=1}^{I} \mathbf{A}(\beta_{j} - \alpha_{j})\mathbf{K}^{(j)}
	\end{align}

and since :math:`\mathbf{A}\mathbf{K}^{(j)} = \lambda_{j}\mathbf{K}^{(j)}` , we get

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{i}^{n} + \sum_{j=1}^{I} (\beta_{j} - \alpha_{j})\lambda_{j}\mathbf{K}^{(j)}
	\end{align}

Similarly, the second expression gives

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{i+1}^{n} - \sum_{j=I+1}^{m}(\beta_{j}-\alpha_{j})\lambda_{j}\mathbf{K}^{(j)}
	\end{align}

or combining the above two results we obtain

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}}
	= \frac{1}{2}(\mathbf{F}_{i}^{n} + \mathbf{F}_{i+1}^{n})
	- \frac{1}{2}\sum_{j=1}^{m}(\beta_{j} - \alpha_{j}) |\lambda_{j}| \mathbf{K}^{(j)}  
	\end{align}

Now we show that the Godunov flux can also be expressed in two more alternative forms. Starting from the above equation we can get

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} &= \frac{1}{2}(\mathbf{F}_{i}^{n} + \mathbf{F}_{i+1}^{n}) - \frac{1}{2}\sum_{j=1}^{m}(\beta_{j}-\alpha_{j})(\lambda_{j}^{+} - \lambda_{j}^{-})\mathbf{K}^{(j)} \\
	&= \frac{1}{2}(\mathbf{F}_{i}^{n} + \mathbf{F}_{i+1}^{n}) - \frac{1}{2}\sum_{j=1}^{m}(\beta_{j}-\alpha_{j}) \Big[ \lambda_{j}^{+}\mathbf{K}^{(j)} - \lambda_{j}^{-}\mathbf{K}^{(j)} \Big] \\
	&= \frac{1}{2}(\mathbf{F}_{i}^{n} + \mathbf{F}_{i+1}^{n}) - \frac{1}{2}\sum_{j=1}^{m}(\beta_{j}-\alpha_{j}) \Big[ \mathbf{A}^{+}\mathbf{K}^{(j)} - \mathbf{A}^{-}\mathbf{K}^{(j)} \Big] \\
	&= \frac{1}{2}(\mathbf{F}_{i}^{n} + \mathbf{F}_{i+1}^{n}) - \frac{1}{2}\sum_{j=1}^{m}(\beta_{j}-\alpha_{j}) (\mathbf{A}^{+} - \mathbf{A}^{-}) \mathbf{K}^{(j)} \\
	&= \frac{1}{2}(\mathbf{F}_{i}^{n} + \mathbf{F}_{i+1}^{n}) - \frac{1}{2}|\mathbf{A}| \sum_{j=1}^{m} (\beta_{j}-\alpha_{j}) \mathbf{K}^{(j)}
	\end{align}

Hence we get another form of the Godunov flux

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \frac{1}{2}(\mathbf{F}_{i}^{n} + \mathbf{F}_{i+1}^{n}) - \frac{1}{2}|\mathbf{A}| (\mathbf{U}_{i+1}^{n} - \mathbf{U}_{i}^{n})
	\end{align}

Another Godunov flux in flux-split form follows directly from manupulating the above result and using appropriate definitions. Alternatively we have

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} &= \mathbf{A}\mathbf{U}_{i+\frac{1}{2}}(0)
	= \sum_{j=1}^{I} \beta_{j}\mathbf{A}\mathbf{K}^{(j)} + \sum_{j=I+1}^{m}\alpha_{j}\mathbf{A}\mathbf{K}^{(j)} \\
	&= \sum_{j=1}^{I} \beta_{j}\lambda_{j}\mathbf{K}^{(j)} + \sum_{j=I+1}^{m}\alpha_{j}\lambda_{j}\mathbf{K}^{(j)} 
	= \sum_{j=1}^{m}\beta_{j}\lambda_{j}^{-}\mathbf{K}^{(j)} + \sum_{j=1}^{m}\alpha_{j}\lambda_{j}^{+}\mathbf{K}^{(j)} \\
	&= \sum_{j=1}^{m}\beta_{j}\mathbf{A}^{-}\mathbf{K}^{(j)} + \sum_{j=1}^{m} \alpha_{j}\mathbf{A}^{+}\mathbf{K}^{(j)}
	= \mathbf{A}^{+} \sum_{j=1}^{m}\alpha_{j}\mathbf{K}^{(j)} + \mathbf{A}^{-}\sum_{j=1}^{m}\beta_{i}\mathbf{K}^{(j)} \\
	&= \mathbf{A}^{+} \mathbf{U}_{i}^{n} + \mathbf{A}^{-}\mathbf{U}_{i+1}^{n}
	\end{align}


.. note:: 

	The intercell flux has been split as 

	.. math::
		\begin{align}
		\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{i+\frac{1}{2}}^{+} + \mathbf{F}_{i+\frac{1}{2}}^{-}
		\end{align}

	where the positive :math:`\mathbf{F}_{i+\frac{1}{2}}^{+}` and negative :math:`\mathbf{F}_{i+\frac{1}{2}}^{-}` flux components are

	.. math::
		\begin{align}
		\mathbf{F}_{i+\frac{1}{2}}^{+} = \mathbf{A}^{+}\mathbf{U}_{i}^{n}
		,\quad
		\mathbf{F}_{i+\frac{1}{2}}^{-} = \mathbf{A}^{-}\mathbf{U}_{i}^{n}
		\end{align}

	Note that, trivially, the respective Jacobian matrices have eigenvalues that are all positive (or zero) and all negative (or zero).


The Method of Godunov for Non-linear Systems
==============================================


Bases of Godunov's Method
----------------------------

Consider the general Initial-Boundary Value Problem(IBVP) for non-linear systems of hyperbolic conservation laws

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = 0 \\
	& \mathbf{U}(x,0) = \mathbf{U}^{(0)}(x) \\
	& \mathbf{U}(0,t) = \mathbf{U}_{l}(t) , \quad \mathbf{U}(L,t) = \mathbf{U}_{r}(t)
	\end{align}

Here, :math:`\mathbf{U}(x,t)` is the vector of conserved variables; :math:`\mathbf{F}(\mathbf{U})` is the vector of fluxes; :math:`\mathbf{U}^{(0)}(x)` is the initial data at time :math:`t=0` ; :math:`[0,L]` is the spatial domain and boundary conditions are, for the moment, assumed to be represented by the boundary functions :math:`\mathbf{U}_{l}(t)` and :math:`\mathbf{U}_{r}(t)` . We make the assumption that the solution of the IVBP does exist.

In order to admit discontinuous solutions we must use one of the integral forms of the conservation laws. Here we adopt

.. math::
	\begin{align}
	\int_{x_{1}}^{x_{2}} \mathbf{U}(x,t_{2})\mathrm{d}x
	= \int_{x_{1}}^{x_{2}} \mathbf{U}(x,t_{1})\mathrm{d}x
	+ \int_{t_{1}}^{t_{2}} \mathbf{F}\big(\mathbf{U}(x_{1},t)\big)\mathrm{d}t
	- \int_{t_{1}}^{t_{2}} \mathbf{F}\big(\mathbf{U}(x_{2},t)\big)\mathrm{d}t
	\end{align}

for any control volume :math:`[x_{1},x_{2}] \times [t_{1},t_{2}]` in the domain of interest. We discretise the spatial domain :math:`[0,L]` into :math:`M` computing cells or finite volumes :math:`I_{i} = [x_{i-\frac{1}{2}}, x_{i+\frac{1}{2}}]` of regular size :math:`\Delta x = x_{i+\frac{1}{2}} - x_{i-\frac{1}{2}} = L/M` , with :math:`i = 1,\cdots,M` . For a given cell :math:`I_{i}` the location of the cell center :math:`x_{i}` and the cell boundaries :math:`x_{i-\frac{1}{2}}, x_{i+\frac{1}{2}}` are given by

.. math::
	\begin{align}
	x_{i-\frac{1}{2}} = (i-1)\Delta x
	,\quad
	x_{i} = (i-\frac{1}{2})\Delta x
	,\quad
	x_{i+\frac{1}{2}} = i\Delta x
	\end{align}

We denote the temporal domain by :math:`[0,T]` , where :math:`T` is some output time, not a boundary. The discretisation of the time interval :math:`[0,T]` is generally done in time steps :math:`\Delta t` of variable size; recall that of non-linear systems wave speeds vary in space and time, and thus the choice of :math:`\Delta t` is carried out as marching in time proceeds. Given general initial data :math:`\tilde{\mathbf{U}}(x,t^{n})` for the conservation laws at time :math:`t=t^{n}` say, in order to evolve the solution to a time :math:`t^{n+1} = t^{n} + \Delta t` , the Godunov method first assumes a piece-wise constant distribution of the data. Formally, this is realised by defining cell averages.

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n} = \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{\mathbf{U}}(x,t^{n})~\mathrm{d}x
	\end{align}

which produces the desired piecewise constant distribution :math:`\mathbf{U}(x,t^{n})` , with

.. math::
	\begin{align}
	\mathbf{U}(x,t^{n}) = \mathbf{U}_{i}^{n} ,\quad \text{for}~x~\text{in each cell}~I_{i} = [x_{i-\frac{1}{2}}, x_{i+\frac{1}{2}}]
	\end{align}

Data now consists of a set :math:`\{ \mathbf{U}_{i}^{n} \}` of constant states. Naturally these are in terms of conserved variables, but other variables may be derived to proceed with the implementation of numerical methods. In particular, for the Godunov method we use the solution of the Riemann problem in terms of primitive variables, which for the Euler equation are :math:`\mathbf{W} = (\rho, u, p)^{T}` ; :math:`\rho` is density, :math:`u` is velocity and :math:`p` is pressure.

Once the piece-wise constant distribution of data has been established, the next step in the Godunov method is to solve the Initial Value Problem(IVP) for the original conservation laws but with the modified initial data :math:`\mathbf{U}(x,t^{n}) = \mathbf{U}_{i}^{n}` . Effectively, this generates local Riemann problems :math:`RP(\mathbf{U}_{i}^{n}, \mathbf{U}_{i+1}^{n})` with data :math:`\mathbf{U}_{i}` (left side) and :math:`\mathbf{U}_{n+1}^{n}` (right side), centred at the intercell boundary position :math:`x_{i+\frac{1}{2}}` . The solution of :math:`RP(\mathbf{U}_{i}^{n}, \mathbf{U}_{i+1}^{n})` is a similarity solution and depends on the ratio :math:`\bar{x}/\bar{t}` , and the data states :math:`\mathbf{U}_{i}^{n},\mathbf{U}_{i+1}^{n}` ; the solution is denoted by :math:`\mathbf{U}_{i+\frac{1}{2}}(\bar{x}/\bar{t})` , where :math:`(\bar{x}, \bar{t})` are the local coordinates for the local Riemann problem. Fig.6.2 shows typical wave patterns emerging from intercell boundaries :math:`x_{i-\frac{1}{2}}` and :math:`x_{i+\frac{1}{2}}` when solving the two Riemann problems :math:`RP(\mathbf{U}_{i-1}^{n}, \mathbf{U}_{i}^{n})` and :math:`RP(\mathbf{U}_{i}^{n}, \mathbf{U}_{i+1}^{n})` . For a time step :math:`\Delta t` that is sufficiently small, to avoid wave interaction, one can define a global solution :math:`\tilde{\mathbf{U}}(x,t)` in the strip :math:`0 \le x \le L` ， :math:`t^{n} \le t \le t^{n+1}` in terms of the local solutions as follows

.. math::
	\begin{align}
	\tilde{\mathbf{U}}(x,t) = \mathbf{U}_{i+\frac{1}{2}}(\bar{x}/\bar{t}) , \quad x\in [x_{i}, x_{i+1}]
	\end{align}

where the correspondence between the global :math:`(x,t)` and local :math:`(\bar{x}, \bar{t})` coordinates is given by

.. math::
	\begin{align}
	& \bar{x} = x - x_{i+\frac{1}{2}} ,\quad \bar{t} = t - t^{n} \\
	& x \in [x_{i}, x_{i+1}] ,\quad t \in [t^{n}, t^{n+1}] \\
	& \bar{x} \in [-\frac{\Delta x}{2}, \frac{\Delta x}{2}] ,\quad \bar{t} \in [0, \Delta t]
	\end{align}

Having found a solution :math:`\tilde{U}(x,t)` in terms of solutions :math:`\mathbf{U}_{i+\frac{1}{2}}(\bar{x}/\bar{t})` to local Riemann problems, the Godunov method advances the solution to a time :math:`t^{n+1} = t^{n} + \Delta t` by defining a new set of average values :math:`\{ \mathbf{U}_{i}^{n+1} \}` , in a way to be described. We shall often use :math:`(x,t)` to mean the local frame of reference :math:`(\bar{x}, \bar{t})` .

The Godunov Scheme
--------------------

The first version of Godunov's method defines new average values :math:`\mathbf{U}_{i}^{n+1}` at time :math:`t^{n+1} = t^{n} + \Delta t` via the integrals

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{\mathbf{U}}(x,t^{n+1})\mathrm{d}x
	\end{align}

within each cell :math:`I_{i} = [x_{i-\frac{1}{2}}, x_{i+\frac{1}{2}}]` . 

Note first that in order to perform the averaging, we need to make the assumption that no wave interaction takes place within cell :math:`I_{i}` , in the chosen time :math:`\Delta t` . This is satisfied by impoing the following restriction on the size of :math:`\Delta t` , namely

.. math::
	\begin{align}
	\Delta t \le \frac{\frac{1}{2}\Delta x}{S_{\max}^{n}} 
	\end{align}

where :math:`S_{\max}^{n}` denotes the maximum wave velocity present throughout the domain at time :math:`t^{n}` . A consequence of this restriction is that only two Riemann problem solutions affect cell :math:`I_{i}` , namely the right travelling waves of :math:`\mathbf{U}_{i-\frac{1}{2}}(x/t)` and the left travelling waves of :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` . Thus :math:`\mathbf{U}_{i}^{n+1}` can be expressed as

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1}
	= \frac{1}{\Delta x} \int_{0}^{\frac{1}{2}\Delta x} \mathbf{U}_{i-\frac{1}{2}}\big(\frac{x}{\Delta t}\big)\mathrm{d}x
	+ \frac{1}{\Delta x} \int_{-\frac{1}{2}\Delta x}^{0} \mathbf{U}_{i+\frac{1}{2}}\big(\frac{x}{\Delta t}\big)\mathrm{d}x
	\end{align}


This version of Godunov's method can obviously be implemented as a practical computational scheme. We note however that it has two main drawbacks. First, the CFL-like condition is computationally somewhat restrictive on :math:`\Delta t` . Second, the evaluation of the integrals in the above equation, although possible, could be involved. Rarefaction waves are bound to add to the complexity of the scheme. The second version of Godunov's method is more attractive and is given by the following statement.

We will show that the Godunov method can be written in conservative form

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1}
	= \mathbf{U}_{i}^{n}
	+ \frac{\Delta t}{\Delta x}\Big( \mathbf{F}_{i-\frac{1}{2}} - \mathbf{F}_{i+\frac{1}{2}} \Big) 
	\end{align}

with intercell numerical flux given by

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}\big(\mathbf{U}_{i+\frac{1}{2}}(0)\big)
	\end{align}

if the time step :math:`\Delta t` satisfies the condition

.. math::
	\begin{align}
	\Delta t \le \frac{\Delta x}{S_{\max}^{n}} 
	\end{align}

To prove it, we should realize that the integrand :math:`\tilde{\mathbf{U}}(x,t)` is an exact solution of the conservation laws. We can therefore apply the integral form of the conservation laws to any control volume :math:`[x_{1}, x_{2}] \times [t_{1}, t_{2}]` . In particular, we can apply it to the case in which :math:`x_{1} = x_{i-\frac{1}{2}}` ， :math:`x_{2} = x_{i+\frac{1}{2}}` ， :math:`t_{1} = t^{n}` ， :math:`t_{2} = t^{n+1}` . From :math:`\mathbf{U}_{i}^{n} = \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{\mathbf{U}}(x,t^{n})\mathrm{d}x` we then have

.. math::
	\begin{align}
	\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{\mathbf{U}}(x,t^{n+1})~\mathrm{d}x
	= \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{\mathbf{U}}(x,t^{n})~\mathrm{d}x
	+ \int_{0}^{\Delta t} \mathbf{F}[\tilde{\mathbf{U}}(x_{i-\frac{1}{2}},t)]~\mathrm{d}t
	- \int_{0}^{\Delta t} \mathbf{F}[\tilde{\mathbf{U}}(x_{i+\frac{1}{2}},t)]~\mathrm{d}t
	\end{align}

In terms of local solutions, and assuming condition :math:`\Delta t \le \Delta x / S_{\max}^{n}` , we have

.. math::
	\begin{align}
	& \tilde{\mathbf{U}}(x_{i-\frac{1}{2}},t) = \mathbf{U}_{i-\frac{1}{2}}(0) = \text{constant} \\
	& \tilde{\mathbf{U}}(x_{i+\frac{1}{2}},t) = \mathbf{U}_{i+\frac{1}{2}}(0) = \text{constant}
	\end{align}

where :math:`\mathbf{U}_{i+\frac{1}{2}}(0)` is the solution of the Riemann problem :math:`RP(\mathbf{U}_{i}^{n}, \mathbf{U}_{i+1}^{n})` along the ray :math:`x/t=0` , which is the t-axis in the local frame. Similarly, :math:`\mathbf{U}_{i-\frac{1}{2}}(0)` is the solution of :math:`RP(\mathbf{U}_{i-1}^{n}, \mathbf{U}_{i}^{n})` along the t-axis. Division of the above equation we got through by :math:`\Delta x` gives

.. math::
	\begin{align}
	\frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{\mathbf{U}}(x,t^{n+1})\mathrm{d}x
	= \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{\mathbf{U}}(x,t^{n})\mathrm{d}x
	+ \frac{\Delta t}{\Delta x} \Big[ \mathbf{F}\big( \mathbf{U}_{i-\frac{1}{2}}(0) \big) - \mathbf{F}\big( \mathbf{U}_{i+\frac{1}{2}}(0) \big) \Big]
	\end{align}

which by virtue of :math:`\mathbf{U}_{i}^{n} = \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \tilde{\mathbf{U}}(x,t^{n})~\mathrm{d}x` and :math:`\tilde{\mathbf{U}}(x_{i-\frac{1}{2}},t) = \mathbf{U}_{i-\frac{1}{2}}(0) = \text{constant}` ， :math:`\tilde{\mathbf{U}}(x_{i+\frac{1}{2}},t) = \mathbf{U}_{i+\frac{1}{2}}(0) = \text{constant}` leads to the desired result what we want, and thus the proposition has been proved.

.. note:: 

	- The CFL condition :math:`\Delta t \le \Delta x / S_{\max}^{n}` for the second version of the Godunov method is more generous than  :math:`\Delta t \le \frac{1}{2}\Delta x / S_{\max}^{n}` , thus allowing a larger time step. This in turn results in a more efficient time-marching scheme. Here a wave is allowed to travel, at most, a complete cell length :math:`\Delta x` in a time :math:`\Delta t` .
	- Condition :math:`\Delta t \le \Delta x / S_{\max}^{n}` remians valid even if wave interaction takes place intime :math:`\Delta t` within cell :math:`I_{i}` , under the assumption that no wave acceleration takes place as a consequence of wave interaction; this is a kind of linearity assumption. Condition :math:`\Delta t \le \Delta x / S_{\max}^{n}` is necessary in the result equation when computing the fluxes along the left and right intercell boundaries.
	- The second version of the Godunov method is the on that is used for practical computations.


Godunov's Method for the Euler Equations
-------------------------------------------

Here we describe Godunov's method for the specific case of the time-dependent, one-dimensional Euler equations. As data :math:`\{ \mathbf{U}_{i}^{n} \}` at time level :math:`n` is assumed, in order to march the solution to time level :math:`n+1` via the conservative formular, we need to compute the intercell fluxes :math:`\mathbf{F}_{i-\frac{1}{2}}` and :math:`\mathbf{F}_{i+\frac{1}{2}}` .

Evaluation of the Intercell Fluxes
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

For a generic cell interface at :math:`x_{i+\frac{1}{2}}` we compute the Godunov flux :math:`\mathbf{F}_{i+\frac{1}{2}}` according to :math:`\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}\big( \mathbf{U}_{i+\frac{1}{2}}(0) \big)` . We therefore require the solution :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` of the Riemann problem :math:`RP(\mathbf{U}_{i}^{n}, \mathbf{U}_{i+1}^{n})` evaluated at the point :math:`S = x/t = 0` .

The complete exact solution to a general Riemann problem :math:`RP(\mathbf{U}_{i}^{n}, \mathbf{U}_{i+1}^{n})` for the Euler equations requires the identification of ten possible wave patterns. Before we considered the five sub-cases arising from the case in which the sampling point :math:`S` lies to the left of the contact discontinuity. There is an analogous flow chart for the five sub-cases arising from the case in which the sampling point :math:`S` lies to the right of the contact discontinuity. For the Godunov method the sampling is performed for the special value :math:`S = x/t = 0` . Unfortunately, this does not simplify the sampling procedure and all ten possible wave patterns must be taken into account. Recall that in our convention a shock is a single thick ray, a contact is a dashed line and a rarefaction wave is obviously a fan. A wave of unknown character is represented by a pair of rays emanating from the origin. There are two situations, each of which has five cases, namely:

- :math:`0 \le u_{*}` (positive particle speed in the Star Region)
- :math:`0 \ge u_{*}` (negative particle speed in the Star Region)
 
The sampled value :math:`\mathbf{W}_{i+\frac{1}{2}}(0)` needed for evaluating the Godunov flux is given below for all ten possible wave patterns. Consider for example the situation in which :math:`u_{*}` is positive. In order to compute correctly the value :math:`\mathbf{W}_{i+\frac{1}{2}}(0)` along the t-axis (left of contact) we must identify the character of the left wave. This can be a shock or a rarefaction. If the left wave is a shock wave, we compute the state :math:`\mathbf{W}_{*L}` between the left shock and the contact using shock relations. Then the speed :math:`S_{L}` of the left shock is computed. This then allows us to test whether the shock speed is positive (supersonic flow) or negative (subsonic flow). If :math:`S_{L} \ge 0` then

.. math::
	\begin{align}
	\mathbf{W}_{i+\frac{1}{2}}(0) = \mathbf{W}_{L}
	\end{align}

If :math:`S_{L} \le 0` then

.. math::
	\begin{align}
	\mathbf{W}_{i+\frac{1}{2}}(0) = \mathbf{W}_{*L}
	\end{align}

+----------+---------------------------------------+---------------------------------------+
| Sub-case | Case(a): positive speed :math:`u_{*}` | Case(b): negative speed :math:`u_{*}` |
+==========+=======================================+=======================================+
| 1        | :math:`\mathbf{W}_{L}`                | :math:`\mathbf{W}_{R}`                |
+----------+---------------------------------------+---------------------------------------+
| 2        | :math:`\mathbf{W}_{*L}`               | :math:`\mathbf{W}_{*R}`               |
+----------+---------------------------------------+---------------------------------------+
| 3        | :math:`\mathbf{W}_{L}`                | :math:`\mathbf{W}_{R}`                |
+----------+---------------------------------------+---------------------------------------+
| 4        | :math:`\mathbf{W}_{*L}`               | :math:`\mathbf{W}_{*R}`               |
+----------+---------------------------------------+---------------------------------------+
| 5        | :math:`\mathbf{W}_{Lfan}`             | :math:`\mathbf{W}_{Rfan}`             |
+----------+---------------------------------------+---------------------------------------+


Havign identified the desired value :math:`\mathbf{W}_{i+\frac{1}{2}}(0)` , the intercell becomes

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}\big( \mathbf{W}_{i+\frac{1}{2}}(0) \big)
	\end{align}



Time Step Size
^^^^^^^^^^^^^^^^^

So far we know how to compute the intercell flux to be used in the conservative formula. The spatial discretisation length :math:`\Delta x` is chosen on desired accuracy or available computing resources. What remains to be determined in the conservative formula is the size of the time step :math:`\Delta t` . This is based on the condition :math:`\Delta t \le \Delta x / S_{\max}^{n}` . The time step is then given by

.. math::
	\begin{align}
	\Delta t = \frac{C_{cfl}\Delta x}{S_{\max}^{n}}
	\end{align}

Here :math:`C_{cfl}` is a Courant or CFL coefficient satisfying

.. math::
	\begin{align}
	0 < C_{cfl} < 1
	\end{align}

The closer the coefficient :math:`C_{cfl}` is to :math:`1` , the more efficient the time marching scheme is. :math:`S_{\max}^{n}` is the largest wave speed present through out the domain at time level :math:`n` . This means that no wave present in the solution of all Riemann problems travels more than a distance :math:`\Delta x` in time :math:`\Delta t` . As discussed before in the context of simple problems, there are various ways of estimating :math:`\mathbf{S}_{\max}^{n}` . For the time-dependent, one dimensional Euler equations a reliable choice is

.. math::
	\begin{align}
	S_{\max}^{n} = \max_{i} \Big\{ |S_{i+\frac{1}{2}}^{L}| , |S_{i+\frac{1}{2}}^{R}| \Big\}
	\end{align}

for :math:`i = 0,\cdots,M` , where :math:`S_{i+\frac{1}{2}}^{L},S_{i+\frac{1}{2}}^{R}` are the wave speeds of the left and right non-linear waves present in the solution of the Riemann problem :math:`RP(\mathbf{U}_{i}^{n}, \mathbf{U}_{i+1}^{n})` . Recall that this Riemann problem generates three waves; the fastest are the non-linear waves, which can be shocks or rarefactions. For rarefaction waves one selects the speed of the head. For shock waves one selects the shock speed, naturally.

.. note:: Note that in sampling the wave speeds one must include the boundaries, as these might generate large wave speeds.

Using :math:`S_{\max}^{n} = \max_{i} \Big\{ |S_{i+\frac{1}{2}}^{L}| , |S_{i+\frac{1}{2}}^{R}| \Big\}` to find :math:`S_{\max}^{n}` and thus :math:`\Delta t` according to :math:`C_{cfl}\Delta x / S_{\max}^{n}` , is a simple and very reliable procedure. As the local solutions of Riemann problems are available for flux evaluation, it is just a question of using this information to find :math:`\Delta t` as well. 

.. attention:: For multi-dimensional problems however, this scheme for estimating the maximum wave speed is unsuitable.


A popular alternative for estimating :math:`S_{\max}^{n}` , whick extends to multi-dimensional problems, is

.. math::
	\begin{align}
	S_{\max}^{n} = \max_{i}\Big\{ |u_{i}^{n}| + a_{i}^{n} \Big\}
	\end{align}

Only data values for the particle velocity :math:`u_{i}^{n}` and sound speed :math:`a_{i}^{n}` are used here. It is not difficult to see however that the above equation can lead to an underestimate of :math:`S_{\max}^{n}` . For instance, assume shock-tube data in which the flow is stationary at time :math:`t=0` . Then :math:`u_{i}^{n}=0` and the sound speed is the only contribution to :math:`S_{\max}^{n}` . Underestimating :math:`S_{\max}^{n}` results in a choice of :math:`\Delta t` that is too large and instabilities may be developed from the beginning of the computations. A possible way of remedying this, is by choosing the CFL coefficient :math:`C_{cfl}` cautiously. If :math:`S_{\max}^{n}` is known reliably then the choice :math:`C_{cfl}=1` is probably adequate, although this implies that waves pass through each other without acceleration, which is a kind of linearity assumption. A practical choice is :math:`C_{cfl} = 0.9` . If there are uncertainties in the estimate for :math:`S_{\max}^{n}` , a more conservative choice for :math:`C_{cfl}` is advised. In spite of the alluded disadvantages of choice :math:`S_{\max}^{n} = \max_{i}\Big\{ |u_{i}^{n}| + a_{i}^{n} \Big\}` , it provides a practical approach when computing solutions to multi-dimensional problems.


Boundary Conditions
^^^^^^^^^^^^^^^^^^^^^

For a domain :math:`[0,L]` discretised into :math:`M` computing cells of length :math:`\Delta x` , we need boundary conditions at the boundaries :math:`x=0` and :math:`x=L` . Numerically, such boundary conditions are expected to provide numerical fluxes :math:`\mathbf{F}_{\frac{1}{2}}` and :math:`\mathbf{F}_{M+\frac{1}{2}}` . These are required in order to apply the conservative formular to update the extreme cells :math:`I_{1}` and :math:`I_{M}` to the next time level :math:`n+1` . The boundary conditions may result in direct prescription of :math:`\mathbf{F}_{\frac{1}{2}}` and :math:`\mathbf{F}_{M+\frac{1}{2}}` . Alternatively, we may prescribe fictitous data values in the fictitous cell :math:`I_{0}` and :math:`I_{M+1}` , adjacent to :math:`I_{1}` and :math:`I_{M}` respectively. In this way, boundary Riemann problems :math:`RP(\mathbf{U}_{0}^{n}, \mathbf{U}_{1}^{n})` and :math:`RP(\mathbf{U}_{M}^{n}, \mathbf{U}_{M+1}^{n})` are solved and the corresponding Godunov fluxes :math:`\mathbf{F}_{\frac{1}{2}}` and :math:`\mathbf{F}_{M+\frac{1}{2}}` are computed, as done for the interior cells. The imposition of boundary conditions is, fundamentally, a physical problem. Great care is required in their numerical implementation. For the Godunov method this tasts to be facilitated by the fact that local Riemann problem solutions are used. Here we consider only two types of boundaries: reflective and transparent or transmissive.


Reflective Boundaries
""""""""""""""""""""""""

Consider the boundary at :math:`x=L` and suppose it physically consists of a fixed, reflective impermeable wall. Then the physical situation is correcly modelled by creating a fictitious state :math:`\mathbf{W}_{M+1}^{n}` on the right hand side of the boundary and defining the boundary Riemann problem :math:`RP(\mathbf{W}_{M}^{n}, \mathbf{W}_{M+1}^{n})` . The fictitious state :math:`\mathbf{W}_{M+1}^{n}` is defined from the known state :math:`\mathbf{W}_{M}^{n}` inside the computational domain, namely

.. math::
	\begin{align}
	\rho_{M+1}^{n} = \rho_{M}^{n}
	,\quad
	u_{M+1}^{n} = - u_{M}^{n}
	,\quad
	p_{M+1}^{n} = p_{M}^{n}
	\end{align}

The exact solution of this boundary Riemann problem consists of either (1) two shock waves if :math:`u_{M}^{n} > 0` or (2) two rarefaction waves if :math:`u_{M}^{n} \le 0` . In both cases :math:`u_{*} = 0` along the boundary; this is the desired condition at the solid, fixed impermeable boundary. Consequently, the only non-zero contribution to the flux vector at the boundary is in the momentum component and is due to the pressure :math:`p_{*}` corresponding to :math:`u_{*} = 0` . In both cases the solution can be obtained in closed form, no iteration is required. As a matter of fact, a closed-form solution exists for the more general case in which the fluid under consideration obeys the covolume equation of state and the impermeable wall moves with a prescribed speed :math:`u_{wall}` . The boundary conditions are

.. math::
	\begin{align}
	\rho_{M+1}^{n} = \rho_{M}^{n}
	,\quad
	u_{M+1}^{n} = - u_{M}^{n} + 2 u_{wall}
	,\quad
	p_{M+1}^{n} = p_{M}^{n}
	\end{align}

The exact solution of the Riemann problem :math:`RP(\mathbf{W}_{M}^{n}, \mathbf{W}_{M+1}^{n})` containing a moving boundary is symmetric about the path of the moving wall and consists of either two shocks or two rarefactions, with the contact wave coinciding with the moving wall.

We now find the exact solution for :math:`p_{*}` and :math:`u_{*}` in the moving-wall Riemann problem. From the analysis of the exact function for pressure, it is seen that if :math:`\Delta u = -2(u_{M} - u_{wall}) = 0` , that is :math:`u_{M} = u_{wall}` , then the solution :math:`p_{*}` for pressure at the boundary is :math:`p_{*} = p_{M} = p_{M+1}` . For :math:`\Delta u > 0` we have :math:`p_{*} < p_{M} = p_{M+1}` , that is, the solution consists of two rarefaction waves. For :math:`\Delta u < 0` we have :math:`p_{*} > p_{M} = p_{M+1}` and the solution consists of two shocks. For the case of two rarefaction waves, :math:`u_{M} < u_{wall}` , direct utilisation of the data in the pressure function :math:`f(p)=0` gives

.. math::
	\begin{align}
	p_{*} = p_{M} \bigg[ 1 + \frac{1}{2}(\gamma - 1) \Big( \frac{C_{M}}{a_{M}} \Big) \bigg]^{\frac{2\gamma}{\gamma - 1}}
	\end{align}

For the case of two shocks, :math:`u_{M} > u_{wall}` , we have

.. math::
	\begin{align}
	p^{*} = p_{M} + \frac{C_{M}}{2A_{M}} \bigg\{ C_{M} + \Big[ C_{M}^{2} + 4A_{M}(B_{M} + p_{M}) \Big]^{\frac{1}{2}} \bigg\}
	\end{align}

where

.. math::
	\begin{align}
	A_{M} = \frac{2}{(\gamma + 1)\rho_{M}}
	,\quad
	B_{M} = \frac{\gamma - 1}{\gamma +1}p_{M}
	,\quad
	C_{M} = u_{M} - u_{wall}
	\end{align}

As anticipated, the solution for the velocity :math:`u_{*}` in both cases is found to be

.. math::
	\begin{align}
	u_{*} = u_{wall}
	\end{align}

These closd-form solutions for the pressure and velocity at the boundary (fixed or moving) can also be utilised in the Godunov method even when this is used in conjuncion with approximte Riemann solvers, particularly if these are thought to be inaccurate for boundary data Riemann problems.


Transmissive Boundaries
""""""""""""""""""""""""""

Transmissive, or transparent boundaries arise from the need to define finite, or sufficiently small, computational domains. The corresponding boundary conditions are a numerical attempt to produce boundaries that allow the passage of waves without any effect on them. For one-dimensional problems the objective is reasonably well attained. For multi-dimensional problems this is a substantial area of current research, usually referred to as open-end boundary conditions, transparent boundary conditions, far-field boundary conditions, radiation boundary conditions or non-reflecting boundary conditions. For a transmissive right boundary we suggest the boundary conditions


.. math::
	\begin{align}
	\rho_{M+1}^{n} = \rho_{M}^{n}
	,\quad
	u_{M+1}^{n} = u_{M}^{n}
	,\quad
	p_{M+1}^{n} = p_{M}^{n}
	\end{align}

This data produces a trivial Riemann problem. No wave of finite strength is produced at the boundary that may affect the flow inside the domain.

For an assumed mesh of size :math:`\Delta x` , we have defined all details for the practical implementation of the Godunov method. These are (1) intercell fluxes; (2) the maximum wave speed :math:`S_{\max}^{n}` to compute the time step size :math:`\Delta t` ; (3) boundary conditions.

.. note:: The wave speeds generated at the boundaries, after applying boundary conditions, must be taken into account when selecting the time step :math:`\Delta t` .




Random Choice and Related Methods
====================================


RCM on a Non-Staggered Grid
------------------------------

We consider the general Initial Boundary Value Problem (IBVP) for non-linear systems of hyperbolic conservation laws, namely

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \mathbf{U}^{(0)}(x) \\
	& \mathbf{U}(0,t) = \mathbf{U}_{l}(t) ,\quad \mathbf{U}(L,t) = \mathbf{U}_{r}(t)
	\end{align}

We assume a solution to this IBVP exists. Here :math:`\mathbf{U}(x,t)` is the vector of conserved variables, :math:`\mathbf{F}(\mathbf{U})` is the vector of fluxes, :math:`\mathbf{U}^{(0)}(x)` is the initial data at time :math:`t = 0` , :math:`[0,L]` is the spatial domain and boundary conditions are, for the moment, assumed to be represented by the boundary functions :math:`\mathbf{U}_{l}(t)` and :math:`\mathbf{U}_{r}(t)` .

In the RCM the only step in which one is required to work with the vector of conserved variables is at the level of the Riemann problem, when enforcing the Rankine–Hugoniot Conditions at shocks. All other steps of the method are more conveniently performed in terms of the vector of primitive variables, which for the Euler equations are :math:`\mathbf{W} = (\rho, u, p)^{T}` ; :math:`\rho` is density, :math:`u` is velocity and :math:`p` is pressure.

The Scheme for Non-Linear Systems
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

We discretise the spatial domain :math:`[0,L]` into :math:`M` computing cells :math:`I_{i} = [x_{i-\frac{1}{2}}, x_{i+\frac{1}{2}}]` of size :math:`\Delta x = x_{i+\frac{1}{2}} - x_{i-\frac{1}{2}} = L/M` , with :math:`i = 1,\cdots, M` . For a given cell :math:`I_{i}` , the location of the cell centre :math:`x_{i}` and the cell boundaries :math:`x_{i-\frac{1}{2}}` , :math:`x_{i+\frac{1}{2}}` are given by

.. math::
	\begin{align}
	x_{i-\frac{1}{2}} = (i - 1)\Delta x
	,\quad
	x_{i} = (i-\frac{1}{2})\Delta x
	,\quad
	x_{i+\frac{1}{2}} = i\Delta x
	\end{align}

For convenience we choose cells of regular size :math:`\Delta x` , but this is not a necessary requirement for implementing the RCM. Fig. 7.1 illustrates the non–staggered grid arrangement for this version of the Random Choice Method. The solution is updated at the cell centres :math:`x_{i}` , every time step. Obviously, the time step is, in general, of different size for every time step. Given general initial data :math:`\mathbf{W}(x,t^{n})` at time :math:`t = t^{n}` say, in order to evolve the solution to a time :math:`t^{n+1} = t^{n} + \Delta t` , the Random Choice Method first assumes a piecewise constant distribution of the data. Formally, this may be realised by defining cell averages as in the Godunov method. For the RCM, this is not necessary and we assume that the given data at the cell centres :math:`x_{i}` is constant throughout the respective cell :math:`I_{i}` . We then have :math:`\mathbf{W}(x,t^{n}) = \mathbf{W}_{i}^{n}` in each cell :math:`I_{i}` . Fig.7.2 shows the distribution of a typical variable :math:`w_{k}` at a given time level :math:`n` .


The pairs of neighbouring, constant, states :math:`\mathbf{W}_{i}^{n}, \mathbf{W}_{i+1}^{n}` define local Riemann problems :math:`RP(\mathbf{W}_{i}^{n}, \mathbf{W}_{i+1}^{n})` , which have similarity solutions :math:`\mathbf{W}_{i+\frac{1}{2}}(x/t)` . A detialed understanding of the complete exact solution of the Riemann problem is essential for understanding and implementing the RCM. Fig.7.3 illustrates the structure of a typical Riemann problem solution and a typical sampling range of the solution at a given time :math:`t^{*}` , across the wave structure. In the Random Choice Method the particular point :math:`x=x^{*}` is picked up at random within the sampling range :math:`[x_{l},x_{r}]` . The sampling routine evaluates :math:`\mathbf{W}_{i+\frac{1}{2}}(x^{*}/t^{*})` automatically.

The Random Choice Method updates the solution from the data value :math:`\mathbf{W}_{i}^{n}` in cell :math:`I_{i}` at time level :math:`n` , to the value :math:`\mathbf{W}_{i}^{n+1}` at time level :math:`n+1` , in two steps as follows:

Step one: Solve the Riemann problems :math:`RP(\mathbf{W}_{i-1}^{n}, \mathbf{W}_{i}^{n})` and :math:`RP(\mathbf{W}_{i}^{n}, \mathbf{W}_{i+1}^{n})` to find their respective solutions :math:`\mathbf{W}_{i-\frac{1}{2}}(x/t)` and :math:`\mathbf{W}_{i+\frac{1}{2}}(x/t)` . Fig.7.4 shows typical wave patterns emerging from the intercell boundaries :math:`x_{i-\frac{1}{2}}` and :math:`x_{i+\frac{1}{2}}` .

Step two: Random sample these solutions at time :math:`\Delta t` within cell :math:`I_{i}` to pick up a state and assign it to cell :math:`I_{i}` . The random sampling range is shown in Fig.7.4 by a thick horizontal line. The picked up state depends on a random, or quasi-random, number :math:`\theta^{n}` in the interval :math:`[0,1]` . The updated solution is then

.. math::
	\begin{align}
	\mathbf{W}_{i}^{n+1} = \left\{ \begin{array}{ll}
	\mathbf{W}_{i-\frac{1}{2}}(\theta^{n}\Delta x/\Delta t) ,\quad \text{if}~ 0\le \theta^{n} \le \frac{1}{2} \\
	\mathbf{W}_{i-\frac{1}{2}}\Big( (\theta^{n}-1)\Delta x / \Delta t \Big) ,\quad \text{if}~ \frac{1}{2} \le \theta^{n} \le 1
	\end{array}\right.
	\end{align}


The case in which :math:`0\le \theta^{n} \le \frac{1}{2}` is illustrated in Fig.7.5. Here the updated solution depends on the random sampling procedure applied to the right side of the left Riemann problem soluiton :math:`\mathbf{W}_{i-\frac{1}{2}}(x/t)` . The particular randomly chosen state is returned by the sampling routine, called with the argument

.. math::
	\begin{align}
	S := x/t = \frac{\theta^{n}\Delta x}{\Delta t}
	\end{align}

The resulting state is then assigned to the grid point :math:`i` , which is regarded as the solution in cell :math:`I_{i}` for the next time level. A similar procedure is applied if :math:`\frac{1}{2} \le \theta^{n} \le 1` . In this case one samples the left side of the right Riemann problem solution :math:`\mathbf{W}_{i+\frac{1}{2}}(x/t)` . When programming the non-staggered version of the Random Choice Method there are many ways of organising the tasks of (1) solving of Riemann problems and (2) random sampling their solutions.

Concerning the use of random numbers in the scheme, Chorin established that one only requires a single random number :math:`\theta^{n}` for a complete time level :math:`n` . In Glimm's proof one may take one random number per time step per cell.

Finally, we note the relationship between the RCM scheme to obtain the updated value :math:`\mathbf{W}_{i}^{n+1}` and the Godunov method, instead of random sampling the solution of the relevant Riemann problems, will take the integral average of these local Riemann problem solutions

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1}
	= \frac{1}{\Delta x} \int_{0}^{\frac{1}{2}\Delta x}\mathbf{U}_{i-\frac{1}{2}}\Big(\frac{x}{\Delta t}\Big)\mathrm{d}x
	+ \frac{1}{\Delta x} \int_{-\frac{1}{2}}^{0} \mathbf{U}_{i+\frac{1}{2}}\Big(\frac{x}{\Delta t}\Big)\mathrm{d}x
	\end{align}

In order to preserve the conservative character of the Godunov method, the averaging is performed in terms of the conserved variables. The RCM, on the other hand, is not strictly conservative, although one may regard the scheme as being conservative in a statistical sense.


Boundary Conditions and the Time Step Size
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The solution updating  procedure just described is completely defined for all cell :math:`I_{i}` , except for those next to the boundaries, namely :math:`I_{1}` and :math:`I_{M}` . In order to update these two cells we apply boundary conditions. This is carried out in exactly the same way as for the Godunov method. Fictitious states :math:`\mathbf{W}_{0}` and :math:`\mathbf{W}_{M+1}` adjacent to states :math:`\mathbf{W}_{1}` and :math:`\mathbf{W}_{M}` are defined. The otherwise missing Riemann problem solutions :math:`\mathbf{W}_{\frac{1}{2}}(x/t)` and :math:`\mathbf{W}_{M+\frac{1}{2}}(x/t)` at the boundaries are now defined and the random sampling procedure can now be extended to the full computational domain. We consider two types of boundary conditions, as for the one-dimensional time dependent Euler equations:

(1) Transmissive Boundary Conditions. Here the fictitous states are given as 

.. math::
	\begin{align}
	\rho_{0}^{n} = \rho_{1}^{n}
	,\quad
	u_{0}^{n} = u_{1}^{n}
	,\quad
	p_{0}^{n} = p_{1}^{n}
	\end{align}

.. math::
	\begin{align}
	\rho_{M+1}^{n} = \rho_{M}^{n}
	,\quad
	u_{M+1}^{n} = u_{M}^{n}
	,\quad
	p_{M+1}^{n} = p_{M}^{n}
	\end{align}

(2) Reflective Boundary Conditions. Here we state the boundary conditions that apply to reflective left and right boundaries moving with respective speeds :math:`u_{wl}` and :math:`u_{wr}` . The fictitious states are given by
    
.. math::
	\begin{align}
	\rho_{0}^{n} = \rho_{1}^{n}
	,\quad
	u_{0}^{n} = - u_{1}^{n} + 2u_{wl}
	,\quad
	p_{0}^{n} = p_{1}^{n}
	\end{align}

.. math::
	\begin{align}
	\rho_{M+1}^{n} = \rho_{M}^{n}
	,\quad
	u_{M+1}^{n} = - u_{M}^{n} + 2u_{wr}
	,\quad
	p_{M+1}^{n} = p_{M}^{n}
	\end{align}

The choice of the time step :math:`\Delta t` is determined by a CFL condition. Note first that in order to perform the random sampling described previously, we need to make the assumption that no wave interaction takes place within cell :math:`I_{i}` , in the chosen time :math:`\Delta t` , see Fig.7.4. This is satisfied by imposing the following restriction on the size of :math:`\Delta t` , namely

.. math::
	\begin{align}
	\Delta t \le \frac{\frac{1}{2}\Delta x}{S_{\max}^{n}}
	\end{align}

where :math:`S_{\max}^{n}` denotes the maximum wave velocity present throughout the domain at time :math:`t^{n}` . A consequence of this restriction is that only two Riemann problem solutions affect cell :math:`I_{i}` , namely the right travelling waves of :math:`\mathbf{W}_{i-\frac{1}{2}}(x/t)` and the left travelling waves of :math:`\mathbf{W}_{i+\frac{1}{2}}(x/t)` . Condition above may be expressed in the standard form

.. math::
	\begin{align}
	\Delta t = \frac{C_{cfl}\Delta x}{S_{\max}^{n}}
	\end{align} 

where the CFL coefficient :math:`C_{cfl}` satisfies

.. math::
	\begin{align}
	0 \le C_{cfl} \le \frac{1}{2}
	\end{align}

Hence the Random Choice Method has a stability limit of :math:`\frac{1}{2}` , which is only half that of Godunov's method.

For the RCM we recommend the use of the true waves arising from the solutions of local Riemann problems. The collective experience in applying the RCM in that the scheme is not too sensitive to underestimating :math:`S_{\max}^{n}` . If :math:`S_{\max}^{n}` is underestimated then the chosen time step :math:`\Delt t` will be too large and the likely consequence will not be signs of instabilities, as one  would expect, but computed waves will propagate at obviously wrong speed.

A Random Choice Scheme of the Lax-Friedrichs Type
---------------------------------------------------

Here we present a Random Choice Method that arises from interpreting the Lax-Friedrichs scheme as an integral average of solutions of Riemann problems. If these averages are transformed by use of the integral form of the conservation laws one recovers the usual Lax-Friedrichs scheme for non-linear systems, thus eliminating the role of the Riemann problem. If the role of the Riemann problem solution is preserved and the integral averages are interpreted in a stochastic sence one obtains a Random Choice Method of the Lax-Friedrichs type.

Review of the Lax-Friedrichs Scheme
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Let's review the Lax-Friedrichs scheme first. The Lax-Friedrichs scheme as applied to the linear advection equation

.. math::
	\begin{align}
	u_{t} + f(u)_{x} = 0
	,\quad
	f(u) = au
	\end{align}

reads

.. math::
	\begin{align}
	u_{i}^{n+1} = \frac{1 + c}{2}u_{i-1}^{n} + \frac{1 - c}{2}u_{i+1}^{n}
	\end{align}

This is obviously identical to the integral average

.. math::
	\begin{align}
	u_{i}^{n+1} = \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \hat{u}_{i}(x,\frac{1}{2}\Delta t)~\mathrm{d}x
	\end{align}

within cell :math:`i` , in which :math:`\hat{u}_{i}(x,t)` is the solution of the Riemann problem :math:`RP(u_{i-1}^{n}, u_{i+1}^{n})` , that is

.. math::
	\begin{align}
	\hat{u}_{i}(x/t) = \left\{ \begin{array}{ll}
	u_{i-1}^{n} \quad \text{if}~ x/t<a \\
	u_{i+1}^{n} \quad \text{if}~ x/t > a
	\end{array}\right.
	\end{align}

See Fig.7.6. The Lax-Friedrichs solution in cell :math:`i` at time :math:`t^{n+1} = t^{n} + \Delta t` is a weighted average of the solution of the Riemann problem with the left :math:`u_{i-1}^{n}` and right :math:`u_{i+1}^{n}` neighbour states as data, at time :math:`t=\frac{1}{2}\Delta t` . Note the two peculiarities of the scheme, (1) the data states do not include :math:`u_{i}^{n}` and (2) the time for the averaging is half the full time step :math:`\Delta t` .


The Scheme
^^^^^^^^^^^

We first generalise interpretation of the Lax-Friedrichs scheme to non-linear systems of conservation laws

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}
	\end{align}

The scheme reads

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \frac{1}{\Delta x} \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \hat{\mathbf{U}}_{i}(x,\frac{1}{2}\Delta t)~\mathrm{d}x
	\end{align}

where :math:`\hat{\mathbf{U}}_{i}(x,t)` is the solution of the Riemann problem :math:`RP(\mathbf{U}_{i-1}^{n}, \mathbf{U}_{i+1}^{n})` . There are now three possible routes to follow, these are:

- Solve Riemann problems and find the updated solution by evaluating the above equation directly. Numerical results of this scheme are indistinguishable from those obtained from the conventional, much simpler, Lax-Friedrichs scheme. We therefore discard this as a useful scheme.
- Apply the integral form of the conservation laws to the above equation to reproduce the conventional Lax-Friedrichs scheme for non-linear systems, and thus eliminate the role of the Riemann problem.
- Keep the role of the Riemann problem and reinterpret the above equation in a stochastic sense. We obtain
  
.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \frac{1}{\Delta x} \int_{-\frac{1}{2}\Delta x}^{\frac{1}{2}\Delta x} \hat{\mathbf{U}}_{i}(\theta^{n}\Delta x, \frac{1}{2}\Delta t)~\mathrm{d}x
	\end{align}

where :math:`\theta^{n}` is a random number satisfying

.. math::
	\begin{align}
	- \frac{1}{2} \le \theta^{n} \le \frac{1}{2}
	\end{align}

A Random Choice Scheme for updating the solution to the new time level is thus obtained, namely

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \hat{\mathbf{U}}_{i}(\theta^{n}\Delta x, \frac{1}{2}\Delta t)
	\end{align}

The conventional RCM has stability restriction :math:`0 < C_{cfl} \le \frac{1}{2}` , while the random choice scheme above has stability condition

.. math::
	\begin{align}
	0 < C_{cfl} \le 1
	\end{align}

which represents an improvement by a factor of :math:`2` .


The RCM on a Staggered Grid
------------------------------


The Scheme for Non-Linear Systems
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The staggered grid version of the RCM to solve :math:`\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}` updates :math:`\mathbf{U}_{i}^{n}` to a new value :math:`\mathbf{U}_{i}^{n+1}` in two steps, as illustrated in Fig.7.8. The steps are:

Step one: Solve the Riemann problems :math:`RP(\mathbf{U}_{i-1}^{n}, \mathbf{U}_{i}^{n})` and :math:`RP(\mathbf{U}_{i}^{n}, \mathbf{U}_{i+1}^{n})` to find respective solutions

.. math::
	\begin{align}
	\hat{\mathbf{U}}_{i-\frac{1}{2}}^{n+\frac{1}{2}}(x,t)
	,\quad
	\hat{\mathbf{U}}_{i+\frac{1}{2}}^{n+\frac{1}{2}}(x,t)
	\end{align}

Random sample these solutions at a stable time :math:`\Delta t^{n+\frac{1}{2}}` , that is

.. math::
	\begin{align}
	\mathbf{U}_{i-\frac{1}{2}}^{n+\frac{1}{2}}
	= \hat{\mathbf{U}}_{i-\frac{1}{2}}^{n+\frac{1}{2}}(\theta^{n}\Delta x, \Delta t^{n+\frac{1}{2}})
	,\quad
	\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}}
	= \hat{\mathbf{U}}_{i+\frac{1}{2}}^{n+\frac{1}{2}}(\theta^{n}\Delta x, \Delta t^{n+\frac{1}{2}})
	\end{align}

Step two: Solve :math:`RP(\mathbf{U}_{i-\frac{1}{2}}^{n+\frac{1}{2}}, \mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}})` to find solution :math:`\hat{\mathbf{U}}_{i}^{n+1}(x,t)` and random sample it, at a stable time :math:`\Delta t^{n+1}` , to obtain :math:`\mathbf{U}_{i}^{n+1}` , that is

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \hat{\mathbf{U}}_{i}^{n+1}(\theta^{n+1}\Delta x, \Delta t^{n+1})
	\end{align}

The time steps :math:`\Delta t^{n+\frac{1}{2}}` and :math:`\Delta t^{n+1}` need not be the same but must be chosen according to the usual stability restriction for the RCM. As for the case of the non-staggered RCM, one may use the primitive variables to describe the staggered grid RCM. However, for the theme of the next section we assume the vector :math:`\mathbf{U}` in the above equations to be the vector of conserved variables.


A Deterministic First-Order Centred Scheme (FORCE)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Here we present a First-Order Centred deterministic scheme (FORCE), that is obtained by replacing the stochastic steps in the RCM on staggered grid

.. math::
	\begin{align}
	\mathbf{U}_{i-\frac{1}{2}}^{n+\frac{1}{2}}
	= \hat{\mathbf{U}}_{i-\frac{1}{2}}^{n+\frac{1}{2}}(\theta^{n}\Delta x, \Delta t^{n+\frac{1}{2}})
	,\quad
	\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}}
	= \hat{\mathbf{U}}_{i+\frac{1}{2}}^{n+\frac{1}{2}}(\theta^{n}\Delta x, \Delta t^{n+\frac{1}{2}})
	\end{align}

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \hat{\mathbf{U}}_{i}^{n+1}(\theta^{n+1}\Delta x, \Delta t^{n+1})
	\end{align}

by deterministic versions, via integral averages of Riemann problem solutions. We preserve the previous notation and assume

.. math::
	\begin{align}
	\Delta t^{n+\frac{1}{2}} = \Delta t^{n+1} = \frac{1}{2}\Delta t
	\end{align}

The stochastic integrals are replaced by the deterministic integrals

.. math::
	\begin{align}
	\mathbf{U}_{i-\frac{1}{2}}^{n+\frac{1}{2}} = \frac{1}{\Delta x} \int_{-\frac{1}{2}\Delta x}^{\frac{1}{2}\Delta x} \hat{\mathbf{U}}_{i-\frac{1}{2}}^{n+\frac{1}{2}}(x, \frac{\Delta t}{2})~\mathrm{d}x
	\end{align}

and 

.. math::
	\begin{align}
	\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}} = \frac{1}{\Delta x} \int_{-\frac{1}{2}\Delta x}^{\frac{1}{2}\Delta x}\hat{\mathbf{U}}_{i+\frac{1}{2}}(x,\frac{\Delta t}{2})~\mathrm{d}x
	\end{align}

Then we apply the integral form of the  conservation laws to the two expressions above. The result is

.. math::
	\begin{align}
	& \mathbf{U}_{i-\frac{1}{2}}^{n+\frac{1}{2}} = \frac{1}{2}(\mathbf{U}_{i-1}^{n} + \mathbf{U}_{i}^{n}) + \frac{\Delta t}{2\Delta x}(\mathbf{F}_{i-1}^{n} - \mathbf{F}_{i}^{n}) \\
	& \mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}} = \frac{1}{2}(\mathbf{U}_{i}^{n} + \mathbf{U}_{i+1}^{n}) + \frac{\Delta t}{2\Delta x}(\mathbf{F}_{i}^{n} - \mathbf{F}_{i+1}^{n})
	\end{align}

We denote by :math:`\hat{\mathbf{U}}_{i}(x,t)` the solution of the Riemann problem :math:`RP(\mathbf{U}_{i-\frac{1}{2}}^{n+\frac{1}{2}}, \mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}})` and define an average :math:`\mathbf{U}_{i}^{n+1}` at the complete time step :math:`\Delta t` in terms of an integral average of :math:`\hat{\mathbf{U}}_{i}(x,t)` at the (local) time :math:`t=\frac{1}{2}\Delta t` , namely

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \frac{1}{\Delta x} \int_{-\frac{1}{2}\Delta x}^{\frac{1}{2}\Delta x} \hat{\mathbf{U}}_{i}(x,\frac{1}{2}\Delta t)~\mathrm{d}x
	\end{align}

This is the deterministic version of :math:`\mathbf{U}_{i}^{n+1} = \hat{\mathbf{U}}_{i}^{n+1}(\theta^{n+1}\Delta x, \Delta t^{n+1})` . Applying the integral form of the conservation laws to the right-hand side of the above equation gives

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1}
	= \frac{1}{2}\Big( \mathbf{U}_{i-\frac{1}{2}}^{n+\frac{1}{2}} + \mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}} \Big)
	+ \frac{\Delta t}{2\Delta x}\Big( \mathbf{F}_{i-\frac{1}{2}}^{n+\frac{1}{2}} - \mathbf{F}_{i+\frac{1}{2}}^{n+\frac{1}{2}} \Big)
	\end{align}

where

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}}^{n+\frac{1}{2}} = \mathbf{F}(\mathbf{U}_{i+\frac{1}{2}}^{n+\frac{1}{2}}) =: \mathbf{F}_{i+\frac{1}{2}}^{RI}
	\end{align}

and :math:`\mathbf{F}_{i+\frac{1}{2}}^{RI}` is the intercell numerical flux for the Richtmyer scheme.

The scheme is obviously conservative and when written in conservation form we have

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} + \frac{\Delta t}{\Delta x}\Big( \mathbf{F}_{i-\frac{1}{2}} - \mathbf{F}_{i+\frac{1}{2}} \Big)
	\end{align}

with intercell numerical flux

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}}^{force} = \frac{1}{2}\bigg[ \mathbf{F}_{i+\frac{1}{2}}^{n+\frac{1}{2}} + \frac{1}{2}(\mathbf{F}_{i}^{n} + \mathbf{F}_{i+1}^{n}) \bigg] + \frac{1}{4}\frac{\Delta x}{\Delta t}(\mathbf{U}_{i}^{n} - \mathbf{U}_{i+1}^{n})
	\end{align}

A surprising outcome is that the intercell flux is in fact the arithmetic mean of the fluxes for the Richtmyer and Lax-Friedrichs schemes, namely

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}}^{force} = \frac{1}{2}\Big( \mathbf{F}_{i+\frac{1}{2}}^{RI} + \mathbf{F}_{i+\frac{1}{2}}^{LF} \Big)
	\end{align}



Analysis of the FORCE Scheme
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

For the linear advection equation, the conservative FORCE scheme yields

.. math::
	\begin{align}
	u_{i}^{n+1} = b_{-1}u_{i-1}^{n} + b_{0}u_{i}^{n} + b_{1}u_{i+1}^{n}
	\end{align}

with coefficients given as

.. math::
	\begin{align}
	b_{-1} = \frac{1}{4}(1 + c)^{2}
	,\quad
	b_{0} = \frac{1}{2}(1 - c^{2})
	,\quad
	b_{1} = \frac{1}{4}(1-c)^{2}
	\end{align}

Using standard von Neumann analysis, or more directly by utilising Billett's result, which says that a scheme of this form is stable and only if

.. math::
	\begin{align}
	b_{0}(b_{-1} + b_{1}) \ge 0 
	,\quad
	b_{0}(b_{-1} + b_{1}) + 4b_{-1}b_{1} := B \ge 0
	\end{align}

The first condition leads to the expression of stability condition directly:

.. math::
	\begin{align}
	0 \le |c| \le 1, \qquad c = \frac{\Delta t a}{\Delta x}
	\end{align}

While the second condition produces

.. math::
	\begin{align}
	B = \frac{1}{4} \Big[ (1-c^{2})(1+c^{2}) + (1+c)^{2}(1-c)^{2} \Big]
	\end{align}

A sufficient condition for :math:`B \ge 0` is again :math:`b_{0} \ge 0` , which confirms the sought stabiliy restriction. 

Concerning monotonicity, by inspection, the scheme is monotone for Courant numbers satisfying the stability condition, i.e. all coeffients are non-negative.

By using standard analysis we can get modified equation

.. math::
	\begin{align}
	q_{t} + aq_{x} = \alpha_{fo}q_{xx}
	,\qquad
	\alpha_{fo} = \frac{1}{4}a\Delta x\Big(\frac{1-c^{2}}{c}\Big) = \frac{1}{2}\alpha_{lf}
	\end{align}




Random Numbers
----------------

The quality of the computed RCM solution depends crucially on the random numbers :math:`\{\theta^{n}\}` . Research in this area has produced some very effective guidelines. For example, it has been established that the more random the generation of :math:`\{\theta^{n}\}` , the worse the computed RCM results. Colella introduced the use of pseudo-random numbers of the van der Corput type.



Van der Corput Pseudo-Random Numbers
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Statistical Properties
^^^^^^^^^^^^^^^^^^^^^^^^

Propagation of a Single Shock
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^



Flux Vector Splitting Methods
================================

A distinguishing feature of upwind numerical methods is this: the discretisation of the equations on a mesh is performed according to the direction of propagation of information on that mesh. In this way, salient features of the physical phenomena modelled by the equations are incorporated into the discretisation schemes. There are essentially two approaches for identifying upwind directions, namely the Godunov approach and the Flux Vector Splitting (FVS) approach. These two approaches are often referred to as the Riemann approach and the Boltzmann approach. The respective numerical methods derived from these two approaches are often referred to as Flux Difference Splitting Methods and Flux Vector Splitting Methods.

The identification of upwind directions in Flux Vector Splitting Methods is achieved with less effort than in Godunov-type methods, leading to simpler and somewhat more efficient schemes. These two features are very attractive and have made FVS schemes very popular within a large community of practitioners. The Flux Vector Splitting approach is particularly well suited for implicit methods; these are popular in Aerodynamics, where the computation of steady solutions is of great practical value. The reduced sophistication of FVS schemes however, as compared with Godunov-type schemes, results in poorer resolution of discontinuities, particularly stationary contact and shear waves. In applications to the Navier-Stokes equations, it is reported by van Leer, Thomas and Roe that their FVS scheme is considerably less accurate than Godunov's method with Roe's approximate Riemann solver. A key feature of the FVS approach is its reliance on a special property of the equations, namemly the homogeneity property. The Euler equations satisfy this property but there are important examples, such as the shallow water equations, that do not. The homogeneity property may however be circumvented so as to be apply the FVS approach.


The Flux Vector Splitting Approach
------------------------------------


Upwind Differencing
^^^^^^^^^^^^^^^^^^^^^

Consider the small perturbation steady supersonic equations

.. math::
	\begin{align}
	u_{x} - a^{2}v_{y}=0
	,\quad
	v_{x} - u_{y} = 0
	\end{align}

where :math:`u=u(x,y)` ， :math:`v=v(x,y)` ,

.. math::
	\begin{align}
	a = \sqrt{\frac{1}{M_{\infty}^{2} - 1}}
	\end{align}

is the sound speed and :math:`M_{\infty}` is the free-stream Mach number, assumed to be greater than unity. The equations may be rewritten as

.. math::
	\begin{align}
	\mathbf{U}_{x} + \mathbf{A}\mathbf{U}_{y} = \mathbf{0}
	\end{align}

with

.. math::
	\begin{align}
	\mathbf{U} = \begin{bmatrix} u \\ v \end{bmatrix}
	,\quad
	\mathbf{A} = \begin{bmatrix}
	0 & -a^{2} \\
	-1 & 0
	\end{bmatrix}
	\end{align}

The eigenvalues of the coefficient matrix :math:`\mathbf{A}` are

.. math::
	\begin{align}
	\lambda_{1} = -a
	,\quad
	\lambda_{2} = +a
	\end{align}

with corresponding right eigenvectors

.. math::
	\begin{align}
	\mathbf{K}^{(1)} = \begin{bmatrix} a \\ 1 \end{bmatrix}
	,\quad
	\mathbf{K}^{(2)} = \begin{bmatrix} a \\ -1 \end{bmatrix}
	\end{align}

Given the mixed character of the eigenvalues ( :math:`\lambda_{1}=-a` is negative and :math:`\lambda_{2}=+a` is positive), a finite difference discretisation of the equation has limited choices for the spatial derivative, if upwind bias is to be applied. Consider, for instance, the one-sided difference schemes

.. math::
	\begin{align}
	& \mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} - \frac{\Delta x}{\Delta y}\mathbf{A}(\mathbf{U}_{i}^{n} - \mathbf{U}_{i-1}^{n}) \\
	& \mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} - \frac{\Delta x}{\Delta y}\mathbf{A}(\mathbf{U}_{i+1}^{n} - \mathbf{U}_{i}^{n})
	\end{align}

Clearly the first scheme is upwind relative to the eigenvalue :math:`\lambda_{2}=a>0` but is downwind, and thus unstable, relative to the eigenvalue :math:`\lambda_{1}=-a<0` . A similar observation applies to the second scheme. For the case in which all eigenvalues have the same sign the difficulty of choosing the upwind direction does not arise.

General linear hyperbolic systems with constant coefficients may be solved by the CIR first-order upwind method by decomposing the coefficient matrix :math:`\mathbf{A}` into a positive component :math:`\mathbf{A}^{+}` and a negative component :math:`\mathbf{A}^{-}` , such that

.. math::
	\begin{align}
	\mathbf{A} = \mathbf{A}^{+} + \mathbf{A}^{-}
	\end{align}

where :math:`\mathbf{A}^{+}` has positive or zero eigenvalues and :math:`\mathbf{A}^{-}` has negative or zero eigenvalues. One then has the upwind scheme

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} - \frac{\Delta x}{\Delta y}\mathbf{A}^{+}[\mathbf{U}_{i}^{n} - \mathbf{U}_{i-1}^{n}] - \frac{\Delta x}{\Delta y}\mathbf{A}^{-}[\mathbf{U}_{i+1}^{n} - \mathbf{U}_{i}^{n}]
	\end{align}

The Split-Coefficient Matrix Scheme of Chakravarthy et. al. is an extension of this procedure to non-linear systems, in non-conservative form.

The CIR upwind scheme, when applied to general linear hyperbolic systems with constant coefficients, may be written in conservative form by defining the flux vector

.. math::
	\begin{align}
	\mathbf{F} = \mathbf{A}\mathbf{U}
	\end{align}

Then the splitting of the coefficient matrix :math:`\mathbf{A}` results in a natural splitting of the flux vector :math:`\mathbf{F}` , namely

.. math::
	\begin{align}
	\mathbf{F} = \mathbf{F}^{+} + \mathbf{F}^{-}
	\end{align}

In this way the CIR upwind scheme can be written in conservative form

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} - \frac{\Delta t}{\Delta x}[\mathbf{F}_{i+\frac{1}{2}} - \mathbf{F}_{i-\frac{1}{2}}]
	\end{align}

where the intercell numerical flux

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{i}^{+}(\mathbf{U}_{i}^{n}) + \mathbf{F}_{i}^{-}(\mathbf{U}_{i+1}^{n})
	\end{align}

is identical to the Godunov intercell flux. The Flux Vector Splitting Method is a generalisation of this to non-linear systems in conservation form.


The FVS Approach
^^^^^^^^^^^^^^^^^^

Here we consider a general system of :math:`m` non-linear hyperbolic conservation laws

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}
	\end{align}

From the assumption of hyperbolicity the Jacobian matrix

.. math::
	\begin{align}
	\mathbf{A}(\mathbf{U}) = \frac{\partial \mathbf{F}}{\partial \mathbf{U}}
	\end{align}

may be expressed as

.. math::
	\begin{align}
	\mathbf{A} = \mathbf{K}\mathbf{\Lambda}\mathbf{K}^{-1}
	\end{align}

where :math:`\mathbf{\Lambda}` is the diagonal matrix formed by the eigenvalues of :math:`\mathbf{A}` , namely

.. math::
	\begin{align}
	\mathbf{\Lambda} = \begin{bmatrix}
	\lambda_{1} & & 0 \\
	 & \ddots & \\
	0 & & \lambda_{m}
	\end{bmatrix}
	\end{align}

The matrix :math:`\mathbf{K}` is 

.. math::
	\begin{align}
	\mathbf{K} = [\mathbf{K}^{(1)} , \mathbf{K}^{(2)} , \cdots , \mathbf{K}^{(m)}]
	\end{align}

where the colume :math:`\mathbf{K}^{(i)}` is the right eigenvector of :math:`\mathbf{A}` corresponding to :math:`\lambda_{i}` and :math:`\mathbf{K}^{-1}` is the inverse of :math:`\mathbf{K}` . Recall our usual convention of ordering the eigenvalues in increasing order.

The Flux Vector Splitting method aims to generalising the intercell numerical flux to non-linear systems. That is, FVS requires a splitting of the flux vector :math:`\mathbf{F}` into two component :math:`\mathbf{F}^{+}` and :math:`\mathbf{F}^{-}` such that

.. math::
	\begin{align}
	\mathbf{F}(\mathbf{U}) = \mathbf{F}^{+}(\mathbf{U}) + \mathbf{F}^{-}(\mathbf{U})
	\end{align}

under the restriction that the eigenvalues :math:`\lambda_{i}^{+}` and :math:`\lambda_{i}^{-}` of the Jacobian matrices

.. math::
	\begin{align}
	\mathbf{A}^{+} = \frac{\partial \mathbf{F}^{+}}{\partial \mathbf{U}}
	,\quad
	\mathbf{A}^{-} = \frac{\partial \mathbf{F}^{-}}{\partial \mathbf{U}}
	\end{align}

satisfy the condition

.. math::
	\begin{align}
	\lambda_{i}^{+} \ge 0
	,\quad
	\lambda_{i}^{-} \le 0
	\end{align}

The splitting is also required to reproduce regular upwinding when all eigenvalues :math:`\lambda_{i}` of the coefficient matrix :math:`\mathbf{A}` are one-sided, that is, all positive or zero, or all negative or zero. That is to say

.. math::
	\begin{align}
	& \mathbf{F}^{+} = \mathbf{F} ,\quad \mathbf{F}^{-}=\mathbf{0} \quad \text{if}~\lambda_{i}\ge 0 \quad \text{for}~ i=1,\cdots,m \\
	& \mathbf{F}^{+} = \mathbf{0} ,\quad \mathbf{F}^{-} = \mathbf{F} \quad \text{if}~\lambda_{i} \le 0 \quad \text{for}~ i=1,\cdots,m
	\end{align}

If in addition to hyperbolicity, the system satisfies the homogeneity property

.. math::
	\begin{align}
	\mathbf{F}(\mathbf{U}) = \mathbf{A}(\mathbf{U})\mathbf{U}
	\end{align}

just as in the linear constant coefficient case, then the sought splitting is easily accomplished by identifying a suitable splitting of the Jacobian matrix :math:`\mathbf{A}` . The time-dependent Euler equations satisfy the homogeneity property.

From the diagonalisation of :math:`\mathbf{A}` given by :math:`\mathbf{A}=\mathbf{K}\mathbf{\Lamda}\mathbf{K}^{-1}` , a splitting of :math:`\mathbf{A}` may be accomplished by an appropriate splitting of the diagonal matrix :math:`\mathbf{\Lambda}` . This in turn, may be split by identifying a splitting of the eigenvalues :math:`\lambda_{i}, i=1,\cdots,m` of :math:`\mathbf{A}` . Suppose we may split the eigenvalues :math:`\lambda_{i}` as

.. math::
	\begin{align}
	\lambda_{i} = \lambda_{i}^{+} + \lambda_{i}^{-}
	\end{align}

such that :math:`\lambda_{i}^{+} \ge 0` and :math:`\lambda_{i}^{-} le 0` . Then :math:`\mathbf{\Lambda}` may be split as

.. math::
	\begin{align}
	\Lambda = \Lambda^{+} + \Lambda^{-}
	\end{align}

where

.. math::
	\begin{align}
	\Lambda^{+} = \begin{bmatrix}
	\lambda_{1}^{+} & & 0 \\
	 & \ddots & \\
	0 & & \lambda_{m}^{+}
	\end{bmatrix}
	,\qquad
	\Lambda^{-} = \begin{bmatrix}
	\lambda_{1}^{-} & & 0 \\
	 & \ddots & \\
	0 & & \lambda_{m}^{-}
	\end{bmatrix}
	\end{align}

A natural splitting of :math:`\mathbf{A}` results, namely

.. math::
	\begin{align}
	\mathbf{A} = \mathbf{A}^{+} + \mathbf{A}^{-}
	\end{align}

with

.. math::
	\begin{align}
	\mathbf{A}^{+} = \mathbf{K}\mathbf{\Lambda}^{+}\mathbf{K}^{-1}
	,\quad
	\mathbf{A}^{-} = \mathbf{K}\mathbf{\Lambda}^{-}\mathbf{K}^{-1}
	\end{align}

Then, if :math:`\mathbf{F}(\mathbf{U}) = \mathbf{A}(\mathbf{U})\mathbf{U}` is satisfied, we can split :math:`\mathbf{F}(\mathbf{U})` as

.. math::
	\begin{align}
	\mathbf{F} = \mathbf{F}^{+} + \mathbf{F}^{-}
	\end{align}

where

.. math::
	\begin{align}
	\mathbf{F}^{+} = \mathbf{A}^{+}\mathbf{U}
	,\quad
	\mathbf{F}^{-} = \mathbf{A}^{-}\mathbf{U}
	\end{align}

Steger and Warming proposed a splitting of the eigenvalues :math:`\lambda_{i}` as in :math:`\lambda_{i} = \lambda_{i}^{+} + \lambda_{i}^{-}` with definitions

.. math::
	\begin{align}
	\lambda_{i}^{+} = \frac{1}{2}(\lambda_{i} + |\lambda_{i}|)
	,\quad
	\lambda_{i}^{-} = \frac{1}{2}(\lambda_{i} - |\lambda_{i}|)
	\end{align}

where :math:`|\lambda_{i}|` is the absolute value of :math:`\lambda_{i}` . Clearly

.. math::
	\begin{align}
	\lambda_{i}^{+} \ge 0 , \quad \lambda_{i}^{-} \le 0 ,\quad \text{for}~ i=1,\cdots,m
	\end{align}

.. note:: 

	We can verify that the following properties are satisfied

	.. math::
		\begin{align}
		&  \lambda_{i} = \lambda_{i}^{+} + \lambda_{i}^{-}, \quad |\lambda_{i}| = \lambda_{i}^{+} - \lambda_{i}^{-} \\
		& \mathbf{\Lambda} = \mathbf{\Lambda}^{+} + \mathbf{\Lambda}^{-} ,\quad |\mathbf{\Lambda}| = \mathbf{\Lambda}^{+} - \mathbf{\Lambda}^{-} \\
		& \mathbf{A} = \mathbf{A}^{+} + \mathbf{A}^{-} ,\quad |\mathbf{A}| = \mathbf{A}^{+} - \mathbf{A}^{-}
		\end{align}



FVS for the Isothermal Equations
----------------------------------

In order to illustrate the FVS approach we consider the isothermal equations of Gas Dynamics

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}
	\end{align}

.. math::
	\begin{align}
	\mathbf{U} = \begin{bmatrix} \rho \\ \rho u \end{bmatrix}
	,\quad
	\mathbf{F}(\mathbf{U}) = \begin{bmatrix} \rho u \\ \rho u^{2} + \rho a^{2} \end{bmatrix}
	\end{align}

where the sound speed :math:`a` is a positive constant. The Jacobian matrix is

.. math::
	\begin{align}
	\mathbf{A} = \frac{\partial \mathbf{F}}{\partial \mathbf{U}} =
	\begin{bmatrix}
	0 & 1 \\
	a^{2}-u^{2} & 2u
	\end{bmatrix}
	\end{align}

The eigenvalues of :math:`\mathbf{A}` are

.. math::
	\begin{align}
	\lambda_{1} = u-a
	,\quad
	\lambda_{2} = u+a
	\end{align}

and the matrix :math:`\mathbf{K}` of corresponding right eigenvectors is

.. math::
	\begin{align}
	\mathbf{K} = \begin{bmatrix}
	1 & 1 \\
	u-a & u+a
	\end{bmatrix}
	\end{align}


.. note:: We can verify that the system satisfy the homogeneity property.


Split Fluxes
^^^^^^^^^^^^^^

Given any splitting :math:`\lambda_{i} = \lambda_{i}^{+} + \lambda_{i}^{-}` with

.. math::
	\begin{align}
	\mathbf{\Lambda}^{+} = \begin{bmatrix} \lambda_{1}^{+} & 0 \\ 0 & \lambda_{2}^{+} \end{bmatrix}
	,\quad
	\mathbf{\Lambda}^{-} = \begin{bmatrix} \lambda_{1}^{-} & 0 \\ 0 & \lambda_{2}^{-} \end{bmatrix}
	\end{align}

we require the computation of the matrices :math:`\mathbf{A}^{+}` and :math:`\mathbf{A}^{-}` as given by :math:`\mathbf{A}^{+}=\mathbf{K}\mathbf{\Lambda}^{+}\mathbf{K}^{-}, \mathbf{A}^{-}=\mathbf{K}\mathbf{\Lambda}^{-}\mathbf{K}^{-1}` . One then requires the determination of the inverse :math:`\mathbf{K}^{-1}` of the matrix :math:`\mathbf{K}` , the products of three matrices as in :math:`\mathbf{A}^{+}=\mathbf{K}\mathbf{\Lambda}^{+}\mathbf{K}^{-}, \mathbf{A}^{-}=\mathbf{K}\mathbf{\Lambda}^{-}\mathbf{K}^{-1}` and finally the products :math:`\mathbf{F}^{+}=\mathbf{A}^{+}\mathbf{U}, \mathbf{F}^{-}=\mathbf{A}^{-}\mathbf{U}` to find the flux components. For the isothermal equations we have

.. math::
	\begin{align}
	\mathbf{K}^{-1} = \frac{1}{2a}\begin{bmatrix}
	u+a & -1 \\
	a-u & 1
	\end{bmatrix}
	\end{align}

Now, given any of the two components of :math:`\mathbf{\Lambda}` , :math:`\mathbf{A}^{\alpha}` , say, we compute

.. math::
	\begin{align}
	\mathbf{A}^{\alpha} = \mathbf{K}\mathbf{\Lambda}^{\alpha}\mathbf{K}^{-1}
	\end{align}

The result is

.. math::
	\begin{align}
	\mathbf{\mathbf{\alpha}} = \frac{1}{2a} 
	\begin{bmatrix}
	\lambda_{1}^{\alpha} (u+a) - \lambda_{2}^{\alpha}(u-a) & \lambda_{2}^{\alpha} - \lambda_{1}^{\alpha} \\
	(u^{2} - a^{2})(\lambda_{1}^{\alpha}-\lambda_{2}^{\alpha}) & \lambda_{2}^{\alpha}(u+a) - \lambda_{1}^{\alpha}(u-a)
	\end{bmatrix}
	\end{align}

Application of :math:`\mathbf{F}^{+}=\mathbf{A}^{+}\mathbf{U}, \mathbf{F}^{-}=\mathbf{A}^{-}\mathbf{U}` gives the flux vector component

.. math::
	\begin{align}
	\mathbf{F}^{\alpha} = \mathbf{A}^{\alpha}\mathbf{U} = \frac{\rho}{2} \begin{bmatrix} \lambda_{1}^{\alpha}+\lambda_{2}^{\alpha} \\ \lambda_{1}^{\alpha}(u-a) + \lambda_{2}^{\alpha}(u+a) \end{bmatrix}
	\end{align}

Note that the expression for the component :math:`\mathbf{F}^{\alpha}` given by the above expression is general. For :math:`\alpha=+` and :math:`\alpha=-` the flux components :math:`\mathbf{F}^{+}` and :math:`\mathbf{F}^{-}` are

.. math::
	\begin{align}
	\mathbf{F}^{+} = \frac{\rho}{2} \begin{bmatrix} \lambda_{1}^{+}+\lambda_{2}^{+} \\ \lambda_{1}^{+}(u-a) + \lambda_{2}^{+}(u+a) \end{bmatrix}
	,\quad
	\mathbf{F}^{-} = \frac{\rho}{2} \begin{bmatrix} \lambda_{1}^{-}+\lambda_{2}^{-} \\ \lambda_{1}^{-}(u-a) + \lambda_{2}^{-}(u+a) \end{bmatrix}
	\end{align}

For the split fluxes given above, for the case of subsonic flow, for the positive flux component :math:`\mathbf{F}^{+}` the Jacobian matrix is

.. math::
	\begin{align}
	\hat{\mathbf{A}}^{+} = \frac{\partial \mathbf{F}^{+}}{\partial \mathbf{U}} = \begin{bmatrix} \frac{1}{2}a & \frac{1}{2} \\ \frac{1}{2}(a^{2}-u^{2}) & u+a \end{bmatrix}
	\end{align}

The eigenvalues are the roots of the characteristic polynomial

.. math::
	\begin{align}
	\lambda^{2} - (\frac{3}{2}a + u)\lambda + \frac{1}{4}(u + a)^{2} = 0
	\end{align}

namely,

.. math::
		\begin{align}
		\hat{\lambda}_{1}^{+} = \frac{1}{4}a\Big( 2M + 3 - \sqrt{4M + 5} \Big)
		,\quad
		\hat{\lambda}_{2}^{+} = \frac{1}{4}a \Big( 2M + 3 + \sqrt{4M + 5} \Big)
		\end{align}

.. note:: 

	Note that

	.. math::
		\begin{align}
		\hat{\mathbf{A}}^{+} \ne \mathbf{A}^{+}
		,\quad
		\hat{\lambda}_{i}^{+} \ne \hat{\lambda}_{i}^{+}
		\end{align}

	Note also that :math:`\hat{\lambda}_{i}^{+} > 0` , that is, none of the eigenvalues vanish. Numerically, this particular property is not desirable, and which unfortunately also carries over to the Euler equations. As we shall see in the next section, there are other splitting schemes that remove this difficulty.



FVS Numerical Schemes
^^^^^^^^^^^^^^^^^^^^^^^

The FVS approach can be used to solve :math:`\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}` using the explicit conservative scheme

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} - \frac{\Delta t}{\Delta x}[\mathbf{F}_{i+\frac{1}{2}} - \mathbf{F}_{i-\frac{1}{2}}]
	\end{align}

where the FVS numerical flux is given by

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{i}^{+}(\mathbf{U}_{i}^{n}) + \mathbf{F}_{i+1}^{-}(\mathbf{U}_{i+1}^{n})
	\end{align}

Fig.8.1 provides a physical interpretation of it. The intercell numerical flux :math:`\mathbf{F}_{i+\frac{1}{2}}` is made out from two contributions; one comes from the forward component :math:`\mathbf{F}_{i}^{+}` in the left cell :math:`I_{i}` and the other comes from the backward component :math:`\mathbf{F}_{i+1}^{-}` in the right cell :math:`I_{i+1}` .

The Steger and Warming splitting in a computational set up is as follows: we consider a computing cell :math:`I_{i}` at time level :math:`n` , where :math:`\mathbf{U}_{i}^{n}` is the vector of conserved variables and :math:`\mathbf{F}_{i}^{n} = \mathbf{F}(\mathbf{U}_{i}^{n})` is the vector of fluxes. The three cases to consider are illustrated in Fig.8.2 and are:

- Case(a) Left supersonic flow: :math:`\lambda_{2} = u_{i}^{n} + a_{i}^{n} \le 0` . Fig.8.2a illustrates the situation in a cell :math:`I_{i}` at time level :math:`n` . Clearly
  
.. math::
	\begin{align}
	& \lambda_{1}^{+} = 0 ,\quad \lambda_{1}^{-} = \lambda_{1} = u_{i}^{n}-a_{i}^{n} \\
	& \lambda_{2}^{+} = 0 ,\quad \lambda_{2}^{-} = \lambda_{2} = u_{i}^{n}+a_{i}^{n} \\
	& \mathbf{F}_{i}^{n} = \mathbf{0} ,\quad \mathbf{F}_{i}^{-}=\mathbf{F}_{i}^{n}
	\end{align}

- Case(b) Right supersonic flow: :math:`\lambda_{1}=u_{i}^{n}-a_{1}^{n} \ge 0` . See Fig.8.2b. Obviously
  
.. math::
	\begin{align}
	& \lambda_{1}^{+} = \lambda_{1} = u_{i}^{n}-a_{i}^{n} ,\quad \lambda_{1}^{-} = 0 \\
	& \lambda_{2}^{+} = \lambda_{2} = u_{i}^{n}+a_{i}^{n} ,\quad \lambda_{2}^{-} = 0 \\
	& \mathbf{F}_{i}^{+} = \mathbf{F}_{i}^{n} ,\quad \mathbf{F}_{i}^{n} = \mathbf{0}
	\end{align}

- Case(c) Subsonic flow: :math:`\lambda_{1} = u_{i}^{n}-a_{i}^{n} \le 0 \le \lambda_{2} = u_{i}^{n}+a_{i}^{n}` . See Fig.8.2c. Evidently
  
.. math::
	\begin{align}
	& \lambda_{1}^{+} = 0 ,\quad \lambda_{1}^{-} = \lambda_{1} = u_{i}^{n}-a_{i}^{n} \\
	& \lambda_{2}^{+} = \lambda_{2} = u_{i}^{n} + a_{i}^{n} ,\quad \lambda_{2}^{-} = 0
	\end{align}

According to the flux components expressions discussed before, the fluxes :math:`\mathbf{F}_{i}^{+}` and :math:`\mathbf{F}_{i}^{n}` for the subsonic case are given by

.. math::
	\begin{align}
	\mathbf{F}_{i}^{+} = \frac{\rho_{i}^{n}}{2}\begin{bmatrix} u_{i}^{n}+a_{i}^{n} \\ (u_{i}^{n}+a_{i}^{n})^{2} \end{bmatrix}
	,\quad
	\mathbf{F}_{i}^{-} = \frac{\rho_{i}^{n}}{2}\begin{bmatrix} u_{i}^{n}-a_{i}^{n} \\ (u_{i}^{n}-a_{i}^{n})^{2} \end{bmatrix}
	\end{align}




FVS Applied to the Euler Equations
------------------------------------


Recalling the Equations
^^^^^^^^^^^^^^^^^^^^^^^^^

Here we present three Flux applied to the time dependent Euler equations. The one-dimensional Euler Equations in conservation-law form are given by

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}
	\end{align}

.. math::
	\begin{align}
	\mathbf{U} = \begin{bmatrix} \rho \\ \rho u \\ E \end{bmatrix}
	,\quad
	\mathbf{F}(\mathbf{U}) = \begin{bmatrix} \rho u \\ \rho u^{2} + p \\ u(E+p) \end{bmatrix}
	\end{align}

The Jacobian matrix :math:`\mathbf{A}` is given by

.. math::
	\begin{align}
	\mathbf{A} = 
	\begin{bmatrix}
	0 & 1 & 0 \\
	\frac{1}{2}(\gamma - 3)u^{2} & (3-\gamma)u & \gamma - 1 \\
	\frac{1}{2}(\gamma - 2)u^{3}-\frac{a^{2}u}{\gamma-1} & \frac{3-2\gamma}{2}u^{2}+\frac{a^{2}}{\gamma-1} & \gamma u
	\end{bmatrix}
	\end{align}

and the system is hyperbolic with real eigenvalues

.. math::
	\begin{align}
	\lambda_{1} = u - a
	,\quad
	\lambda_{2} = u
	,\quad
	\lambda_{3} = u + a
	\end{align}

The matrix :math:`\mathbf{K}` of corresponding right eigenvectors is

.. math::
	\begin{align}
	\mathbf{K} =
	\begin{bmatrix}
	0 & 1 & 0 \\
	u-a & u & u+a \\
	H - ua & \frac{1}{2}u^{2} & H+ua
	\end{bmatrix}
	\end{align}

Here :math:`H` is the enthalpy

.. math::
	\begin{align}
	H = (E + p)/\rho = \frac{1}{2}u^{2} + \frac{a^{2}}{\gamma - 1}
	\end{align}

The three-dimensional Euler equations may be dealt with by only considering the flux component normal to the computing cell interface. In constructing numerical methods for Cartesian geometries it is sufficient to consider the flux in any of the coordinate directions. For general geometries this is modified by use of rotation matrices. We thus state teh schemes for the x-split three dimensional Euler equations

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}
	\end{align}

.. math::
	\begin{align}
	\mathbf{U} = \begin{bmatrix}
	\rho \\ \rho u \\ \rho v \\ \rho w \\ E
	\end{bmatrix}
	,\quad
	\mathbf{F}(\mathbf{U}) = \begin{bmatrix}
	\rho u \\ \rho u^{2} + p \\ \rho u v \\ \rho u w \\ u(E+p)
	\end{bmatrix}
	\end{align}

The Jacobian matrix :math:`\mathbf{A}` is given by

.. math::
	\begin{align}
	\mathbf{A} = 
	\begin{bmatrix}
	0 & 1 & 0 & 0 & 0 \\
	(\gamma-1)H-u^{2}-a^{2} & (3-\gamma)u & (1-\gamma)v & (1-\gamma)w & \gamma-1 \\
	-uv & v & u & 0 & 0 \\
	-uw & w & 0 & u & 0 \\
	\frac{1}{2}u[(\gamma-3)H-a^{2}] & H-(\gamma-1)u^{2} & (1-\gamma)uv & (1-\gamma)uw & (\gamma-1)u
	\end{bmatrix}
	\end{align}

where

.. math::
	\begin{align}
	H = (E + p)/\rho = \frac{1}{2}\mathbf{V}^{2} + \frac{a^{2}}{\gamma-1}
	,\quad
	\mathbf{V}^{2} = u^{2} + v^{2} + w^{2}
	\end{align}

This system is hyperbolic with real eigenvalues

.. math::
	\begin{align}
	\lambda_{1} = u-a
	,\quad
	\lambda_{2} = \lambda_{3} = \lambda_{4} = u
	,\quad
	\lambda_{5} = u+a
	\end{align}

The matrix of corresponding right eigenvectors is

.. math::
	\begin{align}
	\mathbf{K} = 
	\begin{bmatrix}
	1 & 1 & 0 & 0 & 1 \\
	u-a & u & 0 & 0 & u+a \\
	v & v & 1 & 0 & v \\
	w & w & 0 & 1 & w \\
	H-ua & \frac{1}{2}\mathbf{V}^{2} & v & w & H+ua
	\end{bmatrix}
	\end{align}

The one-dimensional Euler equations satisfy the homogeneity property

.. math::
	\begin{align}
	\mathbf{F}(\mathbf{U}) = \mathbf{A}(\mathbf{U})\mathbf{U}
	\end{align}

We can also verify that the split three-dimensional Euler equations also satisfy the homogeneity property.


The Steger-Warming Splitting
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

For the Steger-Warming Splitting we require an expression for the inverse :math:`\mathbf{K}^{-1}` of the matrix :math:`\mathbf{K}` , in order to find the split Jacobians.


The One-Dimensional Case
"""""""""""""""""""""""""""

For the one-dimensional Euler equations we have

.. math::
	\begin{align}
	\mathbf{K}^{-1} = \frac{\gamma-1}{2a^{2}}
	\begin{bmatrix}
	\frac{1}{2}u^{2}+\frac{ua}{\gamma-1} & -u-\frac{a}{\gamma-1} & 1 \\
	\frac{2a^{2}}{\gamma-1}-u^{2} & 2u & -2 \\
	\frac{1}{2}u^{2}-\frac{ua}{\gamma-1} & \frac{a}{\gamma-1}-u & 1
	\end{bmatrix}
	\end{align}

Then, for any component :math:`\mathbf{\Lambda}^{\alpha}` of the two components of :math:`\mathbf{\Lambda}` , the corresponding Jacobian component is 

.. math::
	\begin{align}
	\mathbf{A}^{\alpha} = \mathbf{K}\mathbf{\Lambda}^{\alpha}\mathbf{K}^{-1}
	\end{align}

The associated split flux component :math:`\mathbf{F}^{\alpha} = \mathbf{A}^{\alpha}\mathbf{U}` is

.. math::
	\begin{align}
	\mathbf{F}^{\alpha} = \frac{\rho}{2\gamma}
	\begin{bmatrix}
	\lambda_{1}^{\alpha} + 2(\gamma-1)\lambda_{2}^{\alpha} + \lambda_{3}^{\alpha} \\
	(u-a)\lambda_{1}^{\alpha} + 2(\gamma - 1)u \lambda_{2}^{\alpha} + (u+a)\lambda_{3}^{\alpha} \\
	(H-ua)\lambda_{1}^{\alpha} + (\gamma-1)u^{2}\lambda_{2}^{\alpha} + (H+ua)\lambda_{3}^{\alpha}
	\end{bmatrix}
	\end{align}

where the eigenvalues :math:`\lambda_{k}^{\alpha}` are given by :math:`\lambda_{i}^{+}=\frac{1}{2}(\lambda_{i}+|\lambda_{i}|), \lambda_{i}^{-}=\frac{1}{2}(\lambda_{i}-|\lambda_{i}|)` , for :math:`\alpha = +,-` .


The Three-Dimensional Case
""""""""""""""""""""""""""""

For the three-dimensional case we have

.. math::
	\begin{align}
	\mathbf{K}^{-1} = \frac{\gamma-1}{2a^{2}}
	\begin{bmatrix}
	H + \frac{a}{\gamma-1}(u-a) & -(u+\frac{a}{\gamma-1}) & -v & -w & 1 \\
	-2H + \frac{4}{\gamma-1}a^{2} & 2u & 2v & 2w & -2 \\
	-\frac{2va^{2}}{\gamma-1} & 0 & \frac{2a^{2}}{\gamma-1} & 0 & 0 \\
	-\frac{2wa^{2}}{\gamma-1} & 0 & 0 & \frac{2a^{2}}{\gamma-1} & 0 \\
	H-\frac{a}{\gamma-1}(u+a) & -u+\frac{a}{\gamma-1} & -v & -w & 1
	\end{bmatrix}
	\end{align}
 
and the resulting split flux component :math:`\mathbf{F}^{\alpha} = \mathbf{A}^{\alpha}\mathbf{U}` is found to be

.. math::
	\begin{align}
	\mathbf{F}^{\alpha} = \frac{\rho}{2\gamma}
	\begin{bmatrix}
	\lambda_{1}^{\alpha} + 2(\gamma-1)\lambda_{2}^{\alpha} + \lambda_{5}^{\alpha} \\
	(u-a)\lambda_{1}^{\alpha} + 2(\gamma-1)u\lambda_{2}^{\alpha} + (u+a)\lambda_{5}^{\alpha} \\
	v\lambda_{1}^{\alpha} + 2(\gamma-1)v\lambda_{2}^{\alpha} + v\lambda_{5}^{\alpha} \\
	w\lambda_{1}^{\alpha} + 2(\gamma-1)w\lambda_{2}^{\alpha} + w\lambda_{5}^{\alpha} \\
	(H-ua)\lambda_{1}^{\alpha} + (\gamma-1)\mathbf{V}^{2}\lambda_{2}^{\alpha} + (H+ua)\lambda_{5}^{\alpha}
	\end{bmatrix}
	\end{align}



The van Leer Splitting
^^^^^^^^^^^^^^^^^^^^^^^^^

Van Leer constructed a splitting for the Euler equations that has some extra desirable properties, namely

- The split Jacobian matrices
  
.. math::
	\begin{align}
	\hat{\mathbf{A}}^{+} = \frac{\partial \mathbf{F}^{+}}{\partial \mathbf{U}}
	,\quad
	\hat{\mathbf{A}}^{-} = \frac{\partial \mathbf{F}^{-}}{\partial \mathbf{U}}
	\end{align}

are required to be continuous.

- The split fluxes are degenerate for subsonic flow, that is :math:`\hat{\mathbf{A}}^{+},\hat{\mathbf{A}}^{-}` have a zero eigenvalue.


Van Leer expresses the flux vector :math:`\mathbf{F}` as a function of density, sound speed and Mach number :math:`M = \frac{u}{a}` , that is

.. math::
	\begin{align}
	\mathbf{F} = \mathbf{F}(\rho,a,M) = 
	\begin{bmatrix}
	\rho a M \\
	\rho a^{2}(M^{2} + \frac{1}{\gamma}) \\
	\rho a^{3}M(\frac{1}{2}M^{2} + \frac{1}{\gamma-1})
	\end{bmatrix}
	=: \begin{bmatrix}
	f_{mas} \\
	f_{mom} \\
	f_{ene}
	\end{bmatrix}
	\end{align}

For the mass flux :math:`f_{mas}=\rho aM` , one requires quadratics in :math:`M` and the split mass fluxes are

.. math::
	\begin{align}
	f_{mas}^{+} = \frac{1}{4}\rho a(1+M)^{2}
	,\quad
	f_{mas}^{-} = -\frac{1}{4}\rho a(1-M)^{2}
	\end{align}

The momentum split fluxes are

.. math::
	\begin{align}
	f_{mom}^{+} = f_{mas}^{+}\frac{2a}{\gamma}\Big[ \frac{\gamma-1}{2}M + 1 \Big]
	,\quad
	f_{mom}^{-} = f_{mas}^{-}\frac{2a}{\gamma}\Big[ \frac{\gamma-1}{2}M - 1 \Big]
	\end{align}

and the energy split fluxes are

.. math::
	\begin{align}
	f_{ene}^{+} = \frac{\gamma^{2}}{2(\gamma^{2}-1)}\frac{[f_{mom}^{+}]^{2}}{f_{mas}^{+}}
	,\quad
	f_{ene}^{-} = \frac{\gamma^{2}}{2(\gamma^{2}-1)}\frac{[f_{mom}^{-}]^{2}}{f_{mas}^{-}}
	\end{align}

In vector form we have

.. math::
	\begin{align}
	\mathbf{F}^{+} = \frac{1}{4}\rho a (1+M)^{2}
	\begin{bmatrix}
	1 \\
	\frac{2a}{\gamma}(\frac{\gamma-1}{2}M + 1) \\
	\frac{2a^{2}}{\gamma^{2}-1}(\frac{\gamma-1}{2}M + 1)^{2}
	\end{bmatrix}
	\end{align}

.. math::
	\begin{align}
	\mathbf{F}^{-} = -\frac{1}{4}\rho a (1-M)^{2}
	\begin{bmatrix}
	1 \\
	\frac{2a}{\gamma}(\frac{\gamma-1}{2}M - 1) \\
	\frac{2a^{2}}{\gamma^{2}-1}(\frac{\gamma-1}{2}M - 1)^{2}
	\end{bmatrix}
	\end{align}

For the x-split three dimensional Euler equations the split flux formulae are

.. math::
	\begin{align}
	\mathbf{F}^{+} = \frac{1}{4}\rho a (1 + M)^{2}
	\begin{bmatrix}
	1 \\
	\frac{2a}{\gamma}(\frac{\gamma-1}{2}M + 1) \\
	v \\
	w \\
	\frac{2a^{2}}{\gamma^{2}-1}(\frac{\gamma-1}{2}M + 1)^{2} + \frac{1}{2}(v^{2} + w^{2})
	\end{bmatrix}
	\end{align}

.. math::
	\begin{align}
	\mathbf{F}^{-} = -\frac{1}{4}\rho a (1 - M)^{2}
	\begin{bmatrix}
	1 \\
	\frac{2a}{\gamma}(\frac{\gamma-1}{2}M - 1) \\
	v \\
	w \\
	\frac{2a^{2}}{\gamma^{2}-1}(\frac{\gamma-1}{2}M - 1)^{2} + \frac{1}{2}(v^{2} + w^{2})
	\end{bmatrix}
	\end{align}

where the Mach number is still :math:`M=\frac{u}{a}` .

Concerning stability, van Leer gives the following practical stability condition

.. math::
	\begin{align}
	C_{cfl} := \frac{\Delta t}{\Delta x}(|u| + a) \le \frac{2\gamma + |M|(3-\gamma)}{\gamma+3}
	\end{align}

Note that :math:`C_{cfl}=C_{cfl}(M)` and that when :math:`\gamma=1.4` we have

.. math::
	\begin{align}
	C_{cfl}^{\max} = 1 \quad\text{for}\quad |M|=1
	,\qquad
	C_{cfl}^{\min} = \frac{2\gamma}{\gamma+3}\approx 0.636... \quad\text{for}\quad |M|=0
	\end{align}

.. note:: 

	The CFL condition for the explicit FVS scheme is more restrictive than that for the Godunov method, for which :math:`C_{cfl}` is close to unity.


Advection Upstream Splitting Method (AUSM)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

A recent scheme that attempts to combine features from the Flux Vector Splitting and Godunov approaches is due to Liou and Steffen. The scheme has been formulated in terms of the time-dependent Euler equations and relies on splitting the flux vector :math:`\mathbf{F}` into a convective component :math:`\mathbf{F}^{(c)}` and a pressure component :math:`\mathbf{F}^{(p)}` . For the x-split three dimensional flux we have

.. math::
	\begin{align}
	\mathbf{F}(\mathbf{U}) = 
	\begin{bmatrix}
	\rho u \\
	\rho u^{2} + p \\
	\rho u v \\
	\rho u w \\
	u(E + p)
	\end{bmatrix}
	=
	\begin{bmatrix}
	\rho u \\ \rho u^{2} \\ \rho u v \\ \rho u w \\ \rho u H
	\end{bmatrix}
	+
	\begin{bmatrix}
	0 \\ p \\ 0 \\ 0 \\ 0
	\end{bmatrix}
	=: \mathbf{F}^{(c)} + \mathbf{F}^{(p)}
	\end{align}

with the obvious definitions for the convective component :math:`\mathbf{F}^{(c)}` and the pressure component :math:`\mathbf{F}^{(p)}` . By introducing the Mach number and enthalpy

.. math::
	\begin{align}
	M = \frac{u}{a}
	,\quad
	H = \frac{E + p}{\rho}
	\end{align}

we write

.. math::
	\begin{align}
	\mathbf{F}^{(c)} = M \begin{bmatrix} \rho a \\ \rho au \\ \rho av \\ \rho aw \\ \rho aH \end{bmatrix}
	=: M \hat{\mathbf{F}}^{(c)}
	\end{align}

with the obvious notation for the vector :math:`\hat{\mathbf{F}}^{(c)}` . In defining the intercell numerical flux :math:`\mathbf{F}_{i+\frac{1}{2}}` , Liou and Steffen take

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{i+\frac{1}{2}}^{(c)} + \mathbf{F}_{i+\frac{1}{2}}^{(p)}
	\end{align}

where the convective flux component is given by

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}}^{(c)} = M_{i+\frac{1}{2}}\Big[ \hat{\mathbf{F}}^{(c)} \Big]_{i+\frac{1}{2}}
	\end{align}

with definition

.. math::
	\begin{align}
	[\cdot]_{i+\frac{1}{2}} = \left\{ \begin{array}{ll}
	[\cdot]_{i} \quad \text{if}~M_{i+\frac{1}{2}} \ge 0 \\
	[\cdot]_{i+1} \quad \text{if}~M_{i+\frac{1}{2}} \le 0
	\end{array} \right.
	\end{align}

Note that the flux vector is upwinded according to the sign of the convection, or advection, speed implied in the intercell Mach number :math:`M_{i+\frac{1}{2}}` . For this reason Liou and Steffen call their scheme AUSM, which stands for Advection Upstream Splitting Method.

The cell-interface Mach number is given by the splitting

.. math::
	\begin{align}
	M_{i+\frac{1}{2}} = M_{i}^{+} + M_{i+1}^{-}
	\end{align}

with the positive and negative components yet to be defined. The splitting of the pressure flux component depends on the splitting of the pressure itself, namely

.. math::
	\begin{align}
	p_{i+\frac{1}{2}} = p_{i}^{+} + p_{i+1}^{-}
	\end{align}

For the splitting of the Mach number Liou and Steffen follow van Leer and set

.. math::
	\begin{align}
	M^{\pm} = \left\{ \begin{array}{ll}
	\pm \frac{1}{4}(M \pm 1)^{2} \quad \text{if}~|M|\le 1 \\
	\frac{1}{2}(M \pm |M|) \quad \text{if}~|M| > 1
	\end{array} \right.
	\end{align}

For splitting the pressure they suggest two choices, namely

.. math::
	\begin{align}
	p^{\pm} = \left\{ \begin{array}{ll}
	\frac{1}{2}p(1 \pm M) \quad \text{if}~|M| \le 1 \\
	\frac{1}{2}p\frac{M \pm |M|}{M} \quad \text{if}~|M| > 1
	\end{array} \right.
	\end{align}

and 

.. math::
	\begin{align}
	p^{\pm} = \left\{ \begin{array}{ll}
	\frac{1}{4}p(M \pm 1)^{2}(2 \mp M) \quad \text{if}~|M|\le 1 \\
	\frac{1}{2}p\frac{(M \pm |M|)}{M} \quad \text{if}~|M| > 1
	\end{array} \right.
	\end{align}







Approximate-State Riemann Solvers
=====================================

The method of Godunov and its high-order extensions require the solution of the Riemann problem. In a practical computation this is solved billions of times, making the Riemann problem solution process the single most demanding task in the numerical method. An iterative procedure is always involved and the associated computational effort may not always be justified. This effort may increase dramatically by equations of state of complicated algebraic form or by the complexity of the particular system of equations being solved, or both. Approximate, non-iterative solutions have the potential to provide the necessary items of information for numerical purposes. There are essentially two ways of extracting approximate information from the solution of the Riemann problem to be used in Godunov-type methods:

- One is to find an approximation to the numerical flux employed in the numerical method directly.
- The other approach is to find an approximation to a state and then evaluate the physical flux function at this state.
  
We present, approximate, Riemann solvers that do not need an iteration process. We provide an approximate solution for the state required to evaluate the Godunov flux. The approximations can be used directly in the first-order Godunov method and its high-order extensions. Some of the approximations presented are exceedingly simple but not accurate enough to produce robust numerical methods. This difficulty is resolved by designing hybrid schemes that combine various approximate solvers in and adaptive fashion.


The Riemann Problem and the Godunov Flux
--------------------------------------------

We want to solve numerically the general Initial Boundary Value Problem (IBVP)

.. math::
	\begin{align}
	& \mathbf{U}_{t} = \mathbf{F}(\mathbf{U})_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \mathbf{U}^{(0)}(x) \\
	& \mathbf{U}(0,t) = \mathbf{U}_{l}(t) ,\quad \mathbf{U}(L,t)=\mathbf{U}_{r}(t)
	\end{align}

utilising the explicit conservative formula

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} + \frac{\Delta t}{\Delta x}[\mathbf{F}_{i-\frac{1}{2}} - \mathbf{F}_{i+\frac{1}{2}}]
	\end{align}

along with the Godunov intercell numerical flux

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}(\mathbf{U}_{i+\frac{1}{2}}(0))
	\end{align}

We assume that the solution of IBVP exists. Here :math:`\mathbf{U}_{i+\frac{1}{2}}(0)` is the similarity solution :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` of the Riemann problem

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \left\{ \begin{array}{ll}
	\mathbf{U}_{L} \quad \text{if}~x<0 \\
	\mathbf{U}_{R} \quad \text{if}~x>0
	\end{array} \right.
	\end{align}

evaluated at :math:`x/t=0` . Fig.9.1 shows the structure of the exact solution of the Riemann problem for the x-split three-dimensional Euler equations, for which the vectors of conserved variables and fluxes are

.. math::
	\begin{align}
	\mathbf{U} = 
	\begin{bmatrix}
	\rho \\ \rho u \\ \rho v \\ \rho w \\ E
	\end{bmatrix}
	,\quad
	\mathbf{F} = 
	\begin{bmatrix}
	\rho u \\ \rho u^{2}+p \\ \rho uv \\ \rho u w \\ u(E+p)
	\end{bmatrix}
	\end{align}

The value :math:`x/t=0` for the Godunov flux corresponds to the t-axis. The piece-wise constant initial data, in terms of primitive variables, is

.. math::
	\begin{align}
	\mathbf{W}_{L} = 
	\begin{bmatrix}
	\rho_{L} \\ u_{L} \\ v_{L} \\ w_{L} \\ p_{L}
	\end{bmatrix}
	,\quad
	\mathbf{W}_{R} = 
	\begin{bmatrix}
	\rho_{R} \\ u_{R} \\ v_{R} \\ w_{R} \\ p_{R}
	\end{bmatrix}
	\end{align}

The purpose of this chapter is to find approximate solutions to the Riemann problem in order to evaluate the Godunov flux. The evaluation of the flux requires the identification of the appropriate wave pattern in the Riemann problem solution; as depicted in Fig.9.2, there are ten possibilities to be considered.

In our solution procedure we split the task of solving the complete Riemann problem into three subproblems, namely

- The star values :math:`p_{*},u_{*},\rho_{*L},\rho_{*R}` in the Star Region between the non-linear waves.
- The solution for the tangential velocity components :math:`v` and :math:`w` throughout the wave structure.
- The solution for :math:`\rho, u, p` inside rarefactions.
  
Tangential Velocity Components
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Recall that in the exact solution, the values of the tangential velocity components :math:`v` and :math:`w` do not change across the non-linear waves but do change, discontinuously, across the middle wave. Thus, given an approximate solution :math:`u_{*}` for the normal velocity component in the Star Region, the solution for the tangential velocity components :math:`v` and :math:`w` is 

.. math::
	\begin{align}
	v(x,t), w(x,t) = \left\{ \begin{array}{ll}
	v_{L}, w_{L} \quad \text{if}~x/t \le u_{*} \\
	v_{R}, w_{R} \quad \text{if}~x/t > u_{*}
	\end{array} \right.
	\end{align}

In this way, the solution for the tangential velocity components is, in a sense, exact; the only approximation being that for :math:`u_{*}` . As a matter of fact, any passive scalar quantity :math:`q(x,y,z,t)` advected with the fluid will have this property. In the study of multi-component flow, this quantity could be a species concentration; in practical applications there can be many of such quantities. Hence, it is very important that the approximate solution of the Riemann problem preserves the correct behaviour.


Sonic Rarefactions
^^^^^^^^^^^^^^^^^^^^^

Assuming the solution for the star values is available, we then need to identify the correct values along the t-axis, in order to evaluate the Godunov flux. The cases (a1) to (a4) and (b1) to (b4) of Fig.9.2 can be dealt with once solutions for star values and tangential velocity are available. The sonic flow cases (a5) and (b5) must be treated separately. For these two cases we recommend the use of the exact solution, which is non-iterative.

The solution along the t-axis inside a left sonic rarefaction is obtained by setting :math:`x/t=0` im

.. math::
	\begin{align}
	\mathbf{W}_{Lfan} = \left\{ \begin{array}{ll}
	\rho = \rho_{L}\Big[ \frac{2}{\gamma+1} + \frac{\gamma-1}{(\gamma+1)a_{L}}(u_{L} - \frac{x}{t}) \Big]^{\frac{2}{\gamma-1}} \\
	u = \frac{2}{\gamma + 1}\Big[ a_{L} + \frac{\gamma-1}{2}u_{L} + \frac{x}{t} \Big] \\
	p = p_{L}\Big[ \frac{2}{\gamma + 1} + \frac{\gamma-1}{(\gamma+1)a_{L}} (u_{L} - \frac{x}{t}) \Big]^{\frac{2\gamma}{\gamma-1}}
	\end{array}\right.
	\end{align}

The solution along the t-axis inside a right sonic rarefaction is obtained by setting :math:`x/t = 0` in

.. math::
	\begin{align}
	\mathbf{W}_{Rfan} = \left\{ \begin{array}{ll}
	\rho = \rho_{R}\Big[ \frac{2}{\gamma+1} - \frac{\gamma-1}{(\gamma+1)a_{R}}(u_{R} - \frac{x}{t}) \Big]^{\frac{2}{\gamma-1}} \\
	u = \frac{2}{\gamma + 1}\Big[ -a_{R} + \frac{\gamma-1}{2}u_{R} + \frac{x}{t} \Big] \\
	p = p_{R}\Big[ \frac{2}{\gamma + 1} + \frac{\gamma-1}{(\gamma+1)a_{R}} (u_{R} - \frac{x}{t}) \Big]^{\frac{2\gamma}{\gamma-1}}
	\end{array}\right.
	\end{align}

The rest of this chapter is devoted to providing approximate solutions for the star values. We study four approaches as well as two adaptive schemes that combine various approximations.


Primitive Variable Riemann Solvers (PVRS)
--------------------------------------------

A very simple linearised solution to the Riemann problem for the x-split, three dimensional time dependent Euler equations can be obtained in terms of the primitive variables :math:`\rho, u, v, w, p` . The corresponding governing equations are

.. math::
	\begin{align}
	\mathbf{W}_{t} + \mathbf{A}(\mathbf{W})\mathbf{W}_{x} = \mathbf{0}
	\end{align}

where the coefficient matrix :math:`\mathbf{A}(\mathbf{W})` is given by

.. math::
	\begin{align}
	\mathbf{A} = 
	\begin{bmatrix}
	u & \rho & 0 & 0 & 0 \\
	0 & u & 0 & 0 & 1/\rho \\
	0 & 0 & u & 0 & 0 \\
	0 & 0 & 0 & u & 0 \\
	0 & \rho a^{2} & 0 & 0 & u
	\end{bmatrix}
	\end{align}

The eigenvalues of :math:`\mathbf{A}(\mathbf{W})` are

.. math::
	\begin{align}
	\lambda_{1} = u - a
	,\quad
	\lambda_{2} = \lambda_{3} = \lambda_{4} = u
	,\quad
	\lambda_{5} = u + a
	\end{align}

and the matrix of corresponding right eigenvectors is

.. math::
	\begin{align}
	\mathbf{K} = 
	\begin{bmatrix}
	\rho & 1 & \rho & \rho & \rho \\
	-a & 0 & 0 & 0 & a \\
	0 & v & 1 & v & 0 \\
	0 & w & w & 1 & 0 \\
	\rho a^{2} & 0 & 0 & 0 & \rho a^{2}
	\end{bmatrix}
	\end{align}

The difficulty in solving is due to the fact that the coefficient matrix :math:`\mathbf{A}(\mathbf{W})` depends on the solution vector :math:`\mathbf{W}` itself. If :math:`\mathbf{A}(\mathbf{W})` were to be constant, then we could apply the various techniques for solving linear hyperbolic systems with constant coefficients.

Assume that the initial data :math:`\mathbf{W}_{L}, \mathbf{W}_{R}` and the solution :math:`\mathbf{W}(x/t)` are close to a constant state :math:`\bar{\mathbf{W}}` . Then, by setting

.. math::
	\begin{align}
	\bar{\mathbf{A}} \equiv \mathbf{A}(\bar{\mathbf{W}})
	\end{align}

we approximate the Riemann problem for :math:`\mathbf{W}_{t} + \mathbf{A}(\mathbf{W})\mathbf{W}_{x} = \mathbf{0}` by the Riemann problem for the linear hyperbolic systems with constant coefficients

.. math::
	\begin{align}
	\mathbf{W}_{t} + \bar{\mathbf{A}}\mathbf{W}_{x} = \mathbf{0}
	\end{align}

We now solve this approximate problem, with initial data :math:`\mathbf{W}_{L},\mathbf{W}_{R}` , exactly. We have studied various techniques that are directly applicable to this problem. One possibility is to apply Rankine-Hugoniot Conditions across each wave of speed :math:`\bar{\lambda}_{i}` . Thus we treat :math:`\mathbf{W}_{t} + \bar{\mathbf{A}}\mathbf{W}_{x} = \mathbf{0}` as the system in conservative form

.. math::
	\begin{align}
	\mathbf{W}_{t} + \mathbf{F}(\mathbf{W})_{x} = \mathbf{0}
	,\quad
	\mathbf{F}(\mathbf{W}) \equiv \bar{\mathbf{A}}\mathbf{W}
	\end{align}

Then, across a wave of speed :math:`\bar{\lambda}_{i}` we have

.. math::
	\begin{align}
	\Delta \mathbf{F} \equiv \bar{\mathbf{A}} \Delta\mathbf{W} = \bar{\lambda_{i}}\Delta \mathbf{W}
	\end{align}

Direct application of it to the :math:`\bar{\lambda}_{1}` and :math:`\bar{\lambda}_{5}` waves gives four useful relations, namely

.. math::
	\begin{align}
	& (u_{*} - u_{L})\bar{\rho} + \bar{a} (\rho_{*L} - \rho_{L}) = 0 \\
	& (\rho_{*} - \rho_{L})/\bar{\rho} + \bar{a} (u_{*} - u_{L}) = 0 \\
	& (u_{R} - u_{*})/\bar{\rho} - \bar{a}(\rho_{R} - \rho_{*R}) = 0 \\
	& (p_{R} - p_{*})/\bar{\rho} - \bar{a}(u_{R} - u_{*}) = 0
	\end{align}

The complete solution for the unknowns is then given by

.. math::
	\begin{align}
	& p_{*} = \frac{1}{2}(p_{L} + p_{R}) + \frac{1}{2}(u_{L} - u_{R}) (\bar{p}\bar{a}) \\
	& u_{*} = \frac{1}{2}(u_{L} + u_{R}) + \frac{1}{2}(p_{L} - p_{R})/(\bar{\rho}\bar{a}) \\
	& \rho_{*L} = \rho_{L} + (u_{L} - u_{*})(\bar{\rho}/\bar{a}) \\
	& \rho_{*R} = \rho_{R} + (u_{*} - u_{R})(\bar{\rho}/\bar{a})
	\end{align}

Notice that in this linearised solution we only need to specify constant values for :math:`\bar{\rho}` and :math:`\bar{a}` . There is some freedom in making the choice. Selecting some average of the data values :math:`\rho_{L}, \rho_{R}, a_{L}, a_{R}` appears sensible. The choice may be constrained to satisfy some desirable properties of the Riemann problem solution, such as exact recognition of particular flow features. Here we suggest to select the simple arithmetic means

.. math::
	\begin{align}
	\bar{\rho} = \frac{1}{2}(\rho_{L} + \rho_{R})
	,\quad
	\bar{a} = \frac{1}{2}(a_{L} + a_{R})
	\end{align}

Note that if the data states :math:`\mathbf{W}_{L}` and :math:`\mathbf{W}_{R}` are connected by a single isolated contact discontinuity or shear wave, then the solution is actually exact, regardless of the particular choice for the averages :math:`\bar{\rho}` and :math:`\bar{a}` . This is in fact a very important property; contacts and shear waves turn out to be some of the most challenging flow features to resolve correctly by any numerical method.

Another way of obtaining approximate solutions for the star values is to use the characteristic equations

.. math::
	\begin{align}
	& \mathrm{d}p - \rho a \mathrm{d}u = 0 \quad \text{along}~\mathrm{d}x/\mathrm{d}t = u - a \\
	& \mathrm{d}p - a^{2}\mathrm{d}\rho = 0 \quad \text{along}~\mathrm{d}x/\mathrm{d}t = u \\
	& \mathrm{d}p + \rho a \mathrm{d}u = 0 \quad \text{along}~\mathrm{d}x/\mathrm{d}t = u + a
	\end{align}

These differential relations hold true along characteristic directions. First we set

.. math::
	\begin{align}
	C = \rho a
	\end{align}

Then, in order to find the star values we connect the state :math:`\mathbf{W}_{*L}` to the data state :math:`\mathbf{W}_{L}` , see Fig.9.1, by integrating the third characteristic equation along the characteristic of speed :math:`u+a` , where :math:`C` is evaluated at the foot of the characteristic. See Fig.9.3 The results is

.. math::
	\begin{align}
	p_{*} + C_{L}u_{*} = p_{L} + C_{L}u_{L}
	\end{align}

Similarly, we connect :math:`\mathbf{W}_{*R}` to the data state :math:`\mathbf{W}_{R}` by integrating first characteristic equation along the characteristic of speed :math:`u-a` , with :math:`C` is evaluated at the foot of the characteristic. We obtain

.. math::
	\begin{align}
	p_{*} - C_{R}u_{*} = p_{R} - C_{R}u_{R}
	\end{align}

The values :math:`\rho_{*L}` and :math:`\rho_{*R}` are obtained by connecting :math:`\mathbf{W}_{*L}` to :math:`\mathbf{W}_{L}` and :math:`\mathbf{W}_{*R}` to :math:`\mathbf{W}_{R}` via the second characteristic equation. The complete solution is

.. math::
	\begin{align}
	& p_{*} = \frac{1}{C_{L} + C_{R}}\Big[ C_{R}p_{L} + C_{L}p_{R} + C_{L}C_{R}(u_{L} - u_{R}) \Big] \\
	& u_{*} = \frac{1}{C_{L} + C_{R}}\Big[ C_{L}u_{L} + C_{R}u_{R} + (p_{L} - p_{R}) \Big] \\
	& \rho_{*L} = \rho_{L} + (p_{*} - p_{L})/a_{L}^{2} \\
	& \rho_{*R} = \rho_{R} + (p_{*} - p_{R})/a_{R}^{2}
	\end{align}

In this approximation we do not need to make a choice for the averages :math:`\bar{\rho}` and :math:`\bar{a}` ; their values are replaced by data values at the foot of the corresponding characteristics. If :math:`C_{L} = C_{R} = \bar{\rho}\bar{a}` , then the two approximations are identical.

The two linearised approximations for the star values are exceedingly simple and may be useful in a variety of ways. The approaches might prove very useful in solving the Riemann problem for complicated sets of equations.

We have now given the complete approximation solution to the sub-problems. In order to evaluate the Godunov flux we need to sample the solution to find the value :math:`\mathbf{W}_{i+\frac{1}{2}}(0)` along the t-axis. This sampling procedure is virtually identical, although simpler, to the sampling procedure for the exact Riemann problem solution. The reader is made aware that the numerical schemes associated with the simple linearised solutions just derived may not be robust enough to be used with absolute confidence under all flow condtions. We will study hybrid Riemann solvers, which combine simple and sophisticated solvers to provide schemes that have effectively the computational cost of the simplest Riemann solvers and the robustness of the sophisticated Riemann solvers.




Approximations Based on the Exact Solver
-------------------------------------------

We have presented an exact Riemann solver based on the pressure equation

.. math::
	\begin{align}
	f(p) \equiv f_{L}(p, \mathbf{W}_{L}) + f_{R}(p, \mathbf{W}_{R}) + \Delta u = 0
	,\quad
	\Delta u = u_{R} - u_{L}
	\end{align}

with

.. math::
	\begin{align}
	f_{K}(p) = \left\{ \begin{array}{l}
	(p - p_{K})\Big[ \frac{A_{K}}{p + B_{K}} \Big]^{\frac{1}{2}} \quad \text{if}~ p>p_{K}~(\text{shock}) \\
	\frac{2a_{K}}{\gamma-1}\Big[ \Big(\frac{p}{p_{K}}\Big)^{z} - 1 \Big] \quad \text{if}~ p \le p_{K} ~(\text{rarefaction})
	\end{array} \right.
	\end{align}

.. math::
	\begin{align}
	z = \frac{\gamma - 1}{2\gamma}
	,\quad
	A_{K} = \frac{2}{(\gamma+1)\rho_{K}}
	,\quad
	B_{K} = \Big( \frac{\gamma - 1}{\gamma + 1} \Big)p_{K}
	,\quad
	K = L,R
	\end{align}

Various approximations based on :math:`f(p) = 0` can be obtained, including curve-fitting procedures. Here we give approximations based on the rarefaction and shock branches of :math:`f(p)` .


A Two-Rarefaction Riemann Solver (TRRS)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Recall that the non-linear waves in the Riemann problem solution are either shock or rarefaction waves and finding their type is part of the solution procedure. If one assumes :math:`a` -priori that both non-linear waves are rarefactions then, with the appropriate choice of :math:`f_{L}` and :math:`f_{R}` above, becomes

.. math::
	\begin{align}
	\frac{2a_{L}}{\gamma - 1} \Big[ \Big( \frac{p}{p_{L}} \Big)^{2} - 1 \Big]
	+ \frac{2a_{R}}{\gamma - 1} \Big[ \Big( \frac{p}{p_{R}} \Big)^{2} - 1 \Big]
	+ u_{R} - u_{L} = 0
	\end{align}

Solving this equation for pressure :math:`p_{*}` gives the approximation

.. math::
	\begin{align}
	p_{*} = \bigg[ \frac{a_{L} + a_{R} - \frac{\gamma-1}{2}(u_{R} - u_{L})}{a_{L}/p_{L}^{z} + a_{R}/p_{R}^{z}} \bigg]^{\frac{1}{z}}
	\end{align}

Having found :math:`p_{*}` one can obtain the particle velocity :math:`u_{*}` from any of the rarefaction wave relations

.. math::
	\begin{align}
	u_{*} = u_{L} - \frac{2a_{L}}{\gamma - 1}\Big[ \Big(\frac{p_{*}}{p_{L}}\Big)^{z} - 1 \Big]
	\end{align}

or

.. math::
	\begin{align}
	u_{*} = u_{R} + \frac{2a_{R}}{\gamma - 1}\Big[ \Big(\frac{p_{*}}{p_{R}}\Big)^{z} - 1 \Big]
	\end{align}

Alternatively, one can eliminate :math:`\rho_{*}` from the above relations to obtain a closed-form solution for the particle velocity

.. math::
	\begin{align}
	u_{*} = \frac{P_{LR}u_{L}/a_{L} + u_{R}a_{R} + 2(P_{LR} - 1)/(\gamma-1)}{P_{LR}/a_{L} + 1/a_{R}}
	,\quad
	P_{LR} = \Big(\frac{p_{L}}{p_{R}}\Big)^{2}
	\end{align}


Computing :math:`p_{*}` from the approximation expression requires the evaluation of 3 fractional powers. A more efficient approach is to calculate :math:`u_{*}` from the above equation, which only requires one fractional power, and then evaluate :math:`p_{*}` from one of the two rarefaction wave relations, or from a mean value as

.. math::
	\begin{align}
	p_{*} = \frac{1}{2}\bigg\{ p_{L} \Big[ 1 + \frac{\gamma-1}{2a_{L}}(u_{L} - u_{*}) \Big]^{\frac{1}{z}} + p_{R}\Big[ 1 + \frac{\gamma-1}{2a_{R}}(u_{*} - u_{R}) \Big]^{\frac{1}{z}} \bigg\}
	\end{align}

Being consistent with the assumption that the two nonlinear waves are rarefaction waves, the computation of the densities :math:`\rho_{*L}` and :math:`\rho_{*R}` on either side of the contact discontinuity is obtained from the isentropic law. The result is

.. math::
	\begin{align}
	\rho_{*L} = \rho_{L} \Big( \frac{p_{*}}{p_{L}} \Big)^{\frac{1}{\gamma}}
	,\quad
	\rho_{*R} = \rho_{R} \Big( \frac{p_{*}}{p_{R}} \Big)^{\frac{1}{\gamma}}
	\end{align}

An improved version of the two-rarefaction solution is obtained by using exact relations, for given :math:`p_{*}` or :math:`u_{*}` . For instance, suppose :math:`p_{*}` is given by approximation say, then :math:`u_{*}` can be found from

.. math::
	\begin{align}
	u_{*} = \frac{1}{2}(u_{L} + u_{R}) + \frac{1}{2}[f_{R}(p_{*}) - f_{L}(p_{*})]
	\end{align}

where the functions :math:`f_{L}` and :math:`f_{R}` are evaluated according to the exact relations :math:`f_{K}(p)` by comparing :math:`p_{*}` with :math:`p_{L}` and :math:`p_{R}` . The densities :math:`\rho_{*L}` and :math:`\rho_{*R}` can be found from the isentropic law if the :math:`K` wave is a rarefaction :math:`(p_{*} \le p_{K})` or from the shock relation if the :math:`K` wave is a shock wave :math:`(p_{*} > p_{K})` .


The two-rarefaction approximation is generally quite robust; it is more accurate, although more expensive, than the simple PVRS solutions. The TRRS is in fact exact when both nonlinear waves are actually rarefaction waves. This can be detected a-priori by the condition

.. math::
	\begin{align}
	f(p_{\min}) \ge 0 \quad \text{with}~ p_{\min} = \min(p_{L}, p_{R})
	\end{align}


We have now given another approximate solution to the star values problem. The solution for :math:`\mathbf{W}_{Lfan},\mathbf{W}_{Rfan}` follows. The evaluation of the Godunov flux requires sampling the solution to find the value :math:`\mathbf{W}_{i+\frac{1}{2}}(0)` along the t-axis, in the usual way.


A Two-Shock Riemann Solver (TSRS)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

By assuming that both non-linear waves are shock waves in :math:`f(p) \equiv f_{L}(p,\mathbf{W}_{L}) + f_{R}(p,\mathrm{W}_{R}) + \Delta u = 0` , :math:`f_{K}(p)` , one can derive the two-shock approximation

.. math::
	\begin{align}
	f(p) = (p - p_{L})g_{L}(p) + (p - p_{R})g_{R}(p) + u_{R} - u_{L} = 0
	\end{align}

with

.. math::
	\begin{align}
	g_{K}(p) = \bigg[ \frac{A_{K}}{p + B_{K}} \bigg]^{\frac{1}{2}}
	,\quad
	A_{K} = \frac{2}{(\gamma + 1)\rho_{K}}
	,\quad
	B_{K} = \Big(\frac{\gamma - 1}{\gamma + 1}\Big)p_{K}
	,\quad
	K = L,R
	\end{align}

Unfortunately, this approximation does not lead to a closed-form solution. Further approximations must be constructed. Obvious approximations to the two-shock approximation involve quadratic equations. These do not generally lead to robust schemes. One difficulty is the non-uniqueness of solutions and making the correct choice; the exact solution is unique. The other problem is the case of complex roots (non-existence) even for data for which the exact problem has a solution; in our experience these can occur very often and is therefore the most serious difficulty of the two-shock approach.

An alternative approach is as follows. First we assume an estimate :math:`p_{0}` for the solution for pressure. Then we insert this estimate in the functions :math:`g_{K}(p)` , which in turn are substituted into two-shock approximation equation. We obtain

.. math::
	\begin{align}
	(p - p_{L})g_{L}(p_{0}) + (p - p_{R})g_{R}(p_{0}) + u_{R} - u_{L} = 0
	\end{align}

The solution of this equation is immediate:

.. math::
	\begin{align}
	p_{*} = \frac{g_{L}(p_{0})p_{L} + g_{R}(p_{0})p_{R} - (u_{R} - u_{L})}{g_{L}(p_{0}) + g_{R}(p_{0})}
	\end{align}

Being consistent with the two-shock assumption we derive a solution for the velocity :math:`u_{*}` as

.. math::
	\begin{align}
	u_{*} = \frac{1}{2}(u_{L} + u_{R}) + \frac{1}{2} \big[(p_{*} - p_{R})g_{R}(p_{0}) - (p_{*} - p_{L})g_{L}(p_{0}) \big]
	\end{align}

Solution values for :math:`\rho_{*L}` and :math:`\rho_{*R}` obtained from shock relations namely

.. math::
	\begin{align}
	\rho_{*L} = \rho_{L} \bigg[ \frac{\frac{p_{*}}{p_{L}} + \frac{\gamma-1}{\gamma+1}}{\frac{\gamma-1}{\gamma+1}\frac{p_{*}}{p_{L}} + 1} \bigg]
	,\quad
	\rho_{*R} = \rho_{R} \bigg[ \frac{\frac{p_{*}}{p_{R}} + \frac{\gamma-1}{\gamma+1}}{\frac{\gamma-1}{\gamma+1}\frac{p_{*}}{p_{R}} + 1} \bigg]
	\end{align}

As to the choice for the pressure estimate :math:`p_{0}` we propose

.. math::
	\begin{align}
	p_{0} = \max(0, p_{pvrs})
	\end{align}

where :math:`p_{pvrs}` is the solution for pressure given by the PVRS solver.


We have just presented another approximate solution to the problem. As before, the solution for :math:`\mathbf{W}_{Lfan},\mathbf{W}_{Rfan}` follows. The evaluation of the Godunov flux requires sampling the solution to find the value :math:`\mathbf{W}_{i+\frac{1}{2}}(0)` along the t-axis, in the usual way.

The approximation given above to the star values is more efficient than the TRRS and only slightly more expensive than the PVRS approximations. Also TSRS is more accurate then TRRS and PVRS for a wider range of flow conditions, except for near vacuum condtions, where TRRS is very accurate or indeed exact. As for the case of the TRRS approximation, we improve the TSRS by using the true wave relations whenever possible. For instance, for given :math:`p_{*}` as computed from the above expression, one can obtain :math:`u_{*},\rho_{*L}` and :math:`\rho_{*R}` from exact wave relations. This is bound to improve the accuracy of the derived quantities.



Adaptive Riemann Solvers
---------------------------

In a typical flow field the overwhelming majority of local Riemann problems are a representation for smooth flow. Large gradients occur only near shock waves, contact surfaces, shear waves or some other sharp flow features. Large gradients generate Riemann problems with widely different data states :math:`\mathbf{W}_{L}, \mathbf{W}_{R}` . Generally, it is in this kind of situations where approximate Riemann solvers can be fatally inaccurate leading to a failure of the numerical method being used. The rationale behind the use of hybrid schemes is the use of simple Riemann solvers in regions of smooth flow and near isolated contacts and shear waves and more sophisticated Riemann solvers elsewhere in an adaptive fashion.

An Adaptive Iterative Riemann Solver (AIRS)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

This adaptive scheme makes use of two Riemann solvers: any of primitive-variable Riemann solvers PVRS and exact Riemann solver. The PVRS scheme is used if the following two condtions are met:

.. math::
	\begin{align}
	Q = p_{\max} / p_{\min} < Q_{user}
	\end{align}

and 

.. math::
	\begin{align}
	p_{\min} < p_{*} < p_{\max}
	\end{align}

where

.. math::
	\begin{align}
	p_{\min} \equiv \min(p_{L},p_{R})
	,\quad
	p_{\max} \equiv \max(p_{L},p_{R})
	,\quad
	p_{*} \equiv p_{pvrs}
	\end{align}

Otherwise, the exact Riemann solver is used.

Some remarks on the switching conditions above are in order. Condition :math:`Q = p_{\max} / p_{\min} < Q_{user}` ensures that the pressure data values :math:`p_{L},p_{R}` are not widely different. Condition :math:`p_{\min} < p_{*} < p_{\max}` imposes an extra restriction on the use of PVRS. The pressure restriction is no sufficient; in fact for :math:`Q \approx 1, (p_{L} \approx p_{R})` and :math:`\Delta u = u_{R} - u_{L}` negative and large in absolute value, strong shock waves are present in the solution of the Riemann problem, that is :math:`p_{*} > p_{\max}` . For :math:`\Delta u` large and positive :math:`p_{*} < p_{\min}` and strong rarefactions are present in the exact solution of the Riemann problem. Condition :math:`p_{\min} < p_{*} < p_{\max}` is effectively a condition on :math:`\Delta u` and excludes the two-rarefaction and the two-shock cases; both of these cases occur naturally at reflected boundaries, where it would be unwise to employ unreliable approxiamtions. Also, these two cases are inconsistent with condtion :math:`Q = p_{\max} / p_{\min} < Q_{user}` on pressure ratios.

A choice of the switching parameter :math:`Q_{user}` is to be made. Extensive testing suggests that the value :math:`Q_{user} = 2` is perfectly adequate to give both very robust and efficient schemes. Even much larger values of :math:`Q_{user}` can give accurate solutions, but the gains are not significant and thus the cautions choice of :math:`Q_{user} = 2` is recommended. For typical flow conditions and meshes, over :math:`90\%` of  all Riemann problems are handled by the cheap linearised Riemann solver. Effectively, the resulting schems have the efficiency of the cheapest Riemann solvers and the robustness of the exact Riemann solver. A disadvantage of this hybrid PVRS-EXACT scheme is the iterative character of the robust component of the scheme, namely the exact Riemann solver. This may be inconvenient for some computer architectures. One possiblity here is to fix the number of iterations in the exact Riemann solver. In our experience, one iteration leads to very accurate values for pressure and subsequent quantities derived. This is due in part to the provision of a sophisticated starting value for the iteration procedure.


An Adaptive Noniterative Riemann Solver (ANRS)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Here we propose to combine a PVRS scheme, as the cheap component, together with the non-iterative TRRS and TSRS solvers to provide the robust component of the adaptive scheme. The use of PVRS is again restricted by conditions of the previous scheme. If any of conditions are not met we use either TRRS or TSRS. The switching between TRRS and TSRS is motivated by the behaviour of the exact function for pressure, and is as follows. If

.. math::
	\begin{align}
	p_{pvrs} \le p_{\min}
	\end{align}

then we use TRRS, otherwise we use TSRS. The flow chart of Fig.9.4 illustrates the implementation of this adaptive scheme. The problems of computing the tangential velocity components, handling sonic flow and the sampling procedure to find the Godunov flux are dealt with as described in the previous sections. This adaptive noniterative Riemann solver is recommended for practical applications.




The HLL and HLLC Riemann Solvers
====================================

For the purpose of computing a Godunov flux, Harten, Lax and van Leer proposed HLL Riemann solvers. In this approach an approximation for the intercell numerical flux is obtained directly. The central idea is assume, for the solution, a wave configuration that consists of two wave separating three constant states. Assuming that the wave speeds are given by some algorithm, application of the integral form of the conservation laws gives a closed-form, approximate expression for the flux. The resulting HLL-type Riemann solvers form the bases of very efficient and robust approximate Godunov-type methods.

One difficulty with these schemes, however, is the assumption of a  two-wave configuration. This is correct only for hyperbolic systems of two equations, such as the one-dimensional shallow water equations. For larger systems, such as the Euler equations or the split two-dimensional shallow water equations for example, the two-wave assumption is incorrect. As a consequence the resolution of physical features such as contact surfaces, shear waves and material interfaces, can be very inaccurate. For the limiting case in which these features are stationary relative to the mesh, the resulting numerical smearing is unacceptable.

A different approach to remedy the problem of intermediate waves in the HLL approach waves was taken by Toro, Spruce and Speares. They proposed the HLLC Riemann solver (C standing for Contact), as applied to the time-dependent Euler equations. HLLC is a three-wave model, resulting two-star states for the intermediate region of the Riemann-problem solution fan. The approximate wave structure of HLLC contains all the characteristic fields of the exact problem. However, for systems with eigenstructure containing more than three distinct characteristic fields, HLLC becomes incomplete, tending to behave like HLL for the one-dimensional Euler equations. The incomplete character of a Riemann solver affects the resolution of intermediate waves, particularly when these move slowly relative to the mesh. Therefore, the obvious way of improving the HLLC approach is to admit the correct number of characteristic fields for the system of interest.


The Riemann Problem
-----------------------

We concerned with solving numerically the general Initial Boundary Value Problem (IBVP)

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \mathbf{U}^{(0)}(x) \\
	& \mathbf{U}(0,t) = \mathbf{U}_{l}(t) ,\quad \mathbf{U}(L,t) = \mathbf{U}_{r}(t)
	\end{align}

in a domain :math:`0 \le x \le L` , with appropriate boundary conditions. We use the explicit conservative formula

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} - \frac{\Delta t}{\Delta x}[\mathbf{F}_{i+\frac{1}{2}} - \mathbf{F}_{i-\frac{1}2{}}]
	\end{align}

with the numerical flux :math:`\mathbf{F}_{i+\frac{1}{2}}` yet to be defined.


The Godunov Flux
^^^^^^^^^^^^^^^^^^^

We defined the Godunov intercell numerical flux as

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}(\mathbf{U}_{i+\frac{1}{2}}(0))
	\end{align}

in which :math:`\mathbf{U}_{i+\frac{1}{2}}(0)` is the exact similarity solution :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` of the Riemann problem

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \left\{ \begin{array}{l}
	\mathbf{U}_{L} \quad \text{if}~ x<0 \\
	\mathbf{U}_{R} \quad \text{if}~ x>0
	\end{array} \right.
	\end{align}

evaluated at :math:`x/t=0` . Fig.10.1 shows the structure of the exact solution of the Riemann problem for the x-split, three dimensional Euler equations, for which the vectors of conserved variables and fluxes are

.. math::
	\begin{align}
	\mathbf{U} = 
	\begin{bmatrix}
	\rho \\ \rho u \\ \rho v \\ \rho w \\ E
	\end{bmatrix}
	,\quad
	\mathbf{F} = 
	\begin{bmatrix}
	\rho u \\ \rho u^{2} + p \\ \rho u v \\ \rho u w \\ u(E + p)
	\end{bmatrix}
	\end{align}

The value :math:`x/t=0` for the Godunov flux corresponds to the t-axis. The piece-wise constant initial data, in terms of primitive variables, is

.. math::
	\begin{align}
	\mathbf{W}_{L} = 
	\begin{bmatrix}
	\rho_{L} \\ u_{L} \\ v_{L} \\ w_{L} \\ p_{L}
	\end{bmatrix}
	,\quad
	\mathbf{W}_{R} = 
	\begin{bmatrix}
	\rho_{R} \\ u_{R} \\ v_{R} \\ w_{R} \\ p_{R}
	\end{bmatrix}
	\end{align}

We provided approximations to the state :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` and obtained a corresponding approximate Godunov method by evaluating the physical flux function :math:`\mathbf{F}` at this approximate state. The purpose of this chapter is to find direct approximations to the flux function :math:`\mathbf{F}_{i+\frac{1}{2}}` following the novel approach proposed by Harten, Lax and van Leer.


Integral Relations
^^^^^^^^^^^^^^^^^^^^^

Consider Fig.10.2, in which the whole of the wave structure arising from the exact solution of the Riemann problem is contained in the control volume :math:`[x_{L},x_{R}] \times [0,T]` , that is 

.. math::
	\begin{align}
	x_{L} \le TS_{L}
	,\quad
	x_{R} \ge TS_{R}
	\end{align}

where :math:`S_{L}` and :math:`S_{R}` are the fastest signal velocities perturbing the initial data states :math:`\mathbf{U}_{L}` and :math:`\mathbf{U}_{R}` respectively, and :math:`T` is a chosen time. The integral form of the conservation laws in control volume :math:`[x_{L},x_{R}] \times [0,T]` reads

.. math::
	\begin{align}
	\int_{x_{L}}^{x_{R}}\mathbf{U}(x,T)\mathrm{d}x
	= \int_{x_{L}}^{x_{R}}\mathbf{U}(x,0)\mathrm{d}x
	+ \int_{0}^{T}\mathbf{F}(\mathbf{U}(x_{L},t))\mathrm{d}t
	- \int_{0}^{T}\mathbf{F}(\mathbf{U}(x_{R},t))\mathrm{d}t
	\end{align}

Evaluation of the right-hand side of this expression gives

.. math::
	\begin{align}
	\int_{x_{L}}^{x_{R}} \mathbf{U}(x,T)\mathrm{d}x
	= x_{R}\mathbf{U}_{R}
	- x_{L}\mathbf{U}_{L}
	+ T(\mathbf{F}_{L} - \mathbf{F}_{R})
	\end{align}

where :math:`\mathbf{F}_{L} = \mathbf{F}(\mathbf{U}_{L})` and :math:`\mathbf{F}_{R} = \mathbf{F}(\mathbf{U}_{R})` . We call this integral relation **the consistency condition** . Now we split the integral on the left-hand side of the integral form of the conservation laws into three integrals, namely

.. math::
	\begin{align}
	\int_{x_{L}}^{x_{R}} \mathbf{U}(x,T)\mathrm{d}x
	= \int_{x_{L}}^{TS_{L}}\mathbf{U}(x,T)\mathrm{d}x
	+ \int_{TS_{L}}^{TS_{R}}\mathbf{U}(x,T)\mathrm{d}x
	+ \int_{TS_{R}}^{x_{R}}\mathbf{U}(x,T)\mathrm{d}x
	\end{align}

and evaluate the first and third terms on the right-hand side. We obtain

.. math::
	\begin{align}
	\int_{x_{L}}^{x_{R}} \mathbf{U}(x,T)\mathrm{d}x
	= \int_{TS_{L}}^{TS_{R}}\mathbf{U}(x,T)\mathrm{d}x
	+ (TS_{L} - x_{L})\mathbf{U}_{L}
	+ (x_{R} - TS_{R})\mathbf{U}_{R}
	\end{align}

Comparing it with the consistency condition gives

.. math::
	\begin{align}
	\int_{TS_{L}}^{TS_{R}}\mathbf{U}(x,T)\mathrm{d}x
	= T(S_{R}\mathbf{U}_{R} - S_{L}\mathbf{U}_{L} + \mathbf{F}_{L} - \mathbf{F}_{R})
	\end{align}

On division through by the length :math:`T(S_{R} - S_{L})` , which is the width of the wave system of the solution of the Riemann problem between the slowest and fastest signals at time :math:`T` , we have

.. math::
	\begin{align}
	\frac{1}{T(S_{R} - S_{L})}\int_{TS_{L}}^{TS_{R}}\mathbf{U}(x,T)\mathrm{d}x
	= \frac{S_{R}\mathbf{U}_{R} - S_{L}\mathbf{U}_{L} + \mathbf{F}_{L} - \mathbf{F}_{R}}{S_{R} - S_{L}}
	\end{align}

Thus, the integral average of the exact solution of the Riemann problem between the slowest and fastest signals at time :math:`T` is a known constant, provided that the signal speeds :math:`S_{L}` and :math:`S_{R}` are known; such constant is the right-hand side of the above equation and we denote it by

.. math::
	\begin{align}
	\mathbf{U}^{hll} = \frac{S_{R}\mathbf{U}_{R} - S_{L}\mathbf{U}_{L} + \mathbf{F}_{L} - \mathbf{F}_{R}}{S_{R} - S_{L}}
	\end{align}

We now apply the integral form of the conservation laws to the left portioin of Fig.10.2, that is the control volume :math:`[x_{L},0] \times [0,T]` . We obtain

.. math::
	\begin{align}
	\int_{TS_{L}}^{0}\mathbf{U}(x,T)\mathrm{d}x = -TS_{L}\mathbf{U}_{L} + T(\mathbf{F}_{L} - \mathbf{F}_{0L})
	\end{align}

where :math:`\mathbf{F}_{0L}` is the flux :math:`\mathbf{F}(\mathbf{U})` along the t-axis. Solving for :math:`\mathbf{F}_{0L}` we find 

.. math::
	\begin{align}
	\mathbf{F}_{0L} = \mathbf{F}_{L} - S_{L}\mathbf{U}_{L} - \frac{1}{T}\int_{TS_{L}}^{0}\mathbf{U}(x,T)\mathrm{d}x
	\end{align}

Evaluation of the integral form of the conservation laws on the control volume :math:`[0,x_{R}] \times [0,T]` yields

.. math::
	\begin{align}
	\mathbf{F}_{0R} = \mathbf{F}_{R} - S_{R}\mathbf{U}_{R} + \frac{1}{T}\int_{0}^{TS_{R}}\mathbf{U}(x,T)\mathrm{d}x
	\end{align}

We can easily veriy that the equality

.. math::
	\begin{align}
	\mathbf{F}_{0L} = \mathbf{F}_{0R}
	\end{align}

results in the consistency condition. All relations so far are exact, as we are assuming the exact solution of the Riemann problem.


The HLL Approximate Riemann Solver
------------------------------------

Harten, Lax and van Leer put forward the following approximate Riemann solver

.. math::
	\begin{align}
	\tilde{\mathbf{U}}(x,t) = \left\{ \begin{array}{l}
	\mathbf{U}_{L} \quad \text{if}~ \quad \frac{x}{t} \le S_{L} \\
	\mathbf{U}^{hll} \quad \text{if}~\quad S_{L} \le \frac{x}{t} \le S_{R} \\
	\mathbf{U}_{R} \quad \text{if}~\quad \frac{x}{t} \ge S_{R}
	\end{array} \right.
	\end{align}

where :math:`\mathbf{U}^{hll}` is the constant state vector and the speeds :math:`S_{L}` and :math:`S_{R}` are assumed to be known. Fig.10.3 shows the strcuture of this approximate solution of the Riemann problem, called the HLL Riemann solver. Note that this approximation consists of just three constant states separated by two waves. The Star Region consists of a single constant state; all intermediate states separated by intermediate waves are lumped into the single state :math:`\mathbf{U}^{hll}` . The corresponding flux :math:`\mathbf{F}^{hll}` along the t-axis is found from the relations :math:`\mathbf{F}_{0L}` or :math:`\mathbf{F}_{0R}` , with the exact integrand replaced by the approximate solution :math:`\tilde{\mathbf{U}}(x,t)` . Note that we do not take :math:`\mathbf{F}^{hll} = \mathbf{F}(\mathbf{U}^{hll})` . The non-trivial case of interest is the subsonic case :math:`S_{L} \le 0 \le S_{R}` . Substitution of the integrand in :math:`\mathbf{F}_{0L}` or :math:`\mathbf{F}_{0R}` by :math:`\mathbf{U}^{hll}` gives

.. math::
	\begin{align}
	\mathbf{F}^{hll} = \mathbf{F}_{L} + S_{L}(\mathbf{U}^{hll} - \mathbf{U}_{L})
	\end{align}

or 

.. math::
	\begin{align}
	\mathbf{F}^{hll} = \mathbf{F}_{R} + S_{R}(\mathbf{U}^{hll} - \mathbf{U}_{R})
	\end{align}

Note that the above two relations are also obtained from applying Rankine-Hugoniot conditions across the left and right waves respectively. Use of :math:`\mathbf{U}^{hll}` in the above two relations gives the HLL flux

.. math::
	\begin{align}
	\mathbf{F}^{hll} = \frac{S_{R}\mathbf{F}_{L} - S_{L}\mathbf{F}_{R} + S_{L}S_{R}(\mathbf{U}_{R} - \mathbf{U}_{L})}{S_{R} - S_{L}}
	\end{align}

The corresponding HLL intercell flux for the approximate Godunov method is then given by

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}}^{hll} = \left\{ \begin{array}{l}
	\mathbf{F}_{L} \quad \text{if}~ 0 \le S_{L} \\
	\frac{S_{R}\mathbf{F}_{L} - S_{L}\mathbf{F}_{R} + S_{L}S_{R}(\mathbf{U}_{R} - \mathbf{U}_{L})}{S_{R} - S_{L}} \quad \text{if}~ S_{L} \le 0 \le S_{R} \\
	\mathbf{F}_{R} \quad \text{if}~ 0 \ge S_{R}
	\end{array} \right.
	\end{align}

Given an algorithm to compute the speeds :math:`S_{L}` and :math:`S_{R}` we have an approximate intercell flux :math:`\mathbf{F}_{i+\frac{1}{2}}^{hll}` to be used in the conservative formula to produce an approximate Godunov method. Harten, Lax and van Leer showed that the Godunov scheme, if convergent, converges to the weak solution of the conservation laws. In fact they proved that the converged solution is also the physical, entropy satisfying, solution of the conservation laws. Their results actually apply to a larger class of approximate Riemann solvers. One of the requirements is consistency with the integral form of the conservation laws. That is, an approximate solution :math:`\tilde{\mathbf{U}}(x,t)` is consistent with the integral form of the conservation laws if, when substituted for the exact solution :math:`\mathbf{U}(x,t)` in the consistency condition, the right-hand side remains unaltered.


A shortcoming of the HLL scheme is exposed by contact discontinuities, shear waves and material interfaces, or any type of intermediate waves. For the Euler equations these waves are associated with the multiple eigenvalue :math:`\lambda_{2}=\lambda_{3}=\lambda_{4}=u` . Note that in the integral average of the exact solution of the Riemann problem between the slowest and fastest signals at time :math:`T` , all that matters is the average across the wave structure, without regard for the spatial variations of the solution of the Riemann problem in the Star Region. This defect of the HLL scheme may be corrected by restoring the missing waves. Accordingly, Toro, Spruce and Speares proposed the so called HLLC scheme, where C stands for Contact. In this scheme the missing middle waves are put back into the structure of the approximate Riemann solver.


The HLLC Approximate Riemann Solver
--------------------------------------

The HLLC scheme is a modification of the HLL scheme described in the previous section, whereby the missing contact and shear waves in the Euler equations are restored. The scheme was first presented in terms of the time-dependent, two dimensional Euler equations. Early applications include the steady supersonic two-dimensional Euler equations and the time-dependent two dimensional shallow water equations.

Useful Relations
^^^^^^^^^^^^^^^^^^

Consider Fig.10.2, in which the complete structure of the solution of the Riemann problem is contained in a sufficiently large control volume :math:`[x_{L},x_{R}] \times [0,T]` . Now, in addition to the slowest and fastest signal speeds :math:`S_{L}` and :math:`S_{R}` we include a middle wave of speed :math:`S_{*}` ; for the Euler equations this corresponds to the multiple eigenvalue :math:`\lambda_{2}=\lambda_{3}=\lambda_{4}=u` . See Fig.10.4. Evaluation of the integral form of the conservation laws in the control volume reproduces the result of equation of the integral average of the exact solution of the Riemann problem between the slowest and fastest signals at time :math:`T` , even if variations of the integrand across the wave of speed :math:`S_{*}` are allowed. Note that the consistency condition effectively becomes the condition of the integral average. By splitting the left-hand side of integral into two terms we obtain

.. math::
	\begin{align}
	\frac{1}{T(S_{R} - S_{L})}\int_{TS_{L}}^{TS_{R}}\mathbf{U}(x,T)\mathrm{d}x
	= \frac{1}{T(S_{R} - S_{L})} \int_{TS_{L}}^{TS_{*}}\mathbf{U}(x,T)\mathrm{d}x
	+ \frac{1}{T(S_{R} - S_{L})} \int_{TS_{*}}^{TS_{R}}\mathbf{U}(x,T)\mathrm{d}x
	\end{align}

We define the integral averages

.. math::
	\begin{align}
	& \mathbf{U}_{*L} = \frac{1}{T(S_{*} - S_{L})} \int_{TS_{L}}^{TS_{*}}\mathbf{U}(x,T)\mathrm{d}x \\
	& \mathbf{U}_{*R} = \frac{1}{T(S_{R} - S_{*})} \int_{TS_{*}}^{TS_{R}}\mathbf{U}(x,T)\mathrm{d}x
	\end{align}

The consistency condition becomes

.. math::
	\begin{align}
	\Big( \frac{S_{*} - S_{L}}{S_{R} - S_{L}} \Big)\mathbf{U}_{*L}
	+ \Big( \frac{S_{R} - S_{*}}{S_{R} - S_{L}} \Big) \mathbf{U}_{*R}
	= \mathbf{U}^{hll}
	\end{align}

The HLLC approximate Riemann solver is given as follows

.. math::
	\begin{align}
	\tilde{\mathbf{U}}(x,t) = \left\{ \begin{array}{l}
	\mathbf{U}_{L} ,\quad \text{if}~ \frac{x}{t} \le S_{L} \\
	\mathbf{U}_{*L} ,\quad \text{if}~ S_{L} \le \frac{x}{t} \le S_{*} \\
	\mathbf{U}_{*R} ,\quad \text{if}~ S_{*} \le \frac{x}{t} \le S_{R} \\
	\mathbf{U}_{R} ,\quad \text{if}~ \frac{x}{t} \ge S_{R}
	\end{array} \right.
	\end{align}

We seek a corresponding HLLC numerical flux defined as

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}}^{hllc} = \left\{ \begin{array}{l}
	\mathbf{F}_{L} ,\quad \text{if}~ 0 \le S_{L} \\
	\mathbf{F}_{*L} ,\quad \text{if}~ S_{L} \le 0 \le S_{*} \\
	\mathbf{F}_{*R} ,\quad \text{if}~ S_{*} \le 0 \le S_{R} \\
	\mathbf{F}_{R} ,\quad \text{if}~ 0 \ge S_{R}
	\end{array} \right.
	\end{align}

with the intermediate fluxes :math:`\mathbf{F}_{*L}` and :math:`\mathbf{F}_{*R}` still to be determined. Fig.10.4 shows the structure of the HLLC approximate Riemann solver.

By integrating over appropriate control volumes, or more directly, by applying Rankine-Hugoniot Conditions across each of the waves of speeds :math:`S_{L}, S_{*}, S_{R}` , we obtain

.. math::
	\begin{align}
	& \mathbf{F}_{*L} = \mathbf{F}_{L} + S_{L}(\mathbf{U}_{*L} - \mathbf{U}_{L}) \\
	& \mathbf{F}_{*R} = \mathbf{F}_{*L} + S_{*}(\mathbf{U}_{*R} - \mathbf{U}_{*L}) \\
	& \mathbf{F}_{*R} = \mathbf{F}_{R} + S_{R}(\mathbf{U}_{*R} - \mathbf{U}_{R})
	\end{align}

The three conditions are sufficient for ensuring consistency; these are three equations for the four unknowns vectors :math:`\mathbf{U}_{*L}, \mathbf{F}_{*L}, \mathbf{U}_{*R}, \mathbf{F}_{*R}` .



The HLLC Flux for the Euler Equations
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

We seek the solution for the two unknown intermediate fluxes :math:`\mathbf{F}_{*L}` and :math:`\mathbf{F}_{*R}` . From the three conditions above we see that it is sufficient to find solutions for the two intermediate state vectors :math:`\mathbf{U}_{*L}` and :math:`\mathbf{U}_{*R}` . There are more unknowns than equations and some extra conditions need to be imposed, in order to solve the algebraic problem. Obvious conditions to impose are those satisfied by the exact solution; for pressure and normal component of velocity we have

.. math::
	\begin{align}
	& p_{*L} = p_{*R} = p_{*} \\
	& u_{*L} = u_{*R} = u_{*}
	\end{align}

and for tangential velocity components we have

.. math::
	\begin{align}
	& v_{*L} = v_{L} ,\quad v_{*R} = v_{R} \\
	& w_{*L} = w_{L} ,\quad w_{*R} = w_{R}
	\end{align}

In addition, it is entirely justified, and convenient, to set

.. math::
	\begin{align}
	S_{*} = u_{*}
	\end{align}

and thus if an estimate for :math:`S_{*}` is known, the normal velocity component :math:`u_{*}` in the Star Region is known. Now the equations can be rearranged as

.. math::
	\begin{align}
	S_{L}\mathbf{U}_{*L} - \mathbf{F}_{*L} = S_{L}\mathbf{U}_{L} - \mathbf{F}_{L}
	\end{align}

and

.. math::
	\begin{align}
	S_{R}\mathbf{U}_{*R} - \mathbf{F}_{*R} = S_{R}\mathbf{U}_{R} - \mathbf{F}_{R}
	\end{align}

where the right-hand sides are known constant vectors. We also note the useful relation between :math:`\mathbf{U}` and :math:`\mathbf{F}` , namely

.. math::
	\begin{align}
	\mathbf{F}(\mathbf{U}) = u\mathbf{U} + p\mathbf{D}
	,\quad
	\mathbf{D} = [0, 1, 0, 0, u]^{T}
	\end{align}

Assuming that the wave speeds :math:`S_{L}` and :math:`S_{R}` are known and performing algebraic manipulations of the first and second components of the rearranged equations one obtains the following solutions for pressure in the two Star Regions

.. math::
	\begin{align}
	p_{*L} = p_{L} + \rho_{L}(S_{L} - u_{L})(S_{*} - u_{L})
	,\quad
	p_{*R} = p_{R} + \rho_{R}(S_{R} - u_{R})(S_{*} - u_{R})
	\end{align}

From :math:`p_{*L}=p_{*R}` allows us to obtain an expression for the speed :math:`S_{*}` purely in terms of the assumed speeds :math:`S_{L}` and :math:`S_{R}` , namely

.. math::
	\begin{align}
	S_{*} = \frac{p_{R} - p_{L} + \rho_{L}u_{L}(S_{L} - u_{L}) - \rho_{R}u_{R}(S_{R} - u_{R})}{\rho_{L}(S_{L} - u_{L}) - \rho_{R}(S_{R} - u_{R})}
	\end{align}

Thus, we only need to provide estimate for :math:`S_{L}` and :math:`S_{R}` , just as for the simpler HLL solver.

Algebraic manipulation of the rearranged equations and using the corresponding values :math:`p_{*L}` and :math:`p_{*R}` gives the intermediate fluxes :math:`\mathbf{F}_{*L}` and :math:`\mathbf{F}_{*R}` as

.. math::
	\begin{align}
	\mathbf{F}_{*K} = \mathbf{F}_{K} + S_{K}(\mathbf{U}_{*K} - \mathbf{U}_{K})
	\end{align}

for :math:`K=L,R` , with the intermediate states given as

.. math::
	\begin{align}
	\mathbf{U}_{*K} = \rho_{K} \Big( \frac{S_{K} - u_{K}}{S_{K} - S_{*}} \Big)
	\begin{bmatrix}
	1 \\
	S_{*} \\
	v_{K} \\
	w_{K} \\
	\frac{E_{K}}{\rho_{K}} + (S_{*} - u_{K})\Big[ S_{*} + \frac{p_{K}}{\rho_{K}(S_{K} - u_{K})} \Big]
	\end{bmatrix}
	\end{align}

The final choice of the HLLC flux is made according to the expression of :math:`\mathbf{F}_{i+\frac{1}{2}}^{hllc}` .


A variation in the formulation of the HLLC solver is the following. From the rearranged equations we may write the following solutions for the state vectors :math:`\mathbf{U}_{*L}` and :math:`\mathbf{U}_{*R}` 

.. math::
	\begin{align}
	\mathbf{U}_{*K} = \frac{S_{K}\mathbf{U}_{K} - \mathbf{F}_{K} + p_{*K}\mathbf{D}_{*}}{S_{L} - S_{*}}
	,\quad
	\mathbf{D}_{*} = [0, 1, 0, 0, S_{*}]
	\end{align}

with :math:`p_{*L}` and :math:`p_{*R}` as given by the expressions. Substitution of :math:`p_{*K}` from the expressions into the equation followed by use of expressions of :math:`\mathbf{F}_{*L}, \mathbf{F}_{*R}` gives direct expressions for the intermediate fluxes as

.. math::
	\begin{align}
	\mathbf{F}_{*K} = \frac{S_{*}(S_{K}\mathbf{U}_{K} - \mathbf{F}_{K}) + S_{K}(p_{K} + \rho_{L}(S_{K} - u_{K})(S_{*} - u_{K}))D_{*}}{S_{K} - S_{*}}
	\end{align}

with the final choice of the HLLC flux made again according to the expression of :math:`\mathbf{F}_{i+\frac{1}{2}}^{hllc}` .


We remark here that the first HLLC formulation enforces the condition :math:`p_{*L} = p_{*R}` , which is satisfied by the exact solution. In the alternative HLLC formulation we relax such condition, being more consistent with the pressure approximations.


A different HLLC flux is obtained by assuming a single mean pressure value in the Star Region, and given by the arithmetic average of the pressures :math:`p_{*L}, p_{*R}` , namely

.. math::
	\begin{align}
	P_{LR} = \frac{1}{2}[p_{L} + p_{R} + \rho_{L}(S_{L} - u_{L})(S_{*} - u_{L}) + \rho_{R}(S_{R} - u_{R})(S_{*} - u_{R})]
	\end{align}

Then the intermediate state vectors are given by

.. math::
	\begin{align}
	\mathbf{U}_{*K} = \frac{S_{K}\mathbf{U}_{K} - \mathbf{F}_{K} + P_{LR}\mathbf{D}_{*}}{S_{K} - S_{*}}
	\end{align}

Substitution of these into expressions of :math:`\mathbf{F}_{*L},\mathbf{F}_{*R}` gives the fluxes :math:`\mathbf{F}_{*L}` and :math:`\mathbf{F}_{*R}` as

.. math::
	\begin{align}
	\mathbf{F}_{*K} = \frac{S_{*}(S_{K}\mathbf{U}_{K} - \mathbf{F}_{K}) + S_{K}P_{LR}\mathbf{D}_{*}}{S_{K} - S_{*}}
	\end{align}

Again the final choice of HLLC flux is made according to :math:`\mathbf{F}_{i+\frac{1}{2}}^{hllc}` .

.. note:: 

	All manipulations so far, assuming that wave speed estimates for :math:`S_{L}` and :math:`S_{R}` are available, are valid for any equation of state. The equation o state only enters in prescribing estmates for :math:`S_{L}` and :math:`S_{R}` .


Multidimensional and Multicomponent Flow
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Here we consider extensions of the HLLC solver to two areas of application, namely multidimensional flow and multicomponent flow.

The presentation of the HLLC scheme has been made for the x-split three dimensional Euler equations, for which the corresponding eigenvalues are denoted here as :math:`\lambda_{1} = u - a` , :math:`\lambda_{2} = u` (multiplicity 3), :math:`\lambda_{3} = u + a` , where :math:`u` is the normal velocity component and :math:`a` is the speed of sound. In a general multidimensional situation, one usually requires the flux in the direction normal to a volume (or element) interface, which is not necessarily aligned with any of the Cartesian directions. In this case the form of the governing equations remains identical to the x-split system. There will be a normal and two tangential components of velocity as before, and all the results obtained so far will be applicable.

In the study of multicomponent flow, one considers the advection of chemical species by the flow, the carrier fluid. For example, let us consider :math:`m` species of concentrations :math:`q_{l}` , for :math:`l=1,\cdots,m` , advected with the normal fluid speed :math:`u` . This means that for each species we can write the following advection equation

.. math::
	\begin{align}
	\partial_{t}q_{l} + u\partial_{x}q_{l} = 0
	\end{align}

for :math:`l = 1,\cdots,m` . Note that these equations are written in non-conservative form. However, by combining these with the continuity equation we obtain a conservative form of these equations, namely

.. math::
	\begin{align}
	(\rho q_{l})_{t} + (\rho u q_{l})_{x} = 0
	,\quad \text{for}~ l=1,\cdots,m
	\end{align}

The eigenvalues of the enlarged system are as before, with the exception of :math:`\lambda_{2} = u` , which now, in three space dimensions, has multiplicity :math:`m+3` . These conservation equations can then be added as new components to the conservation equations discussed before, with the enlarged vectors of conserved variables and fluxes given as

.. math::
	\begin{align}
	\mathbf{U} = 
	\begin{bmatrix}
	\rho \\ \rho u \\ \rho v \\ \rho w \\ E \\ \rho q_{1} \\ \cdots \\ \rho q_{l} \\ \cdots \\ \rho q_{m}
	\end{bmatrix}
	,\quad
	\mathbf{F} = 
	\begin{bmatrix}
	\rho u \\ \rho u^{2}+p \\ \rho u v \\ \rho u w \\ u(E + p) \\ \rho u q_{1} \\ \cdots \\ \rho u q_{l} \\ \cdots \\ \rho u q_{m}
	\end{bmatrix}
	\end{align}

The HLLC flux accommodates these new equations in a very natural way, and nothing special needs to be done. If the HLLC flux :math:`\mathbf{F}_{*K}` is used, with :math:`\mathbf{F}` as given above, then the intermediate state vectors are given by

.. math::
	\begin{align}
	\mathbf{U}_{*K} = \rho_{K} \Big( \frac{S_{K} - u_{K}}{S_{K} - S_{*}} \Big)
	\begin{bmatrix}
	1 \\
	S_{*} \\
	v_{K} \\
	w_{K} \\
	\frac{E_{K}}{\rho_{K}} + (S_{*} - u_{K})\Big[ S_{*} + \frac{p_{K}}{\rho_{K}(S_{K} - u_{K})} \Big] \\
	(q_{1})_{K} \\
	\cdots \\
	(q_{l})_{K} \\
	\cdots \\
	(q_{m})_{K}
	\end{bmatrix}
	\end{align}

for :math:`K=L,R` . In this manner the HLLC flux will resolve the additional intermediate fields as the exact Riemann solver.

Note that the tangential velocity components :math:`v` and :math:`w` are special cases of passive scalars; compare it with :math:`\mathbf{U}_{*K}` given before for :math:`q=v` and :math:`q=w` .



Wave-Speed Estimates
-----------------------

In order to determine completely the numerical fluxes in both the HLL and HLLC Riemann solvers we need to provide an algorithm for computing the wave speeds :math:`S_{L}` and :math:`S_{R}` . For the HLLC scheme one requires in addition an estimate for the speed of the middle wave :math:`S_{*}` , but this can in fact be computed once :math:`S_{L}` and :math:`S_{R}` are known. Thus the pending task is to determine estimates for :math:`S_{L}` and :math:`S_{R}` . One approach is to estimate the speeds directly; another approach relies on pressure estimates in the Star Region, which are then utilised to obtain :math:`S_{L}` and :math:`S_{R}` using exact wave relations.

Direct Wave Speed Estimates
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The most well known approach for estimating bounds for the minimum and maximum signal velocities present in the solution of the Riemann problem is to provide, directly, wave speeds :math:`S_{L}` and :math:`S_{R}` . Davis suggested the simple estimates

.. math::
	\begin{align}
	S_{L} = u_{L} - a_{L}
	,\quad
	S_{R} = u_{R} + a_{R}
	\end{align}

and

.. math::
	\begin{align}
	S_{L} = \min(u_{L}-a_{L}, u_{R}-a_{R})
	,\quad
	S_{R} = \max(u_{L}+a_{L}, u_{R}+a_{R})
	\end{align}

These estimates make use of data values only, are exceedingly simple but are no recommended for practical computations. Both Davis and Einfeldt, proposed to use the Roe average eigenvalues for the left and right non-linear waves, that is

.. math::
	\begin{align}
	S_{L} = \tilde{u} - \tilde{a}
	,\quad
	S_{R} = \tilde{u} + \tilde{a}
	\end{align}

where :math:`\tilde{u}` and :math:`\tilde{a}` are the Roe-average particle and sound speeds respectively, given as follows

.. math::
	\begin{align}
	\tilde{u} = \frac{\sqrt{\rho_{L}}u_{L} + \sqrt{\rho_{R}}u_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	,\quad
	\tilde{a} = \Big[ (\gamma - 1)(\tilde{H} - \frac{1}{2}\tilde{u}^{2}) \Big]^{1/2}
	\end{align}

with the enthalpy :math:`H = (E + p)/\rho` approximated as

.. math::
	\begin{align}
	\tilde{H} = \frac{\sqrt{\rho_{L}}H_{L} + \sqrt{\rho_{R}}H_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

Motivated by the Roe eigenvalues Einfeldt proposed the estimates

.. math::
	\begin{align}
	S_{L} = \bar{u} - \bar{d}
	,\quad
	S_{R} = \bar{u} + \bar{d}
	\end{align}

for his HLLE solver, where

.. math::
	\begin{align}
	\bar{d}^{2} = \frac{\sqrt{\rho_{L}}a_{L}^{2} + \sqrt{\rho_{R}}a_{R}^{2}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}} + \eta_{2}(u_{R} - u_{L})^{2}
	\end{align}

and

.. math::
	\begin{align}
	\eta_{2} = \frac{1}{2} \frac{\sqrt{\rho_{L}}\sqrt{\rho_{R}}}{(\sqrt{\rho_{L}} + \sqrt{\rho_{R}})^{2}}
	\end{align}

These wave speed estimates are reported to lead to effective and robust Godunov-type schemes.

Davis made some observations regarding the relationship between the chosen wave speeds and some well-known numerical methods. Suppose that for a given Riemann problem we can identify a positive speed :math:`S^{+}` . Then by choosing :math:`S_{L} = -S^{+}` and :math:`S_{R} = S^{+}` in the HLL flux one obtains a Rusanov flux

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \frac{1}{2}(\mathbf{F}_{L} + \mathbf{F}_{R}) - \frac{1}{2}S^{+}(\mathbf{U}_{R} - \mathbf{U}_{L})
	\end{align}

As to the choice of the speed :math:`S^{+}` , Davis considered

.. math::
	\begin{align}
	S^{+} = \max(|u_{L} - a_{L}|, |u_{R} - a_{R}|, |u_{L} + a_{L}|, |u_{R} + a_{R}|)
	\end{align}

Actually, the above speed is bounded by

.. math::
	\begin{align}
	S^{+} = \max(|u_{L}| + a_{L}, |u_{R}| + a_{R})
	\end{align}

This choice is likely to produce a more robust scheme and is also simpler than Davis's choice.

Another possible choice is :math:`S^{+} = S_{\max}^{n}` , the maximum wave speed present at the appropriate time found by imposing the Courant stability condtion. This speed is related to the time step :math:`\Delta t` and the grid spacing :math:`\Delta x` via

.. math::
	\begin{align}
	S_{\max}^{n} = \frac{C_{cfl}\Delta x}{\Delta t}
	\end{align}

where :math:`C_{cfl}` is the Courant number coefficient, usually chosen (empirically) to be :math:`C_{cfl} \approx 0.9` , for a scheme of linear stability limit of unity. For :math:`C_{cfl} = 1` one has :math:`S^{+}=\frac{\Delta x}{\Delta t}` , which results in the Lax-Friedrichs numerical flux

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \frac{1}{2}(\mathbf{F}_{L} + \mathbf{F}_{R}) - \frac{1}{2}\frac{\Delta x}{\Delta t}(\mathbf{U}_{R} - \mathbf{U}_{L})
	\end{align}


Pressure-Based Wave Speed Estimates
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

A different approach for finding wave speed estimates was proposed by Toro et. al., whereby one first finds an estimate for the pressure :math:`p_{*}` in the Star Region. Then estimates for :math:`S_{L}` and :math:`S_{R}` are derived. This is a simple tast and several reliable choices are available. Suppose we have an estimate :math:`p_{*}` for the pressure in the Star Region. Then we choose the following wave speeds

.. math::
	\begin{align}
	S_{L} = u_{L} - a_{L}q_{L}
	,\quad
	S_{R} = u_{R} + a_{R}q_{R}
	\end{align}

where

.. math::
	\begin{align}
	q_{K} = \left\{ \begin{array}{l}
	1 \quad \text{if}~ p_{*} \le p_{K} \\
	\Big[ 1 + \frac{\gamma + 1}{2\gamma}(p_{*}/p_{K} - 1) \Big]^{1/2} \quad \text{if}~ p_{*} > p_{K}
	\end{array} \right.
	\end{align}

This choice of wave speeds discriminates between shock and rarefaction waves. If the :math:`K` wave ( :math:`K=L` or :math:`K=R` ) is a rarefaction then the speed :math:`S_{K}` corresponds to the characteristic speed of the head of the rarefaction, which carries the fastest signal. If the wave is a shock wave then the speed corresponds to an approximation of the true shock speed; the wave relations used are exact but the pressure ratio across the shock is approximated, because :math:`p_{*}` is an approximation to the pressure behind the shock wave. We propose to use the state approximations to find :math:`p_{*}` .

The PVRS approximate Riemann solver gives

.. math::
	\begin{align}
	p_{pvrs} = \frac{1}{2}(p_{L} + p_{R}) - \frac{1}{2}(u_{R} - u_{L})\bar{\rho}\bar{a}
	\end{align}

where

.. math::
	\begin{align}
	\bar{\rho} = \frac{1}{2}(\rho_{L} + \rho_{R})
	,\quad
	\bar{a} = \frac{1}{2}(a_{L} + a_{R})
	\end{align}

This approximation for pressure can be used directly into the wave speeds expressions above to obtain wave speed estimates for the HLL and HLLC schemes.

Another choice is furnished by the Two-Rarefaction Riemann solver TRRS, namely

.. math::
	\begin{align}
	p_{tr} = \Big[ \frac{a_{L} + a_{R} - \frac{\gamma-1}{2}(u_{R} - u_{L})}{a_{L}/p_{L}^{z} + a_{R}/p_{R}^{z}} \Big]^{1/z}
	\end{align}

where

.. math::
	\begin{align}
	P_{LR} = \Big( \frac{p_{L}}{p_{R}} \Big)^{z}
	,\quad
	z = \frac{\gamma-1}{2\gamma}
	\end{align}

The Two-Shock Riemann solver TSRS gives

.. math::
	\begin{align}
	p_{ts} = \frac{g_{L}(p_{0})p_{L} + g_{R}(p_{0})p_{R} - \Delta u}{g_{L}(p_{0}) + g_{R}(p_{0})}
	\end{align}

where

.. math::
	\begin{align}
	g_{K}(p) = \Big[ \frac{A_{K}}{p + B_{K}} \Big]^{1/2}
	,\quad
	p_{0} = \max(0, p_{pvrs})
	\end{align}

for :math:`K=L` and :math:`K=R` .

In computational practice we could use the hybrid scheme to determine :math:`p_{*}` . The HLL approximate Riemann solver with the hybrid pressure-based wave speed estimates has been implemented in the NAG routine D03PXF for Godunov-type methods to solve the time-dependent, one dimensional Euler equations for ideal gases. For ideal gases we find that the simplified PVRS scheme, with :math:`p_{*} = \max(0, p_{pvrs})` is very simple and also is found to be sufficiently robust.


Contact Waves and Passive Scalars
------------------------------------

Here we study the special case of a passive scalar :math:`q(x,t)` transported with the fluid speed :math:`u(x,t)` . The time-dependent, one dimensional Euler equations are augmented by the extra conservation law

.. math::
	\begin{align}
	(\rho q)_{t} + (\rho qu)_{x} = 0
	\end{align}

Consider the special IVP in which :math:`p,\rho,u` are constant and

.. math::
	\begin{align}
	q(x,0) = q_{0}(x) = \left\{ \begin{array}{l}
	q_{L} \quad \text{if}~ x\le0 \\
	q_{R} \quad \text{if}~ x>0
	\end{array} \right.
	\end{align}

Clearly, the non-trivial part of the exact solution is

.. math::
	\begin{align}
	q(x,t) = q_{0}(x-ut)
	\end{align}

Application of the HLL Riemann solver to this problem gives the following expression for the numerical flux

.. math::
	\begin{align}
	f_{i+\frac{1}{2}}^{hll} = \frac{1}{2}\Big(1 + \frac{1}{M}\Big)f_{i} + \frac{1}{2}\Big(1 - \frac{1}{M}\Big)f_{i+1}
	\end{align}

where :math:`M=\frac{u}{a}` is the Mach number and the wave speeds have been taken to be

.. math::
	\begin{align}
	S_{L} = u - a
	,\quad
	S_{R} = u + a
	\end{align}

Obviously, this flux applies only in the subsonic regime :math:`u-a \le 0 \le u+a` . For sonic flow, the flux reduces identically to the Godunov flux computed from the exact Riemann solver. For subsonic flow :math:`1/M > 1` and the resulting scheme is more diffusive than the Godunov method when used in the conjunction with the exact Riemann solver. For the special case

.. math::
	\begin{align}
	M = \frac{u\Delta t}{\Delta x}
	\end{align}

the HLL scheme reproduces the Lax-Friedrichs method, which is exceedingly diffusive. The limiting case of a stationary passive scalar is the worst. Note that the analysis includes the important cases :math:`q=v` and :math:`q=w` , the tangential velocity components in three-dimensional flow.

The analysis for an isolated contact can be carried out in a similar manner; by using an appropriate choice of the wave speeds the resulting HLL flux is identical to :math:`f_{i+\frac{1}{2}}^{hll} = \frac{1}{2}\Big(1 + \frac{1}{M}\Big)f_{i} + \frac{1}{2}\Big(1 - \frac{1}{M}\Big)f_{i+1}` , and thus the same observations as for a passive scalar apply. The HLLC solver, on the other hand, behaves as the exact Riemann solver; for the limiting case in which the wave is stationary, the HLLC numerical scheme gives infinite resolution; the reader can verify this algebraically. The relevance of these observations is that the HLL scheme, unlike the HLLC scheme, will add excessive numerical dissipation to the resolution of spacial but important flow features such as material interfaces, shear waves and vortices.



The Riemann Solver of Roe
============================

Bases of the Roe Approach
---------------------------

The Exact Riemann Problem and the Godunov Flux
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

We concerned with solving numerically the general Initial Boundary Value Problem (IBVP)

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \mathbf{U}^{(0)}(x) \\
	& \mathbf{U}(0,t) = \mathbf{U}_{l}(t) ,\quad \mathbf{U}(L,t) = \mathbf{U}_{r}(t)
	\end{align}

in a domain :math:`x_{l} \le x \le x_{r}` , utilising the explicit conservative formula

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} + \frac{\Delta t}{\Delta x}[\mathbf{F}_{i-\frac{1}{2}} - \mathbf{F}_{i+\frac{1}{2}}]
	\end{align}

We assume the solution of IBVP exists. We defined the Godunov intercell numerical flux

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}(\mathbf{U}_{i+\frac{1}{2}}(0))
	\end{align}

in which :math:`\mathbf{U}_{i+\frac{1}{2}}(0)` is the exact similarity solution :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` of the Riemann problem

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \left\{ \begin{array}{l}
	\mathbf{U}_{L} \quad \text{if}~ x<0 \\
	\mathbf{U}_{R} \quad \text{if}~ x>0
	\end{array} \right.
	\end{align}

evaluated at :math:`x/t=0` . Fig.11.1 shows the structure of the exact solution of the Riemann problem for the x-split three dimensional Euler equations, for which the vectors of conserved variables and fluxes are

.. math::
	\begin{align}
	\mathbf{U} = 
	\begin{bmatrix}
	\rho \\ \rho u \\ \rho v \\ \rho w \\ E
	\end{bmatrix}
	,\quad
	\mathbf{F} = 
	\begin{bmatrix}
	\rho u \\ \rho u^{2} + p \\ \rho u v \\ \rho u w \\ u(E + p)
	\end{bmatrix}
	\end{align}

The Star Region between the left and right waves contains the unknowns of the problem. The particular value at :math:`x/t=0` corresponds to the t-axis and is the value required by the Godunov flux. The piece-wise constant initial data, in terms of primitive variables, is

.. math::
	\begin{align}
	\mathbf{W}_{L} = 
	\begin{bmatrix}
	\rho_{L} \\ u_{L} \\ v_{L} \\ w_{L} \\ p_{L}
	\end{bmatrix}
	,\quad
	\mathbf{W}_{R} = 
	\begin{bmatrix}
	\rho_{R} \\ u_{R} \\ v_{R} \\ w_{R} \\ p_{R}
	\end{bmatrix}
	\end{align}

We have provided an algorithm to compute the exact solution :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` and we utilised this solution in the Godunov method. We provided approximations to the state :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` and obtained a corresponding approximate Godunov method by evaluating the physical flux function :math:`\mathbf{F}` at this approximate state. The purpose of this chapter is to find direct approximations to the flux function :math:`\mathbf{F}_{i+\frac{1}{2}}` following the approach proposed by Roe and Pike.

Approximate Conservation Laws
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Roe solved the Riemann problem approximately. By introducing the Jacobian matrix

.. math::
	\begin{align}
	\mathbf{A}(\mathbf{U}) = \frac{\partial \mathbf{F}}{\partial \mathbf{U}}
	\end{align}

and using the chain rule the conservation laws may be written as

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{A}(\mathbf{U})\mathbf{U}_{x} = \mathbf{0}
	\end{align}

Roe's approach replaces the Jacobian matrix :math:`\mathbf{A}(\mathbf{U})` by a constant Jacobian matrix

.. math::
	\begin{align}
	\tilde{\mathbf{A}} = \tilde{\mathbf{A}}(\mathbf{U}_{L}, \mathbf{U}_{R})
	\end{align}

which is a function of the data states :math:`\mathbf{U}_{L}, \mathbf{U}_{R}` . In this way the original PDEs are replaced by

.. math::
	\begin{align}
	\mathbf{U}_{t} + \tilde{\mathbf{A}}\mathbf{U}_{x} = \mathbf{0}
	\end{align}

This is a linear system with constant coefficients. The original Riemann problem is then replaced by the approximate Riemann problem

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \tilde{\mathbf{A}}\mathbf{U}_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \left\{ \begin{array}{l}
	\mathbf{U}_{L} ,\quad x<0 \\
	\mathbf{U}_{R} ,\quad x>0
	\end{array} \right.
	\end{align}

which is then solved exactly. The approximate problem results from replacing the original non-linear conservation laws by a linearised system with constant coefficients but the initial data of the exact problem is retained.

For a general hyperbolic system of :math:`m` conservation laws, the Roe Jacobian matrix :math:`\tilde{\mathbf{A}}` is required to satisfy the following properties:

Property (A): Hyperbolicity of the system. :math:`\tilde{\mathbf{A}}` is required to have real eigenvalues :math:`\tilde{\lambda}_{i} = \tilde{\lambda}_{i}(\mathbf{U}_{L}, \mathbf{U}_{R})` , which we choose to order as

.. math::
	\begin{align}
	\tilde{\lambda}_{1} \le \tilde{\lambda}_{2} \le \cdots \le \tilde{\lambda}_{m}
	\end{align}

and a complete set of linearly independent right eigenvectors

.. math::
	\begin{align}
	\tilde{\mathbf{K}}^{(1)} ,\quad \tilde{\mathbf{K}}^{(2)} , \cdots , \tilde{\mathbf{K}}^{(m)}
	\end{align}

Property (B): Consistency with the exact Jacobian

.. math::
	\begin{align}
	\tilde{\mathbf{A}}(\mathbf{U},\mathbf{U}) = \mathbf{A}(\mathbf{U})
	\end{align}

Property (C): Conservation across discontinuities

.. math::
	\begin{align}
	\mathbf{F}(\mathbf{U}_{R}) - \mathbf{F}(\mathbf{U}_{L}) = \tilde{\mathbf{A}}(\mathbf{U}_{R} - \mathbf{U}_{L})
	\end{align}

Property (A) on hyperbolicity is an obvious requirement; the approximate problem should at the very least preserve the mathematical character of the original non-linear system. Property (B) ensures consistency with the conservation laws. Property (C) ensures conservation. It also ensures exact recognition of isolated discontinuities; that is, if the data :math:`\mathbf{U}_{L}, \mathbf{U}_{R}` are connected by a single, isolated discontinuity, then the approximate Riemann solver recognises this wave exactly. Note however that this does not mean that the corresponding, approximate, Godunov method with the Roe approximate numerical flux will in general give exact solutions for isolated discontinuities.

The construction of matrices satisfying properties (A)-(C) for general hyperbolic systems can be very complicated and thus computationally unattractive. For the specific case of the Euler equations of Gas Dynamics Roe proposed a relatively simple way of constructing a matrix :math:`\tilde{\mathbf{A}}` . Later, Roe and Pike proposed a simpler approach, where the explicit construction of :math:`\tilde{\mathbf{A}}` is actually avoided.

The Approximate Riemann Problem and the Intercell Flux
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Once the matrix :math:`\tilde{\mathbf{A}}(\mathbf{U}_{L},\mathbf{U}_{R})` , its eigenvalues :math:`\tilde{\lambda}_{i}(\mathbf{U}_{L},\mathbf{U}_{R})` and right eigenvectors :math:`\tilde{\mathbf{K}}^{(i)}(\mathbf{U}_{L},\mathbf{U}_{R})` are available, one solves the Riemann problem by direct application of methods discussed for linear hyperbolic systems with constant coefficients. By projecting the data difference

.. math::
	\begin{align}
	\Delta \mathbf{U} = \mathbf{U}_{R} - \mathbf{U}_{L}
	\end{align}

onto the right eigenvectors we write

.. math::
	\begin{align}
	\Delta \mathbf{U} = \mathbf{U}_{R} - \mathbf{U}_{L} = \sum_{i=1}^{m}\tilde{\alpha}_{i}\tilde{\mathbf{K}}^{(i)}
	\end{align}

from which one finds the wave strengths :math:`\tilde{\alpha}_{i} = \tilde{\alpha}_{i}(\mathbf{U}_{L},\mathbf{U}_{R})` . The solution :math:`\mathbf{U}_{i+\frac{1}{2}}(x/t)` evaluated along the t-axis, :math:`x/t=0` , is given by

.. math::
	\begin{align}
	\mathbf{U}_{i+\frac{1}{2}}(0) = \mathbf{U}_{L} + \sum_{\tilde{\lambda}_{i} \le 0}\tilde{\alpha}_{i}\tilde{\mathbf{K}}^{(i)}
	\end{align}

or

.. math::
	\begin{align}
	\mathbf{U}_{i+\frac{1}{2}}(0) = \mathbf{U}_{R} - \sum_{\tilde{\lambda}_{i} \ge 0}\tilde{\alpha}_{i}\tilde{\mathbf{K}}^{(i)}
	\end{align}

We now find the corresponding numerical flux. Recall that we have replaced the original set of conservation laws by the constant coefficient linear system; this can be viewed as a modified system of conservation laws

.. math::
	\begin{align}
	\overline{\mathbf{U}}_{t} + \overline{\mathbf{F}}(\overline{\mathbf{U}})_{x} = \mathbf{0}
	\end{align}

with flux function

.. math::
	\begin{align}
	\overline{\mathbf{F}}(\overline{\mathbf{U}}) = \tilde{\mathbf{A}}\overline{\mathbf{U}}
	\end{align}

The corresponding numerical flux is not the choice :math:`\mathbf{F}_{i+\frac{1}{2}}=\tilde{\mathbf{A}}\overline{\mathbf{U}}_{i+\frac{1}{2}}(0)` . That this would be incorrect becomes obvious when, for instance, assuming right supersonic flow in the expression of :math:`\mathbf{\mathbf{U}}_{i+\frac{1}{2}}(0)` one would compute an intercell flux :math:`\mathbf{F}_{i+\frac{1}{2}} \ne \mathbf{F}_{L}` . Instead, the correct expression for the corresponding numerical flux is obtained from any of the integral relations

.. math::
	\begin{align}
	& \mathbf{F}_{0L} = \mathbf{F}_{L} - S_{L}\mathbf{U}_{L} - \frac{1}{T}\int_{TS_{L}}^{0}\mathbf{U}(x,T)\mathrm{d}x \\
	& \mathbf{F}_{0R} = \mathbf{F}_{R} - S_{R}\mathbf{U}_{R} + \frac{1}{T}\int_{0}^{TS_{R}}\mathbf{U}(x,T)\mathrm{d}x
	\end{align}

Here :math:`S_{L}, S_{R}` are the smallest and largest signal speeds in the exact solution of the Riemann problem with data :math:`\mathbf{U}_{L}, \mathbf{U}_{R}` and :math:`T` is a positive time. If the integrand :math:`\mathbf{U}(x,t)` is replaced by some approximate solution, then equality of the fluxes :math:`\mathbf{F}_{0L}` and :math:`\mathbf{F}_{0R}` requires the approximate solution to satisfy a Consistency Condition.

If :math:`\overline{\mathbf{U}}_{i+\frac{1}{2}}(x,t)` is the solution of the Riemann problem for the modified conservation laws with data :math:`\mathbf{U}_{L},\mathbf{U}_{R}` , then the integrals in the above two relations respectively, are

.. math::
	\begin{align}
	\int_{TS_{L}}^{0}\overline{\mathbf{U}}_{i+\frac{1}{2}}(x,T)\mathrm{d}x
	= T [\overline{\mathbf{F}}(\mathbf{U}_{L}) - \overline{\mathbf{F}}(\overline{\mathbf{U}}_{i+\frac{1}{2}}(0))]
	- TS_{L}\mathbf{U}_{L}
	\end{align}

and

.. math::
	\begin{align}
	\int_{0}^{TS_{R}}\overline{\mathbf{U}}_{i+\frac{1}{2}}(x,T)\mathrm{d}x
	= T [\overline{\mathbf{F}}(\overline{\mathbf{U}}_{i+\frac{1}{2}}(0)) - \overline{\mathbf{\mathbf{F}}}(\mathbf{U}_{R})]
	+ TS_{R}\mathbf{U}_{R}
	\end{align}

Substitution of these two expressions into the integral relations gives

.. math::
	\begin{align}
	\mathbf{F}_{0L} = \overline{\mathbf{F}}(\overline{\mathbf{U}}_{i+\frac{1}{2}}(0))
	+ \mathbf{F}(\mathbf{U}_{L}) - \overline{\mathbf{F}}(\mathbf{U}_{L})
	\end{align}

and

.. math::
	\begin{align}
	\mathbf{F}_{0R} = \overline{F}(\overline{\mathbf{U}}_{i+\frac{1}{2}}(0))
	+ \mathbf{F}(\mathbf{U}_{R}) - \overline{\mathbf{F}}(\mathbf{U}_{R})
	\end{align}

Finally, by using :math:`\overline{\mathbf{U}}_{i+\frac{1}{2}}(0)` as given by :math:`\mathbf{U}_{i+\frac{1}{2}}(0) = \mathbf{U}_{L} + \sum_{\tilde{\lambda}_{i} \le 0}\tilde{\alpha}_{i}\tilde{\mathbf{K}}^{(i)}` or :math:`\mathbf{U}_{i+\frac{1}{2}}(0) = \mathbf{U}_{R} - \sum_{\tilde{\lambda}_{i} \ge 0}\tilde{\alpha}_{i}\tilde{\mathbf{K}}^{(i)}` and the definition of the flux :math:`\overline{\mathbf{F}} = \tilde{\mathbf{A}}\overline{\mathbf{U}}` we obtain the numerical flux as

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{L} + \sum_{\tilde{\lambda}_{i} \le 0}\tilde{\alpha}_{i}\tilde{\lambda}_{i}\tilde{\mathbf{K}}^{(i)}
	\end{align}

or

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{R} - \sum_{\tilde{\lambda}_{i} \ge 0} \tilde{\alpha}_{i}\tilde{\lambda}_{i}\tilde{\mathbf{K}}^{(i)}
	\end{align}

Alternatively, we may also write

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \frac{1}{2}(\mathbf{F}_{L} + \mathbf{F}_{R})
	- \frac{1}{2} \sum_{i=1}^{m} \tilde{\alpha}_{i}|\tilde{\lambda}_{i}|\tilde{\mathbf{K}}^{(i)}
	\end{align}

We remark that all previous relations are valid for any hyperbolic system and any linearisation of it. In order to compute Roe's numerical flux for a particular system of hyperbolic conservation laws, one requires expressions for the wave strengths :math:`\tilde{\alpha}_{i}` , the eigenvalues :math:`\tilde{\lambda}_{i}` and the right eigenvectors :math:`\tilde{\mathbf{K}}^{(i)}` in any of the flux expressions. Note that the Jacobian matrix :math:`\tilde{\mathbf{A}}(\mathbf{U}_{L}, \mathbf{U}_{R})` is not explicitly required by the numerical flux. In the next two sections we give detials on methodologies to find :math:`\tilde{\alpha}_{i}, \tilde{\lambda}_{i}` and :math:`\tilde{\mathbf{K}}^{i}` . There are two approaches, namely the original approach presented by Roe and the Roe-Pike approach.


The Original Roe Method
--------------------------

In order for the approximate Godunov method with the Roe-type numerical flux to be completely determined, we need to find the average eigenvalues :math:`\tilde{\lambda}_{i}` , the corresponding averaged right eigenvectors :math:`\tilde{\mathbf{K}}^{(i)}` and averaged wave strengths :math:`\tilde{\alpha}_{i}` . In his original paper Roe finds an averaged Jacobian matrix :math:`\tilde{\mathbf{A}}` , the Roe matrix, from which :math:`\tilde{\lambda}_{i}, \tilde{\mathbf{K}}^{(i)}` and :math:`\tilde{\alpha}_{i}` follow directly. In constructing a matrix :math:`\tilde{\mathbf{A}}` the properties (A)-(C) are enforced. It is not difficult to think of candidates :math:`\tilde{\mathbf{A}}` that satisfy the first two properties. Property C is crucial and is the one that narrows down the choices. Roe showed that the existence of a matrix :math:`\tilde{\mathbf{A}}` satisfying Property C is assured by the mean value theorem. An early line of attack in constructing a matrix :math:`\tilde{\mathbf{A}}` satisfying all desirable properties is reported by Sells. Roe identifies some disadvantages of this approach; it is argued, for instance, that the construction is far from unique and that the resulting schemes are too complicated.

A breakthrough in constructing :math:`\tilde{\mathbf{A}}` resulted from Roe's ingenious idea of introducing a parameter vector :math:`\mathbf{Q}` , such that both the vector of conserved variables :math:`\mathbf{U}` and the flux vector :math:`\mathbf{F}(\mathbf{U})` could be expressed in terms of :math:`\mathbf{Q}` . That is

.. math::
	\begin{align}
	\mathbf{U} = \mathbf{U}(\mathbf{Q})
	,\quad
	\mathbf{F} = \mathbf{F}(\mathbf{Q})
	\end{align} 

Two important steps then follow. First, the changes

.. math::
	\begin{align}
	\Delta \mathbf{U} = \mathbf{U}_{R} - \mathbf{U}_{L}
	,\quad
	\Delta \mathbf{F} = \mathbf{F}(\mathbf{U}_{R}) - \mathbf{F}(\mathbf{U}_{L})
	\end{align}

can be expressed in terms of the change :math:`\Delta \mathbf{Q} = \mathbf{Q}_{R} - \mathbf{Q}_{L}` . Then, averages are obtained in terms of simple arithmetic means of :math:`\mathbf{Q}` . Next, we illustrate the technique as applied to a simple set of conservation laws.


The Isothermal Equations
^^^^^^^^^^^^^^^^^^^^^^^^^^^

Consider the isothermal equations

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}
	\end{align}

.. math::
	\begin{align}
	\mathbf{U} \equiv \begin{bmatrix} u_{1} \\ u_{2} \end{bmatrix} \equiv \begin{bmatrix} \rho \\ \rho u \end{bmatrix}
	,\quad
	\mathbf{F} \equiv \begin{bmatrix} f_{1} \\ f_{2} \end{bmatrix} \equiv \begin{bmatrix} \rho u \\ \rho u^{2} + a^{2}\rho \end{bmatrix}
	\end{align}

where :math:`a` is a constant sound speed. The exact Jacobian, eigenvalues and corresponding right eigenvectors are

.. math::
	\begin{align}
	\mathbf{A}(\mathbf{U}) = 
	\begin{bmatrix}
	0 & 1 \\
	a^{2}-u^{2} & 2u
	\end{bmatrix}
	\end{align}

.. math::
	\begin{align}
	\lambda_{1} = u - a
	,\quad
	\lambda_{2} = u + a
	\end{align}

.. math::
	\begin{align}
	\mathbf{K}^{(1)} = 
	\begin{bmatrix}
	1 \\ u-a
	\end{bmatrix}
	,\quad
	\mathbf{K}^{(2)} = 
	\begin{bmatrix}
	1 \\ u+a
	\end{bmatrix}
	\end{align}

Choose the parameter vector

.. math::
	\begin{align}
	\mathbf{Q} \equiv \begin{bmatrix} q_{1} \\ q_{2} \end{bmatrix}
	\equiv \frac{\mathbf{U}}{\sqrt{\rho}}
	= \begin{bmatrix} \sqrt{\rho} \\ \sqrt{\rho} u \end{bmatrix}
	\end{align}

Then :math:`\mathbf{U}` and :math:`\mathbf{F}` can be expressed in terms of the components :math:`q_{1},q_{2}` of :math:`\mathbf{Q}` , namely

.. math::
	\begin{align}
	\mathbf{U} \equiv \begin{bmatrix} u_{1} \\ u_{2} \end{bmatrix}
	\equiv q_{1}\mathbf{Q}
	= \begin{bmatrix} q_{1}^{2} \\ q_{1}q_{2} \end{bmatrix}
	\end{align}

and

.. math::
	\begin{align}
	\mathbf{F} \equiv \begin{bmatrix} f_{1} \\ f_{2} \end{bmatrix}
	\equiv \begin{bmatrix} q_{1}q_{2} \\ q_{2}^{2}+a^{2}q_{1}^{2} \end{bmatrix}
	\end{align}

One now looks for an averaged vector :math:`\tilde{\mathbf{Q}} = (\tilde{q}_{1}, \tilde{q}_{2})^{T}` . This is found by simple arithmetic averaging

.. math::
	\begin{align}
	\tilde{\mathbf{Q}} = \begin{bmatrix} \tilde{q}_{1} \\ \tilde{q}_{2} \end{bmatrix}
	= \frac{1}{2}(\mathbf{Q}_{L} + \mathbf{Q}_{R})
	= \frac{1}{2}
	\begin{bmatrix}
	\sqrt{\rho_{L}} + \sqrt{\rho_{R}} \\
	\sqrt{\rho_{L}}u_{L} + \sqrt{\rho_{R}}u_{R}
	\end{bmatrix}
	\end{align}

Then two matrices :math:`\tilde{\mathbf{B}}=\tilde{\mathbf{B}}(\tilde{\mathbf{Q}})` and :math:`\tilde{\mathbf{C}}=\tilde{\mathbf{C}}(\tilde{\mathbf{Q}})` are found, such that the jumps :math:`\Delta \mathbf{U}` and :math:`\Delta \mathbf{F}` can be expressed in terms of the jump :math:`\Delta \mathbf{Q}` , namely

.. math::
	\begin{align}
	\Delta\mathbf{U} = \tilde{\mathbf{B}}\Delta\mathbf{Q}
	,\quad
	\Delta\mathbf{F} = \tilde{\mathbf{C}}\Delta\mathbf{Q}
	\end{align}

Use of these two expressions produces

.. math::
	\begin{align}
	\Delta\mathbf{F} = (\tilde{\mathbf{C}}\tilde{\mathbf{B}}^{-1})\Delta\mathbf{U}
	\end{align}

which if compared with condition (C) produces the Roe averaged matrix

.. math::
	\begin{align}
	\tilde{\mathbf{A}} = \tilde{\mathbf{C}}\tilde{\mathbf{B}}^{-1}
	\end{align}

Matrices :math:`\tilde{\mathbf{B}}` and :math:`\tilde{\mathbf{C}}` satisfying :math:`\Delta\mathbf{U} = \tilde{\mathbf{B}}\Delta\mathbf{Q}` and :math:`\Delta\mathbf{F} = \tilde{\mathbf{C}}\Delta\mathbf{Q}` are

.. math::
	\begin{align}
	\tilde{\mathbf{B}} = 
	\begin{bmatrix}
	2\tilde{q}_{1} & 0 \\
	\tilde{q}_{2} & \tilde{q}_{1}
	\end{bmatrix}
	,\quad
	\tilde{\mathbf{C}} = 
	\begin{bmatrix}
	\tilde{q}_{2} & \tilde{q}_{1} \\
	2a^{2}\tilde{q}_{1} & 2\tilde{q}_{2}^{2}
	\end{bmatrix}
	\end{align}

The sought Roe matrix is then 

.. math::
	\begin{align}
	\tilde{\mathbf{A}} = 
	\begin{bmatrix}
	0 & 1 \\
	a^{2}-\tilde{u}^{2} & 2\tilde{u}
	\end{bmatrix}
	\end{align}

where :math:`\tilde{u}` is the Roe averaged velocity and is given by

.. math::
	\begin{align}
	\tilde{u} = \frac{\sqrt{\rho_{L}}u_{L} + \sqrt{\rho_{R}}u_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

As the sound speed :math:`a` is constant, no averaged :math:`\tilde{\rho}` is required.

Having found :math:`\tilde{\mathbf{A}}` one computes the averaged eigenvalues, eigenvectors and wave strengths. The eigenvalues of :math:`\tilde{\mathbf{A}}` are

.. math::
	\begin{align}
	\tilde{\lambda}_{1} = \tilde{u} - a
	,\quad
	\tilde{\lambda}_{2} = \tilde{u} + a
	\end{align}

and are all real. The corresponding averaged right eigenvectors are

.. math::
	\begin{align}
	\tilde{\mathbf{K}}^{(1)} =
	\begin{bmatrix}
	1 \\ \tilde{u}-a
	\end{bmatrix}
	,\quad
	\tilde{\mathbf{K}}^{(2)} =
	\begin{bmatrix}
	1 \\ \tilde{u}+a
	\end{bmatrix}
	\end{align}

and are easily seen to be linearly independent. Thus condition (A) is satisfied. To find the wave strengths :math:`\tilde{\alpha}_{i}` we solve the :math:`2 \times 2` linear system

.. math::
	\begin{align}
	\Delta \mathbf{U} \equiv \begin{bmatrix} \Delta u_{1} \\ \Delta u_{2} \end{bmatrix}
	= \sum_{i=1}^{2}\tilde{\alpha}_{i}\tilde{\mathbf{K}}^{(i)}
	\end{align}

The solution is easily verified to be

.. math::
	\begin{align}
	& \tilde{\alpha}_{1} = \frac{\Delta u_{1} (\tilde{u} + a) - \Delta u_{2}}{2a} \\
	& \tilde{\alpha}_{2} = \frac{-\Delta u_{1} (\tilde{u} - a) + \Delta u_{2}}{2a}
	\end{align}

with the obvious definitions :math:`\Delta u_{1} \equiv \rho_{R} - \rho_{L}` , :math:`\Delta u_{2} \equiv \rho_{R}u_{R} - \rho_{L}u_{L}` . The corresponding Roe numerical flux :math:`\mathbf{F}_{i+\frac{1}{2}}` now follows from using the above expressions into any of the flux expressions given before.


The Euler Equations
^^^^^^^^^^^^^^^^^^^^^^

Here we present the Roe Riemann solver as applied to the Riemann problem for the x-split three dimensional time dependent Euler equations for ideal gases.

The exact, x-direction Jacobian matrix :math:`\mathbf{A}(\mathbf{U})` is 

.. math::
	\begin{align}
	\mathbf{A} = 
	\begin{bmatrix}
	0 & 1 & 0 & 0 & 0 \\
	\hat{\gamma}H - u^{2} - a^{2} & (3-\gamma)u & -\hat{\gamma}v & -\hat{\gamma}w & \hat{\gamma} \\
	-uv & v & u & 0 & 0 \\
	-uw & w & 0 & u & 0 \\
	\frac{1}{2}u[(\gamma-3)H-a^{2}] & H-\hat{\gamma}u^{2} & -\hat{\gamma}uv & -\hat{\gamma}uw & \gamma u
	\end{bmatrix}
	\end{align}

where :math:`\hat{\gamma} = \gamma - 1` . The eigenvalues are

.. math::
	\begin{align}
	\lambda_{1} = u - a
	,\quad
	\lambda_{2} = \lambda_{3} = \lambda_{4} = u
	,\quad
	\lambda_{5} = u + a
	\end{align}

where :math:`a = \sqrt{\gamma p/\rho}` is the sound speed. The corresponding right eigenvectors are

.. math::
	\begin{align}
	\mathbf{K}^{(1)} = 
	\begin{bmatrix}
	1 \\ u-a \\ v \\ w \\ H-ua
	\end{bmatrix}
	,\quad
	\mathbf{K}^{(2)} = 
	\begin{bmatrix}
	1 \\ u \\ v \\ w \\ \frac{1}{2}\mathbf{V}^{2}
	\end{bmatrix}
	,\quad
	\mathbf{K}^{(3)} = 
	\begin{bmatrix}
	0 \\ 0 \\ 1 \\ 0 \\ v
	\end{bmatrix}
	,\quad
	\mathbf{K}^{(4)} = 
	\begin{bmatrix}
	0 \\ 0 \\ 0 \\ 1 \\ w
	\end{bmatrix}
	,\quad
	\mathbf{K}^{(5)} = 
	\begin{bmatrix}
	1 \\ u+a \\ v \\ w \\ H+ua
	\end{bmatrix}
	\end{align}

Here :math:`H` is the total enthalpy

.. math::
	\begin{align}
	H = \frac{E + p}{\rho}
	\end{align}

and :math:`E` is the total energy per unit volume

.. math::
	\begin{align}
	E = \frac{1}{2}\rho\mathbf{V}^{2} + \rho e
	\end{align}

with

.. math::
	\begin{align}
	\mathbf{V}^{2} = u^{2} + v^{2} + w^{2}
	\end{align}

and :math:`e` denoting the specific internal energy, which for ideal gases is

.. math::
	\begin{align}
	e = \frac{p}{(\gamma - 1)\rho}
	\end{align}

Roe chooses the parameter vector

.. math::
	\begin{align}
	\mathbf{Q} \equiv \begin{bmatrix} q_{1} \\ q_{2} \\ q_{3} \\ q_{4} \\ q_{5} \end{bmatrix}
	\equiv \sqrt{\rho} \begin{bmatrix} 1 \\ u \\ v \\ w \\ H \end{bmatrix}
	\end{align}

which has the property that every component :math:`u_{i}` of :math:`\mathbf{U}` and every component :math:`f_{i}` of :math:`\mathbf{F}(\mathbf{U})` is a quadratic in the components :math:`q_{i}` of :math:`\mathbf{Q}` . For instance :math:`u_{1} = q_{1}^{2}` and :math:`f_{1} = q_{1}q_{2}` , etc. Actually, the property is also valid for the components of the :math:`\mathbf{G}` and :math:`\mathbf{H}` fluxes for the full three-dimensional Euler equations.

As done for the isothermal equations, one can express the jumps :math:`\Delta\mathbf{U}` and :math:`\Delta\mathbf{F}` in terms of the jump :math:`\Delta\mathbf{Q}` via two matrices :math:`\tilde{\mathbf{B}}` and :math:`\tilde{\mathbf{C}}` . Roe gives the following expressions

.. math::
	\begin{align}
	\tilde{\mathbf{B}} = 
	\begin{bmatrix}
	2\tilde{q}_{1} & 0 & 0 & 0 & 0 \\
	\tilde{q}_{2} & \tilde{q}_{1} & 0 & 0 & 0 \\
	\tilde{q}_{3} & 0 & \tilde{q}_{1} & 0 & 0 \\
	\tilde{q}_{4} & 0 & 0 & \tilde{q}_{1} & 0 \\
	\frac{\tilde{q}_{5}}{\gamma} & \frac{\gamma-1}{\gamma}\tilde{q}_{2} & \frac{\gamma-1}{\gamma}\tilde{q}_{3} & \frac{\gamma-1}{\gamma}\tilde{q}_{4} & \frac{\tilde{q}_{1}}{\gamma}
	\end{bmatrix}
	\end{align}

and

.. math::
	\begin{align}
	\tilde{\mathbf{C}} = 
	\begin{bmatrix}
	\tilde{q}_{2} & \tilde{q}_{1} & 0 & 0 & 0 \\
	\frac{\gamma-1}{\gamma}\tilde{q}_{5} & \frac{\gamma+1}{\gamma}\tilde{q}_{2} & -\frac{\gamma-1}{\gamma}\tilde{q}_{3} & -\frac{\gamma-1}{\gamma}\tilde{q}_{4} & \frac{\gamma-1}{\gamma}\tilde{q}_{1} \\
	0 & \tilde{q}_{3} & \tilde{q}_{2} & 0 & 0 \\
	0 & \tilde{q}_{4} & 0 & \tilde{q}_{2} & 0 \\
	0 & \tilde{q}_{5} & 0 & 0 & \tilde{q}_{2}
	\end{bmatrix}
	\end{align}

The sought Roe matrix is then given by

.. math::
	\begin{align}
	\tilde{\mathbf{A}} = \tilde{\mathbf{B}}\tilde{\mathbf{C}}^{-1}
	\end{align}

The eigenvalues of :math:`\tilde{\mathbf{A}}` are

.. math::
	\begin{align}
	\tilde{\lambda}_{1} = \tilde{u} - \tilde{a}
	,\quad
	\tilde{\lambda}_{2} = \tilde{\lambda}_{3} = \tilde{\lambda}_{4} = \tilde{u}
	,\quad
	\tilde{\lambda}_{5} = \tilde{u} + \tilde{a}
	\end{align}

and the corresponding right eigenvectors are

.. math::
	\begin{align}
	\tilde{\mathbf{K}}^{(1)} = 
	\begin{bmatrix}
	1 \\ \tilde{u}-\tilde{a} \\ \tilde{v} \\ \tilde{w} \\ \tilde{H}-\tilde{u}\tilde{a}
	\end{bmatrix}
	,\quad
	\tilde{\mathbf{K}}^{(2)} = 
	\begin{bmatrix}
	1 \\ \tilde{u} \\ \tilde{v} \\ \tilde{w} \\ \frac{1}{2}\tilde{\mathbf{V}}^{2}
	\end{bmatrix}
	,\quad
	\tilde{\mathbf{K}}^{(3)}
	\begin{bmatrix}
	0 \\ 0 \\ 1 \\ 0 \\ \tilde{v}
	\end{bmatrix}
	,\quad
	\mathbf{K}^{(4)} = 
	\begin{bmatrix}
	0 \\ 0 \\ 0 \\ 1 \\ \tilde{w}
	\end{bmatrix}
	,\quad
	\mathbf{K}^{(5)} = 
	\begin{bmatrix}
	1 \\ \tilde{u}+\tilde{a} \\ \tilde{v} \\ \tilde{w} \\ \tilde{H}+\tilde{u}\tilde{a}
	\end{bmatrix}
	\end{align}

The symbol :math:`\tilde{r}` denotes a Roe average for a variable :math:`r` . The relevant averages are given as follows

.. math::
	\begin{align}
	\tilde{u} = \frac{\sqrt{\rho_{L}}u_{L} + \sqrt{\rho_{R}}u_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

.. math::
	\begin{align}
	\tilde{v} = \frac{\sqrt{\rho_{L}}v_{L} + \sqrt{\rho_{R}}v_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

.. math::
	\begin{align}
	\tilde{w} = \frac{\sqrt{\rho_{L}}w_{L} + \sqrt{\rho_{R}}w_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

.. math::
	\begin{align}
	\tilde{H} = \frac{\sqrt{\rho_{L}}H_{L} + \sqrt{\rho_{R}}H_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

.. math::
	\begin{align}
	\tilde{a} = \Big( (\gamma-1)(\tilde{H} - \frac{1}{2}\tilde{\mathbf{V}}^{2}) \Big)^{\frac{1}{2}}
	\end{align}	

where :math:`\tilde{\mathbf{V}}^{2} = \tilde{u} + \tilde{v} + \tilde{w}^{2}` .

In order to determin completely the Roe numerical flux :math:`\mathbf{F}_{i+\frac{1}{2}}` we need, in addition, the wave strengths :math:`\tilde{\alpha}_{i}` . These are obtained by projecting the jump :math:`\Delta\mathbf{U}` onto the right, averaged eigenvectors, namely

.. math::
	\begin{align}
	\Delta\mathbf{U} = \sum_{i=1}^{5}\tilde{\alpha}_{i}\tilde{\mathbf{K}}^{(i)}
	\end{align}

when written in full these equations read

.. math::
	\begin{align}
	\tilde{\alpha}_{1} + \tilde{\alpha}_{2} + \tilde{\alpha}_{5} = \Delta u_{1}
	\end{align}

.. math::
	\begin{align}
	\tilde{\alpha}_{1}(\tilde{u} - \tilde{a}) + \tilde{\alpha}_{2}\tilde{u} + \tilde{\alpha}_{5}(\tilde{u} + \tilde{a}) = \Delta u_{2}
	\end{align}

.. math::
	\begin{align}
	\tilde{\alpha}_{1}\tilde{v} + \tilde{\alpha}_{2}\tilde{v} + \tilde{\alpha}_{3} + \tilde{\alpha}_{5}\tilde{v} = \Delta u_{3}
	\end{align}

.. math::
	\begin{align}
	\tilde{\alpha}_{1}\tilde{w} + \tilde{\alpha}_{2}\tilde{w} + \tilde{\alpha}_{4} + \tilde{\alpha}_{5}\tilde{w} = \Delta u_{4}
	\end{align}

.. math::
	\begin{align}
	\tilde{\alpha}_{1}(\tilde{H} - \tilde{u}\tilde{a}) + \frac{1}{2}\tilde{\mathbf{V}}^{2}\tilde{\alpha}_{2} + \tilde{\alpha}_{3}\tilde{v} + \tilde{\alpha}_{4}\tilde{w} + \tilde{\alpha}_{5}(\tilde{H} + \tilde{u}\tilde{a}) = \Delta u_{5}
	\end{align}

Here the right-hand side terms are knowns: they are jumps :math:`\Delta u_{i}` in the conserved quantity :math:`u_{i}` , namely

.. math::
	\begin{align}
	\Delta u_{i} = (u_{i})_{R} - (u_{i})_{L}
	\end{align}

.. note:: 

	Before solving these equations we note that in the purely one-dimensional case

	.. math::
		\begin{align}
		\tilde{v} = \tilde{w} = 0
		,\quad
		\tilde{\alpha}_{3} = \tilde{\alpha}_{4} = 0
		,\quad
		\tilde{\mathbf{K}}^{(3)} = \tilde{\mathbf{K}}^{(4)} = \mathbf{0}
		\end{align}

	and the problem reduces to solving for :math:`\tilde{\alpha}_{1}, \tilde{\alpha}_{2}` and :math:`\tilde{\alpha}_{5}` , with terms involving :math:`\tilde{\alpha}_{3}` and :math:`\tilde{\alpha}_{4}` being absent.

	For the x-split dimensional problem the system may be viewed in exactly the same manner as for the one-dimensional case.

Solve the system and computationally it is convenient to arrange the solution as follows

.. math::
	\begin{align}
	& \tilde{\alpha}_{1} = \frac{1}{2\tilde{a}}[\Delta u_{1}(\tilde{u} + \tilde{a}) - \Delta u_{2} - \tilde{a} \tilde{\alpha}_{2}] \\
	& \tilde{\alpha}_{2} = \frac{\gamma-1}{\tilde{a}^{2}}\Big[ \Delta u_{1}(\tilde{H} - \tilde{u}^{2}) + \tilde{u}\Delta u_{2} - \overline{\Delta u_{5}} \Big] \\
	& \tilde{\alpha}_{3} = \Delta u_{3} - \tilde{v}\Delta u_{1} \\
	& \tilde{\alpha}_{4} = \Delta u_{4} - \tilde{w}\Delta u_{1} \\
	& \tilde{\alpha}_{5} = \Delta u_{1} - (\tilde{\alpha}_{1} + \tilde{\alpha}_{2})
	\end{align}

where

.. math::
	\begin{align}
	\overline{\Delta u_{5}} = \Delta u_{5} - (\Delta u_{3} - \tilde{v}\Delta u_{1})\tilde{v} - (\Delta u_{4} - \tilde{w}\Delta u_{1})\tilde{w}
	\end{align}


The Roe-Pike Method
----------------------

Recall that solving the Riemann problem approximately using Roe's method means finding averaged eigenvalues :math:`\tilde{\lambda}_{i}` , right eigenvectors :math:`\tilde{\mathbf{K}}^{(i)}` and wave strengths :math:`\tilde{\alpha}_{i}` , so that the Roe numerical flux may be evaluated by any of the flux formulae. In the previous section this task was carried out by following the original Roe approach, where the averaged Jacobian matrix :math:`\tilde{\mathbf{A}}` is first sought. In this section we present a different approach, due to Roe and Pike, whereby the construction of :math:`\tilde{\mathbf{A}}` is avoided; instead, one seeks directly averages of a set of scalar quantities that can then be used to evaluate the eigenvalues, right eigenvectors and wave strengths needed.

The Approach
^^^^^^^^^^^^^^

The approach assumes, of course, that the appropriate original system is hyperbolic and that analytical expressions for the eigenvalues :math:`\lambda_{i}` and the set of linearly independent right eigenvectors :math:`\mathbf{K}^{(i)}` are available. Analytical expressions :math:`\hat{\alpha}_{i}` for the wave strengths require extra work via an extra linearisation. One then selects a suitable vector of scalar quantities, typically the vector :math:`\mathbf{W}` of primitive variables or variations of it, for which an average :math:`\tilde{\mathbf{W}}` is to be found. The values of :math:`\tilde{\lambda}_{i}, \tilde{\mathbf{K}}^{(i)}` and :math:`\tilde{\alpha}_{i}` are then found by direct evaluation of the analytical expressions for :math:`\lambda_{i}, \mathbf{K}^{(i)}` and :math:`\hat{\alpha}_{i}` at the state :math:`\tilde{\mathbf{W}}` . There are two distinct steps in the Roe-Pike approach.

Linearisation about a Reference State
""""""""""""""""""""""""""""""""""""""""

To find analytical expressions for the wave strengths :math:`\alpha_{i}` Roe and Pike assume a linearised form of the governing equations based on the assumption that the data states :math:`\mathbf{U}_{L}` and :math:`\mathbf{U}_{R}` are close to a reference state :math:`\hat{\mathbf{U}}` , to order :math:`O(\Delta^{2})` . Linearisation of the conservation laws about this state :math:`\hat{\mathbf{U}}` gives

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x}
	\equiv \mathbf{U}_{t} + \Big( \frac{\partial \mathbf{F}}{\partial \mathbf{U}} \Big) \mathbf{U}_{x}
	\approx \mathbf{U}_{t} + \hat{\mathbf{A}}\mathbf{U}_{x}
	\end{align}

where

.. math::
	\begin{align}
	\mathbf{U}_{t} + \hat{\mathbf{A}}\mathbf{U}_{x} = \mathbf{0}
	\end{align}

is an approximation to the original conservation laws. Here :math:`\hat{\mathbf{A}}` is the Jacobian matrix, assumed available, computed at the reference state :math:`\hat{\mathbf{U}}` . Eigenvalues and right eigenvectors follow. Analytical expressions for the wave strengths :math:`\hat{\alpha}_{i}` in the solution of the linear Riemann problem

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \hat{\mathbf{A}}\mathbf{U}_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \left\{ \begin{array}{l}
	\mathbf{U}_{L} \quad \text{if}~ x<0 \\
	\mathbf{U}_{R} \quad \text{if}~ x>0
	\end{array} \right.
	\end{align}

are found by decomposing the data jump :math:`\Delta \mathbf{U}` onto the right eigenvectors, in the usual way. That is we solve

.. math::
	\begin{align}
	\Delta\mathbf{U} = \mathbf{U}_{R} - \mathbf{U}_{L} = \sum_{k=1}^{m}\hat{\alpha}_{k}\hat{\mathbf{K}}^{(k)}
	\end{align}

Before proceeding, we note that this linearisation is not the Roe linearisation resulting from the Roe matrix :math:`\tilde{\mathbf{A}}` ; it is merely a step to find some sufficiently simple analytical expressions for the wave strengths, which can then be evaluated at the unknown Roe-Pike average state :math:`\tilde{\mathbf{W}}` , yet to be found.

The Algebraic Problem for the Average State
"""""""""""""""""""""""""""""""""""""""""""""

The sought Roe-Pike average vector :math:`\tilde{\mathbf{W}}` is then found by first setting

.. math::
	\begin{align}
	\tilde{\alpha}_{i} = \hat{\alpha}_{i}(\tilde{\mathbf{W}})
	,\quad
	\tilde{\lambda}_{i} = \lambda_{i}(\tilde{\mathbf{W}})
	,\quad
	\tilde{\mathbf{K}}^{(i)} = \mathbf{K}^{(i)}(\tilde{\mathbf{W}})
	\end{align}

the analytical expressions for :math:`\lambda_{i}, \mathbf{K}^{(i)}` and :math:`\hat{\alpha}_{i}` are evaluated at the unknown average state :math:`\tilde{\mathbf{W}}` . Then :math:`\tilde{\mathbf{W}}` is found by solving the algebraic problem posed by the following two sets of equations

.. math::
	\begin{align}
	\Delta\mathbf{U} = \mathbf{U}_{R} - \mathbf{U}_{L} = \sum_{k=1}^{m}\tilde{\alpha}_{k}\tilde{\mathbf{K}}^{(k)}
	\end{align}

and

.. math::
	\begin{align}
	\Delta\mathbf{F} = \mathbf{F}_{R} - \mathbf{F}_{L} = \sum_{k=1}^{m}\tilde{\alpha}_{k}\tilde{\lambda}_{k}\tilde{\mathbf{K}}^{(k)}
	\end{align}

In the following section we illustrate the Roe-Pike approach in terms of a simple system of conservation laws.

The Isothermal Equations
^^^^^^^^^^^^^^^^^^^^^^^^^^^

We solve the Riemann problem

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \left\{ \begin{array}{l}
	\mathbf{U}_{L} \quad \text{if}~ x<0 \\
	\mathbf{U}_{R} \quad \text{if}~ x>0
	\end{array} \right.
	\end{align}

for the isothermal equations using the Roe-Pike approach. The exact Jacobian matrix, eigenvalues and right eigenvectors are

.. math::
	\begin{align}
	\mathbf{A}(\mathbf{U}) = 
	\begin{bmatrix}
	0 & 1 \\
	a^{2}-u^{2} & 2u
	\end{bmatrix}
	\end{align}

.. math::
	\begin{align}
	\lambda_{1} = u - a
	,\quad
	\lambda_{2} = u + a
	\end{align}

.. math::
	\begin{align}
	\mathbf{K}^{(1)} = \begin{bmatrix} 1 \\ u - a \end{bmatrix}
	,\quad
	\mathbf{K}^{(2)} = \begin{bmatrix} 1 \\ u + a \end{bmatrix}
	\end{align}

Linearisation about a Reference State
"""""""""""""""""""""""""""""""""""""""

Assume that the data states :math:`\mathbf{U}_{L}` and :math:`\mathbf{U}_{R}` are close to a state :math:`\hat{\mathbf{U}}` to order :math:`O(\Delta^{2})` . Linearisation of the conservation laws about this state :math:`\hat{\mathbf{U}}` gives linear Riemann problem

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \hat{\mathbf{A}}\mathbf{U}_{x} = \mathbf{0} \\
	& \mathbf{U}(x,0) = \left\{ \begin{array}{l}
	\mathbf{U}_{L} \quad \text{if}~ x<0 \\
	\mathbf{U}_{R} \quad \text{if}~ x>0
	\end{array} \right.
	\end{align}

Here :math:`\hat{\mathbf{A}}` is the Jacobian :math:`\mathbf{A}` evaluated at the reference state :math:`\hat{\mathbf{U}}` , which in terms of primitive variables is denoted by :math:`\hat{\mathbf{W}}=(\hat{\rho}, \hat{u})^{T}` . The complete eigenstructure is

.. math::
	\begin{align}
	\hat{\mathbf{A}}(\mathbf{U}) = 
	\begin{bmatrix}
	0 & 1 \\
	a^{2}-\hat{u}^{2} & 2\hat{u}
	\end{bmatrix}
	\end{align}

.. math::
	\begin{align}
	\hat{\lambda}_{1} = \hat{u} - a
	,\quad
	\hat{\lambda}_{2} = \hat{u} + a
	\end{align}

.. math::
	\begin{align}
	\hat{\mathbf{K}}^{(1)} = \begin{bmatrix} 1 \\ \hat{u} - a \end{bmatrix}
	,\quad
	\hat{\mathbf{K}}^{(2)} = \begin{bmatrix} 1 \\ \hat{u} + a \end{bmatrix}
	\end{align}

Recall that the sound speed :math:`a` is constant. We look for solutions of this linear Riemann problem. The system is linear with constant coefficients. One can therefore deploy appropriate techniques. We decompose the data jump :math:`\Delta\mathbf{U}` onto the right eigenvectors as follows

.. math::
	\begin{align}
	\Delta\mathbf{U} = \mathbf{U}_{R} - \mathbf{U}_{L} = \sum_{k=1}^{2}\hat{\alpha}_{k}\hat{\mathbf{K}}^{(k)} = \hat{\alpha}_{1}\hat{\mathbf{K}}^{(1)} + \hat{\alpha}_{2}\hat{\mathbf{K}}^{(2)}
	\end{align}

where analytical expressions for the coefficients :math:`\hat{\alpha}_{1}, \hat{\alpha}_{2}` are to be found. Writing it in full gives

.. math::
	\begin{align}
	\Delta\rho = \rho_{R} - \rho_{L} = \hat{\alpha}_{1} + \hat{\alpha}_{2}
	\end{align}

.. math::
	\begin{align}
	\Delta(\rho u) = (\rho u)_{R} - (\rho u)_{L} = \hat{\alpha}_{1}(\hat{u} - a) + \hat{\alpha}_{2}(\hat{u} + a)
	\end{align}

It can easily be shown that

.. math::
	\begin{align}
	\Delta(\rho u) = \hat{\rho}\Delta u + \hat{u}\Delta \rho + O(\Delta^{2})
	\end{align}

where the leading term in :math:`O(\Delta^{2})` is

.. math::
	\begin{align}
	(\rho_{R} - \hat{\rho})(u_{R} - \hat{u}) - (\rho_{L} - \hat{\rho})(u_{L} - \hat{u})
	\end{align}

By neglecting :math:`O(\Delta^{2})` it becomes

.. math::
	\begin{align}
	\hat{\rho}\Delta u + \hat{u}\Delta\rho = \hat{\alpha}_{1}(\hat{u} - a) + \hat{\alpha}_{2}(\hat{u} + a)
	\end{align}

Hence we can get the sought analytical expressions for :math:`\hat{\alpha}_{1}` and :math:`\hat{\alpha}_{2}` , namely

.. math::
	\begin{align}
	\hat{\alpha}_{1} = \frac{1}{2}\Big[ \Delta\rho - \hat{\rho}\frac{\Delta u}{a} \Big]
	,\quad
	\hat{\alpha}_{2} = \frac{1}{2}\Big[ \Delta\rho + \hat{\rho}\frac{\Delta u}{a} \Big]
	\end{align}

The reader may easily verify that, to within :math:`O(\Delta^{2})` , the following two sets of equations are identically satisfied

.. math::
	\begin{align}
	\Delta\mathbf{U} = \mathbf{U}_{R} - \mathbf{U}_{L} = \sum_{k=1}^{2}\hat{\alpha}_{k}\hat{\mathbf{K}}^{(k)}
	,\quad
	\Delta\mathbf{F} = \mathbf{F}_{R} - \mathbf{F}_{L} = \sum_{k=1}^{2}\hat{\alpha}_{k}\hat{\lambda}_{k}\hat{\mathbf{K}}^{(k)}
	\end{align}

Here we give details for the second set. In full, these equations read

.. math::
	\begin{align}
	\Delta(\rho u) = \hat{\alpha}_{1}\hat{\lambda}_{1} + \hat{\alpha}_{2}\hat{\lambda}_{2}
	\end{align}

.. math::
	\begin{align}
	\Delta(\rho u^{2} + \rho a^{2}) = \hat{\alpha}_{1}\hat{\lambda}_{1}(\hat{u} - a) + \hat{\alpha}_{2}\hat{\lambda}_{2}(\hat{u} + a)
	\end{align}

The first equation may be written as

.. math::
	\begin{align}
	\hat{\rho}\Delta u + \hat{u}\Delta\rho = \hat{u}(\hat{\alpha}_{1} + \hat{\alpha}_{2}) + a (\hat{\alpha}_{2} - \hat{\alpha}_{1})
	\end{align}

which after using :math:`\hat{\alpha}_{1} = \frac{1}{2}\Big[ \Delta\rho - \hat{\rho}\frac{\Delta u}{a} \Big], \hat{\alpha}_{2} = \frac{1}{2}\Big[ \Delta\rho + \hat{\rho}\frac{\Delta u}{a} \Big]` becomes an identity. To prove the second equation we first expand its left-hand side

.. math::
	\begin{align}
	\Delta(\rho u^{2} + \rho a^{2}) = 2\hat{\rho}\hat{u}\Delta u + \hat{u}^{2}\Delta\rho + a^{2}\Delta\rho
	\end{align}
	
The right-hand side of the second equation can be expressed as

.. math::
	\begin{align}
	(\hat{\alpha}_{1} + \hat{\alpha}_{2})(\hat{u}^{2} + a^{2}) + 2\hat{u}a(\hat{\alpha}_{2} - \hat{\alpha}_{1})
	\end{align}

Therefore, after use of :math:`\hat{\alpha}_{1} = \frac{1}{2}\Big[ \Delta\rho - \hat{\rho}\frac{\Delta u}{a} \Big], \hat{\alpha}_{2} = \frac{1}{2}\Big[ \Delta\rho + \hat{\rho}\frac{\Delta u}{a} \Big]` , the second equation becomes an identity and thus the second set of equtions, to order :math:`O(\Delta^{2})` , is identically satisfied.


The Algebraic Problem for the Average State
""""""""""""""""""""""""""""""""""""""""""""""

For the general case in which the data states :math:`\mathbf{U}_{L}` and :math:`\mathbf{U}_{R}` are not necessarily close, the Roe-Pike approach proposes the algebraic problem of finding the Roe-Pike averages :math:`\tilde{\rho}` and :math:`\tilde{u}` such that the two conditions are valid, namely

.. math::
	\begin{align}
	\Delta\mathbf{U} = \sum_{k=1}^{2}\tilde{\alpha}_{k}\tilde{\mathbf{K}}^{(k)}
	,\quad
	\Delta\mathbf{F} = \sum_{k=1}^{2}\tilde{\alpha}_{k}\tilde{\lambda}_{k}\tilde{\mathbf{K}}^{(k)}
	\end{align}

Here :math:`\tilde{\alpha}_{k}, \tilde{\lambda}_{k}` and :math:`\tilde{\mathbf{K}}^{(k)}` are obtained by evaluating the available analytical expressions at the sought averages :math:`\tilde{\rho}, \tilde{u}` . For the wave strengths these are given by :math:`\hat{\alpha}_{1} = \frac{1}{2}\Big[ \Delta\rho - \hat{\rho}\frac{\Delta u}{a} \Big], \hat{\alpha}_{2} = \frac{1}{2}\Big[ \Delta\rho + \hat{\rho}\frac{\Delta u}{a} \Big]` . For the eigenvalues and right eigenvectors they are given by the exact expressions. We then set

.. math::
	\begin{align}
	\tilde{\alpha}_{1} = \frac{1}{2}\Big[ \Delta\rho - \tilde{\rho}\frac{\Delta u}{a} \Big]
	,\quad
	\tilde{\alpha}_{2} = \frac{1}{2}\Big[ \Delta\rho + \tilde{\rho}\frac{\Delta u}{a} \Big]
	\end{align}

.. math::
	\begin{align}
	\tilde{\lambda}_{1} = \tilde{u} - a
	,\quad
	\tilde{\lambda}_{2} = \tilde{u} + a
	\end{align}

.. math::
	\begin{align}
	\mathbf{K}^{(1)} = \begin{bmatrix} 1 \\ \tilde{u}-a \end{bmatrix}
	,\quad
	\mathbf{K}^{(2)} = \begin{bmatrix} 1 \\ \tilde{u}+a \end{bmatrix}
	\end{align}

Writing condtions in full produces

.. math::
	\begin{align}
	\Delta\rho = \tilde{\alpha}_{1} + \tilde{\alpha}_{2}
	\end{align}

.. math::
	\begin{align}
	\Delta(\rho u) = \tilde{\alpha}_{1}(\tilde{u} - a) + \tilde{\alpha}_{2}(\tilde{u} + a)
	\end{align}

.. math::
	\begin{align}
	\Delta(\rho u) = \tilde{\lambda}_{1}\tilde{\alpha}_{1} + \tilde{\lambda}_{2}\tilde{\alpha}_{2}
	\end{align}

.. math::
	\begin{align}
	\Delta(\rho u^{2} + a^{2}\rho) = \tilde{\lambda}_{1}\tilde{\alpha}_{1}(\tilde{u} - a) + \tilde{\lambda}_{2}\tilde{\alpha}_{2}(\tilde{u} + a)
	\end{align}

These are a set of four non-linear algebraic equations for the two unknowns :math:`\tilde{\rho}` and :math:`\tilde{u}` . Note however that, by virtue of :math:`\tilde{\alpha}_{1} = \frac{1}{2}\Big[ \Delta\rho - \tilde{\rho}\frac{\Delta u}{a} \Big], \tilde{\alpha}_{2} = \frac{1}{2}\Big[ \Delta\rho + \tilde{\rho}\frac{\Delta u}{a} \Big]` , the frist equation is an identity, for any average value :math:`\tilde{\rho}` . Also, the second equation is identical to the third equation and thus we work with the third and fourth equations only. From the third equation one obtains

.. math::
	\begin{align}
	\Delta(\rho u) = \tilde{u}(\tilde{\alpha}_{1} + \tilde{\alpha}_{2}) + a (\tilde{\alpha}_{2} - \tilde{\alpha}_{1})
	\end{align}

Use of :math:`\tilde{\alpha}_{1} = \frac{1}{2}\Big[ \Delta\rho - \tilde{\rho}\frac{\Delta u}{a} \Big], \tilde{\alpha}_{2} = \frac{1}{2}\Big[ \Delta\rho + \tilde{\rho}\frac{\Delta u}{a} \Big]` here leads to

.. math::
	\begin{align}
	\Delta (\rho u) = \tilde{\rho}\Delta u + \tilde{u}\Delta\rho
	\end{align}

From the fourth equation we write

.. math::
	\begin{align}
	\Delta(\rho u^{2} + \rho a^{2}) = (\tilde{\alpha}_{1} + \tilde{\alpha}_{2})(\tilde{u}^{2} + a^{2}) + 2a\tilde{u}(\tilde{\alpha}_{2} - \tilde{\alpha}_{1})
	\end{align}

which after using :math:`\tilde{\alpha}_{1} = \frac{1}{2}\Big[ \Delta\rho - \tilde{\rho}\frac{\Delta u}{a} \Big], \tilde{\alpha}_{2} = \frac{1}{2}\Big[ \Delta\rho + \tilde{\rho}\frac{\Delta u}{a} \Big]` and the exact relation

.. math::
	\begin{align}
	\Delta(\rho u^{2} + \rho a^{2}) = \Delta(\rho u^{2}) + a^{2}\Delta\rho
	\end{align}

leads to the result

.. math::
	\begin{align}
	\Delta(\rho u^{2}) = 2\tilde{u}\tilde{\rho}\Delta u + \tilde{u}^{2}\Delta\rho
	\end{align}

Elimination of :math:`\tilde{\rho}` from :math:`\Delta (\rho u) = \tilde{\rho}\Delta u + \tilde{u}\Delta\rho` and :math:`\Delta(\rho u^{2}) = 2\tilde{u}\tilde{\rho}\Delta u + \tilde{u}^{2}\Delta\rho` leads to a quadratic equation for :math:`\tilde{u}` , namely

.. math::
	\begin{align}
	\Delta\rho\tilde{u}^{2} - 2\Delta(\rho u)\tilde{u} + \Delta(\rho u^{2}) = 0
	\end{align}

This equation has two solutions, namely

.. math::
	\begin{align}
	\tilde{u} = \frac{\Delta(\rho u) \pm \sqrt{[\Delta(\rho u)]^{2} - \Delta\rho\Delta(\rho u^{2})}}{\Delta \rho}
	\end{align}

After using the definition :math:`\Delta r = r_{R} - r_{L}` the discriminant is found to be

.. math::
	\begin{align}
	\rho_{L}\rho_{R}(\Delta u)^{2}
	\end{align}

which simplifies the solutions to be

.. math::
	\begin{align}
	\tilde{u} = \frac{\Delta(\rho u )\pm \Delta u \sqrt{\rho_{L}\rho_{R}}}{\Delta \rho}
	\end{align}

The root obtained by taking the negative sign in it produces the Roe-averaged velocity

.. math::
	\begin{align}
	\tilde{u} = \frac{\sqrt{\rho_{L}}u_{L} + \sqrt{\rho_{R}}u_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

From :math:`\Delta(\rho u) = \tilde{\rho}\Delta u + \tilde{u}\Delta\rho` we obtain

.. math::
	\begin{align}
	\tilde{\rho} = \sqrt{\rho_{L}\rho_{R}}
	\end{align}

We have thus found algebraic expressions for the sought Roe-Pike averages :math:`\tilde{\rho}` and :math:`\tilde{u}` .


.. note:: 

	We observe that the second root obtained by taking the positive sign leads to the spurious solution

	.. math::
		\begin{align}
		\tilde{u} = \frac{\sqrt{\rho_{R}}u_{R} - \sqrt{\rho_{L}}u_{L}}{\sqrt{\rho_{R}} - \sqrt{\rho_{L}}}
		\end{align}

	There is a very good reason for rejecting this as a useful solution; in the trivial case :math:`\rho_{L}=\rho_{R}` , :math:`u_{L}\ne u_{R}` the solution :math:`\tilde{u}` is not even defined.
	
Having found the Roe-Pike averages :math:`\tilde{\rho}` and :math:`\tilde{u}` we can then compute the wave strengths :math:`\tilde{\alpha}_{k}` , the eigenvalues :math:`\tilde{\lambda}_{k}` and the right eigenvectors :math:`\tilde{\mathbf{K}}^{(k)}` according to expressions given before. The Roe numerical flux :math:`\mathbf{F}_{i+\frac{1}{2}}` to be used in the conservative formula can now be obtained from any of the flux relations.

The Euler Equations
^^^^^^^^^^^^^^^^^^^^^^

We solve the Riemann problem for the x-split, three dimensional Euler equations using the Roe-Pike method. Assuming the analytical expressions for the eigenvalues and eigenvectors, one then linearises the equations about a state :math:`\hat{\mathbf{U}}` to find analytical expressions for the wave strengths; this is done under the assumption that both data states :math:`\mathbf{U}_{L}, \mathbf{U}_{R}` are close to :math:`\hat{\mathbf{U}}` to :math:`O(\Delta^{2})` . This leads to the linear system

.. math::
	\begin{align}
	& \mathbf{U}_{t} + \tilde{\mathbf{A}}\mathbf{U}_{x} = \mathbf{0} \\
	& \mathbf{U}(x,t) = \left\{ \begin{array}{l}
	\mathbf{U}_{L} ,\quad x<0 \\
	\mathbf{U}_{R} ,\quad x>0
	\end{array} \right.
	\end{align}

The Jacobian matrix :math:`\tilde{\mathbf{A}}` is obtained by evaluating the exact Jacobian matrix at the state :math:`\hat{\mathbf{U}}` ; the eigenvalues :math:`\hat{\lambda}_{i}` are

.. math::
	\begin{align}
	\hat{\lambda}_{1} = \hat{u} - \hat{a}
	,\quad
	\hat{\lambda}_{2} = \hat{\lambda}_{3} = \hat{\lambda}_{4} = \hat{u}
	,\quad
	\hat{\lambda}_{5} = \hat{u} + \hat{a}
	\end{align}

and the right eigenvectors :math:`\hat{\mathbf{K}}^{(i)}` are

.. math::
	\begin{align}
	\hat{\mathbf{K}}^{(1)} = 
	\begin{bmatrix}
	1 \\ \hat{u}-\hat{a} \\ \hat{v} \\ \hat{w} \\ \hat{H}-\hat{u}\hat{a}
	\end{bmatrix}
	,\quad
	\hat{\mathbf{K}}^{(2)} = 
	\begin{bmatrix}
	1 \\ \hat{u} \\ \hat{v} \\ \hat{w} \\ \frac{1}{2}\hat{\mathbf{V}}^{2}
	\end{bmatrix}
	,\quad
	\hat{\mathbf{K}}^{(3)} = 
	\begin{bmatrix}
	0 \\ 0 \\ 1 \\ 0 \\ \hat{v}
	\end{bmatrix}
	,\quad
	\hat{\mathbf{K}}^{(4)} = 
	\begin{bmatrix}
	0 \\ 0 \\ 0 \\ 1 \\ \hat{w}
	\end{bmatrix}
	,\quad
	\hat{\mathbf{K}}^{(5)} = 
	\begin{bmatrix}
	1 \\ \hat{u}+\hat{a} \\ \hat{v} \\ \hat{w} \\ \hat{H}+\hat{u}\hat{a}
	\end{bmatrix}
	\end{align}

By expanding the data jump :math:`\Delta\mathbf{U}` onto the right eigenvectors we write

.. math::
	\begin{align}
	\Delta\mathbf{U} = \sum_{i=1}^{5}\hat{\alpha}_{i}\hat{\mathbf{K}}^{(i)}
	\end{align}

The solution of this :math:`5 \times 5` linear system will provide analytical expressions for the wave strengths :math:`\hat{\alpha}_{i}` . As a matter of fact we can use the solution for the wave strengths obtained in the Roe original method, and reinterpret the solution appropriately. These are

.. math::
	\begin{align}
	& \hat{\alpha}_{1} = \frac{1}{2\hat{a}}[\Delta u_{1}(\hat{u} + \hat{a}) - \Delta u_{2} - \hat{a}\hat{\alpha}_{2}] \\
	& \hat{\alpha}_{2} = \frac{\gamma-1}{\hat{a}^{2}}[\Delta u_{1}(\hat{H} - \hat{u}^{2}) + \hat{u}\Delta u_{2} - \overline{\Delta u_{5}}] \\
	& \hat{\alpha}_{3} = \Delta u_{3} - \hat{v}\Delta u_{1} \\
	& \hat{\alpha}_{4} = \Delta u_{4} - \hat{w}\Delta u_{1} \\
	& \hat{\alpha}_{5} = \Delta u_{1} - (\hat{\alpha}_{1} + \hat{\alpha}_{2})
	\end{align}

where

.. math::
	\begin{align}
	\overline{\Delta u}_{5} = \Delta u_{5} - (\Delta u_{3} - \hat{v}\Delta u_{1})\hat{v} - (\Delta u_{4} - \hat{w}\Delta u_{1})\hat{w}
	\end{align}

By applying the operator

.. math::
	\begin{align}
	\Delta(rs) = \hat{r}\Delta s + \hat{s}\Delta r + O(\Delta^{2})
	\end{align}

and neglecting :math:`O(\Delta^{2})` we arrive at the following solution:

.. math::
	\begin{align}
	& \hat{\alpha}_{1} = \frac{1}{2\hat{a}^{2}}[\Delta p - \hat{\rho}\hat{a}\Delta u] \\
	& \hat{\alpha}_{2} = \Delta\rho - \Delta p/\hat{a}^{2} \\
	& \hat{\alpha}_{3} = \hat{\rho}\Delta v \\
	& \hat{\alpha}_{4} = \hat{\rho}\Delta w \\
	& \hat{\alpha}_{5} = \frac{1}{2\hat{a}^{2}}[\Delta p + \hat{\rho}\hat{a}\Delta u]
	\end{align}

The second step in the Roe-Pike method is to find an average state

.. math::
	\begin{align}
	\tilde{\mathbf{W}} = (\tilde{\rho}, \tilde{u}, \tilde{v}, \tilde{w}, \tilde{a})^{T}
	\end{align}

such that the algebraic problem posed by the following two sets of equations

.. math::
	\begin{align}
	\Delta\mathbf{U} = \sum_{i=1}^{5}\tilde{\alpha}_{i}\tilde{\mathbf{K}}^{(i)}
	,\quad
	\Delta\mathbf{F} = \sum_{i=1}^{5}\tilde{\alpha}_{i}\tilde{\lambda}_{i}\tilde{\mathbf{K}}^{(i)}
	\end{align}

is satisfied, where

.. math::
	\begin{align}
	\tilde{\alpha}_{i} = \hat{\alpha}_{i}(\tilde{\mathbf{W}})
	,\quad
	\tilde{\lambda}_{i} = \lambda_{i}(\tilde{\mathbf{W}})
	,\quad
	\tilde{\mathbf{K}}^{(i)} = \mathbf{K}^{(i)}(\tilde{\mathbf{W}})
	\end{align}

with :math:`\lambda_{i}, \mathbf{K}^{(i)}` and :math:`\hat{\alpha}_{i}` already given before. Details of the algebra for the one-dimensional case are given by Roe and Pike. For the x-split three dimensional case the solution for the average vector :math:`\tilde{\mathbf{W}}` is

.. math::
	\begin{align}
	\tilde{\rho} = \sqrt{\rho_{L}\rho_{R}}
	\end{align}

.. math::
	\begin{align}
	\tilde{u} = \frac{\sqrt{\rho_{L}}u_{L} + \sqrt{\rho_{R}}u_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

.. math::
	\begin{align}
	\tilde{v} = \frac{\sqrt{\rho_{L}}v_{L} + \sqrt{\rho_{R}}v_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

.. math::
	\begin{align}
	\tilde{w} = \frac{\sqrt{\rho_{L}}w_{L} + \sqrt{\rho_{R}}w_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

.. math::
	\begin{align}
	\tilde{H} = \frac{\sqrt{\rho_{L}}H_{L} + \sqrt{\rho_{R}}H_{R}}{\sqrt{\rho_{L}} + \sqrt{\rho_{R}}}
	\end{align}

.. math::
	\begin{align}
	\tilde{a} = \Big( (\gamma-1)(\tilde{H}-\frac{1}{2}\tilde{\mathbf{V}}^{2}) \Big)^{\frac{1}{2}}
	\end{align}

where :math:`\tilde{\mathbf{V}}^{2} = \tilde{u}^{2} + \tilde{v}^{2} + \tilde{w}^{2}` . These are identical to the Roe averages obtained by the original Roe method. Now :math:`\tilde{\alpha}_{i}, \tilde{\lambda}_{i}` and :math:`\tilde{\mathbf{K}}^{(i)}` can be computed and then the Roe intercell flux :math:`\mathbf{F}_{i+\frac{1}{2}}` follows from any of the flux formulae.



An Entropy Fix
-----------------

Linearised Riemann problem solutions consist of discontinuous jumps only. This can be a good approximation for contacts and shocks, in that the discontinuous character of the wave is correct, although the size of the jump may not be correctly approximated by the linearised solution. Rarefaction waves, on the other hand, carry a continuous change in flow variables, and as time increases, they tend to spread; that is spatial gradients tend to decay. Quite clearly then, the linearised approximation via discontinuous jumps is grossly incorrect. In a practical computational set up however, it is only in the case in which the rarefaction wave is transonic, or sonic, where linearised approximations encounter difficulties; these show up in the form of unphyisical, entropy violating discontinuous waves, sometimes called rarefaction shocks.

The Entropy Problem
^^^^^^^^^^^^^^^^^^^^^^

Consider the Riemann problem whose initial data is that Test 1 in Table 11.1. The structure of the exact solution of this problem, depicted in Fig.11.2, contains a left sonic rarefaction, a contact discontinuity of speed :math:`u_{*}` and a right shock wave. As the left rarefaction is sonic the eigenvalue :math:`\lambda_{1} = u - a` changes from negative to positive, as the wave is crossed from left to right. There is a point at which :math:`\lambda_{1} = u - a = 0` , giving the sonic flow condition :math:`u=a` .

.. math::
	\begin{align}
	\lambda_{1}(\mathbf{U}_{L}) = S_{HL} = u_{L} - a_{L} < 0
	\end{align}

is the speed of the head of the rarefaction and

.. math::
	\begin{align}
	\lambda_{1}(\mathbf{U}_{*L}) = S_{TL} = u_{*} - a_{*L} > 0
	\end{align}

is the speed of the tail. Fig.11.4 shows the numerical (symbols) and exact (line) solutions of this problem, where the numerical solution is obtained by Roe's method as described so far. The numerical solution within the rarefaction exhibits a discontinuity within the wave; this discontinuity is unphysical, it violates the entropy condition. Recall that a physically admissible discontinuity of speed :math:`S` requires :math:`S_{b} \ge S \ge S_{a}` where :math:`S_{b}` and :math:`S_{a}` are characteristic speeds behind and ahead of the wave respectively. That is, characteristics move into the discontinuity; the limiting case of parallel chracteristic speeds is that of a contact discontinuity. For the example above, the opposite happens.

Roe's solver can be modified so as to avoid entropy violating solutions. This is usually referred to as an entropy fix. Harten and Hyman suggested an entropy fix for Roe's method, which has widespread use. Other ways of correcting the scheme have been discussed by Roe and Pike, Roe, Sweby and Dubois and Mehlman, amongst others. Here we present the details of the Harten-Hymann approach.

The Harten-Hymann Entropy Fix
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The general approach is presented in the original paper of Harten and Hyman of 1983. The presentation here is tailored specifically to the time-dependent Euler equations, for which we only need to consider the left and right non-linear waves associated with the eigenvalues :math:`\lambda_{1} = u-a` and :math:`\lambda_{5} = u+a` respectively. Our version of the Harten-Hyman entropy fix relies on estimates for particle velocity :math:`u_{*}` and sound speeds :math:`a_{*L}, a_{*R}` in the Star Region.

Left Transonic Rarefaction
""""""""""""""""""""""""""""""

Consider the situation depicted in Fig.11.2. Assuming :math:`u_{*}` and :math:`a_{*L}` are available, we compute the speeds

.. math::
	\begin{align}
	\lambda_{1}^{L} = u_{L} - a_{L}
	,\quad
	\lambda_{1}^{R} = u_{*} - a_{*L}
	\end{align}

If

.. math::
	\begin{align}
	\lambda_{1}^{L} < 0 < \lambda_{1}^{R}
	\end{align}

then the left wave is a transonic, or sonic, rarefaction wave. In these circumstances the entropy fix is required and is enforced as follows. The single jump

.. math::
	\begin{align}
	\mathbf{U}_{*L} - \mathbf{U}_{L} = \tilde{\alpha}_{1}\tilde{\mathbf{K}}^{(1)}
	\end{align}

travelling with speed :math:`\tilde{\lambda}_{1}` is split into two smaller jumps :math:`\mathbf{U}_{SL} - \mathbf{U}_{L}` and :math:`\mathbf{U}_{*L} - \mathbf{U}_{SL}` travelling respectively at speeds :math:`\lambda_{1}^{L}` and :math:`\lambda_{1}^{R}` , where :math:`\mathbf{U}_{SL}` is a transonic state yet to be found; see Fig.11.3. Application of the integral form of the conservation laws gives

.. math::
	\begin{align}
	\lambda_{1}^{R}(\mathbf{U}_{SL} - \mathbf{U}_{*L}) + \lambda_{1}^{L}(\mathbf{U}_{L} - \mathbf{U}_{SL}) = \tilde{\lambda}_{1}(\mathbf{U}_{L} - \mathbf{U}_{*L})
	\end{align}

from which we obtain

.. math::
	\begin{align}
	\mathbf{U}_{SL} = \frac{(\tilde{\lambda}_{1} - \lambda_{1}^{L})\mathbf{U}_{L} + (\lambda_{1}^{R} - \tilde{\lambda}_{1})\mathbf{U}_{*L}}{\lambda_{1}^{R} - \lambda_{1}^{L}}
	\end{align}

To compute the Roe intercell flux we adopt the one-sided formulae, namely

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{L} + \sum_{\tilde{\lambda}_{k} \le 0}\tilde{\lambda}_{k}\tilde{\alpha}_{k}\tilde{\mathbf{K}}^{(k)}
	\end{align}

where in the present case the summation applies to the single jump :math:`\mathbf{U}_{SL} - \mathbf{U}_{L}` travelling with speed :math:`\lambda_{1}^{L} < 0` ; the jump is

.. math::
	\begin{align}
	\mathbf{U}_{SL} - \mathbf{U}_{L} = \frac{(\lambda_{1}^{R} - \tilde{\lambda}_{1})}{(\lambda_{1}^{R} - \lambda_{1}^{L})}(\mathbf{U}_{*L} - \mathbf{U}_{L})
	\end{align}

But the Roe approximation gives

.. math::
	\begin{align}
	\mathbf{U}_{*L} - \mathbf{U}_{L} = \tilde{\alpha}_{1}\tilde{\mathbf{K}}^{(1)}
	\end{align}

and thus the flux jump :math:`(\Delta\mathbf{F})_{1}^{L}` across the wave of speed :math:`\lambda_{1}^{L}` is

.. math::
	\begin{align}
	(\Delta\mathbf{F})_{1}^{L} = \lambda_{1}^{L}\Big(\frac{\lambda_{1}^{R} - \tilde{\lambda}_{1}}{\lambda_{1}^{R} - \lambda_{1}^{L}}\Big)\tilde{\alpha}_{1}\tilde{\mathbf{K}}^{(1)}
	\end{align}

By defining the new wave speed

.. math::
	\begin{align}
	\overline{\lambda_{1}} = \lambda_{1}^{L}\Big(\frac{\lambda_{1}^{R} - \tilde{\lambda}_{1}}{\lambda_{1}^{R} - \lambda_{1}^{L}}\Big)
	\end{align}

the intercell flux becomes

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{L} + \overline{\lambda_{1}}\tilde{\alpha}_{1}\tilde{\mathbf{K}}^{(1)}
	\end{align}


Right Transonic Rarefaction
""""""""""""""""""""""""""""""""

For a right transonic rarefaction, the entropy fix procedure is entirely analogous to the left rarefaction case. Assuming the speeds :math:`u_{*}` and :math:`a_{*R}` are available, we compute the two wave speeds

.. math::
	\begin{align}
	\lambda_{5}^{L} = u_{*} + a_{*R}
	,\quad
	\lambda_{5}^{R} = u_{R} + a_{R}
	\end{align}

If

.. math::
	\begin{align}
	\lambda_{5}^{L} < 0 < \lambda_{5}^{R}
	\end{align}

then the right wave is a transonic rarefaction wave. The transonic state :math:`\mathbf{U}_{SR}` is defined between the waves of speeds :math:`\lambda_{5}^{L}` and :math:`\lambda_{5}^{R}` and is given by

.. math::
	\begin{align}
	\mathbf{U}_{SR} = \frac{(\lambda_{5}^{R} - \tilde{\lambda}_{5})\mathbf{U}_{R} + (\tilde{\lambda}_{5} - \lambda_{5}^{L})\mathbf{U}_{*R}}{\lambda_{5}^{R} - \lambda_{5}^{L}}
	\end{align}

Next we define the new wave speed

.. math::
	\begin{align}
	\overline{\lambda_{5}} = \lambda_{5}^{R}\Big( \frac{\tilde{\lambda}_{5} - \lambda_{5}^{L}}{\lambda_{5}^{R} - \lambda_{5}^{L}} \Big)
	\end{align}

and then use the one-sided flux formula to compute the numerical flux. The resulting Roe numerical flux is

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}_{R} - \overline{\lambda_{5}}\tilde{\alpha}_{5}\tilde{\mathbf{K}}^{(5)}
	\end{align}

In the present version of the Harten-Hymann entropy fix we have used the one-sided flux formulae. The procedure can be easily adapted for use in conjunction with the centred formulae, if desired. Next we dicuss ways of finding the speeds :math:`u_{*}, a_{*L}` and :math:`a_{*R}` needed to implement the entropy fix.


The Star Region Speeds
^^^^^^^^^^^^^^^^^^^^^^^^

The star states :math:`\mathbf{U}_{*L}, \mathbf{U}_{*R}` are required in order to obtain the speeds :math:`u_{*}, a_{*L}, a_{*R}` and thus the characteristic speeds :math:`\lambda_{1}^{R}, \lambda_{5}^{L}` . We present various possible alternatives.

The Roe-Averaged States
""""""""""""""""""""""""""

Given the Roe-averaged :math:`\tilde{\alpha}_{i}` and :math:`\tilde{\mathbf{K}}^{(i)}` one can find the state :math:`\mathbf{U}_{*L}` as

.. math::
	\begin{align}
	\mathbf{U}_{*L} = \mathbf{U}_{L} + \tilde{\alpha}_{1}\tilde{\mathbf{K}}^{(1)}
	\end{align}

which leads to

.. math::
	\begin{align}
	& \rho_{*L} = \rho_{L} + \tilde{\alpha}_{1} \\
	& u_{*} = \frac{\rho_{L}u_{L} + \tilde{\alpha}_{1}(\tilde{u} - \tilde{a})}{\rho_{L} + \tilde{\alpha}_{1}} \\
	& p_{*} = (\gamma-1)\Big[ E_{L} + \tilde{\alpha}_{1}(\tilde{H} - \tilde{u}\tilde{a}) - \frac{1}{2}\rho_{*L}u_{*}^{2} \Big]
	\end{align}

Then we compute the sound speed

.. math::
	\begin{align}
	a_{*L} = \sqrt{\frac{\gamma p_{*}}{\rho_{*L}}}
	\end{align}

and thus the speeds :math:`\lambda_{1}^{L}` and :math:`\lambda_{1}^{R}` follow. For the right wave one has

.. math::
	\begin{align}
	\mathbf{U}_{*R} = \mathbf{U}_{R} - \tilde{\alpha}_{5}\tilde{\mathbf{K}}^{(5)}
	\end{align}

which produces

.. math::
	\begin{align}
	& \rho_{*R} = \rho_{R} - \tilde{\alpha}_{5} \\
	& u_{*} = \frac{\rho_{R}u_{R} - \tilde{\alpha}_{5}(\tilde{u} + \tilde{a})}{\rho_{R} - \tilde{\alpha}_{5}} \\
	& p_{*} = (\gamma-1)\Big[ E_{R} - \tilde{\alpha}_{5}(\tilde{H} + \tilde{u}\tilde{a}) - \frac{1}{2}\rho_{*R}u_{*}^{2} \Big]
	\end{align}

The sound speed follows as :math:`a_{*R} = \sqrt{\frac{\gamma p_{*}}{\rho_{*R}}}` and thus the wave speeds :math:`\lambda_{5}^{L}` and :math:`\lambda_{5}^{R}` are determined.


The PVRS Approximation
"""""""""""""""""""""""""

Another way of estimating the required wave speeds is by using the Primitive-Variable Riemann Solver (PVRS) of Toro. The relevant solution values are

.. math::
	\begin{align}
	& p_{*} = \frac{1}{2}(p_{L} + p_{R}) + \frac{1}{2}(u_{L} - u_{R})\bar{\rho}\bar{a} \\
	& u_{*} = \frac{1}{2}(u_{L} + u_{R}) + \frac{1}{2}(p_{L} - p_{R})/(\bar{\rho}\bar{a}) \\
	& \rho_{*L} = \rho_{L} + (u_{L} - u_{*})\bar{\rho}/\bar{a} \\
	& \rho_{*R} = \rho_{R} + (u_{*} - u_{R})\bar{\rho}/\bar{a}
	\end{align}

with

.. math::
	\begin{align}
	\bar{\rho} = \frac{1}{2}(\rho_{L} + \rho_{R})
	,\quad
	\bar{a} = \frac{1}{2}(a_{L} + a_{R})
	\end{align}

In order to avoid negative pressures we recommend replacing the linearised solution :math:`p_{*}` by :math:`\max(0, p_{*})` . The sound speeds :math:`a_{*L}, a_{*R}` are then computed in the usual way.


TRRS Approximation
"""""""""""""""""""""

Another possibility is to use the Two-Rarefaction Riemann Solver (TRRS). The pressure :math:`p_{*}` is given by

.. math::
	\begin{align}
	p_{*} = \Big[ \frac{a_{L} + a_{R} - \frac{\gamma-1}{2}(u_{R} - u_{L})}{a_{L}/p_{L}^{z} + a_{R}/p_{R}^{z}} \Big]^{\frac{1}{z}}
	\end{align}

with :math:`z = \frac{\gamma - 1}{2\gamma}` . For the left non-linear wave the sound speed and particle velocity follow directly as

.. math::
	\begin{align}
	a_{*L} = a_{L}(p_{*}/p_{L})^{z}
	,\quad
	u_{*} = u_{L} + \frac{2}{(\gamma-1)}(a_{L} - a_{*L})
	\end{align}

For the right non-linear wave we have

.. math::
	\begin{align}
	a_{*R} = a_{R}(p_{*}/p_{R})^{z}
	,\quad
	u_{*} = u_{R} + \frac{2}{(\gamma-1)}(a_{*R} - a_{R})
	\end{align}

Hence speeds :math:`\lambda_{1}^{L}, \lambda_{1}^{R}, \lambda_{5}^{L}, \lambda_{5}^{R}` are determined.


Other Alternatives
"""""""""""""""""""""

Both the PVRS and the Roe linearised solutions for the speed :math:`u_{*}, a_{*L}, a_{*R}` may fail in the vicinity of low density flow. The TRRS approximation presented above would not suffer from such difficulties; in fact, in the case in which both non-linear waves are rarefactions such an approximation would be exact. But as seen in its equations there are four fractional powers to be computed in each case, which makes this approximation rather expensive to use. A robust and yet more efficient scheme is the Two-Shock Riemann Solver (TSRS). Even better is the adaptive Riemann solver scheme.



The Riemann Solver of Osher
===============================

One of the attractions of Osher's scheme is the smoothness of the numerical flux; the scheme has also been proved to be entropy satisfying and in practical computations it is seen to handle sonic flow well. A distinguishing feature of the Osher scheme is its performance near slowly-moving shock waves. The scheme is closely related to the Flux Vector Splitting approach and it is a generalisation of the CIR scheme for linear hyperbolic systems with constant coefficients. 

The derivation of the Osher intercell numerical flux depends on integration in phase space. Such operation involves the choice of integration paths, intersection points and sonic points. The integration paths are taken to be integral curves associated with the set of right eigenvectors and to date there are essentially two ways of ordering these integration paths. The most recent approach orders the integration paths such that these correspond to physically meaningful relations across wave families in physical space. In the current literature this is called physical ordering or P-ordering. Osher's original scheme utilises the ordering of paths that is precisely the inverse of the P-ordering; this is usually called O-ordering. Intersection and sonic points are computed via Generalised Riemann Invariants.


Osher's Scheme for a General System
--------------------------------------

Mathematical Bases
^^^^^^^^^^^^^^^^^^^^^

Osher's approach to upwind differencing provides an approximation to the Godunov numerical flux and results from evaluating the physical flux :math:`\mathbf{F}(\mathbf{U})` at various states :math:`\mathbf{U}_{k}` ; these include the data states :math:`\mathbf{U}_{L}, \mathbf{U}_{R}` , intersection points and sonic points. Consider a system of :math:`m` hyperbolic conservation laws

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} = \mathbf{0}
	\end{align}

and the conservative scheme

.. math::
	\begin{align}
	\mathbf{U}_{i}^{n+1} = \mathbf{U}_{i}^{n} + \frac{\Delta t}{\Delta x}\Big[ \mathbf{F}_{i-\frac{1}{2}} - \mathbf{F}_{i+\frac{1}{2}} \Big]
	\end{align}

to solve it numerically. The objective of this chapter is to provide an expression for the numerical flux :math:`\mathbf{F}_{i+\frac{1}{2}}` following Osher's approach.

We assume the system to be strictly hyperbolic with eigenvalues

.. math::
	\begin{align}
	\lambda_{1}(\mathbf{U}) < \lambda_{2}(\mathbf{U}) < \cdots < \lambda_{m}(\mathbf{U})
	\end{align}

and corresponding right eigenvectors

.. math::
	\begin{align}
	\mathbf{K}^{(1)}(\mathbf{U})
	,\quad
	\mathbf{K}^{(2)}(\mathbf{U})
	,\quad \cdots ,\quad
	\mathbf{K}^{(m)}(\mathbf{U})
	\end{align}

From hyperbolicity, the Jacobian matrix

.. math::
	\begin{align}
	\mathbf{A}(\mathbf{U}) = \frac{\partial \mathbf{F}}{\partial \mathbf{U}}
	\end{align}

is diagonalisable, that is

.. math::
	\begin{align}
	\mathbf{A}(\mathbf{U}) = \mathbf{K}(\mathbf{U})\mathbf{\Lambda}(\mathbf{U})\mathbf{K}^{-1}(\mathbf{U})
	\end{align}

where :math:`\mathbf{K}(\mathbf{U})` is the non-singular matrix whose columns are the right eigenvectors of :math:`\mathbf{A}(\mathbf{U})` , that is 

.. math::
	\begin{align}
	\mathbf{K}(\mathbf{U}) = \Big[ \mathbf{K}^{(1)}(\mathbf{U}); \mathbf{K}^{(2)}(\mathbf{U}); \cdots ; \mathbf{K}^{(m)}(\mathbf{U}) \Big]
	\end{align}

and :math:`\mathbf{\Lambda}(\mathbf{U})` is the diagonal matrix formed by the eigenvalues :math:`\lambda_{i}(\mathbf{U})`

.. math::
	\begin{align}
	\mathbf{\Lambda}(\mathbf{U}) = 
	\begin{bmatrix}
	\lambda_{1}(\mathbf{U}) & \cdots & 0 \\
	\vdots & & \vdots \\
	0 & \cdots & \lambda_{m}(\mathbf{U})
	\end{bmatrix}
	\end{align}

As done before for linear systems with constant coefficients, we introduce the following notation

.. math::
	\begin{align}
	\lambda_{i}^{+}(\mathbf{U}) = \max(\lambda_{i}(\mathbf{U}), 0)
	,\quad
	\lambda_{i}^{-}(\mathbf{U}) = \min(\lambda_{i}(\mathbf{U}), 0)
	\end{align}

to define diagonal matrices

.. math::
	\begin{align}
	\mathbf{\Lambda}^{+}(\mathbf{U}) = 
	\begin{bmatrix}
	\lambda_{1}^{+}(\mathbf{U}) & \cdots & 0 \\
	\vdots & & \vdots \\
	0 & \cdots & \lambda_{m}^{+}(\mathbf{U})
	\end{bmatrix}
	,\quad
	\mathbf{\Lambda}^{-}(\mathbf{U}) = 
	\begin{bmatrix}
	\lambda_{1}^{-}(\mathbf{U}) & \cdots & 0 \\
	\vdots & & \vdots \\
	0 & \cdots & \lambda_{m}^{-}(\mathbf{U})
	\end{bmatrix}
	,\quad
	|\mathbf{\Lambda}(\mathbf{U})| = 
	\begin{bmatrix}
	|\lambda_{1}(\mathbf{U})| & \cdots & 0 \\
	\vdots & & \vdots \\
	0 & \cdots & |\lambda_{m}(\mathbf{U})|
	\end{bmatrix}
	\end{align}

We also introduce

.. math::
	\begin{align}
	|\mathbf{A}(\mathbf{U})| = \mathbf{K}(\mathbf{U})|\mathbf{\Lambda}(\mathbf{U})|\mathbf{K}^{-1}(\mathbf{U})
	\end{align}

But

.. math::
	\begin{align}
	|\lambda_{i}(\mathbf{U})| = \lambda_{i}^{+}(\mathbf{U}) - \lambda_{i}^{-}(\mathbf{U})
	\end{align}

and hence

.. math::
	\begin{align}
	|\mathbf{\Lambda}(\mathbf{U})| = \mathbf{\Lambda}^{+}(\mathbf{U}) - \mathbf{\Lambda}^{-}(\mathbf{U})
	\end{align}

which if substituted in :math:`|\mathbf{A}(\mathbf{U})| = \mathbf{K}(\mathbf{U})|\mathbf{\Lambda}(\mathbf{U})|\mathbf{K}^{-1}(\mathbf{U})` gives

.. math::
	\begin{align}
	|\mathbf{A}(\mathbf{U})| = \mathbf{A}^{+}(\mathbf{U}) - \mathbf{A}^{-}(\mathbf{U})
	\end{align}

with

.. math::
	\begin{align}
	\mathbf{A}^{+}(\mathbf{U}) = \mathbf{K}(\mathbf{U})\mathbf{\Lambda}^{+}(\mathbf{U})\mathbf{K}^{-1}(\mathbf{U})
	,\quad
	\mathbf{A}^{-}(\mathbf{U}) = \mathbf{K}(\mathbf{U})\mathbf{\Lambda}^{-}(\mathbf{U})\mathbf{K}^{-1}(\mathbf{U})
	\end{align}

These matrices produce a splitting of the Jacobian matrix as

.. math::
	\begin{align}
	\mathbf{A}(\mathbf{U}) = \mathbf{A}^{+}(\mathbf{U}) + \mathbf{A}^{-}(\mathbf{U})
	\end{align}

where :math:`\mathbf{A}^{+}(\mathbf{U})` has positive or zero eigenvalues and :math:`\mathbf{A}^{-}(\mathbf{U})` has negative or zero eigenvalues. Note that this is a direct generalisation to non-linear systems of the Jacobian splitting for linear systems with constant coefficients.


Osher's Numerical Flux
^^^^^^^^^^^^^^^^^^^^^^^^^

Osher's approach assumes that there exist vector-valued functions :math:`\mathbf{F}^{+}(\mathbf{U})` and :math:`\mathbf{F}^{-}(\mathbf{U})` that satisfy

.. math::
	\begin{align}
	\mathbf{F}(\mathbf{U}) = \mathbf{F}^{+}(\mathbf{U}) + \mathbf{F}^{-}(\mathbf{U})
	\end{align}

and

.. math::
	\begin{align}
	\frac{\partial \mathbf{F}^{+}}{\partial \mathbf{U}} = \mathbf{A}^{+}(\mathbf{U})
	,\quad
	\frac{\partial \mathbf{F}^{-}}{\partial \mathbf{U}} = \mathbf{A}^{-}(\mathbf{U})
	\end{align}

If the initial data :math:`\mathbf{U}_{L}, \mathbf{U}_{R}` of the Riemann problem for the conservation laws is denoted by

.. math::
	\begin{align}
	\mathbf{U}_{0} \equiv \mathbf{U}_{L} = \mathbf{U}_{i}^{n}
	,\quad
	\mathbf{U}_{1} \equiv \mathbf{U}_{R} = \mathbf{U}_{i+1}^{n}
	\end{align}

then the corresponding numerical flux to be used is

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}^{+}(\mathbf{U}_{0}) + \mathbf{F}^{-}(\mathbf{U}_{1})
	\end{align}

Using the integral relations

.. math::
	\begin{align}
	\int_{\mathbf{U}_{0}}^{\mathbf{U}_{1}}\mathbf{A}^{-}(\mathbf{U})\mathrm{d}\mathbf{U}
	= \mathbf{F}^{-}(\mathbf{U}_{1}) - \mathbf{F}^{-}(\mathbf{U}_{0})
	\end{align}

and

.. math::
	\begin{align}
	\int_{\mathbf{U}_{0}}^{\mathbf{U}_{1}}\mathbf{A}^{+}(\mathbf{U})\mathrm{d}\mathbf{U}
	= \mathbf{F}^{+}(\mathbf{U}_{1}) - \mathbf{F}^{+}(\mathbf{U}_{0})
	\end{align}

we can express the numerical flux in three different forms, namely

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}(\mathbf{U}_{0}) + \int_{\mathbf{U}_{0}}^{\mathbf{U}_{1}}\mathbf{A}^{-}(\mathbf{U})\mathrm{d}\mathbf{U}
	\end{align}

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \mathbf{F}(\mathbf{U}_{1}) - \int_{\mathbf{U}_{0}}^{\mathbf{U}_{1}}\mathbf{A}^{+}(\mathbf{U})\mathrm{d}\mathbf{U}
	\end{align}

and

.. math::
	\begin{align}
	\mathbf{F}_{i+\frac{1}{2}} = \frac{1}{2}[\mathbf{F}(\mathbf{U}_{0}) + \mathbf{F}(\mathbf{U}_{1})] - \frac{1}{2}\int_{\mathbf{U}_{0}}^{\mathbf{U}_{1}}|\mathbf{A}(\mathbf{U})|\mathrm{d}\mathbf{U}
	\end{align}

The integration with respect to :math:`\mathbf{U}` in these expressions is carried out in phase space :math:`\mathbb{R}^{m}` . Elements of this vector space are vectors

.. math::
	\begin{align}
	\mathbf{U} = [u_{1}, u_{2}, \cdots, u_{m}]^{T}
	\end{align}

whose components :math:`u_{i}` are real numbers. In general, the integrals depend on the integration path chosen. Osher's approach is to select particular integration paths so as to make the actual integration tractable.


Osher's Flux for the Single-Wave Case
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^






AUSM family schemes
===========================

`A Sequel to AUSM: AUSM+ <https://www.sciencedirect.com/science/article/pii/S0021999196902569>`_ 

Consider as an initial-value problem the one-dimensional system of conservation laws for ideal-gas flows

.. math::
	\begin{align}
	& \frac{\partial\mathbf{U}}{\partial t} + \frac{\partial\mathbf{F}}{\partial x} = 0
	,\quad t>0, -\infty \le x \le \infty \\
	& \mathbf{U}(x,0) = \mathbf{U}_{0}(x)
	\end{align}

where :math:`\mathbf{U} = (\rho, \rho u, \rho e_{t})^{T}` belongs to a phase space :math:`\mathbb{R}^{3}` , the inviscid flux :math:`\mathbf{F} = (\rho u, \rho u^{2} + p, \rho u h_{t})^{T}` denoted a smooth mapping :math:`\mathbf{F}: \mathbb{U}\to\mathbb{R}^{3}` . We denote the specific total energy :math:`e_{t} = e + u^{2}/2 = h_{t} - p/\rho` , and the ideal-gas equation of state is assumed, :math:`p = (\gamma - 1)\rho e, \gamma=1.4` .


AUSM formulation
------------------

As a first step in formulation of the AUSM family of schemes, we recognize the convection and acoustic waves as two physically distinct processes and write the inviscid flux as a sum of the convective and pressure terms

.. math::
	\begin{align}
	\mathbf{F} = \mathbf{F}^{(c)} + \mathbf{P}
	\end{align}

where

.. math::
	\begin{align}
	\mathbf{F}^{(c)} = Ma \begin{pmatrix} \rho \\ \rho u \\ \rho h_{t} \end{pmatrix}
	,\quad
	\mathbf{P} = \begin{pmatrix} 0 \\ p \\ 0 \end{pmatrix}
	\end{align}

Here the convective flux :math:`\mathbf{F}^{(c)}` is expressed in terms of the convective speed :math:`M` and the passive scalar quantities indicated in the brackets. The pressure flux :math:`\mathbf{P}` contains nothing but the pressure term.

Boldface characters denote a column vector of variables defined at the continuous level, the lower-case boldface indicates the numerical flux at the discrete level, and the calligraphic type used for the split Mach number and pressure functions. Correspondingly we shall express the numerical flux :math:`\mathbf{f}_{j+1/2}` as the sum of the numerical convective flux :math:`\mathbf{f}_{j+1/2}^{(c)}` and the numerical pressure flux, at the interface :math:`j+1/2` straddling the :math:`j` -th and :math:`(j+1)` -th cells

.. math::
	\begin{align}
	\mathbf{f}_{j+1/2} = \mathbf{f}_{j+1/2}^{(c)} + \mathbf{p}_{j+1/2}
	\end{align}

where we further write

.. math::
	\begin{align}
	\mathbf{f}_{j+1/2}^{(c)} = m_{j+1/2}\Phi_{j+1/2}
	,\quad
	\mathbf{p}_{j+1/2} = \begin{pmatrix} 0 \\ p_{j+1/2} \\ 0 \end{pmatrix}
	\end{align}

For the AUSM formulation, these interface quantities are summarized in the following: First we define :math:`\forall j \in \mathbb{Z}` 

.. math::
	\begin{align}
	& m_{j+1/2} = \mathscr{M}_{j}^{+} + \mathscr{M}_{j+1}^{-}
	,\quad \mathscr{M}_{j}^{\pm} = \mathscr{M}^{\pm}(M_{j}) \\
	& p_{j+1/2} = \mathscr{P}_{j}^{+}p_{j} + \mathscr{P}_{j+1}^{-}p_{j+1}
	,\quad \mathscr{P}_{j}^{\pm} = \mathscr{P}^{\pm}(M_{j})
	\end{align}

where

.. math::
	\begin{align}
	\mathscr{M}^{\pm}(M) = \left\{ \begin{array}{l}
	\frac{1}{2}(M \pm |M|) ,\quad \text{if}~ |M|>1 \\
	\pm\frac{1}{4}(M\pm 1)^{2} ,\quad \text{otherwise}
	\end{array} \right.
	\end{align}

and

.. math::
	\begin{align}
	\mathscr{P}^{\pm} = \left\{ \begin{array}{l}
	\frac{1}{2}(1 \pm \operatorname{sign}(M)) ,\quad \text{if}~|M|\ge 1 \\
	\frac{1}{4}(M \pm 1)^{2}(2 \mp M) ,\quad \text{otherwise}
	\end{array} \right.
	\end{align}

Then simple upwinding is applied to define :math:`\phi_{j+1/2}` :

.. math::
	\begin{align}
	\Phi_{j+1/2} = \left\{ \begin{array}{l}
	\Phi_{j} ,\quad \text{if}~ m_{j+1/2}\ge0 \\
	\Phi_{j+1} ,\quad \text{otherwise}
	\end{array} \right.
	\end{align}

where :math:`\Phi = (\rho a , \rho a u, \rho a h_{t})^{T}` .

Despite successes brought by the scheme, we have also found drawbacks and concluded that further improvement is warranted. In fact, it is possible to derive an improved scheme, termed AUSM+, which contains AUSM as a special case. In this new formulation, the two splittings (respectively, in terms of Mach number and velocity) are unified and the scheme is capable of exactly capturing, not only a stationary contact discontinuity, but also a stationary shock. Furthermore, a set of more general Mach number and pressure splitting functions are used in the AUSM+, resulting in improvement in accuracy, such as removing postshock overshoot and a glitch in the slowly moving shock problem. In what follows, we will present the detailed steps for constructing the AUSM+ and give some interesting heretofore unreported mathematical properties that bear physical consequences. In particular, the positivity-preserving property that allows calculations of strong rarefaction and near vacuum flows.


AUSM+ scheme
------------------


As we saw in the previous section, the AUSM scheme simply consists of two steps: (1) the definition of :math:`\mathscr{M}^{\pm}` and :math:`\mathscr{P}^{\pm}` , followed by (2), a simple upwind selection advection of :math:`\Phi_{j+1/2}` . In essence, we propose to deal with the genuinely nonlinear field associated with the eigenvalues :math:`(u \pm a)` in the first step and the linearly degenerate field associated with the eigenvalue :math:`(u)` in the second step. In other words, the interface (numerical) velocity and pressure will be determined by considering the nonlinear field when we define their explicit functional forms.

The key for unifying the Mach number and velocity formulations is the notion of common speed of sound defined at the cell interface. This notion turns out to be very useful. It allows, in 1D stationary flow, the exact capturing of a contact discontinuity in the AUSMDV and, in addition, the exact capturing of a shock wave in the AUSM+.

Let the common speed of sound be denoted by :math:`a_{j+1/2}` . We now rewrite the numerical convective flux as

.. math::
	\begin{align}
	\mathbf{f}_{j+1/2}^{(c)} = m_{j+1/2}a_{j+1/2}\Phi_{j+1/2}
	,\quad
	\mathbf{\Phi} = (\rho , \rho u , \rho h_{t})^{T}
	\end{align}

We note that the quantity :math:`\mathbf{\Phi}` differs by a factor :math:`a` from that used in the AUSM, and we shall solely use the former hereafter. The scalar quantities in :math:`\Phi_{j+1/2}` again are given by the simple upwinding 

.. math::
	\begin{align}
	\Phi_{j+1/2} = \left\{ \begin{array}{l}
	\Phi_{j} ,\quad \text{if}~ m_{j+1/2}\ge0 \\
	\Phi_{j+1} ,\quad \text{otherwise}
	\end{array} \right.
	\end{align}

with the content of :math:`\mathbf{\Phi}` now given by :math:`\mathbf{\Phi} = (\rho , \rho u , \rho h_{t})^{T}` . What remains is to define :math:`(m_{j+1/2}, p_{j+1/2})` and :math:`a_{j+1/2}` for which we shall develop the detailed framework in the following.

Anticipating contributions from "j" and "j+1" states to the interface Mach number :math:`m_{j+1/2}` , let us write for a 3-point scheme the mapping :math:`m: \mathscr{U} \times \mathscr{U} \to \mathscr{U} \in \mathbb{R}`

.. math::
	\begin{align}
	m_{j + 1/2} = m(M_{j}, M_{j+1})
	\end{align}

Specifically we write :math:`m_{j+1/2}` as a sum of two individual components

.. math::
	\begin{align}
	m_{j+1/2} = \mathscr{M}^{+}(M_{j}) + \mathscr{M}^{-}(M_{j+1})
	\end{align}

where the superscripts "+" and "-" are understood to be associated with the right- and left-running waves.

For 1D conservation laws, the nonlinear characteristic equations are

.. math::
	\begin{align}
	\mathrm{d}p \pm \rho a\mathrm{d}u = 0
	,\quad \text{along}~
	\frac{\mathrm{d}x}{\mathrm{d}t} = u \pm a
	\end{align}

This simply suggests that the velocity and pressure are closely coupled and that the characteristic variables expressed above are propagating locally at the speeds :math:`u \pm a` . For :math:`|M|<1` , the two waves move in opposite directions and interact with each other. Hence the interface velocity and pressure, composed of the interaction of these two waves, are constructed using :math:`(u \pm a)` as basis functions in the polynomial expansion. This suggests the following expansion in terms of :math:`(M \pm 1)` :

.. math::
	\begin{align}
	\mathscr{M}^{\pm} = \frac{1}{2}(M \pm 1) \quad \text{for}~ |M|<1
	\end{align}

This in fact a form of eigenvalue expansion, utilizing just the eigenvalues associated with the genuinely nonlinear fields. Then from :math:`m_{j+1/2} = \mathscr{M}^{+}(M_{j}) + \mathscr{M}^{-}(M_{j+1})` , the interface Mach number is defined, as :math:`|M|<1` , by

.. math::
	\begin{align}
	m_{j+1/2} = \frac{1}{2}[(M+1)_{j} + (M-1)_{j+1}]
	\end{align}

This in fact corresponds to the simple average of :math:`M_{j}` and :math:`M_{j+1}` . As in the Van Leer splitting, the present method makes explicit use of the eigenvalues associated with the nonlinear waves, :math:`M\pm 1` . Using the eigenvalues as a basis for expressing the numerical fluxes is quite common in the upwind formulation.

.. note:: 

	To remove the nondifferentiability of :math:`\mathscr{M}^{\pm} = \frac{1}{2}(M \pm 1)` when the sign of eigenvalues changes, Van Leer chose differentiable second-order polynomials:

	.. math::
		\begin{align}
		\mathscr{M}^{\pm} = \pm \frac{1}{4}(M \pm 1)^{2}
		\end{align}

	It is evident that the above split formula results in an unsymetric distribution of signals propagated by the characteristic speeds :math:`(M \pm 1)` as :math:`M \ne 0` and becomes the simple (symmetric) average as :math:`M` tends to zero, leading to the formula used commonly in the pressure-based codes for incompressble flows.

In the present study, we present a more general footing for designing the split formulas. First we require that the split Mach number and pressure functions satisfy the following properties:

- :math:`\mathscr{M}^{+}(M) + \mathscr{M}^{-}(M) = M` for consistency.
- :math:`\mathscr{M}^{+}(M) \ge 0` and :math:`\mathscr{M}^{-} \le 0` .
- :math:`\mathscr{M}^{\pm}` are monotone increasing functions of :math:`M` .
- :math:`\mathscr{M}^{+} = -\mathscr{M}^{-}(-M)` , i.e., a symmetry property.
- :math:`\mathscr{M}^{+}(M)=M` as :math:`M \ge 1` ; :math:`\mathscr{M}^{-}(M) = M` as :math:`M \le -1` .
- :math:`\mathscr{M}^{\pm}` are continuously differentiable.
  
Consequantly we have the definition of the split Mach number :math:`\mathscr{M}^{\pm}` that satisfy the above six properties:

.. math::
	\begin{align}
	\mathscr{M}^{\pm}(M) = \left\{ \begin{array}{l}
	\frac{1}{2}(M \pm |M|) ,\quad \text{if}~ |M| \ge 1 \\
	\mathscr{M}_{\beta}^{\pm}(M) ,\quad \text{otherwise}
	\end{array} \right.
	\end{align}

with

.. math::
	\begin{align}
	\mathscr{M}_{\beta}^{\pm}(M) = \pm \frac{1}{4}(M \pm 1)^{2} \pm \beta(M^{2} - 1)^{2}
	,\quad -\frac{1}{16} \le \beta \le \frac{1}{2}
	\end{align}

.. note:: :math:`\mathscr{M}_{\beta=0}^{\pm}` correspond to the Van Leer formula and are the lowest degree polynomials differentiable at :math:`M = \pm 1` .


Next, the interface pressure for a 3-point flux scheme is written in general as

.. math::
	\begin{align}
	p_{j+1/2} = p(M_{j}, p_{j}, M_{j+1}, p_{j+1})
	\end{align}

or specifically

.. math::
	\begin{align}
	p_{j+1/2} = \mathscr{P}^{+}(M_{j})p_{j} + \mathscr{P}^{-}(M_{j+1})p_{j+1}
	\end{align}

We require that the split pressures :math:`\mathscr{P}^{\pm}` satisfy the following properties:

- :math:`\mathscr{P}^{+}(M) + \mathscr{P}^{+}(M) = 1` , for consistency.
- :math:`0 \ge \mathscr{P}^{\pm}(M)` , as required by the physical constraint that the pressure be nonnegative.
- :math:`\frac{\partial\mathscr{P}^{+}}{\partial M} \ge 0` and :math:`\frac{\partial\mathscr{P}^{-}}{\partial M} \le 0` .
- :math:`\mathscr{P}^{+}(M) = \mathscr{P}^{-}(-M)` .
- :math:`\mathscr{P}^{+} = 1` as :math:`M > 1` ; :math:`\mathscr{P}^{-} = 1` as :math:`M < -1` .
- :math:`\mathscr{P}^{\pm}(M)` are continuously differentiable.
  
Then we have the definition of the split pressures :math:`\mathscr{P}^{\pm}` that hold the above six properties: 

.. math::
	\begin{align}
	\mathscr{P}^{\pm}(M) = \left\{ \begin{array}{l}
	\frac{1}{2}(1 \pm \operatorname{sign}(M)) ,\quad \text{if}~ |M| \ge 1 \\
	\mathscr{P}_{\alpha}^{\pm}(M) ,\quad \text{otherwise}
	\end{array} \right.
	\end{align}

with

.. math::
	\begin{align}
	\mathscr{P}_{\alpha}^{\pm} = \frac{1}{4}(M \pm 1)^{2}(2 \mp M) \pm \alpha M(M^{2} - 1)^{2}
	,\quad -\frac{3}{4} \le \alpha \le \frac{3}{16}
	\end{align}

Next we consider the criteria for setting the values of the parameters :math:`(\alpha, \beta)` . It is noted that there exists an inflection point in :math:`\mathscr{P}_{\alpha}^{\pm}` at :math:`M=0~~\forall \alpha` . Thus, if we also allow in :math:`\mathscr{M}_{\beta}^{\pm}` the same inflection point at :math:`M=0` , and no other additional inflections in :math:`\mathscr{P}_{\alpha}^{\pm}` for :math:`M \in [-1,1]` , except at the end points :math:`M = \pm 1` , then we get the following results:

.. math::
	\begin{align}
	& \frac{\mathrm{d}^{2}\mathscr{M}_{\beta}^{\pm}}{\mathrm{d}M^{2}}(0) = 0
	\quad\Rightarrow\quad \beta = \frac{1}{8} \\
	& \frac{\mathrm{d}^{2}\mathscr{P}_{\alpha}^{\pm}}{\mathrm{d}M^{2}}(\pm 1) = 0
	\quad\Rightarrow\quad \alpha = \frac{3}{16}
	\end{align}

These values are recommended for use because this pair have given results that are improved over the AUSM and comparable with the Roe splitting. While the above criteria may seem intuitive and there might be a better choice, they have nevetheless performed well on many calculations.


To achieve the unification of the velocity and Mach number :math:`(c=u,M)` splittings, it is obvious that we can no longer use each respective speed of sound, :math:`a_{j}` or :math:`a_{j+1}` , but instead should use a common one. The notion of the common speed of sound turns out to be very useful. It allows, in 1D stationary flow, the exact capturing of the contact discontinuity in AUSMDV and, in addition, the exact capturing of the shock wave in AUSM+. This is also justifiable from the physical point of view. Since the interface flux is viewed as a recipient of contributions from both neighboring cells, it certainly makes sense to use a common speed of sound defined there as a basis for determining the Mach number and subsequent upwinding. Let us now write

.. math::
	\begin{align}
	a_{j+1/2} = a(\mathbf{U}_{j}, \mathbf{U}_{j+1})
	\end{align}

It is this freedom that allows us to make a favorable choice to attain an exact capture of a stationary shock.

.. note:: 

	It is of interest to note that we can write :math:`a_{j+1/2}` for AUSM in the present AUSM+ formulation: 

	.. math::
		\begin{align}
		a_{j+1/2} = \left\{ \begin{array}{l}
		a_{j} ,\quad \text{if}~ m_{j+1/2} \ge 0 \\
		a_{j+1} ,\quad \text{otherwise}
		\end{array} \right.
		\end{align}

	Thus, AUSM belongs to a special case of AUSM+.

Consider a 1D stationary shock problem: 

.. math::
	\begin{align}
	\mathbf{U} = \left\{ \begin{array}{l}
	\mathbf{U}_{L} ,\quad x \le x_{j} \\
	\mathbf{U}_{R} ,\quad x>x_{j}
	\end{array} \right.
	\end{align}

where :math:`\mathbf{U}_{L}` and :math:`\mathbf{U}_{R}` are related via the normal shock relation and :math:`u_{j}>a_{j}` . Let :math:`a_{j}^{*}` be the critical speed of sound evaluated at :math:`U_{j}(=\mathbf{U}_{L})` , then the speed of sound used in the AUSM+

.. math::
	\begin{align}
	a_{j+1/2} = a_{j}^{*2}/u_{j}
	\end{align}

allows an exact resolution of the stationary shock for any :math:`(\alpha,\beta)` . The critical speed of sound :math:`a^{*}` is calculated via the isoenergetic condition

.. math::
	\begin{align}
	h_{t} = \frac{a^{2}}{\gamma - 1} + \frac{1}{2}u^{2} = \frac{(\gamma+1)a^{*2}}{2(\gamma-1)}
	\quad \text{for ideal gas}
	\end{align}

It is well known that the Mach numbers based on the speeds of sound :math:`a` and :math:`a^{*}` indicate equally whether the flow lies at the sonic or the supersonic or the subsonic regime. Namely, let :math:`M=u/a` and :math:`M^{*}=u/a^{*}` ; then

.. math::
	\begin{align}
	M=1 \Leftrightarrow M^{*}=1
	,\quad
	M>1 \Leftrightarrow M^{*}>1
	,\quad
	M<1 \Leftrightarrow M^{*}<1
	\end{align}

Hence, the critical speed of sound defined above can be used as a reference to define the Mach number to be used as the variable for upwinding.

Note that the formula :math:`a_{j+1/2} = a_{j}^{*2}/u_{j}` is valid for :math:`u_{L} > a_{L}^{*}` . We now must extend it to other conditions such as subsonic speed or :math:`u_{L} < 0` ; we suggest the following formula for :math:`M \in \mathbb{R}` :

.. math::
	\begin{align}
	a_{j+1/2} = \min(\tilde{a}_{L}, \tilde{a}_{R})
	,\quad
	\tilde{a}_{L} = \frac{a^{*2}}{\max(a^{*}, u_{L})}
	,\quad
	\tilde{a}_{L} = \frac{a^{*2}}{\max(a^{*}, -u_{R})}
	\end{align}

That is, :math:`\tilde{a}` is taken to be :math:`a^{*}` when :math:`|u| < a^{*}` .


.. note:: 

	Other formulas may be used for the reason of simplicity, but at the expense of losing the above property. Some obvious choices are

	.. math::
		\begin{align}
		a_{j+1/2} = \frac{1}{2}(a_{j} + a_{j+1})
		,\quad
		a_{j+1/2} = \sqrt{a_{j}a_{j+1}}
		\end{align}


In summary, the above splittings for both the advective and pressure terms completely define the Euler numerical flux. The AUSM+ algorithm can be simply summarized as follows: Let :math:`j` and :math:`j+1` states be given, then

1. :math:`M_{j} = u_{j}/a_{j+1/2}` and :math:`M_{j+1}=u_{j+1}/a_{j+1/2}` via :math:`a_{j+1/2} = \min(\tilde{a}_{L}, \tilde{a}_{R})` ;
2. :math:`m_{j+1/2}=\mathscr{M}^{+}(M_{j}) + \mathscr{M}^{-1}(M_{j+1})` and :math:`m_{j+1/2}^{\pm} = \frac{1}{2}(m_{j+1/2} \pm |m_{j+1/2}|)` , :math:`p_{j+1/2} = \mathscr{P}^{+}(M_{j})p_{j} + \mathscr{P}^{-}(M_{j+1})p_{j+1}` ;
3. :math:`\mathbf{f}_{j+1/2} = a_{j+1/2} \left\{  m_{j+1/2}^{+}\begin{pmatrix} \rho \\ \rho u \\ \rho h_{t} \end{pmatrix}_{j} + m_{j+1/2}^{-} \begin{pmatrix} \rho \\ \rho u \\ \rho h_{t} \end{pmatrix}_{j+1} \right\} + \begin{pmatrix} 0 \\ p_{j+1/2} \\ 0 \end{pmatrix}` .
   

The numerical flux defined above can be rewritten as

.. math::
	\begin{align}
	\mathbf{f}_{j+1/2} = a_{j+1/2}\Big[\frac{1}{2}m_{j+1/2}(\mathbf{\Phi}_{j} + \mathbf{\Phi}_{j+1}) - \frac{1}{2}|m_{j+1/2}| (\mathbf{\Phi}_{j+1} - \mathbf{\Phi}_{j}) \Big] + \mathbf{p}_{j+1/2}
	\end{align}



AUSM+up scheme
-----------------

`A sequel to AUSM, Part II: AUSM+up for all speeds <https://www.sciencedirect.com/science/article/pii/S0021999105004274>`_ 

First, one defines

.. math::
	\begin{align}
	M_{L/R} = \frac{u_{L/R}}{a_{1/2}}
	\end{align}

where :math:`a_{1/2}` is defined either by :math:`a_{j+1/2} = \min(\tilde{a}_{L}, \tilde{a}_{R})` or a simple average of :math:`a_{L}` and :math:`a_{R}` . For multi-dimensional flows, :math:`u = \mathbf{U} \cdot \mathbf{n}` , with :math:`\mathbf{n}` being the unit normal vector of the cell face under consideration.

.. math::
	\begin{align}
	\bar{M}^{2} = \frac{u_{L}^{2} + u_{R}^{2}}{2a_{1/2}^{2}}
	\end{align}

.. math::
	\begin{align}
	M_{0}^{2} = \min\Big( 1, \max(\bar{M}^{2}, M_{\infty}^{2}) \Big) \in [0,1]
	\end{align}

.. math::
	\begin{align}
	f_{a}(M_{0}) = M_{0}(2 - M_{0}) \in [0,1]
	\end{align}

.. math::
	\begin{align}
	M_{1/2} = \mathscr{M}^{+}_{(4)}(M_{L}) + \mathscr{M}_{(4)}^{-}(M_{R})
	- \frac{K_{p}}{f_{a}}\max(1 - \sigma\bar{M}^{2}, 0) \frac{p_{R} - p_{L}}{\rho_{1/2}a_{1/2}^{2}}
	,\quad
	\rho_{1/2} = (\rho_{L} + \rho_{R})/2
	\end{align}

where :math:`0 \le K_{p} \le 1` and :math:`\sigma \le 1` . Then, the mass and pressure fluxes are readily defined

.. math::
	\begin{align}
	\dot{m}_{1/2} = a_{1/2}M_{1/2} \left\{\begin{array}{l}
	\rho_{L} \quad \text{if}~ M_{1/2}>0 \\
	\rho_{R} \quad \text{otherwise}
	\end{array}\right.
	\end{align}

and

.. math::
	\begin{align}
	p_{1/2} = \mathscr{P}_{(5)}^{+}(M_{L})p_{L}
	+ \mathscr{P}_{(5)}^{-}(M_{R})\rho_{R}
	- K_{u}\mathscr{P}_{(5)}^{+}\mathscr{P}_{(5)}^{-}(\rho_{L} + \rho_{R})(f_{a}a_{1/2})(u_{R} - u_{L})
	\end{align}

using the parameters

.. math::
	\begin{align}
	\alpha = \frac{3}{16}(-4 + 5f_{a}^{2}) \in [-\frac{3}{4}, \frac{3}{16}]
	,\quad
	\beta = \frac{1}{8}
	\end{align}

with :math:`0 \le K_{u} \le 1` . Finally, the whole flux is

.. math::
	\begin{align}
	\mathbf{f}_{1/2} = \dot{m}_{1/2}\left\{\begin{array}{l}
	\vec{\psi}_{L} \quad \text{if}~\dot{m}_{1/2}>0 \\
	\vec{\psi}_{R} \quad \text{otherwise}
	\end{array}\right.
	+ \mathbf{p}_{1/2}
	\end{align}

It is reminded that only in the pressure flux is the numerical speed of sound used, which is scaled by the factor :math:`f_{a}` , but nowhere else.

This scheme is still designated as AUSM+up since it incorporates both the velocity and pressure terms into AUSM+ scheme and the basic scheme is only a special version obtained by simply setting :math:`f_{a} = 1` .

As noted previously, the basic scheme should be invoked when we consider the shock-tube type of problems in which the leading pressure term is not spatially uniform, even though the fluid velocity may be small.

.. note:: 在原作者的论文当中，推荐使用的参数设置为 :math:`K_{p}=0.25, K_{u}=0.75, \sigma=1.0` .






Higher-order extension
-------------------------

The MUSCL strategy for preserving monotonicity is adopoted here, via the use of a nonlinear limiter sensing the ratio of neighboring first-differences of appropriate variables. We choose to extrapolate the primitive variables :math:`\mathbf{W}` , according to the formulas

.. math::
	\begin{align}
	& \mathbf{W}_{L} := \mathbf{W}_{j} + \frac{1}{2}\psi(r_{j})(\mathbf{W}_{j} - \mathbf{W}_{j-1}) \\
	& \mathbf{W}_{R} := \mathbf{W}_{j+1} - \frac{1}{2}\psi(\frac{1}{r_{j+1}})(\mathbf{W}_{j+2} - \mathbf{W}_{j+1})
	\end{align}

where the subscripts "L" and "R" represent the states that take place of "j" and "j+1" in the formulas derived before for the first-order scheme. To take grid nonuniformity into account, grid-size weighting can also be formulated into it if desired. The function :math:`\psi` is a limiter whose argument is defined as

.. math::
	\begin{align}
	r_{j} = \frac{\Delta_{j+1/2}w_{i}}{\Delta_{j-1/2}w_{i}}
	,\quad
	\mathbf{W} = (w_{1}, w_{2}, w_{3})^{T}
	,\quad
	\Delta_{j+1/2}() = ()_{j+1} - ()_{j}
	\end{align}

We stress that the set of primitive variables :math:`\mathbf{W} = (\rho, u, h_{t})^{T}` is employed and the minmod function is normally chosen for its robustness in our calculations. Other forms for the limiter function have been proposed and it is generally known that the accuracy of solution around discontinuities (shock or contact) is influenced more or less by the choice of the limiter. The dependence of the solution on the choice of the variables chosen for extrapolation also occurs.














High-Order and TVD Methods for Scalar Equations
=================================================

It is well-known that high-order linear (constant coefficients) schemes produce unphysical oscillations in the vicinity of large gradients. On the other hand, the class of monotone methods do not produce unphysical oscillations. However, monotone methods are at most first order accurate and are therefore of limited use. One way of resolving the contradiction between linear schemes of high-order of accuracy and absence of spurious oscillations is by constructing non-linear methods. 

Total Variation Diminishing Methods, or TVD Methods for short, are a prominent class of non-linear methods. The theoretical bases of TVD methods are sound for scalar one-dimensional problems only. In practical, non-linear, multidimensional problems, the accumulated experience of numerous applications has demonstrated that the one-dimensional scalar theory serves well as a guideline or extending the ideas, on a more or less empirical basis. TVD schemes have their roots on the fundamental question of convergence of schemes of non-linear problems. Total-Variation Stable schemes have been proved to be convergent. TVD methods are a class of Total-Variation Stable schemes and they are based on the requirement that the total variation of the numerical solution be non-increasing in time. As a matter of fact the exact solution of a scalar conservation law does possess this property and therefore TVD numerical methods just mimic a property of the exact solution. Apart from being a class of methods proved to be convergent, for scalar problems, the TVD concept is also extremely useful in designing schemes.

TVD schemes are intimately linked to traditional Artificial Viscosity Methods. Both TVD and Artificial Viscosity Methods attempt to circumvent Godunov's theorem by constructing schemes of accuracy :math:`p>1` , such that spurious oscillations near high gradients are eliminated or controlled. Both classes of schemes resort effectively to the same mechanism, namely the addition of artificial viscosity. Artifical Viscosity Methods do this explicitly, by adding extra terms to the PDEs. In TVD methods, on the other hand, the artificial viscosity is inherent in the scheme itself, but the way this is activated is rather sophisticated.

The TVD approach has managed to circumvent Godunov's theorem by resorting to non-linear schemes, even when applied to linear problems. The inherent artificial viscosity of the schemes is controlled in a very precise manner so that spurious oscillations are eliminated and high-order accuracy in smooth parts of the solution is retained. Historically, TVD methods have almost exclusively been associated with high-order upwind methods. Over the last few years, however, the TVD concept has been extended to centred schemes, as distinct from upwind schemes. This development has effectively provided Artificial Viscosity Methods with a more rational basis and has tended to unify the developments on numerical methods for conservation laws.


Basic Properties of Selected Schemes
---------------------------------------

The purpose of this section is to review a selected number of schemes and discuss some of their main properties. In the main, the discussion is centred on the linear advection equation

.. math::
	\begin{align}
	u_{t} + f(u)_{x} = 0 ,\quad f(u) = au
	\end{align}

where :math:`u=u(x,t)` and :math:`a` is a constant wave propagation speed.


Selected Schemes
^^^^^^^^^^^^^^^^^^^


Accuracy
^^^^^^^^^^^


Stability
^^^^^^^^^^^^


WAF-Type High Order Schemes
------------------------------

The Weighted Average Flux (or WAF for short) approach is a generalisation of the Lax-Wendroff and the Godunov first-order upwind schemes to non-linear systems of conservation laws. It is also a generalisation of the Warming-Beam method. The WAF approach has its origins in the random flux scheme, which is second-order accurate in space and time in a statistical sense. The WAF approach is deterministic and leads to fully discrete, explicit second order accurate schemes.

In this section we present the approach as applied to a general scalar conservation law

.. math::
	\begin{align}
	u_{t} + f(u)_{x} = 0
	\end{align}

where :math:`u = u(x,t)` and :math:`f(u)` is a convex flux function. The scheme is based on the explicit conservative formula

.. math::
	\begin{align}
	u_{i}^{n+1} = u_{i}^{n} + \frac{\Delta t}{\Delta x}[f_{i-\frac{1}{2}} - f_{i+\frac{1}{2}}]
	\end{align}

Full details for the linear advection case will be developed.

The Basic WAF Scheme
^^^^^^^^^^^^^^^^^^^^^^^

The WAF method assumes piece-wise constant data :math:`\{ u_{i}^{n} \}` , as in the Godunov first-order upwind method; that is, :math:`u_{i}^{n}` is an integral average of the solution :math:`u(x,t^{n})` within a cell :math:`I_{i}=[x_{i-\frac{1}{2}},x_{i+\frac{1}{2}}]` at time :math:`t=t^{n}` namely

.. math::
	\begin{align}
	u_{i}^{n} = \frac{1}{\Delta x}\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}u(x,t^{n})\mathrm{d}x
	\end{align}





High-Order and TVD Schemes for Non-Linear Systems
===================================================




Splitting Schemes for PDEs with Source Terms
===============================================



Methods for Multi-Dimensional PDEs
=====================================

This chapter concerned with numerical methods for solving non-linear systems of hyperbolic conservation laws in multidimensions. For Cartesian geometries one may write the equations of our interest here as

.. math::
	\begin{align}
	\mathbf{U}_{t} + \mathbf{F}(\mathbf{U})_{x} + \mathbf{G}(\mathbf{U})_{y} + \mathbf{H}(\mathbf{U})_{z} = \mathbf{0}
	\end{align}

where :math:`t` denotes time or a time-like variable and :math:`x,y,z` are Cartesian coordinate directions. :math:`\mathbf{U}` is the vector of conserved variables and :math:`\mathbf{F}(\mathbf{U})` , :math:`\mathbf{G}(\mathbf{U})` , :math:`\mathbf{H}(\mathbf{U})` are vectors of fluxes in the :math:`x,y,z` directions respectively. A prominent example are the time-dependent three dimensional Euler equations. Other examples are the time-dependent two dimensional shallow water equations and the artificial compressibility equations.

We shall present two ways of solving the system numerically. The first approach is dimensional splitting or method of fractional steps. This method is also known as time-operator splitting. In this approach one applies one-dimensional methods in each coordinate direction. A simple extension of the one-dimensional methods is required to solve the one-dimensional conservation laws augmented by the extra components of velocity present in multidimensional problems. Any of the methods studied before can be applied to solve the system, in conjunction with dimensional splitting. The other approach studied here is the finite volume method, whereby in updating the solution within some control volume one includes all the intercell flux contrbutions in a single step. Only some of the one-dimensional approaches discussed before can be extended to multidimensional problems following the (unsplit) finite volume approach. There is a close relationship between dimensional splitting and the finite volume method. If the schemes used in the dimensional splitting approach are of the finite-volume type in one space dimension, then the resulting splitting schemes may be viewed as being predictor-corrector type finite volume schemes in multidimensions. Both the dimensional splitting and the finite volume approaches may be extended to deal with non-Cartesian geometries.

Dimensional Splitting
------------------------




Lower-Upper Symmetric Gauss-Seidel Implicit Scheme (LU-SGS)
===============================================================

`Implementation of density-based implicit LU-SGS solver in the framework of OpenFOAM <https://www.sciencedirect.com/science/article/pii/S0965997815001520>`_ 

Matrix-free LU-SGS implicit scheme is widely used because of its low numerical complexity and modest memory requirements.

Governing equations in integral form is shown as follows:

.. math::
	\begin{align}
	\int_{\Omega}\frac{\partial\mathbf{W}}{\partial t}\mathrm{d}\Omega
	+ \oint_{\partial \Omega}(\mathbf{F}_{c} - \mathbf{F}_{v})~\mathrm{d}S
	= 0
	\end{align}

where :math:`\mathbf{W}` is the vector of the conservative variables, :math:`\mathbf{F}_{c}` and :math:`\mathbf{F}_{v}` are the vectors of the convective fluxes and the viscous fluxes, respectively, and :math:`\Omega, \partial\Omega` and :math:`\mathrm{d}S` denote the control volume, the closed surface related to the particular control volume :math:`\Omega` and a surface element.

By using the finite volume method for each grid cell :math:`i` , the temporal and spatial discretization of the governing equations can be expressed as

.. math::
	\begin{align}
	\Big[ \frac{\Omega_{i}}{\Delta t}I + \frac{\partial \mathbf{R}_{i}^{n}}{\partial \mathbf{W}_{i}} \Big] \Delta \mathbf{W}_{i}^{n} = -\mathbf{R}_{i}^{n}
	\end{align}

where :math:`\mathbf{R}_{i}^{n}` is the so-called residual (the complete spatial discretization term), the term :math:`\frac{\partial \mathbf{R}_{i}^{n}}{\partial \mathbf{W}_{i}}` is referred to as the flux Jacobian, :math:`I` is identity matrix, and the superscript :math:`n` denotes time level at the current time :math:`t` , with

.. math::
	\begin{align}
	\Delta\mathbf{W}_{i}^{n} = \mathbf{W}_{i}^{n+1} - \mathbf{W}_{i}^{n}
	\end{align}

being the solution correction. In this paper, we only consider the contribution of the convective flux Jacobian to the term :math:`\frac{\partial \mathbf{R}_{i}^{n}}{\partial \mathbf{W}_{i}}` , i.e.

.. math::
	\begin{align}
	\frac{\partial \mathbf{R}_{i}^{n}}{\partial \mathbf{W}_{i}} \Delta\mathbf{W}_{i}^{n}
	= \frac{\partial\Big( \sum\limits_{j \in N(i)}\mathbf{F}_{c,ij}^{n}S_{ij} \Big)}{\partial \mathbf{W}_{ij}}\Delta\mathbf{W}_{ij}^{n}
	= \sum_{j \in N(i)} \frac{\partial \mathbf{F}_{c,ij}^{n}}{\partial \mathbf{W}_{ij}} S_{ij} \Delta\mathbf{W}_{ij}^{n}
	= \sum_{j \in N(i)} \mathbf{A}_{c,ij} S_{ij} \Delta\mathbf{W}_{ij}^{n}
	\end{align}

.. math::
	\begin{align}
	\frac{\partial\mathbf{R}_{i}^{n}}{\partial\mathbf{W}_{i}}\Delta\mathbf{W}_{i}^{n}
	= \frac{\partial \Big( \sum\limits_{j\in N(i)}\mathbf{F}_{c,ij}^{n}S_{ij} \Big)}{\partial\mathbf{W}}\Delta\mathbf{W}_{ij}^{n}
	- \frac{\partial \Big( \sum\limits_{j\in N(i)}\mathbf{F}_{v,ij}^{n}S_{ij} \Big)}{\partial \mathbf{W}}\Delta\mathbf{W}_{ij}^{n}
	= \sum_{j \in N(i)} \bigg( \frac{\partial \mathbf{F}_{c,ij}^{n}}{\partial \mathbf{W}} S_{ij}\Delta\mathbf{W}_{ij}^{n} \bigg)
	- \sum_{j \in N(i)} \bigg( \frac{\partial\mathbf{F}_{v,ij}^{n}}{\partial \mathbf{W}}S_{ij}\Delta\mathbf{W}_{ij}^{n} \bigg)
	\end{align}

where :math:`\mathbf{A}_{c}` is the convective Jacobian matrix, :math:`N(i)` is the set of cells which are adjacent to cell :math:`i` . Substituting it for the convective flux Jacobian into discretization equations, the following form is obtained:

.. math::
	\begin{align}
	\frac{\Omega_{i}}{\Delta t_{i}}\Delta\mathbf{W}_{i}
	+ \sum_{j \in N(i)}\mathbf{A}_{c,ij} \Delta \mathbf{W}_{ij}^{n} S_{ij}
	= -\mathbf{R}_{i}^{n}
	\end{align}

Then applying the Steger-Warming splitting scheme to discretize the term related to the convective fluex above

.. math::
	\begin{align}
	\frac{\partial \mathbf{F}_{c,ij}^{n}}{\partial \mathbf{W}} S_{ij}\Delta\mathbf{W}_{ij}^{n}
	= (\mathbf{A}_{c,ij}^{+}\Delta\mathbf{W}_{i}^{n} + \mathbf{A}_{c,ij}^{-}\Delta\mathbf{W}_{j}^{n})S_{ij}
	\end{align}

with :math:`A_{c}^{\pm}` denoting the positive/negative Steger-Warming flux-splitting Jacobian matrix. 

Applying TSL approximation the term related to the viscous fluxes becomes

.. math::
	\begin{align}
	\frac{\partial\mathbf{F}_{v,ij}^{n}}{\partial \mathbf{W}}S_{ij}\Delta\mathbf{W}_{ij}^{n}
	\approx \Big( \mathbf{A}_{v,ij}\Delta\mathbf{W}_{j}^{n} - \mathbf{A}_{v,ij}\Delta\mathbf{W}_{i}^{n} \Big) S_{ij}
	\end{align}

Finally, the following discretization form is obtained:

.. math::
	\begin{align}
	\frac{\Omega_{i}}{\Delta t_{i}}\Delta\mathbf{W}_{i}^{n}
	+ \sum_{j \in N(i)} \Big(
	\mathbf{A}_{c,i}^{+}\Delta \mathbf{W}_{i}^{n} + \mathbf{A}_{c,j}^{-}\Delta \mathbf{W}_{j}^{n}
	+ \mathbf{A}_{v,ij}\Delta\mathbf{W}_{i}^{n} - \mathbf{A}_{v,ij}\Delta\mathbf{W}_{j}^{n}
	\Big)S_{ij}
	= -\mathbf{R}_{i}^{n}
	\end{align}

According to the original theory of LU-SGS scheme, the implicit operator should be divided into the diagonal matrix :math:`D` , the lower-diagonal matrix :math:`L` and the upper-diagonal matrix :math:`U` . For this purpose, the above equation should be deduced further as follows:

.. math::
	\begin{align}
	\Big[\frac{\Omega_{i}}{\Delta t_{i}}I
	+ \sum_{j \in N(i)}(\mathbf{A}_{c,i}^{+}S_{ij} + \mathbf{A}_{v,ij}S_{ij})
	\Big]\Delta W_{i}^{n}
	+ \sum_{j \in L(i)}(\mathbf{A}_{c,j}^{-}S_{ij} - \mathbf{A}_{v,ij}S_{ij})\Delta\mathbf{W}_{j}^{n}
	+ \sum_{j \in U(i)}(\mathbf{A}_{c,j}^{-}S_{ij} - \mathbf{A}_{v,ij}S_{ij})\Delta\mathbf{W}_{j}^{n}
	= -\mathbf{R}_{i}^{n}
	\end{align}

The split convective flux Jacobian could be evaluated as follows:

.. math::
	\begin{align}
	A^{\pm} \Delta  S_{ij} = \frac{1}{2}(A_{c}S_{ij} \pm \Lambda_{c}I)
	,\quad
	\Lambda_{c} = (|V| + c)S_{ij}
	\end{align}

where the contravariant velocity :math:`V = \mathbf{U}\cdot\mathbf{n}_{ij} = n_{x}u + n_{y}v + n_{z}w` , with the unit normal vector :math:`\mathbf{n}_{ij} = n_{x}\mathbf{i} + n_{y}\mathbf{j} + n_{z}\mathbf{k}` corresponding to the face area vector :math:`\mathbf{S}_{ij}` , and :math:`\Lambda_{c}` represents the spectral radius of the convective flux Jacobian :math:`A_{c}` .


.. note:: 

	将 :math:`A_{c}^{\pm}S_{ij}` 具体展开的形式如下所示：

	.. math::
		\begin{align}
		A_{c}^{\pm}S_{ij} = 
		\begin{bmatrix}
		\frac{1}{2}(-V_{t}S_{ij} \pm \Lambda_{c}) &
		\frac{1}{2}n_{x}S_{ij} &
		\frac{1}{2}n_{y}S_{ij} &
		\frac{1}{2}n_{z}S_{ij} &
		0 \\
		\frac{1}{2}(n_{x}S_{ij}\phi - uVS_{ij}) &
		\frac{1}{2}(VS_{ij} - V_{t}S_{ij} - a_{3}n_{x}u S_{ij} \pm \Lambda_{c}) &
		\frac{1}{2}(n_{y}S_{ij}u - a_{2}n_{x}S_{ij}v) &
		\frac{1}{2}(n_{z}S_{ij}u - a_{2}n_{x}S_{ij}w) &
		\frac{1}{2}a_{2}n_{x}S_{ij} \\
		\frac{1}{2}(n_{y}S_{ij}\phi - vVS_{ij}) &
		\frac{1}{2}(n_{x}S_{ij}v - a_{2}n_{y}S_{ij}u) &
		\frac{1}{2}(VS_{ij} - V_{t}S_{ij} - a_{3}n_{y}S_{ij}v \pm \Lambda_{c}) &
		\frac{1}{2}(n_{z}S_{ij}v - a_{2}n_{y}S_{ij}w) &
		\frac{1}{2}a_{2}n_{y}S_{ij} \\
		\frac{1}{2}(n_{z}S_{ij}\phi - wVS_{ij}) &
		\frac{1}{2}(n_{x}S_{ij}w - a_{2}n_{z}S_{ij}u) &
		\frac{1}{2}(n_{y}S_{ij}w - a_{2}n_{z}S_{ij}v) &
		\frac{1}{2}(VS_{ij} - V_{t}S_{ij} - a_{3}n_{z}S_{ij}w \pm \Lambda_{c}) &
		\frac{1}{2}a_{2}n_{z}S_{ij} \\
		\frac{1}{2}V(\phi - a_{1})S_{ij} &
		\frac{1}{2}(n_{x}S_{ij}a_{1} - a_{2}uVS_{ij}) &
		\frac{1}{2}(n_{y}S_{ij}a_{1} - a_{2}vVS_{ij}) &
		\frac{1}{2}(n_{z}S_{ij}a_{1} - a_{2}wVS_{ij}) &
		\frac{1}{2}(\gamma VS_{ij} - V_{t}S_{ij} \pm \Lambda_{c})
		\end{bmatrix}
		\end{align}

	可以看到，对于同一个控制体积，当围绕其表面计算convective flux Jacobian并求和时，非对角元素会因为面矢量的方向原因而相互抵消，因此可以得到下面diagonal matrix的化简表达式。


Then substituting it into the deduced equations, the diagonal matrix :math:`D` could be written as

.. math::
	\begin{align}
	D_{i} = \frac{\Omega_{i}}{\Delta t_{i}}I 
	+ \sum_{j\in N(i)}\frac{\omega}{2}\Lambda_{c,ij}
	+ \sum_{j \in N(i)}\mathbf{A}_{v,ij}S_{ij}
	\end{align}

Meanwhile, :math:`L_{i} = \sum_{j\in L(i)}(A_{c,j}^{-}S_{ij})` , with :math:`L(i)` being the set of owner cells which are adjacent to the discrete element :math:`i` cell, i.e. :math:`j \in L(i)` ; :math:`U_{i} = \sum_{j \in U(i)}(A_{c,j}^{-}S_{ij})` , with :math:`U(i)` being the set of neighbor cells which are adjacent to the discrete element :math:`i` cell, i.e. :math:`j \in U(i)` . The viscous flux Jacobian can be approximated by its spectral radius, therefore the diagonal operator becomes

.. math::
	\begin{align}
	D_{i} = \frac{\Omega_{i}}{\Delta t_{i}}I
	+ \sum_{j\in N(i)}\frac{\omega}{2}\Lambda_{c,ij}
	+ \sum_{j \in N(i)}\Lambda_{v,ij}
	\end{align}

where

.. math::
	\begin{align}
	\Lambda_{v,ij} = \frac{S_{ij}^{2}}{\Omega_{i}}
	\max\Big(\frac{4}{3\rho_{ij}}, \frac{\gamma_{ij}}{\rho_{ij}}\Big)
	\Big(\frac{\mu_{L}}{Pr_{L}} + \frac{\mu_{T}}{Pr_{T}}\Big)_{ij}
	\end{align}

In the above equaiton, :math:`\mu_{L}` denotes the laminar and :math:`\mu_{T}` the turbulent dynamic viscosity coefficient, respectively. Furthermore, :math:`Pr_{L}` and :math:`Pr_{T}` are the laminar and the turbulent Prandtl numbers. The values of the flow variables at the faces of the control volume are obtained by arithmetic averaging.

.. note:: 在进行以上Jacobian matrix计算的时候，单位面矢量的方向都是根据网格 :math:`i` 的方向来确定的，也即需要保证面矢量方向都是从网格 :math:`i` 指向相邻网格 :math:`j` 的，以满足Gauss theorem的要求。


Finally the deduced equations could be transformed into

.. math::
	\begin{align}
	(\mathbf{D} + \mathbf{L})\mathbf{D}^{-1}(\mathbf{D} + \mathbf{U})\Delta \mathbf{W}^{n} = -\mathbf{R}^{n}
	\end{align}

.. note:: 

	精确的方程组应该写成

	.. math::
		\begin{align}
		(\mathbf{L} + \mathbf{D} + \mathbf{U})\Delta\mathbf{W} = -\mathbf{R}
		\end{align}

	.. math::
		\begin{align}
		(\mathbf{L} + \mathbf{D})\mathbf{D}^{-1}(\mathbf{D} + \mathbf{U})\Delta\mathbf{W} = -\mathbf{R} + \mathbf{L}\mathbf{D}^{-1}\mathbf{U}\Delta\mathbf{W}
		\end{align}

	而在LU-SGS中， :math:`\mathbf{L}\mathbf{D}^{-1}\mathbf{U}\Delta\mathbf{W}` 被忽略了。

The solving process is divided into two steps: forward sweep and backward sweep, where forward and backward sweep processes are directly solving the following two equtions, respectively, 

.. math::
	\begin{align}
	& (\mathbf{D} + \mathbf{L})\Delta \mathbf{W}^{*} = - \mathbf{R}^{n} \\
	& (\mathbf{D} + \mathbf{U})\Delta \mathbf{W}^{n} = \mathbf{D}\Delta \mathbf{W}^{*}
	\end{align}

.. note:: 

	与Gauss-Seidel迭代进行对比，可以看到LU-SGS等价于一次初始迭代量取零的Symmetric Gauss-Seidel迭代。因此，使用LU-SGS的主要优势是不需要组装矩阵，节省内存消耗。参考讨论 `LU-SGS求解器 <https://www.cfd-china.com/topic/815/lu-sgs求解器/6>`_ 



Dual time-stepping approach is very often employed for the unsteady flow. In this approach, pseudo-time term, i.e. :math:`\Omega_{i}\frac{\Delta W_{i}^{*}}{\Delta \tau}` , should be added in as follows: 

.. math::
	\begin{align}
	\Omega_{i}\frac{\Delta W_{i}^{l}}{\Delta \tau}
	+ \Omega_{i}\frac{3\Delta W_{i}^{l} + 3W_{i}^{l} - 4W_{i}^{n} + W_{i}^{n-1}}{2\Delta t}
	+ \sum_{j \in N(i)}(F_{c,ij}^{l+1} - F_{v,ij}^{l})S_{ij}
	= 0
	\end{align}

with

.. math::
	\begin{align}
	\Delta W_{i}^{l} = W_{i}^{l+1} - W_{i}^{l}
	\end{align}

where superscript :math:`l` denotes the current pseudo-time level. Similar as the discretization for the physical time implicit scheme, the following equation is obtained: 

.. math::
	\begin{align}
	\bigg[ \Omega_{i}\Big( \frac{1}{\Delta\tau} + \frac{3}{2\Delta t} \Big) + \frac{\partial R_{i}^{l}}{\partial W_{i}^{l}} \bigg] \Delta W_{i}^{l} = -(R_{i}^{*})^{l}
	\end{align}

where the residual term for dual time-stepping approach is

.. math::
	\begin{align}
	(R_{i}^{*})^{l} = R_{i}^{l} + \Big( \Omega_{i}\frac{3W_{i}^{l} - 4W_{i}^{n} + W_{i}^{n-1}}{2\Delta t} \Big)
	\end{align}

The discretization procedure to solve the above eqution is similar as that shown for the physical time implicit scheme.




Temporal Discretization
==========================

The application of the method of lines, that is, the discretization of the governing equations separately for spatial and temporal, leads, written down for each control volume, to a system of coupled ordinary differential equations in time

.. math::
	\begin{align}
	\frac{\mathrm{d}(\Omega\bar{M}\mathbf{W})_{i}}{\mathrm{d}t} = -\mathbf{R}_{i}
	\end{align}

In this eqution, :math:`\Omega` represents the volume, :math:`\mathbf{R}` the residual, :math:`\bar{M}` the mass matrix, and the index :math:`i` denotes the particular control volume. The system has to integrated in time--either to obtain a steady-state solution ( :math:`\mathbf{R}_{i}=0` ), or to reproduce the time history of an unsteady flow.

We saw that the various explicit and implicit methods can be derived from a basic non-linear scheme. It reads for a stationary grid

.. math::
	\begin{align}
	\frac{(\Omega \bar{M})_{i}}{\Delta t_{i}}\Delta\mathbf{W}_{i}^{n}
	= -\frac{\beta}{1 + \omega}\mathbf{R}_{i}^{n+1}
	- \frac{1 - \beta}{1 + \omega}\mathbf{R}_{i}^{n}
	+ \frac{\omega}{1 + \omega}\frac{(\Omega \bar{M})_{i}}{\Delta t_{i}}\Delta\mathbf{W}_{i}^{n-1}
	\end{align}

where

.. math::
	\begin{align}
	\Delta\mathbf{W}_{i}^{n} = \mathbf{W}_{i}^{n+1} - \mathbf{W}_{i}^{n}
	\end{align}

stands for the update (correction) of the solution. The superscripts :math:`n` and :math:`(n+1)` denote the time levels. Hence, :math:`\mathbf{W}^{n}` means the flow solution at the present time :math:`t` . Consequently, :math:`\mathbf{W}^{n+1}` represents the solution at the time :math:`(t + \Delta t)` . The parameters :math:`\beta` and :math:`\omega` determine the discretization type (explicit or implicit) and also the temporal accuracy.


Explicit Time-Stepping Schemes
--------------------------------

An explicit scheme starts from a known solution :math:`\mathbf{W}^{n}` and employs the corresponding residual :math:`\mathbf{R}^{n}` in order to obtain a new solution at time :math:`(t + \Delta t)` . In other words, the new solution :math:`\mathbf{W}^{n+1}` depends solely on values already known. This fact makes the explicit schemes very simple and easy to implement.

A basic explicit scheme can be derived from the basic non-linear scheme by setting :math:`\beta=0` and :math:`\omega=0` . This results in

.. math::
	\begin{align}
	\bar{M}_{i}\Delta\mathbf{W}_{i}^{n} = -\frac{\Delta t_{i}}{\Omega_{i}}\mathbf{R}_{i}^{n}
	\end{align}

which is termed the forward Euler approximation. The mass matrix :math:`\bar{M}` can be lumped (i.e., substituted by the identity matrix) for steady problems or for the cell-centered discretization.

Multistage Schemes (Runge-Kutta)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The concept of explicit multistage schemes was first presented by Jameson et al. The multistage scheme advances the solution in a number of steps (stages) which can be viewed as a sequence of updates according to basic explicit scheme. Applied to the discretized governing equations, where the mass matrix was lumped, an m-stage scheme reads

.. math::
	\begin{align}
	& \mathbf{W}_{i}^{(0)} = \mathbf{W}_{i}^{n} \\
	& \mathbf{W}_{i}^{(1)} = \mathbf{W}_{i}^{(0)} - \alpha_{1}\frac{\Delta t_{i}}{\Omega_{i}}\mathbf{R}_{i}^{(0)} \\
	& \mathbf{W}_{i}^{(2)} = \mathbf{W}_{i}^{(0)} - \alpha_{2}\frac{\Delta t_{i}}{\Omega_{i}}\mathbf{R}_{i}^{(1)} \\
	& \qquad\vdots \\
	& \mathbf{W}_{i}^{n+1} = \mathbf{W}_{i}^{(m)} = \mathbf{W}_{i}^{(0)} - \alpha_{m}\frac{\Delta t_{i}}{\Omega_{i}}\mathbf{R}_{i}^{(m-1)}
	\end{align}

where :math:`\alpha_{1},\cdots,\alpha_{m}` represent the stage coefficients. Furthermore, the denotation :math:`\mathbf{R}_{i}^{(k)}` means that the residual is evaluated with the solution :math:`\mathbf{W}_{i}^{(k)}` from the k-th stage.

Unlike the classical Runge-Kutta schemes, only the zero-th solution and the newest residual are stored here in order to reduce the memory requirements. The stage coefficients can be tuned to increase the maximum time step and to improve the stability for a particular spatial discretization. For consistency, it is only required that :math:`\alpha_{m} = 1` . A consequence of teh modification to the Runge-Kutta scheme is that second-order time accuracy can be realized only if :math:`\alpha_{m-1} = 1/2` . Otherwise, the multistage scheme is first-order accurate in time.

The above multistage approach is particularly suitable for upwind spatial discretization on structured as well as unstructured grids. Central discretization schemes perform more efficiently with the hybrid multistage methodology. Sets of optimized stage coefficients for first- and second-order upwind schemes are presented in the following table for three- to five-stage schemes. Practical experience shows that the coefficients for the first-order scheme should be preferred in cases, where the flow field contains for the first-order scheme should be preferred in cases, where the flow field contains strong shocks, regardless of the order of the spatial discretization. This can be explained by the fact that every higher-order scheme switches to first order at shocks to prevent oscillations of the solution. However, the residuals at strong shocks influence the convergence to steady state the most significantly.


+--------------------+--------------------+--------+--------+---------------------+--------+--------+
|                    | First-order scheme                   | Second-order scheme                   |
+====================+====================+========+========+=====================+========+========+
| Stages             | 3                  | 4      | 5      | 3                   | 4      | 5      |
+--------------------+--------------------+--------+--------+---------------------+--------+--------+
| CFL                | 1.5                | 2.0    | 2.5    | 0.69                | 0.92   | 1.15   |
+--------------------+--------------------+--------+--------+---------------------+--------+--------+
| :math:`\alpha_{1}` | 0.1481             | 0.0833 | 0.0533 | 0.1918              | 0.1084 | 0.0695 |
+--------------------+--------------------+--------+--------+---------------------+--------+--------+
| :math:`\alpha_{2}` | 0.4000             | 0.2069 | 0.1263 | 0.4929              | 0.2602 | 0.1602 |
+--------------------+--------------------+--------+--------+---------------------+--------+--------+
| :math:`\alpha_{3}` | 1.0000             | 0.4265 | 0.2375 | 1.0000              | 0.5052 | 0.2898 |
+--------------------+--------------------+--------+--------+---------------------+--------+--------+
| :math:`\alpha_{4}` |                    | 1.0000 | 0.4414 |                     | 1.0000 | 0.5060 |
+--------------------+--------------------+--------+--------+---------------------+--------+--------+
| :math:`\alpha_{5}` |                    |        | 1.0000 |                     |        | 1.0000 |
+--------------------+--------------------+--------+--------+---------------------+--------+--------+


The main disadvantage of every explicit scheme is that the time step :math:`(\Delta t)` is severely restricted by the characteristics of the governing equations as well as by the grid geometry.



Hybrid multistage schemes
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The computational work of an explicit multistage scheme can be substantially reduced if the viscous fluxes and the dissipation are not re-evaluated at each stage. Additionally, the dissipation terms from different stages can be blended to increase the stability of the scheme. Methods of this type were devised by Martinelli and by Mavriplis and Jameson. They are known as hybrid multistage schemes. Provided the stage coefficients are carefully optimized, the hybrid schemes are as robust as the basic multistage schemes.

Let us for illustration consider a popular 5-stage hybrid scheme, where the dissipative terms are evaluated at odd stages. First, we split the spatial discretization into two parts, that is,

.. math::
	\begin{align}
	\mathbf{R}_{i} = (\mathbf{R}_{c})_{i} - (\mathbf{R}_{d})_{i}
	\end{align}

The first part, :math:`\mathbf{R}_{c}` , contains the central discretization of the convective fluxes, which can be either the average of variables or the average of fluxes. It also includes the source term. The second part, :math:`\mathbf{R}_{d}` , is composed of the viscous fluxes and the numerical dissipation. For example, in the case of the central scheme with artificial dissipation we would set

.. math::
	\begin{align}
	& (\mathbf{R}_{c})_{i} = \sum_{k=1}^{N_{F}}\Big[ \mathbf{F}_{c}(\mathbf{W}_{av})\Delta S \Big]_{k} - (\mathbf{Q}\Omega)_{i} \\
	& (\mathbf{R}_{d})_{i} = \sum_{k=1}^{N_{F}}\Big[ \mathbf{F}_{v}\Delta S + \mathbf{D} \Big]_{k}
	\end{align}

where :math:`\mathbf{W}_{av}` represents the arithmetic average of flow variables from the left and the right side of face :math:`k` .

With the residual split the scheme can be formulated as

.. math::
	\begin{align}
	& \mathbf{W}_{i}^{(0)} = \mathbf{W}_{i}^{n} \\
	& \mathbf{W}_{i}^{(1)} = \mathbf{W}_{i}^{(0)} - \alpha_{1}\frac{\Delta t_{i}}{\Omega_{i}}\Big[ \mathbf{R}_{c}^{(0)} - \mathbf{R}_{d}^{(0)} \Big]_{i} \\
	& \mathbf{W}_{i}^{(2)} = \mathbf{W}_{i}^{(0)} - \alpha_{2}\frac{\Delta t_{i}}{\Omega_{i}}\Big[ \mathbf{R}_{c}^{(1)} - \mathbf{R}_{d}^{(0)} \Big]_{i} \\
	& \mathbf{W}_{i}^{(3)} = \mathbf{W}_{i}^{(0)} - \alpha_{3}\frac{\Delta t_{i}}{\Omega_{i}}\Big[ \mathbf{R}_{c}^{(2)} - \mathbf{R}_{d}^{(2,0)} \Big]_{i} \\
	& \mathbf{W}_{i}^{(4)} = \mathbf{W}_{i}^{(0)} - \alpha_{4}\frac{\Delta t}{\Omega_{i}}\Big[ \mathbf{R}_{c}^{(3)} - \mathbf{R}_{d}^{(2,0)} \Big]_{i} \\
	& \mathbf{W}_{i}^{n+1} = \mathbf{W}_{i}^{(0)} - \alpha_{5}\frac{\Delta t_{i}}{\Omega_{i}}\Big[ \mathbf{R}_{c}^{(4)} - \mathbf{R}_{d}^{(4,2)} \Big]_{i}
	\end{align}

where

.. math::
	\begin{align}
	& \mathbf{R}_{d}^{(2,0)} = \beta_{3}\mathbf{R}_{d}^{(2)} + (1-\beta_{3})\mathbf{R}_{d}^{(0)} \\
	& \mathbf{R}_{d}^{(4,0)} = \beta_{5}\mathbf{R}_{d}^{(4)} + (1-\beta_{5})\mathbf{R}_{d}^{(2,0)}
	\end{align}

The stage coefficients :math:`\alpha_{m}` and the blending coefficients :math:`\beta_{m}` in the above relations equations are given in following table for central and upwind schemes. Both sets of coefficients are particularly optimized for the multigrid method. We shall discuss the properties of the above hybrid multistage scheme later.


+-------+----------------+---------------+--------------------+---------------+---------------------+---------------+
|       | Central scheme                 | First-order upwind                 | Second-order upwind                 |
+=======+================+===============+====================+===============+=====================+===============+
| CFL   | 3.6                            | 2.0                                | 1.0                                 |
+-------+----------------+---------------+--------------------+---------------+---------------------+---------------+
| Stage | :math:`\alpha` | :math:`\beta` | :math:`\alpha`     | :math:`\beta` | :math:`\alpha`      | :math:`\beta` |
+-------+----------------+---------------+--------------------+---------------+---------------------+---------------+
| 1     | 0.2500         | 1.00          | 0.2742             | 1.00          | 0.2742              | 1.00          |
+-------+----------------+---------------+--------------------+---------------+---------------------+---------------+
| 2     | 0.1667         | 0.00          | 0.2067             | 0.00          | 0.2067              | 0.00          |
+-------+----------------+---------------+--------------------+---------------+---------------------+---------------+
| 3     | 0.3750         | 0.56          | 0.5020             | 0.56          | 0.5020              | 0.56          |
+-------+----------------+---------------+--------------------+---------------+---------------------+---------------+
| 4     | 0.5000         | 0.00          | 0.5142             | 0.00          | 0.5142              | 0.00          |
+-------+----------------+---------------+--------------------+---------------+---------------------+---------------+
| 5     | 1.0000         | 0.44          | 1.0000             | 0.44          | 1.0000              | 0.44          |
+-------+----------------+---------------+--------------------+---------------+---------------------+---------------+


It should be mentioned that it is also popular to evaluate the dissipation term :math:`\mathbf{R}_{d}` in the first two stages only, without any blending. A well-known (5,2)-scheme, which is often employed with the central spatial discretization, uses the stage coefficients of the table. However, the (5,2)-scheme is less suitable for viscous flows and multigrid than the (5,3)-scheme.

Treatment of the source term
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

There are certain cases in which the source term :math:`\mathbf{Q}` becomes dominant. Such situation is often encounterred when chemistry or turbulence models are employed. The problem is that a large source term changes the flow variables rapidly in space and in time. The changes due to a strong source term happen at much smaller time scales than those of the flow equations. This increases the stiffness of the governing equations significantly. The stiffness is defined as the ratio of the largest to the smallest eigenvalue of the Jacobian matrix :math:`\partial \mathbf{R}/\partial \mathbf{W}` . The stiffness can also be viewed as the ratio of the largest to the smallest time scale.

When we apply one of the above explicit multistage schemes (or any other purely explicit scheme) to a stiff system of equations, we will have to reduce the time step considerably in order stabilize the time integration. Hence, the convergence to the steady state will become very slow. More seriously, an explicit scheme can be even fail to find the correct solution. A remedy suggested by Curtiss and Hirschfelder is to treat the source term in an implicit way. In order to demonstrate the approach, we rewrite the basic explicit scheme as follows

.. math::
	\begin{align}
	\frac{\Omega_{i}}{\Delta t_{i}}\Delta\mathbf{W}_{i}^{n}
	= - \bigg[ \sum_{k=1}^{N_{F}}(\mathbf{F}_{c}^{n} - \mathbf{F}_{v}^{n})_{k}\Delta S_{k} - \Omega_{i}\mathbf{Q}_{i}^{n+1} \bigg]
	= -(\mathbf{R}_{Q})_{i}^{n} + \Omega_{i}\mathbf{Q}_{i}^{n+1}
	\end{align}

where the source term is now evaluated at the new time level :math:`(n+1)` . For simplicity, the mass matrix was omitted from this equation. Since the value of the source term at the time :math:`(n+1)` is unknown, we have to approximate it. For this purpose, we linearize the source term about the current time level :math:`n` , resulting in

.. math::
	\begin{align}
	\mathbf{Q}^{n+1} \approx \mathbf{Q}^{n} + \frac{\partial \mathbf{Q}}{\partial \mathbf{W}}\Delta\mathbf{W}^{n}
	\end{align}

If we insert it into the equation and rearrange the terms, we obtain the following relation

.. math::
	\begin{align}
	\bigg[ \frac{1}{\Delta t_{i}}\bar{I} - \Big( \frac{\partial\mathbf{Q}}{\partial\mathbf{W}} \Big)_{i} \bigg]\Delta\mathbf{W}_{i}^{n}
	= -\frac{1}{\Omega_{i}}\Big[ (\mathbf{R}_{Q})_{i}^{n} - \Omega_{i}\mathbf{Q}_{i}^{n} \Big]
	\end{align}

where :math:`\bar{I}` represents the identity matrix. The formulation is called point implicit because the term is square brackets on the left-hand side (the implicit operator) depends only on values in the control volume :math:`\Omega_{i}` itself. A comparison with the first equation reveals that now the scalar time step :math:`\Delta t` changed to a matrix. Thus, each flow equation becomes scaled by an individual parameter, corresponding to the associated eigenvalue. In this way, the disparity between the time scales is offset and the time step restriction due to the source term is alleviated.

When we apply the above point-implicit approach to the multistage scheme, we obtain for the k-th stage

.. math::
	\begin{align}
	\mathbf{W}_{i}^{(k)} = \mathbf{W}_{i}^{(0)} - \Big[ (\mathbf{R}_{Q})_{i}^{(k-1)} - \Omega_{i}\mathbf{Q}_{i}^{(0)} \Big] \bigg[ \frac{\Omega_{i}}{\alpha_{k}\Delta t_{i}}\bar{I} - \Big(\frac{\partial \mathbf{Q}}{\partial \mathbf{W}}\Big)_{i} \bigg]^{-1}
	\end{align}

A similar expression holds also for the hybrid multistage scheme. A more elaborate approach is to treat the stiff source term by means of an implicit Runge-Kutta scheme, described first by Rosenbrock and Butcher. Schemes of this type are numerically more stable than the approach above, however they require the inversion of a large system of linear equations at each stage.


Determination of the maximum time step
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Every explicit time-stepping scheme remains stable only up to a certain value of the time step :math:`\Delta t` . To be stable, a time-stepping scheme has to fulfill the so-called CFL condition. It states that the domain of dependence of the numerical method has to include the domain of dependence of the paritial differential equation. The CFL condition means for the basic explicit scheme that the time step should be equal to or smaller than the time required to transport information acroos the stencil of the spatial discretization scheme. Hence, in 1D the condtion for the time step would read for the linear convection equation

.. math::
	\begin{align}
	\Delta t = \sigma\frac{\Delta x}{|\Lambda_{c}|}
	\end{align}

where :math:`\Delta x / |\Lambda_{c}|` represents the time necessary to propagate information over the cell size :math:`\Delta x` with the velocity :math:`\Lambda_{c}` . The velocity :math:`\Lambda_{c}` corresponds to the maximum eigenvalue of the convective flux Jacobian. The positive coefficient :math:`\sigma` denotes the CFL number. The magnitude of the CFL number depends on the type and the parameters of the time-stepping scheme, as well as on the form of the spatial discretization problems.

The maximum time step can be determined for linear model equations with the aid of Von Neumann stability analysis. However, the maximum time step can be calculated only approximately in multiple dimensions and for non-linear governing equations.

Time step on structured grids
""""""""""""""""""""""""""""""""

On a structured grid, the time step :math:`\Delta t` can be determined for a control volume :math:`\Omega_{i}` from the approximate relation

.. math::
	\begin{align}
	\Delta t_{i} = \sigma \frac{\Omega_{i}}{(\hat{\Lambda}_{c}^{i} + \hat{\Lambda}_{c}^{j} + \hat{\Lambda}_{c}^{k})_{i}}
	\end{align}

The CFL number :math:`\sigma` is given for multistage schemes in tables before. The spectral radii of the convective flux Jacobians read for the three grid directions

.. math::
	\begin{align}
	& \hat{\Lambda}_{c}^{I} = (|\mathbf{U} \cdot \mathbf{n}^{I}| + c)\Delta S^{I} \\
	& \hat{\Lambda}_{c}^{J} = (|\mathbf{U} \cdot \mathbf{n}^{J}| + c)\Delta S^{J} \\
	& \hat{\Lambda}_{c}^{K} = (|\mathbf{U} \cdot \mathbf{n}^{K}| + c)\Delta S^{K}
	\end{align}

The normal vectors and face areas in the above equation are obtained by averaging the corresponding values from the two opposite sides of the control volume in the respective direction. For example, if a dual control volume would be oriented as sketched in Fig.4.1b, we would use in the I-direction

.. math::
	\begin{align}
	\mathbf{n}_{i,j,k}^{I} = \frac{1}{2}(\mathbf{n}_{1} - \mathbf{n}_{2})
	,\quad
	\Delta S_{i,j,k}^{I} = \frac{1}{2}(\Delta S_{1} + \Delta S_{2})
	\end{align}

Similar expressions hold for the J- and K-direction.

With the approximate relation, we obtain a local time step, which is valid for one control volume only. If we are interested in s steady state solution, we may use the local time step to accelerate the convergence. However, if time accuracy is important, we have to employ one global time step for all volumes, that is

.. math::
	\begin{align}
	\Delta t = \min_{i}(\Delta t_{i})
	\end{align}

where the minimum is taken over all control volumes.

For viscous flows, the spectral radii of the viscous flux Jacobians have to be included in the computation of :math:`\Delta t` . They can severely limit the maximum time step in boundary layers. The time step can be evaluated from

.. math::
	\begin{align}
	\Delta t_{i} = \sigma \frac{\Omega_{i}}{(\hat{\Lambda}_{c}^{I} + \hat{\Lambda}_{c}^{J} + \hat{\Lambda}_{c}^{K})_{i} + C(\hat{\Lambda}_{v}^{I} + \hat{\Lambda}_{v}^{J} + \hat{\Lambda}_{v}^{K})_{i}}
	\end{align}

The constant which multiplies the viscous spectral radii is usually set as :math:`C=4` for central spatial discretizations, :math:`C=2` for first-order upwind and :math:`C=1` for second-order upwind discretizations. If we assume that an eddy-viscosity turbulence model is employed, the viscous spectral radii are given by

.. math::
	\begin{align}
	\hat{\Lambda}_{v}^{I} = \max\Big( \frac{4}{3\rho}, \frac{\gamma}{\rho}\Big) \Big( \frac{\mu_{L}}{Pr_{L}} + \frac{\mu_{T}}{Pr_{T}}\Big) \frac{(\Delta S^{I})^{2}}{\Omega}
	\end{align}

and similarly for the other directions. In this equation, :math:`\mu_{L}` denotes the laminar and :math:`\mu_{T}` the turbulent dynamic viscosity coefficient, respectively. Furthermore, :math:`Pr_{L}` and :math:`Pr_{T}` are the laminar and the turbulent Prandtl numbers. The CFL numbers in tables apply also for viscous flows. Particularly  efficient for viscous flows is the hybrid scheme.


Time step on unstructured grids
""""""""""""""""""""""""""""""""""

Several approaches were suggested for the estimation of the maximum time step on unstructured grids. We shall present two different approaches below.

**Method 1** One proven method, which closely follows the implementation on strctured grids, reads

.. math::
	\begin{align}
	\Delta t_{I} = \sigma \frac{\Omega_{I}}{(\hat{\Lambda}_{c} + C\hat{\Lambda}_{v})_{I}}
	\end{align}

where :math:`\hat{\Lambda}_{c}` and :math:`\hat{\Lambda}_{v}` represent a sum of the convective and viscous spectral radii over all faces of the control volume. As on strctured grids, :math:`1 \le C \le 4` is usually used. In the case of the cell-centered scheme, the spectral radii are defined as

.. math::
	\begin{align}
	& (\hat{\Lambda}_{c})_{I} = \sum_{J=1}^{N_{F}}(|\mathbf{U}_{IJ} \cdot \mathbf{n}_{IJ}| + c_{IJ})\Delta S_{IJ} \\
	& (\hat{\Lambda}_{v})_{I} = \frac{1}{\Omega_{I}}\sum_{J=1}^{N_{F}} \bigg[ \max\Big(\frac{4}{3\rho_{IJ}}, \frac{\gamma_{IJ}}{\rho_{IJ}}\Big) \Big( \frac{\mu_{L}}{Pr_{L}} + \frac{\mu_{T}}{Pr_{T}} \Big)_{IJ}(\Delta S_{IJ})^{2} \bigg]
	\end{align}

The values of the flow variables at the faces of the control volume are obtained by arithmetic averaging.

**Method 2** The spectral radii predicted by the above equationa are too large, particularly on mixed element grids. This leads to a smaller time step than necessary for stability. Another implementation offers a more accurate estimation of the time step, namely

.. math::
	\begin{align}
	\Delta t_{I} = \sigma \frac{\Omega_{I}}{(\hat{\Lambda}_{c}^{x} + \hat{\Lambda}_{c}^{y} + \hat{\Lambda}_{c}^{z})_{I} + C(\hat{\Lambda}_{v}^{x} + \hat{\Lambda}_{v}^{y} + \hat{\Lambda}_{v}^{z})_{I}}
	\end{align}

with the convective spectral radii

.. math::
	\begin{align}
	& \hat{\Lambda}_{c}^{x} = (|u| + c)\Delta \hat{S}^{x} \\
	& \hat{\Lambda}_{c}^{\gamma} = (|v| + c)\Delta \hat{S}^{y} \\
	& \hat{\Lambda}_{c}^{z} = (|w| + c)\Delta \hat{S}^{z}
	\end{align}

and with the viscous spectral radii (eddy-viscosity turbulence model assuemd)

.. math::
	\begin{align}
	\hat{\Lambda}_{v}^{x} = \max\Big( \frac{4}{3\rho}, \frac{\gamma}{\rho} \Big) \Big( \frac{\mu_{L}}{Pr_{L}} + \frac{\mu_{T}}{Pr_{T}} \Big) \frac{(\Delta \hat{S}^{x})^{2}}{\Omega}
	\end{align}

The variables :math:`\Delta \hat{S}^{x}, \Delta \hat{S}^{y}, \Delta \hat{S}^{z}` , respectively, represent projections of the control volume on the y-z-, x-z-, and the x-y-plane. They are given by the formulas

.. math::
	\begin{align}
	& \Delta \hat{S}^{x} = \frac{1}{2}\sum_{J=1}^{N_{F}}|S_{x}|_{J} \\
	& \Delta\hat{S}^{y} = \frac{1}{2}\sum_{J=1}^{N_{F}}|S_{y}|_{J} \\
	& \Delta\hat{S}^{z} = \frac{1}{2}\sum_{J=1}^{N_{F}}|S_{z}|_{J}
	\end{align}

where :math:`S_{x}, S_{y}` and :math:`S_{z}` denote the x-, y- and the z-component of the face vector :math:`\mathbf{S} = \mathbf{n} \cdot \Delta S` .

The CFL numbers remain in general the same as on structured grids. Thus, the values collected in tables before still apply. Furthermore, the convergence to steady state can also be accelerated by local time stepping, in the same way as on the structured grids. A global time step, necessary for simulating unsteady flows, can be obtained from :math:`\Delta t = \min(\Delta t_{I})` as before.






Implicit Time-Stepping Schemes
---------------------------------


Various implicit time integration schemes can be obtained by setting :math:`\beta \ne 0` . An implicit scheme with :math:`\omega=0` was found to be best suited for the solution of stationary flow problems. Herewith, the basic non-linear scheme simplifies to

.. math::
	\begin{align}
	\frac{(\Omega\bar{M})_{I}}{\Delta t_{I}}\Delta\mathbf{W}_{I}^{n}
	= -\beta\mathbf{R}_{I}^{n+1} - (1-\beta)\mathbf{R}_{I}^{n}
	\end{align}

As we can see, the implicit formulation leads to a set of non-linear equations for the unknown flow variables at the time :math:`(t + \Delta t)` . The solution of the equation requires the evaluation of the residual at the new time level, that is, :math:`\mathbf{R}^{n+1}` . Since we do not know :math:`\mathbf{W}^{n+1}` , this cannot be done directly. However, we can linearize the residual :math:`\mathbf{R}^{n+1}` in the equation about the current time level, that is

.. math::
	\begin{align}
	\mathbf{R}_{I}^{n+1} \approx \mathbf{R}_{I}^{n} + \Big( \frac{\partial \mathbf{R}}{\partial \mathbf{W}} \Big)_{I}\Delta\mathbf{W}^{n}
	\end{align}

where the term :math:`\partial\mathbf{R}/\partial\mathbf{W}` is referred to as the flux Jacobian. We should mention that the flux Jacobian is often derived from a rather crude approximation to the spatial discretization represented by :math:`\mathbf{R}^{n}` . For example, in the case of higher-order upwind discretizations, it is quite common to base the flux Jacobian solely on a first-order upwind scheme. However, for best efficiency and robustness, the flux Jacobian should still reflect the most important features of the spatial discretization.

If we substitute now the linearization for :math:`\mathbf{R}^{n+1}` into the equation, we obtain the following implicit scheme

.. math::
	\begin{align}
	\bigg[ \frac{(\Omega\bar{M})_{I}}{\Delta t_{I}} + \beta \Big( \frac{\partial\mathbf{R}}{\partial\mathbf{W}} \Big)_{I} \bigg] \Delta\mathbf{W}^{n} = -\mathbf{R}_{I}^{n}
	\end{align}

The term in square brackets on the left-hand side of it is reffered to as the implicit operator or the system matrix. Consequently, the right-hand side of the equation is called the explicit operator. It is only the explicit operator that determines the spatial accuracy of the solution.

The implicit operator constitutes a large, sparse, and non-symmetric block matrix with dimensions equal to the total number of cells (cell-centered scheme) or grid points structured as well as for unstructured grids. As we already saw before, the mass matrix :math:`\bar{M}` can be replaced by the identity matrix, without influencing the steady state solution. The parameter :math:`\beta` is generally set to :math:`1` , which results in a first-order accurate temporal discretization. A second-order time accurate scheme is obtained for :math:`\beta=1/2` . However, this is not recommended since the scheme with :math:`\beta=1` is much more robust, and the time accuracy is of no importance for steady problems.

In the case of stiff governing equations, the source term has to be included in the implicit operator. This happens quite naturally with the linearization of the residual, which leads to a formulation identical to :math:`\mathbf{Q}^{n+1} \approx \mathbf{Q}^{n} + \frac{\partial\mathbf{Q}}{\partial\mathbf{W}}\Delta\mathbf{W}` . The above implicit scheme remains stable for any time step if the eigenvalues of :math:`\partial\mathbf{Q}/\partial\mathbf{W}` are all negative or zero.

The solution of the linear equation system requires the inversion of the implicit operator, that is, the inversion of a very large matrix. In principle, this can be done in two ways. The first one consists of a direct matrix inversion, using either the Gaussian elimination or some direct sparse matrix method. However, because of the excessive amount of memory and the very high computational effort, this approach is not suited for practical problems.

The second possibility of inverting the implicit operator represent iterative methods. Iterative methods can be divided roughly into two groups. The first one consists of approaches which decompose the implicit operator into several parts (a process called factorization). The factors are constructed in such a way that they can be more easily inverted than the original implicit operator. To the second group belong schems, which employ a Krylov-subspace method for the inversion of the implicit operator. In this case, the implicit time-stepping scheme is usually turned into Newton's method by setting :math:`\Delta t \to \infty` . The scheme is then named Newton-Krylov method.

Matrix form of the implicit operator
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

We can write the linearization of the residual :math:`\mathbf{R}^{n+1}` in the form

.. math::
	\begin{align}
	\mathbf{R}^{n+1} \approx \mathbf{R}^{n}
	+ \sum_{m=1}^{N_{F}} \bigg\{ \frac{\partial}{\partial\mathbf{W}}\Big[(\mathbf{F}_{c} - \mathbf{F}_{v})_{m}\Delta S_{m}\Big] \Delta\mathbf{W}^{n} \bigg\}
	- \frac{\partial(\Omega\mathbf{Q})}{\partial\mathbf{W}}\Delta\mathbf{W}
	\end{align}

with :math:`N_{F}` being the number of faces of the control volume :math:`\Omega` . Thus, the flux Jacobian reads

.. math::
	\begin{align}
	\frac{\partial\mathbf{R}}{\partial\mathbf{W}}
	= \sum_{m=1}^{N_{F}}\frac{\partial(\mathbf{F}_{c})_{m}}{\partial\mathbf{W}}\Delta S_{m}
	- \sum_{m=1}^{N_{F}}\frac{\partial(\mathbf{F}_{v})_{m}}{\partial\mathbf{W}}\Delta S_{m}
	- \frac{\partial(\Omega\mathbf{Q})}{\partial\mathbf{W}}
	\end{align}

It should be stressed that the flux Jacobian has to be conceived as an operator which acts on the update :math:`\Delta\mathbf{W}` . As stated above, the convective and viscous fluxes do not necessarily have to be identical to the fluxes in the explicit operator.

Because of the significant differences between the implicit operators on structured and unstructured grids, we shall treat each case separately.

The appearance of the system matrix changes completely when we proceed from structured to unstructured grids. This can be demonstrated with the aid of a small unstructured grid sketched in Fig.6.3. We want assume that the spatial discretization is given by the cell-centred scheme, which uses flow values only from the nearest neighbors (e.g., like a first-order upwind scheme). Thus, for example, the stencil for cell 2 includes the cells 18, 10, and 13. The resulting system matrix is displayed on the right side of Fig.6.3. It is obvious that since the grid cells (nodes in the case of a median-dual scheme) are in general numbered in an arbitrary order, no regular pattern can be expected for the matrix. Only the main diagonal, which contains at least the expression :math:`\frac{(\Omega \bar{M})_{I}}{\Delta t_{I}}` and possibly the derivative of the source term, is always present.

The quasi-random distribution of nonzero elements in the system matrix is undesirable. It slows down the convergence of iterative inversion methods like Gauss-Seidel. Furthermore, preconditioning techniques for Krylov-subspace methods like incomplete lower-upper (ILU) factorization scheme cannot be used effectively. Therefore, strategies were developed where the cells (nodes) are renumbered such that the bandwidth of the system matrix is considerably reduced, that is, the nonzero elements are clustered close to the main diagonal. The best-known renumbering strategy is the Reverse-Cuthill-McKee (RCM) algorithm. Several other renumbering strategies were developed in order to minimize cache misses or to allow for vectorization of the numerical scheme.


Evaluation of the flux Jacobian
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Depending on the type of the underlying spatial discretization scheme, an analytical evaluation of the flux Jacobian :math:`\partial\mathbf{R}/\partial\mathbf{W}` may be very complex if not impossible. In order to make the concepts more clear, we shall derive the flux Jacobian for inviscid flows and then discuss the extension to the Navier-Stokes equations.


Central scheme
"""""""""""""""""

The flux Jacobian is most easily formulated in the case of the central spatial discretization. As we already saw for the example in Fig.6.1, :math:`\partial\mathbf{R}/\partial\mathbf{W}` consists of the convective flux Jacobians, which can be derived analytically. Artificial viscosity is usually included in a simplified form, without the non-linear pressure sensor.


Flux-vector splitting scheme
"""""""""""""""""""""""""""""""

The evalutation of the flux Jacobian becomes more involved when one of the flux-vector splitting schemes is used as the basis for its derivation. Let us, for illustration, consider the Steger-Warming. Previous investigations revealed that the Steger-Warming splitting is preferable over, for example, van Leer's flux-vector splitting scheme for various upwind disretizations of the implicit operator.

The basic idea of the Steger-Warming flux-vector splitting scheme is to divide the convective fluxes into a positive and a negative part, that is,

.. math::
	\begin{align}
	\mathbf{F}_{c} = \mathbf{F}_{c}^{+} + \mathbf{F}_{c}^{-}
	\end{align}

with the fluxes defined as

.. math::
	\begin{align}
	\mathbf{F}_{c}^{\pm} = \bar{A}_{SW}^{\pm} = (\bar{T}\bar{\Lambda}^{\pm}\bar{T}^{-1})\mathbf{W}
	\end{align}

where :math:`\bar{A}_{SW}^{\pm}` denotes the positive/negative Steger-Warming flux-splitting Jacobian. Furthermore, :math:`\bar{T}` represents the matrix of right eigenvectors, :math:`\bar{T}^{-1}` the matrix of left eigenvectors, and :math:`\bar{\Lambda}^{\pm}` stands for the diagonal matrix of positive/negative eigenvalues, respectively. The eigenvalue matrices are defined as

.. math::
	\begin{align}
	\bar{\Lambda}^{\pm} = \frac{1}{2}(\bar{\Lambda}_{c} \pm |\bar{\Lambda}_{c}|)
	\end{align}

where :math:`\bar{\Lambda}_{c}` is given by Eq.(A.84).

Using the splitting defined in :math:`\mathbf{F}_{c} = \mathbf{F}_{c}^{+} + \mathbf{F}_{c}^{-}` , we obtain for the product of the flux Jacobian with the update :math:`\Delta\mathbf{W}^{n}`

.. math::
	\begin{align}
	\frac{\partial\mathbf{R}_{I}}{\partial\mathbf{W}}\Delta\mathbf{W}^{n}
	= \sum_{m=1}^{N_{F}} \bigg[
	\frac{\partial(\mathbf{F}_{c}^{+}\Delta S)_{m}}{\partial\mathbf{W}_{L,m}}\Delta\mathbf{W}_{L,m}^{n}
	+ \frac{\partial(\mathbf{F}_{c}^{-}\Delta S)_{m}}{\partial\mathbf{W}_{R,m}}\Delta\mathbf{W}_{R,m}^{n}
	\bigg]
	\end{align}

where :math:`\Delta\mathbf{W}_{L,m}^{n}` and :math:`\Delta\mathbf{W}_{R,m}^{n}` denote the updates of the left and right state at the face :math:`m` , respectively. On structured grids, the left and right state can be evaluated by the MUSCL approach. On unstructured grids, the reconstruction methods can be applied. However, the stencil becomes wider with increasing accuracy, which leads to larger bandwidth of the system matrix. Therefore, and in order to reduce the numerical complexity, only first-order accurate approximation is usually employed in the equation. As a compromise, we could reconstruct the left and right state with higher accuracy but retain the stencil of the first-order scheme for the evaluation of the derivatives.

To proceed with the discussion of the evaluation of the derivatives :math:`\partial\mathbf{F}_{c}^{\pm}/\partial\mathbf{W}` in the equation, let us consider, for example, the positive flux at face :math:`m` 

.. math::
	\begin{align}
	\frac{\partial(\mathbf{F}_{c}^{+}\Delta S)_{m}}{\partial\mathbf{W}_{L,m}}
	= \frac{\partial}{\partial\mathbf{W}_{L,m}}\Big[ (\bar{A}_{SW}^{+}\mathbf{W})_{L,m}\Delta S_{m} \Big]
	\end{align}


which becomes

.. math::
	\begin{align}
	\frac{\partial(\mathbf{F}_{c}^{+}\Delta S)_{m}}{\partial\mathbf{W}_{L,m}}
	= \frac{\Delta S_{m}}{2}\Big[ (\bar{A}_{c})_{L,m} + |(\bar{A}_{c})_{L,m}| \Big]
	+ \frac{\Delta S_{m}}{2}\bigg[ 
	\frac{\partial(\bar{A}_{c})_{L,m}}{\partial\mathbf{W}_{L,m}} 
	+ \frac{\partial |(\bar{A}_{c})_{L,m}|}{\partial\mathbf{W}_{L,m}}
	\bigg] \mathbf{W}_{L,m}^{n}
	\end{align}

An expression similar to the above equation can also be found for the negative flux. As we can see, the first term it consists of convective flux Jacobians and thus presents no difficulty. However, the second term involves derivatives of matrix elements. Although it is possible to obtain the derivatives analytically, this will produce a large, computationally inefficient code. Alternatively, it is possible to assume the matrix :math:`\bar{A}_{c}` is locally constant so that the second term in the equation can be neglected. However, depending on the type of the implicit scheme, this may severely restrict the CFL number.

Flux-difference splitting scheme
"""""""""""""""""""""""""""""""""""

In the case of the flux-difference splitting scheme due to Roe, we can write the product of the flux Jacobian with the update as

.. math::
	\begin{align}
	\frac{\partial\mathbf{R}_{I}}{\partial\mathbf{W}}\Delta\mathbf{W}^{n}
	= \sum_{m=1}^{N_{F}} \frac{\Delta S_{m}}{2} \bigg\{
	(\bar{A}_{c})_{L,m} \Delta\mathbf{W}_{L,m}^{n}
	+ (\bar{A}_{c})_{R,m}\Delta\mathbf{W}_{R,m}^{n}
	- \frac{\partial}{\partial\mathbf{W}_{L,m}} \Big[ |\bar{A}_{Roe}|_{m} (\mathbf{W}_{R,m}^{n} - \mathbf{W}_{L,m}^{n}) \Big] \Delta\mathbf{W}_{L,m}^{n}
	- \frac{\partial}{\partial\mathbf{W}_{R,m}} \Big[ |\bar{A}_{Roe}|_{m} (\mathbf{W}_{R,m}^{n} - \mathbf{W}_{L,m}^{n}) \Big] \Delta\mathbf{W}_{R,m}^{n}
	\bigg\}
	\end{align}

Similar to flux-vector splitting, the expression contains convective flux Jacobians as well as derivatives of the Roe matrix :math:`\bar{A}_{Roe}` . Since the corresponding formulas are very complex, it is a better idea to evaluate the term :math:`\partial\mathbf{F}_{c}/\partial\mathbf{W}` numerically, as discussed above. However, we can also simplify it by assuming locally constant Roe matrices

.. math::
	\begin{align}
	\frac{\partial\mathbf{R}_{I}}{\partial\mathbf{W}}\Delta\mathbf{W}^{n}
	\approx \sum_{m=1}^{N_{F}} \frac{\Delta S_{m}}{2} \bigg\{
	(\bar{A}_{c})_{L,m} \Delta\mathbf{W}_{L,m}^{n}
	+ (\bar{A}_{c})_{R,m} \Delta\mathbf{W}_{R,m}^{n}
	- |\bar{A}_{Roe}|_{m} \Big( \Delta\mathbf{W}_{R,m}^{n} - \Delta\mathbf{W}_{L,m}^{n} \Big)
	\bigg\}
	\end{align}

In contrast to the Steger-Warming flux-vector splitting scheme, the above approximate linearization degrades the performance of the implicit scheme only slightly.


Viscous flows
""""""""""""""""

For the Navier-Stokes equations, we have to account also for the viscous fluxes in the implicit operator. The derivative :math:`\partial\mathbf{F}_{v}/\partial\mathbf{W}` , that is, the viscous flux Jacobian is in general not straightforward to obtain. Additional complexity arises due to the fact that the viscous flux vector contains derivatives of flow variables. For this reason, we have either to evaluate the viscous flux Jacobian by finite differences, or we have to use a simplified formulation.

In the case of the TSL approximation of Navier-Stokes equations, it is possible to find the viscous flux Jacobian analytically by assuming locally constant dynamic viscosity and thermal conductivity coefficients. Then the term related to the viscous fluxes becomes

.. math::
	\begin{align}
	\frac{\partial(\mathbf{F}_{v}\Delta S)_{m}}{\partial\mathbf{W}}\Delta\mathbf{W}^{n}
	\approx \Big[
	(\bar{A}_{v}^{*})_{R,m} \Delta\mathbf{W}_{R,m}^{n}
	- (\bar{A}_{v}^{*})_{L,m} \Delta\mathbf{W}_{L,m}^{n}
	\Big] \Delta S_{m}
	\end{align}

where :math:`\bar{A}_{v}^{*}` stands for the viscous flux Jacobian given by Eq.(A.71) or Eq.(A.75) but without the spatial operators :math:`\partial_{\psi}()` . The Jacobians are evaluated using either the left or the right state for all variables except for the dynamic viscosity, which is determined from an arithmatic average. It should be mentioned that the above equation leads to a second-order central difference approximation in the implicit operator, supposed the left and right state are computed with first-order accuracy.


Alternating direction implicit scheme
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The alternating direction implicit (ADI) scheme was one of the first iterative implicit methods. The ADI scheme can be implemented on structured grids only. It is based on an approximate splitting (or, in other words, factorization) of the implicit operator into two (in 2D) or three (in 3D) factors. Each factor contains the linearization of the convective and viscous fluxes for one particular direction in the computational space. In 3D, this leads to the formulation

.. math::
	\begin{align}
	\bigg\{ \frac{\Omega}{\Delta t}\bar{I}
	+ \frac{\partial\Big[ (\mathbf{F}_{c}^{I} - \mathbf{F}_{v}^{I})\Delta S^{I} \Big]_{i+1/2}}{\partial\mathbf{W}}
	+ \frac{\partial\Big[ (\mathbf{F}_{c}^{I} - \mathbf{F}_{v}^{I})\Delta S^{I} \Big]_{i-1/2}}{\partial\mathbf{W}}
	\bigg\}
	\bigg\{ \frac{\Omega}{\Delta t}\bar{I}
	+ \frac{\partial\Big[ (\mathbf{F}_{c}^{I} - \mathbf{F}_{v}^{I})\Delta S^{I} \Big]_{j+1/2}}{\partial\mathbf{W}}
	+ \frac{\partial\Big[ (\mathbf{F}_{c}^{I} - \mathbf{F}_{v}^{I})\Delta S^{I} \Big]_{j-1/2}}{\partial\mathbf{W}}
	\bigg\}
	\bigg\{ \frac{\Omega}{\Delta t}\bar{I}
	+ \frac{\partial\Big[ (\mathbf{F}_{c}^{I} - \mathbf{F}_{v}^{I})\Delta S^{I} \Big]_{k+1/2}}{\partial\mathbf{W}}
	+ \frac{\partial\Big[ (\mathbf{F}_{c}^{I} - \mathbf{F}_{v}^{I})\Delta S^{I} \Big]_{k-1/2}}{\partial\mathbf{W}}
	- \frac{\partial(\Omega \mathbf{Q})}{\partial \mathbf{W}}
	\bigg\} \Delta\mathbf{W}^{n}
	= -\mathbf{R}^{n}
	\end{align}

For clarity, the node indexes :math:`i,j,k` were omitted where not required. Furthermore, the superscripts :math:`I,J,K` mark the flux vector or of the face area associated with certain coordinate in the computaional space. By replacing the node indexes by cell indexes, the scheme can be applied to a cell-centered discretization.

The derivatives of the convective and viscous fluxes can be evaluated as discussed in the previous subsection. The ADI method is traditionally coupled to the central scheme with artificial dissipation. In such a case, formulation similar to that in Eq.(6.34) holds for each factor (of course, the linearization of the source term is included in one factor only). In order to obtain a robust and efficient scheme, it is necessary to include a linearization of the artificial dissipation terms in the implicit operator. The linearization is in general simplified by treating the spectral radii and the dissipation coefficients as independent of :math:`\mathbf{W}` . Hence, according to Eq.(4.48) the factor, for example, in the I-direction becomes

.. math::
	\begin{align}
	\bigg\{ \frac{\Omega}{\Delta t}\bar{I}
	+ \frac{\partial[ (\mathbf{F}_{c}^{I} - \mathbf{F}_{v}^{I})\Delta S^{I} ]_{i+1/2}}{\partial\mathbf{W}}
	+ \frac{\partial[ (\mathbf{F}_{c}^{I} - \mathbf{F}_{v}^{I})\Delta S^{I} ]_{i-1/2}}{\partial\mathbf{W}}
	- \frac{\partial(\mathbf{D}_{IM}^{I}\Delta S^{I})_{i+1/2}}{\partial\mathbf{W}}
	- \frac{\partial(\mathbf{D}_{IM}^{I}\Delta S^{I})_{i-1/2}}{\partial\mathbf{W}}
	\bigg\}
	\end{align}

with the implicit artificial dissipation term JST scheme

.. math::
	\begin{align}
	\frac{\partial(\mathbf{D}_{IM}^{I})_{i+1/2}}{\partial\mathbf{W}}\Delta\mathbf{W}^{n}
	\approx \hat{\Lambda}_{i+1/2}^{S} \Big[
	(\epsilon_{IM}^{(2)})_{i+1/2} (\Delta\mathbf{W}_{i+1}^{n} - \Delta\mathbf{W}_{i}^{n})
	- (\epsilon_{IM}^{(4)})_{i+1/2} (\Delta\mathbf{W}_{i+2}^{n} - 3\Delta\mathbf{W}_{i+1}^{n} + 3\Delta\mathbf{W}_{i}^{n} - \Delta\mathbf{W}_{i-1}^{n})
	\Big]
	\end{align}

The implicit dissipation terms in other directions are defined in a similar way. It is also possible to retain only the second-order differences in the implicit operator. This reduces the matrix for each factors from block-pentadiagonal to block-tridiagonal form. However, this restricts the stability of the scheme.

The inversion of the implicit operator proceeds in three steps (two steps in 2D), that is,

.. math::
	\begin{align}
	& (\mathbf{D}^{I} + \mathbf{L}^{I} + \mathbf{U}^{I})\Delta\mathbf{W}^{(1)} = -\mathbf{R}^{n} \\
	& (\mathbf{D}^{I} + \mathbf{L}^{J} + \mathbf{U}^{J})\Delta\mathbf{W}^{(2)} = \Delta\mathbf{W}^{(1)} \\
	& (\mathbf{D}^{K} + \mathbf{L}^{K} + \mathbf{U}^{K})\Delta\mathbf{W}^{n} = \Delta\mathbf{W}^{(2)}
	\end{align}

where :math:`\mathbf{D}` represents the diagonal, :math:`\mathbf{L}` the lower-diagonal, and :math:`\mathbf{U}` the upper-diagonal terms, respectively. Each step requires the inversion of a block-tridiagonal or a block-penta-diagonal matrix (if :math:`\epsilon_{IM}^{(4)} > 0` ). This is done by a direct solution method. In order to reduce the numerical effort, Pulliam and Chaussee suggested a diagonalized form of the ADI scheme. Herewith, the block matrices (composed of convective and viscous flux Jacobians) are transformed into diagonal matrices. Hence, only non-block tri- or pentadiagonal matrices have to be inverted, which results in significant savings of computational work and memory. Although the diagonalization is valid strictly for the Euler equations only, it can be employed for viscous flows as well. The linearization of the viscous fluxes is then either dropped from the implicit operator, or it is approximated by the viscous eigenvalue.

The splitting of the implicit operator introduces what is called the factorization error. It is the difference between the implicit operator of the base scheme and the factorized operator. In the case of the ADI scheme, this error term is scaled by the factor :math:`(\Delta t)^{N}` , where :math:`N` denotes the number of space dimensions. This term causes the ADI scheme to loose its unconditional stability in 3D. However, the stability is improved if the fourth-order differences of the artificial viscosity are included in the implicit operator. In fact, the ADI scheme was successfully used for the solution of various 3D problems. An interesting implementation of the ADI scheme on multiblock grids, which treats the block boundaries implicitly, was presented by Rosenfeld and Yassour.

The time step :math:`\Delta t` can be computed in the same way as presented before. The optimal CFL number varies betwenn 20 and 50, depending on the physics of the particular flow case.





Lower-Upper symmetric Gauss-Seidel Scheme
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The implicit lower-upper symmetric Gauss-Seidel (LU-SGS) scheme, which is also called the lower-upper symmetric overrelaxation (LU-SSOR) scheme, became widely used because of its low numerical complexity and modest memory requirements, which are both comparable to an explicit multistage scheme. Furthermore, the LU-SGS scheme can be implemented easily on vector and parallel computers. It can also be used on structured as well as on unstructured grids.

The LU-SGS scheme has its origins in the work of Jameson and Turkel, who considered decompositions of the implicit operator into lower and upper diagonally dominant factors. The LU-SGS method itself was introduced by Yoon and Jameson as a relaxation method for solving the unfactored implicit scheme. It was further developed and applied to 3D viscous flow fields by Rieger and Jameson. Since then, various researchers applied the LU-SGS scheme to viscous flows on structured and on unstructured grids. The LU-SGS approach is often used for the simulation of chemically reacting flows.

The LU-SGS scheme employs a simplification of the first-order accurate flux-vector splitting approach due to Steger and Warming for the linearization of the convective fluxes. The linearization is always kept the same regardless of the discretization of the explicit operator. The LU-SGS scheme is further based on the factorization of the implicit operator into the following three parts

.. math::
	\begin{align}
	(\mathbf{D} + \mathbf{L})\mathbf{D}^{-1}(\mathbf{D} + \mathbf{U})\Delta\mathbf{W}^{n} = -\mathbf{R}_{I}^{n}
	\end{align}

The factors are constructed such that :math:`\mathbf{L}` consists only of terms in the strictly lower triangular matrix, :math:`\mathbf{U}` of terms in the strictly upper triangular matrix, and :math:`\mathbf{D}` of diagonal terms. It is important to remark that the number of factors remains always the same independent of the number of space dimensions.

The system matrix of the LU-SGS scheme can be inverted in two steps--a forward and a backward sweep, that is,

.. math::
	\begin{align}
	& (\mathbf{D} + \mathbf{L})\Delta\mathbf{W}^{(1)} = -\mathbf{R}_{I}^{n} \\
	& (\mathbf{D} + \mathbf{U})\Delta\mathbf{W}^{n} = \mathbf{D}\Delta\mathbf{W}^{(1)}_{I}
	\end{align}

with :math:`\mathbf{W}^{n+1} = \mathbf{W}^{n} + \Delta\mathbf{W}^{n}` . The operators :math:`\mathbf{L},\mathbf{D}` and :math:`\mathbf{U}` and also the inversion procedure differ between structured and unstructured grids in some aspects. Therefore, we shall discuss below each case separately.

LU-SGS on unstructured grids
""""""""""""""""""""""""""""""""

Here, for a median-dual scheme the operators read

.. math::
	\begin{align}
	& \mathbf{L} = \sum_{j \in L(i)}\Big[ \bar{A}_{j}^{+} + (\bar{A}_{v})_{j} \Big]\Delta S_{ij} \\
	& \mathbf{U} = \sum_{j \in U(i)} \Big[ \bar{A}_{j}^{-} - (\bar{A}_{v})_{j} \Big]\Delta S_{ij} \\
	& \mathbf{D} = \frac{\Omega_{i}}{\Delta t_{i}}\bar{I} 
	+ \frac{\omega}{2}(\hat{\Lambda}_{c})_{i}
	+ \sum_{j=1}^{N_{F}}(\bar{A}_{v})_{i}\Delta S_{ij}
	- \frac{\partial (\Omega_{i}\mathbf{Q}_{i})}{\partial \mathbf{W}}
	\end{align}

where :math:`(\hat{\Lambda}_{v})_{i}` is evaluated according to

.. math::
	\begin{align}
	& (\hat{\Lambda}_{c})_{i} = \sum_{j=1}^{N_{F}}(|\mathbf{U}_{ij} \cdot \mathbf{n}_{ij}| + c_{ij})\Delta S_{ij} \\
	& (\hat{\Lambda}_{v})_{i} = \frac{1}{\Omega_{i}}\sum_{j=1}^{N_{F}}\bigg[ \max\Big( \frac{4}{3\rho_{ij}}, \frac{\gamma_{ij}}{\rho_{ij}} \Big) \Big( \frac{\mu_{L}}{Pr_{L}} + \frac{\mu_{T}}{Pr_{T}} \Big)_{ij}(\Delta S_{ij})^{2} \bigg]
	\end{align}

Formulas similar to operator equations can be obtained in the case of the cell-centered scheme. The major difference is that the summation in the :math:`\mathbf{L}` and the :math:`\mathbf{U}` operator is conducted onver faces of the cell instead of incident edges.

The sets :math:`L(i)` and :math:`U(i)` should fulfill the same function as the diagonal planes on structured grids. For this reason, it is necessary to arrange the nodes (cells) into layers such that:

- nodes :math:`i` (cells :math:`I` ) of a current layer have connections to layers with previously updated flow variables--otherwise the LU-SGS scheme degenerates to a Jacobi iteration,
- nodes (cells) in a layer are not connected to each other--otherwise the scheme could not be vectorized.
  
An appropriate definition of the sets :math:`L(i)` and :math:`U(i)` allows for the following two-step inversion procedure

.. math::
	\begin{align}
	& \mathbf{D}\Delta\mathbf{W}_{i}^{(1)} = -\mathbf{R}_{i}^{n}
	- \sum_{j \in L(i)}\frac{1}{2}\Big[ (\Delta F_{c}^{(1)})_{j} \Delta S_{ij} + (r_{A}^{*})_{j}\bar{I}\Delta\mathbf{W}_{j}^{(1)} \Big] \\
	& \mathbf{D}\Delta\mathbf{W}_{i}^{n} = \mathbf{D}\Delta\mathbf{W}_{i}^{(1)}
	- \sum_{j\in U(i)} \frac{1}{2}\Big[ (\Delta F_{c}^{n})_{j} \Delta S_{ij} - (r_{A}^{*})_{j}\bar{I}\Delta\mathbf{W}_{j}^{n} \Big]
	\end{align}

where the viscous Jacobians were approximated by their spectral radii and where the positive/negative Jacobians were linearized according to

.. math::
	\begin{align}
	(\bar{A}^{\pm} \Delta S)\Delta\mathbf{W}^{n}
	\approx \frac{1}{2} (\Delta\mathbf{F}_{c}\Delta S \pm r_{A}\bar{I}\Delta\mathbf{W}^{n})
	\end{align}

with the update of the convective fluxes

.. math::
	\begin{align}
	\Delta\mathbf{F}_{c} = \mathbf{F}_{c}^{n+1} - \mathbf{F}_{c}^{n}
	\end{align}

Futhermore, the factor :math:`(r_{A}^{*})_{j}` is defined as

.. math::
	\begin{align}
	(r_{A}^{*})_{j} = \omega (|\mathbf{U}_{j} \cdot \mathbf{n}_{ij}| + c_{j})\Delta S_{ij}
	+ \frac{\Delta S_{ij}}{\| \mathbf{r}_{j} - \mathbf{r}_{i} \|_{2}} \bigg[ \max\Big( \frac{4}{3\rho_{j}}, \frac{\gamma_{j}}{\rho_{j}} \Big) \Big( \frac{u_{L}}{Pr_{L}} + \frac{u_{T}}{Pr_{T}} \Big)_{j} \bigg]
	\end{align}

with :math:`\| \mathbf{r}_{j} - \mathbf{r}_{i} \|_{2}` being the length of the edge :math:`ij` .

The time step can be computed in the same way as for the explicit scheme. However, the viscous eigenvalue should be omitted, since the viscous terms are already contained in the implicit operator and hence do not reduce the time step as in the case of an explicit scheme. The CFL number can be chosen in the range from :math:`10^{4}` to :math:`10^{6}` for steady flows. The convergence speed and the robustness of the LU-SGS scheme can then be tuned using the overrelaxation parameter :math:`\omega` .




Newton-Krylov method
^^^^^^^^^^^^^^^^^^^^^^^

First of all, let us rewrite the implicit scheme as

.. math::
	\begin{align}
	\bar{J}\Delta\mathbf{W}^{n} = -\mathbf{R}^{n}
	\end{align}

where :math:`\bar{J}` represents the implicit operator (system matrix). As we saw already, :math:`\bar{J}` constitutes a large, sparse, and generally non-symmetric matrix. In the previous sections, we discussed two methods that decompose :math:`\bar{J}` into several factors which can each inverted more easily than :math:`\bar{J}` itself. However, due to the factorization error (and approximate linearization of :math:`\mathbf{R}^{n+1}` ), only a linear convergence to steady state can be achieved. In order to obtain the quadratic convergence of Newton's method for the solution of non-linear equations, four conditions must be fulfilled:

- the linearization of the residual must be exact,
- :math:`\bar{J}` must be accurately inverted,
- the time step has to be :math:`\Delta t \to \infty` ,
- initial solution must be, in some sense, close to the final solution.
  
Obviously, the main obstacles that have to be overcome are the linearization and the inversion of the full system matrix.

A particularly suitable class of iterative techniques for the solution of large linear equation systems are the so-called Krylov-subspace methods. Several were proposed for the inversion of matrices which arise in CFD. Examples are the conjugate gradient squared (CGS) method, the bi-conjugate gradient stabilized (Bi-CGSTAB) scheme, or the transpose-free quasi-minimum residual (TFQMR) approach. However, the most successful Krylov subspace method became the generalized minimal residual (GMRES) technique, which was originally suggested by Saad and Schulz. Since then, the GMRES method was improved and augmented by several researchers. Because of its popularity, we shall focus on the GMRES approach in the following. Nevertheless, most of what we shall discuss also applies to the other Krylov subspace methods.





Unified Gas-Kinetic Scheme (UGKS)
====================================

`A unified gas-kinetic scheme for continuum and rarefied flows <https://www.sciencedirect.com/science/article/pii/S0021999110003475#:~:text=The%20unified%20scheme%20is%20an%20extension%20of%20the,of%20local%20solution%20of%20the%20gas%20distribution%20function.>`_ 

Kinetic theory and discrete ordinate method
--------------------------------------------

In this paper, we will present a unified scheme for all Knudsen flows. The one-dimensional kinetic equation will be used to illustrate the idea. In this section, we are going to first intrduce the kinetic equation and the traditional discrete ordinate method (DOM).

The one-dimensional gas-kinetic BGK equation can be written as

.. math::
	\begin{align}
	\frac{\partial f}{\partial t} + u\frac{\partial f}{\partial x} = \frac{g - f}{\tau}
	\end{align}

where :math:`f` is the gas distribution function and :math:`g` is the equilibrium state approached by :math:`f` . Both :math:`f` and :math:`g` are functions of space :math:`x` , time :math:`t` , particle velocities :math:`u` , and internal variable :math:`\xi` . The particle collision time :math:`\tau` is related to the viscosity and heat conduction coefficients, i.e., :math:`\tau = \mu/p` where :math:`\mu` is the dynamic viscosity coefficient and :math:`p` is the pressure. The equilibrium state is a Maxwellian distribution

.. math::
	\begin{align}
	g = \rho \Big( \frac{\lambda}{\pi} \Big)^{\frac{K+1}{2}} e^{-\lambda((u - U)^{2} + \xi^{2})}
	\end{align}

where :math:`\rho` is the density, :math:`U` is the macroscopic velocity in the :math:`x` direction, :math:`\lambda` is equal to :math:`m/2kT` , :math:`m` is the molecular mass, :math:`k` is the Boltzmann constant, and :math:`T` is the temperature. For 1D flow, the total number of degrees of freedom :math:`K` in :math:`\xi` is equal to :math:`\frac{3 - \gamma}{\gamma - 1}` . For example, for a monatomic gas with :math:`\gamma = 5/3` , :math:`K` is equal to :math:`2` to account for the particle motion in the :math:`y` and :math:`z` directions. In the equilibrium state, the internal variable :math:`\xi^{2}` is equal to :math:`\xi^{2} = \xi_{1}^{2} + \xi_{2}^{2} + \cdots + \xi_{K}^{2}` . The relation between mass :math:`\rho` , momentum :math:`\rho U` , and energy densities :math:`E` with the distribution function :math:`f` is

.. math::
	\begin{align}
	\begin{pmatrix} \rho \\ \rho U \\ E \end{pmatrix}
	= \int \psi_{\alpha}f~\mathrm{d}\Xi 
	,\quad \alpha = 1,2,3
	\end{align}

where :math:`\psi_{\alpha}` is the component of the vector of moments

.. math::
	\begin{align}
	\boldsymbol{\psi} = (\psi_{1}, \psi_{2}, \psi_{3})^{T}
	= \Big( 1, u, \frac{1}{2}(u^{2} + \xi^{2}) \Big)^{T}
	\end{align}

and :math:`\mathrm{d}\Xi = \mathrm{d}u\mathrm{d}\xi_{1}\mathrm{d}\xi_{2}\cdots\mathrm{d}\xi_{K}` is the volume element in the phase space with :math:`\mathrm{d}\xi = \mathrm{d}\xi_{1}\mathrm{d}\xi_{2}\cdots\mathrm{d}\xi_{K}` . Based on the distribution function :math:`f` , all other macroscopic flow variables, such as the stress :math:`p_{ij}` and heat fluxes :math:`q_{i}` , can be defined as well,

.. math::
	\begin{align}
	& p_{ij} = \int (u_{i} - U_{i})(u_{j} - U_{j})f~\mathrm{d}\Xi \\
	& q_{i} = \int \frac{1}{2}(u_{i} - U_{i})((u_{j} - U_{j})^{2} + \xi^{2})~\mathrm{d}\Xi
	\end{align}

where :math:`U_{i}` is the averaged fluid velocity

.. math::
	\begin{align}
	U_{i} = \frac{\int u_{i}f~\mathrm{d}\Xi}{\int f~\mathrm{d}\Xi}
	\end{align}

Since mass, momentum, and energy are conserved during particle collisions, :math:`f` and :math:`g` satisfy the conservation constraint,

.. math::
	\begin{align}
	\int (g - f)\psi_{\alpha}~\mathrm{d}\Xi = 0
	,\quad
	\alpha = 1,2,3
	\end{align}

at any point in space and time.

Before we introduce discrete ordinate method, let's first discretize the physical space, time and particle velocity space. The physical space is divided into numerical cells with cell size :math:`\Delta x` , and the j-th cell is given by :math:`x \in [x_{j-1/2}, x_{j+1/2}]` with cell size :math:`\Delta x = x_{j+1/2} - x_{j-1/2}` . The temporal discretization is denoted by :math:`t^{n}` for the n-th time step. The particle velocity space is discretized by :math:`2N+1` subcells with cell size :math:`\Delta u` , and the center of k-th velocity interval is :math:`u_{k} = k\Delta u` , and it represents the average velocity :math:`u` in that interval,

.. math::
	\begin{align}
	u \in \Big[ (k-\frac{1}{2})\Delta u, (k+\frac{1}{2})\Delta u \Big]
	,\quad
	k = -N, -(N-1), \cdots, -1, 0, 1, \cdots, (N-1), N
	\end{align}

Then, the averaged gas distribution function in cell :math:`j` , at time step :math:`t^{n}` , and around particle velocity :math:`u_{k}` , is given by

.. math::
	\begin{align}
	f(x_{j}, t^{n}, u_{k}) = f_{j,k}^{n}
	= \frac{1}{\Delta x \Delta u} \int_{x_{j-1/2}}^{x_{j+1/2}}\int_{u_{k}-\frac{1}{2}\Delta u}^{u_{k}+\frac{1}{2}\Delta u} f(x,t^{n},u)~\mathrm{d}x\mathrm{d}u
	\end{align}

where :math:`\Delta x` is the cell size and :math:`\Delta u` is the particle velocity interval defined later.

The BGK equation can be rewritten as

.. math::
	\begin{align}
	\frac{\partial f}{\partial t} = -u\frac{\partial f}{\partial x} + \frac{g - f}{\tau}
	\end{align}

Integrating the above equation in a control volume :math:`\int_{x_{j-1/2}}^{x_{j+1/2}}\int_{t^{n}}^{t^{n+1}}(\cdots)\mathrm{d}x\mathrm{d}t/\Delta x` , and keeping the particle velocity space continuous, the above differential equation becomes an integral equation

.. math::
	\begin{align}
	f_{j}^{n+1} = f_{j}^{n}
	+ \frac{1}{\Delta x}\int_{t^{n}}^{t^{n+1}}\Big( u\hat{f}_{j-1/2}(t) - u\hat{f}_{j+1/2}(t) \Big)~\mathrm{d}t
	+ \frac{1}{\Delta x}\int_{t^{n}}^{t^{n+1}}\int_{x_{j-1/2}}^{x_{j+1/2}}\frac{g - f}{\tau}~\mathrm{d}x\mathrm{d}t
	\end{align}

where :math:`\hat{f}_{j+1/2}` is the gas distribution function at the cell interface :math:`x_{j+1/2}` . The above equation is exact and there is no any numerical error introduced yet. For a kinetic scheme, two terms on the right hand side of the above equation have to be numerically evaluated.

With discretized particle space, at each particle velocity :math:`u_{k}` , a standard operator splitting method is to solve the above equation in the following steps. The above equation is decoupled to

.. math::
	\begin{align}
	f_{j,k}^{*} = f_{j,k}^{n} + \frac{1}{\Delta x}\int \Big( u_{k}\hat{f}_{j-1/2,k}(t) - u_{k}\hat{f}_{j+1/2, k}(t) \Big)~\mathrm{d}t
	\end{align}

for the transport across a cell interface, and

.. math::
	\begin{align}
	\frac{\mathrm{d}f_{j,k}}{\mathrm{d}t} = \frac{g - f_{j,k}^{*}}{\tau}
	\end{align}

for the particle collision or source term inside each cell. In the transport part, the collisionless Boltzmann equation or upwinding approach, is used,

.. math::
	\begin{align}
	\frac{\partial f}{\partial t} + u\frac{\partial f}{\partial x} = 0
	\end{align}

for the flux evaluation at the cell interface. For example, for a first-order method, the upwinding flux is based on the following solution at the cell interface,

.. math::
	\begin{align}
	\hat{f}_{j+1/2, k} = \left\{ \begin{array}{l}
	f_{j,k} ,\quad u_{k} \ge 0 \\
	f_{j+1,k} ,\quad u_{k}<0
	\end{array} \right.
	\end{align}

which is dynamically equivalent to the flux vector splitting scheme. The above transport and collision steps can be also coupled using Runge-Kutta method within a time step.

If we take conservative moments :math:`\psi_{\alpha}` on the integral form equation, due to the conservation of conservative variables during particle collision process, the update of conservative variables become

.. math::
	\begin{align}
	W_{j}^{n+1} = W_{j}^{n} + \frac{1}{\Delta x} \int_{t^{n}}^{t^{n+1}}\big( F_{j-1/2}(t) - F_{j+1/2}(t) \big)~\mathrm{d}t
	\end{align}

where :math:`W` is the averaged conservative mass, momentum and energy densities inside each cell, and :math:`F = \int u \psi_{\alpha}\hat{f}~\mathrm{d}\Xi` is the flux based on the collisionless Boltzmann equation. The above scheme for the update of macroscopic flow variables is physically identical to the kinetic flux vector splitting schemes (KFVS). The only difference is the approximation of initial gas distribution function used at the beginning of each time step in order to evaluate the interface flux :math:`\hat{f}` . For the KFVS scheme, an equilibrium state with continuous particle velocity space is used to construct initial condtion :math:`f` for :math:`f_{t} + u f_{x} = 0` , and for the DOM the initial :math:`f` is explicitly given from the update of the discretized particle distribution function. But, the different initial condition will not change the numerical dissipative mechanism in the KFVS method, where the numerical dissipation is proportional to the time step. Therefore, if a large time step could be used for the DOM method in the continuum flow regime, the numerical dissipation would make DOM scheme be inaccurate for the NS solutions. It is a well-known defect for all flux vector splitting methods. So, in the continuum flow regime, for the DOM method the requirement of time step being less than the particle collision time helps the scheme not only for the stability, but also for the accuracy. Unfortunately, this constraint deviates the above scheme away from an AP method for the NS solutions in the continuum flow regime.

In order to design an AP scheme which is able to capture NS solutions in the continuum flow regime and also get an accurate free molecule solution in another limit, the full BGK equation has to be solved in the flux evaluation across a cell interface. The kinetic equation models the transport :math:`uf_{x}(x,t)` and collision :math:`(g-f)/\tau` as a continuous function of :math:`x` and :math:`t` . For these molecules passing through a cell interface, they do suffer from particle collisions during their passage moving towards to the cell interface. The collision frequency of these molecules distinguishes the continuum and rarefied flow regimes dynamically, subsequently presents the corresponding distribution functions.


Unified kinetic scheme for all flow regimes
---------------------------------------------

In this section, we will present a unified kinetic scheme based on the BGK model for all flow regimes. The current method is a natural extension of the gas-kinetic BGK-NS method for the compressible Navier-Stokes solutions to all Knudsen number flows. In this section, only one-dimensional formulation will be presented. The extension to 2D and 3D cases is straightforward for the kinetic method.

With the discretization of space :math:`x_{j}` , time :math:`t^{n}` , and particle velocity :math:`u_{k}` , the finite volume scheme based on the integral solution of the integral form equation is

.. math::
	\begin{align}
	f_{j,k}^{n+1} = f_{j,k}^{n}
	+ \frac{1}{\Delta x}\int \Big( u_{k}\hat{f}_{j-1/2,k} - u_{k}\hat{f}_{j+1/2,k} \Big)~\mathrm{d}t
	+ \frac{1}{\Delta x}\iint \frac{g - f}{\tau}\mathrm{d}x\mathrm{d}t
	\end{align}

where :math:`f_{j,k}^{n}` is the averaged distribution function in the j-th cell :math:`x \in [x_{j-1/2}, x_{j+1/2}]` at the particle velocity :math:`u_{k}` . Instead of using upwinding scheme for the evaluation of the distribution function at a cell interface, the solution :math:`\hat{f}_{j+1/2,k}` in the above equation is constructed from an integral solution of the BGK model using the method of characteristics

.. math::
	\begin{align}
	\hat{f}_{j+1/2,k} = f(x_{j+1/2}, t, u_{k}, \xi)
	= \frac{1}{\tau}\int_{t^{n}}^{t} g(x', t', u_{k}, \xi)e^{-(t-t')/\tau}\mathrm{d}t'
	+ e^{-(t-t^{n})/\tau}f_{0,k}^{n}(x_{j+1/2} - u_{k}(t - t^{n}), t^{n}, u_{k}, \xi)
	\end{align}

where :math:`x' = x_{j+1/2} - u_{k}(t - t')` is the particle trajectory and :math:`f_{0,k}^{n}` is the intial gas distribution function of :math:`f` at time :math:`t=t^{n}` around the cell interface :math:`x_{j+1/2}` at the particle velocity :math:`u_{k}` , i.e., :math:`f_{0,k}^{n} = f_{0}^{n}(x, t^{n},u_{k},\xi)` . In the above equation, :math:`f_{0,k}^{n}` , is known at the beginning of each time step :math:`t^{n}` , and a high-order reconstruction can be used to reconstruct its subcell resolution using TVD and ENO methods. The use of the following discontinuous reconstruction is to introduce artificial dissipation for the unified scheme once the scheme becomes a shock capturing method when the dissipative flow structure cannot be well resolved by the cell size. If the solutions are well resolved, the discontinuous reconstruction will become a continuous one automatically. In order to simplify the notation, in the following the cell :math:`x_{j+1/2}=0` and :math:`t^{n} = 0` are used. For example, around each cell interface :math:`x_{j+1/2}` , at time step :math:`t^{n}` the initial distribution function becomes

.. math::
	\begin{align}
	f_{0}(x,t^{n},u_{k},\xi) = f_{0,k}(x,0) = \left\{ \begin{array}{l}
	f_{j+1/2,k}^{l}[1 + \sigma_{j,k}x] ,\quad x\le 0 \\
	f_{j+1/2,k}[1 + \sigma_{j+1,k}x] ,\quad x>0
	\end{array} \right.
	\end{align}

where nonlinear limiter is used to reconstruct :math:`f_{j+1/2,k}^{l}, f_{j+1/2,k}^{r}` and the corresponding slopes :math:`\sigma_{j,k}` . For example, in this paper we will use van Leer limiter in the reconstruction. The cell interface distribution functions become

.. math::
	\begin{align}
	& f_{j+1/2,k}^{l} = f_{j,k} + (x_{j+1/2} - x_{j})\sigma_{j,k} \\
	& f_{j+1/2,k}^{r} = f_{j+1,k} - (x_{j+1} - x_{j+1/2})\sigma_{j+1,k}
	\end{align}

and

.. math::
	\begin{align}
	\sigma_{j,k} = \Big( \operatorname{sign}(s_{1}) + \operatorname{sign}(s_{2}) \Big) \frac{|s_{1}||s_{2}|}{|s_{1}| + |s_{2}|}
	\end{align}

where :math:`s_{1} = \frac{f_{j,k} - f_{j-1,k}}{x_{j} - x_{j-1}}` and :math:`s_{2} = \frac{f_{j+1,k} - f_{j,k}}{x_{j+1} - x_{j}}` .

There is one-to-one correspondence between an equilibrium state and macroscopic flow variables. For the integral solution of the equilibrium state in :math:`\hat{f}_{j+1/2,k}` , we can first use a continuous particle velocity space to evaluate the integral. For an equilibrium state :math:`g` around a cell interface :math:`(x_{j+1/2}=0, t=0)` , same as the BGK-NS scheme, it can be expanded with two slopes,

.. math::
	\begin{align}
	g = g_{0} \Big[ 1 + (1 - H[x])\overline{a}^{l}x + H[x] \overline{a}^{r}x + \overline{A}t \Big]
	\end{align}

where :math:`H[x]` is the Heaviside function defined as

.. math::
	\begin{align}
	H[x] = \left\{ \begin{array}{l}
	0 ,\quad x<0 \\
	1 ,\quad x\ge 0
	\end{array} \right.
	\end{align}

Here :math:`g_{0}` is a local Maxwellian distribution function located at :math:`x = 0` . Even though, :math:`g` is continuous at :math:`x = 0` , it has different slopes at :math:`x<0` and :math:`x\ge 0` . In the equilibrium state in space and time, it is not necessary to use a discretized particle velocity space. Based on the macroscopic flow distributions, we can construct the integral solution with a continuous particle velocity space first, then take its corresponding value at the specific particle velocity when necessary. The expansion of the above equilibrium distribution is coming from a Taylor expansion of a Maxwellian in space and time. In order to have AP scheme for the Navier-Stokes equations, to keep to keep the first-order expansion of an equilibrium state in space and time is necessary. Certainly, if you would like to increase the order of accuracy or solve Burnett equations as the asymptotic limit in the continuum regime, a high-order expansion needs to be used.

The dependence of :math:`\overline{a}^{l}, \overline{a}^{r}` and :math:`\overline{A}` on the particle velocity can be obtained from a Taylor expansion of a Maxwellian and have the following form

.. math::
	\begin{align}
	& \overline{a}^{l} = \overline{a}_{1}^{l} + \overline{a}_{2}^{l}u + \overline{a}_{3}^{l}\frac{1}{2}(u^{2} + \xi^{2}) = \overline{a}_{\alpha}^{l}\psi_{\alpha} \\
	& \overline{a}^{r} = \overline{a}_{1}^{r} + \overline{a}_{2}^{r}u + \overline{a}_{3}^{r}\frac{1}{2}(u^{2} + \xi^{2}) = \overline{a}_{\alpha}^{r}\psi_{\alpha} \\
	& \overline{A} = \overline{A}_{1} + \overline{A}_{2}u + \overline{A}_{3}\frac{1}{2}(u^{2} + \xi^{2}) = \overline{A}_{\alpha}\psi_{\alpha}
	\end{align}

where :math:`\alpha = 1,2,3` and all coefficient :math:`\overline{a}_{1}^{l}, \overline{a}_{2}^{l}, \cdots, \overline{A}_{3}` are local constants.

The determination of :math:`g_{0}` depends on the determination of the local macroscopic values of :math:`\rho_{0}, U_{0}` and :math:`\lambda_{0}` in :math:`g_{0}` , i.e.

.. math::
	\begin{align}
	g_{0} = \rho_{0}\Big(\frac{\lambda_{0}}{\pi}\Big)^{\frac{K+1}{2}}e^{-\lambda((u-U_{0})^{2} - \xi^{2})}
	\end{align}

which is determined uniquely using the compatibility condition of the BGK model. Taking the limit :math:`t \to 0` in the :math:`\hat{f}_{j+1/2,k}` expression and substituting its solution into :math:`\int (g-f)\psi_{\alpha}\mathrm{d}\Xi` , the conservation constraint at :math:`(x = x_{j+1/2}, t=0)` gives

.. math::
	\begin{align}
	W_{0} = \int g_{0}\psi\mathrm{d}\Xi
	= \sum_{k=-N}^{k=N}\Big( f_{j+1/2,k}^{l} H[u_{k}] + f_{j+1/2,k}^{r}(1 - H[u_{k}]) \Big)\boldsymbol{\psi}
	\end{align}

where :math:`W_{0} = (\rho_{0}, \rho_{0}U_{0}, E_{0})^{T}` is the conservative macroscopic flow variables located at the cell interface at time :math:`t=0` . Since :math:`f_{j+1/2,k}^{l}` and :math:`f_{j+1/2,k}^{r}` have been obtained earlier in the initial distribution function :math:`f_{0}` around a cell interface, the above moments can be evaluated explicitly. Therefore, the conservative variables :math:`\rho_{0}, \rho_{0}U_{0}` and :math:`E_{0}` at the cell interface can be obtained, from which :math:`g_{0}` is uniquely determined. Different from the BGK-NS method, the integration of :math:`f_{0}` term in phase space in BGK-NS scheme is replaced by the quadrature formula in particle velocity due to the discretization of phase space. Also, due to the particle velocity discretization, the gas distribution function has more freedom here to recover any shape distribution function in the highly non-equilibrium flow regime, and the macroscopic governing equations underlying the current kinetic approach can be beyond the NS in the general case. For the equilibrium state, :math:`\lambda_{0}` in :math:`g_{0}` can be found from

.. math::
	\begin{align}
	\lambda_{0} = \frac{(K + 1)\rho_{0}}{4\Big( E_{0} - \frac{1}{2}\rho_{0}U_{0}^{2} \Big)}
	\end{align}

Then, :math:`\overline{a}^{l}` and :math:`\overline{a}^{r}` of :math:`g` can be obtained through the relation of

.. math::
	\begin{align}
	\frac{\overline{W}_{j+1}(x_{j+1}) - W_{0}}{\rho_{0}\Delta x^{+}}
	= \int \overline{a}^{r}g_{0}\psi ~\mathrm{d}\Xi
	= \overline{M}_{\alpha\beta}^{0} \begin{pmatrix} \overline{a}_{1}^{r} \\ \overline{a}_{2}^{r} \\ \overline{a}_{3}^{r} \end{pmatrix}
	= \overline{M}_{\alpha\beta}^{0}\overline{a}_{\beta}^{r}
	\end{align}

and

.. math::
	\begin{align}
	\frac{W_{0} - \overline{W}_{j}(x_{j})}{\rho_{0}\Delta x^{-}}
	= \int \overline{a}^{l}g_{0}\psi ~\mathrm{d}\Xi
	= \overline{M}_{\alpha\beta}^{0} \begin{pmatrix} \overline{a}_{1}^{l} \\ \overline{a}_{2}^{l} \\ \overline{a}_{3}^{l} \end{pmatrix}
	= \overline{M}_{\alpha\beta}^{0}\overline{a}_{\beta}^{l}
	\end{align}

where the matrix :math:`\overline{M}_{\alpha\beta}^{0} = \int g_{0}\psi_{\alpha}\psi_{\beta}\mathrm{d}\Xi/\rho_{0}` is known, and :math:`\Delta x^{+} = x_{j+1} - x_{j+1/2}` and :math:`\Delta x^{-} = x_{j+1/2} - x_{j}` are the distances from the interface to cell centers. Therefore, :math:`(\overline{a}_{1}^{r}, \overline{a}_{2}^{r}, \overline{a}_{3}^{r})^{T}` and :math:`(\overline{a}_{1}^{l}, \overline{a}_{2}^{l}, \overline{a}_{3}^{l})^{T}` can be found following the procedure as BGK-NS method. In order to evaluate the time evolution part :math:`\overline{A}` in the equilibrium state, we can apply the following condition

.. math::
	\begin{align}
	\frac{\mathrm{d}}{\mathrm{d}t}\int (g-\hat{f})\boldsymbol{\psi}\mathrm{d}\Xi = 0
	\end{align}

at :math:`(x=0,t=0)` and get

.. math::
	\begin{align}
	\overline{M}_{\alpha\beta}^{0}\overline{A}_{\beta}
	= \Big( \frac{\partial \rho}{\partial t}, \frac{\partial(\rho U)}{\partial t}, \frac{\partial E}{\partial t} \Big)^{T}
	= -\frac{1}{\rho_{0}}\int \Big[ u\Big( \overline{a}^{l}H[u] + \overline{a}^{r}(1 - H[u]) \Big)g_{0} \Big] \boldsymbol{\psi}\mathrm{d}\Xi
	\end{align}

Up to this point, we have determined all parameters in the initial gas distribution funtion :math:`f_{0}` and the equilibrium state :math:`g` in space and time locally. After substituting the expression of :math:`f_{0}` and :math:`g` into the :math:`\hat{f}_{j+1/2,k}` equation and taking :math:`u=u_{k}` in :math:`g_{0}, \overline{a}^{l}, \overline{a}^{r}` and :math:`\overline{A}` , the gas distribution function :math:`\hat{f}(x_{j+1/2}, t, u_{k}, \xi)` at the discretized particle velocity :math:`u_{k}` can be expressed as

.. math::
	\begin{align}
	\hat{f}_{j+1/2,k}(0,t)
	&= (1 - e^{-t/\tau})g_{0}
	+ \Big( \tau(-1 + e^{-t/\tau}) + te^{-t/\tau} \Big) \Big( \overline{a}^{l}H[u_{k}] + \overline{a}^{r}(1 - H[u_{k}]) \Big) u_{k}g_{0}
	+ \tau (t/\tau - 1 + e^{-t/\tau})\overline{A}g_{0} \\
	&\quad + e^{-t/\tau}\Big( (1 - u_{k}t\sigma_{j,k})H[u_{k}]f_{j+1/2,k}^{l} + (1 - u_{k}t\sigma_{j+1.k})(1 - H[u_{k}])f_{j+1/2,k}^{r} \Big) \\
	&:= \tilde{g}_{j+1/2,k} + \tilde{f}_{j+1/2,k}
	\end{align}

where :math:`\tilde{g}_{j+1/2,k}` is all terms related to the integration of the equilibrium state :math:`g` and :math:`\tilde{f}_{j+1/2,k}` is the terms from initial condtion :math:`f_{0}` . The collision time :math:`\tau` in the above distribution function is determined by :math:`\tau = \mu(T_{0})/p_{0}` , where :math:`T_{0}` is the temperature and :math:`p_{0}` is the pressure, and both of them can be evaluated from :math:`W_{0}` at the cell interface. The above time-accurate gas distribution function can be used in :math:`f_{j,k}^{n+1}` equation for the fluxes at a cell interface.

In order to discretize the collision term in the :math:`f_{j,k}^{n+1}` equation efficiently and accurately, a multiscale unified formulation is the following. Let's first take moment :math:`\boldsymbol{\psi}` on it. Due to the vanishing of the particle collision term for the conservative variables, we have

.. math::
	\begin{align}
	W_{j}^{n+1} = W_{j}^{n}
	+ \frac{1}{\Delta x}\int \int_{t^{n}}^{t^{n+1}}u (\tilde{g}_{j-1/2} - \tilde{g}_{j+1/2})\psi ~\mathrm{d}t\mathrm{d}\Xi
	+ \frac{1}{\Delta x}\sum_{k}\int_{t^{n}}^{t^{n+1}}u_{k}(\tilde{f}_{j-1/2,k} - \tilde{f}_{j+1/2,k})\boldsymbol{\psi}~\mathrm{d}t
	\end{align}

where :math:`\tilde{g}_{j+1/2}` has the same expression as :math:`\tilde{g}_{j+1/2,k}` , but is integrated in a continuous particle velocity space :math:`u_{k}=u` . The integration of the equilibrium part :math:`\tilde{g}` can be evaluated exactly and the integration of the non-equilibrium part :math:`\tilde{f}` can be done using the quadrature.

For the update of the conservative variables, the difference between the above formulation and the BGK-NS scheme is that the discrete sum is used for the integration of the initial distribution function :math:`f_{0}` in particle velocity space. For a highly non-equilibrium flow, the real distribution function :math:`f_{0}` can be a complicated function, and a discretization of particle velocity has to be used. For the original BGK-NS scheme targeting on the NS solutions, the initial gas distribution function :math:`f_{0}` can be reconstructed from the distribution of macroscopic variables according to the Chapman-Enskog expansion. Therefore, the specific form of initial condition :math:`f_{0}` can be mathematically reconstructed. In the continuum flow limit, due to the sufficient number of particle collisions and with the condition of time step being much larger than the particle collision time, the contribution of the integration of the equilibrium state :math:`\tilde{g}_{j+1/2}` will be dominant in the final solution of the distribution function :math:`\hat{f}_{j+1/2,k}` . The :math:`\tilde{g}_{j+1/2}` itself gives a corresponding NS distribution function, and the contribution from initial term :math:`\tilde{f}_{j+1/2,k}` vanishes. As a result, the updated discrete form of the distribution function :math:`f_{j,k}^{n+1}` will present a Chapman-Enskog NS distribution function. Therefore, in the continuum flow regime, the BGK-NS scheme with continuous particle velocity space and the current unified method with discretized particle velocity space will become the same scheme. In the continuum flow regime, for the NS solutions the update of the conservative variables through the above equation is enough, because the gas distribution function :math:`f_{j,k}^{n+1}` can be reconstructed from the updated conservative variables. Therefore, for the continuum flow only, like the BGK-NS scheme, we do not basically update the gas distribution function. This also illustrates that in terms of the conservative flow variable update, the unified scheme is an AP method in the continuum limit. However, the unified scheme is not limited to continuum flow. In the highly non-equilibrium flow regime, the equation for the update of conservative variables is still correct. For example, in the collisionless limit, the non-equilibrium part :math:`\tilde{f}_{j-1/2,k}` and :math:`\tilde{f}_{j+1/2,k}` will take dominant effect, and the contribution from the equilibrium part vanishes. Therefore, the unified scheme has the correct collisionless limit as well.

In general, based on the above updated conservative variables, we can immediately obtain the equilibrium gas distribution function :math:`g_{j,k}^{n+1}` inside each cell, therefore based on the above equation the unified kinetic scheme for the update of gas distribution function becomes

.. math::
	\begin{align}
	f_{j,k}^{n+1} = f_{j,k}^{n}
	+ \frac{1}{\Delta x} \bigg(
	\int_{t^{n}}^{t^{n+1}}u_{k}(\tilde{g}_{j-1/2,k} - \tilde{g}_{j+1/2,k})\mathrm{d}t
	+ \int_{t^{n}}^{t^{n+1}}u_{k}(\tilde{f}_{j-1/2,k} - \tilde{f}_{j+1/2,k})\mathrm{d}t
	\bigg)
	+ \frac{\Delta t}{2}\Big( \frac{g_{j,k}^{n+1} - f_{j,k}^{n+1}}{\tau^{n+1}} + \frac{g_{j,k}^{n} - f_{j,k}^{n}}{\tau^{n}} \Big)
	\end{align}

where trapezoidal rule has been used for the time integration of collision term. So, from the above equation, the unified multiscale scheme for the update of gas distribution function is

.. math::
	\begin{align}
	f_{j,k}^{n+1} = \Big( 1 + \frac{\Delta t}{2 \tau^{n+1}} \Big)^{-1}
	\bigg[ f_{j,k}^{n}
	+ \frac{1}{\Delta x}\Big(
	\int_{t^{n}}^{t^{n+1}}u_{k}(\tilde{g}_{j-1/2,k} - \tilde{g}_{j+1/2,k})\mathrm{d}t
	+ \int_{t^{n}}^{t^{n+1}} u_{k}(\tilde{f}_{j-1/2,k} - \tilde{f}_{j+1/2,k})\mathrm{d}t
	\Big)
	+ \frac{\Delta t}{2}\Big( \frac{g_{j,k}^{n+1}}{\tau_{j}^{n+1}} + \frac{g_{j,k}^{n} - f_{j,k}^{n}}{\tau_{j}^{n}} \Big)
	\bigg]
	\end{align}

where no iteration is needed for the update of the above solution. The particle collision times :math:`\tau_{j}^{n}` and :math:`\tau_{j^{n+1}}` are defined based on the temperature and pressure in the cell, i.e., :math:`\tau_{j}^{n} = \mu(T_{j}^{n})/p_{j}^{n}` and :math:`\tau_{j}^{n+1} = \mu(T_{j}^{n+1})/p_{j}^{n+1}` , which are known due to the update of macroscopic flow variables in the equation given before.


Determination of time step
----------------------------

In the continuum limit, for the unified scheme the time step is determined by the CFL condition

.. math::
	\begin{align}
	\Delta t = \text{CFL}\frac{\Delta x}{|U| + c}
	\end{align}

where CFL is the CFL number and :math:`c` is the sound speed. On the other hand, the particle collision time is defined by

.. math::
	\begin{align}
	\tau = \frac{\mu}{p} = \frac{\rho|U|\Delta x}{p Re}
	\end{align}

where :math:`Re = \rho \Delta x |U| / \mu` is the cell's Reynolds number. With the approximation

.. math::
	\begin{align}
	|U| + c \simeq c
	\end{align}

which is true for low speed flow and is approximately correct even for hypersonic flow because the flow velocity is on the same order of sound speed, we have

.. math::
	\begin{align}
	\frac{\Delta t}{\tau} = \frac{Re}{M}
	\end{align}

where :math:`M` is the Mach number. So, for the continuum flow computation, even for a modest cell Reynolds number, such as :math:`10^{4}` , the time step for the unified scheme can be several order larger than the particle collision time. The above equation can be also written in the following form

.. math::
	\begin{align}
	\Delta t = \frac{\tau}{Kn}
	\end{align}

where :math:`Kn = M/Re` is the local cell Knudsen number. So, for a flow with all Knudsen regimes from the continuum to free molecules, such as the nozzle flows, the overall time step taken by the unified scheme can be the one which maximizes the above time step. As a result, the time step :math:`\Delta t` used in the whole domain will be :math:`\Delta t \gg \tau` in the continuum and :math:`\Delta t < \tau` in rarefied regimes. In comparison with the schemes which use a time step solely controlled by the minimum particle collision time, the current unified scheme is much more efficient.


Prandtl number fix
---------------------

The unified scheme is based on the BGK model, which presents unit Prandtl number. For real gas, due to the interaction forces between molecules, the Prandtl number is approximately equal to :math:`2/3` for a monatomic gas. In order to extend the unified scheme to simulate flow with any realistic Prandtl number, the heat flux in the scheme has to been modified.

Traditionally, in order to fix the Prandtl number, many approaches have been investigated. The well-known ones include Ellipsoid BGK model, velocity dependent particle collision time, and Shakhov model. Since the heat flux is a macroscopic flow variable, it is related to the collective flow properties, it is very hard to directly modify it in the update of gas distribution function. Fortunately, the current unified scheme is a multiscale method. Both microscopic distribution function and macroscopic conservative flow variables are updated in the scheme. As a result, similar to the BGK-NS method, in the process of updating conservative flow variables, we can modify the heat flux across the cell interface in :math:`W_{j}^{n+1}` equation in the following way. In the flux evaluation in the equation, the interface flux is given by

.. math::
	\begin{align}
	F_{j+1/2} = \int u\tilde{g}_{j+1/2}\boldsymbol{\psi}\mathrm{d}\Xi
	+ \sum_{k}u_{k}\tilde{f}_{j+1/2,k}\boldsymbol{\psi}
	\end{align}

which include the energy flux :math:`F_{E}` . Therefore, the easiest way to modify the Prandtl number is to change the heat flux. The heat flux at a cell interface is

.. math::
	\begin{align}
	q_{j+1/2} = \int \frac{1}{2}(u - U_{j+1/2}) \Big( (u - U_{j+1/2})^{2} + \xi^{2} \Big)\boldsymbol{\psi} \tilde{g}_{j+1/2}\mathrm{d}\Xi
	+ \sum_{k}\frac{1}{2}(u_{k} - U_{j+1/2}) \Big( (u_{k} - U_{j+1/2})^{2} + \xi^{2} \Big) \boldsymbol{\psi} \tilde{f}_{j+1/2,k}
	\end{align}

where the interface averaged flow velocity is defined by

.. math::
	\begin{align}
	U_{j + 1/2} = \frac{\int u \tilde{g}_{j+1/2}\mathrm{d}\Xi + \sum_{k}u_{k}\tilde{f}_{j+1/2,k}}{\int \tilde{g}_{j+1/2}\mathrm{d}\Xi + \sum_{k}\tilde{f}_{j+1/2,k}}
	\end{align}

So, with a given Prandtl number :math:`Pr` , we only need to replace the original energy flux :math:`F_{E}` in the :math:`F_{j+1/2}` expression by the new one

.. math::
	\begin{align}
	F_{E}^{new} = F_{E} + \Big(\frac{1}{Pr} - 1\Big)q_{j+1/2}
	\end{align} 

With the correct Prandtl number in the updated macroscopic variables, subsequently it effects the construction of the equilibrium state :math:`g^{n+1}` at the next level. Therefore, the update of microscopic gas distribution function is modified as well. The above procedure of the modification of heat flux has some similarity with the DSMC method. For example, in the current scheme the post-collision particle velocity and directions are controlled through the modified :math:`g^{n+1}` .






